# 🎬 영상 생성 502 에러 해결 가이드

## 📋 문제 상황
- 브라우저 콘솔에 **502 에러** 발생
- "서버에 연결할 수 없습니다" 메시지 표시
- 영상 상태 확인 실패

## 🔍 원인 분석

### 1. 502 에러란?
- **502 Bad Gateway**: 백엔드 서버(Render)가 응답하지 않거나 다운된 상태
- Vercel(프론트엔드) → Render(백엔드) 연결 실패

### 2. 제미나이 API는 어디에 사용되나요?
✅ **제미나이 API**: 이미지 분석 및 프롬프트 생성에만 사용
- 사진을 보고 "이 음식은 어떤 특징이 있나요?" 분석
- "영상으로 만들 때 이런 프롬프트를 사용하세요" 제안

❌ **실제 영상 생성**: Runway API 사용
- 제미나이가 만든 프롬프트를 Runway API에 전달
- Runway API가 실제 영상 파일 생성

**결론**: 제미나이 API는 잘 작동해도, Runway API나 Render 서버 문제로 영상 생성이 실패할 수 있습니다.

## 🛠️ 해결 방법

### 방법 1: Render 서버 상태 확인 (가장 중요!)

1. **Render 대시보드 접속**
   - https://dashboard.render.com 접속
   - 로그인

2. **서비스 확인**
   - 서비스 목록에서 `naver-keyword-tool` 찾기
   - 상태 확인:
     - ✅ **Live** (초록색) = 정상 작동
     - ⚠️ **Sleeping** (노란색) = 잠자기 모드 (첫 요청 시 깨어남)
     - ❌ **Stopped** (빨간색) = 중단됨 (재시작 필요)

3. **로그 확인**
   - 서비스 클릭 → "Logs" 탭 클릭
   - 최근 에러 메시지 확인:
     - `Error: Cannot connect to database` → Supabase 연결 문제
     - `Error: GEMINI_API_KEY is not set` → 환경변수 문제
     - `Error: RUNWAY_API_KEY is not set` → 환경변수 문제
     - `Error: Port 10000 already in use` → 포트 충돌

4. **서버 재시작**
   - 서비스가 "Stopped" 상태면:
     - "Manual Deploy" → "Deploy latest commit" 클릭
     - 또는 "Restart" 버튼 클릭

### 방법 2: 환경변수 확인

Render 대시보드 → 서비스 → "Environment" 탭에서 확인:

**필수 환경변수:**
- ✅ `GEMINI_API_KEY` - 제미나이 API 키 (프롬프트 생성용)
- ✅ `RUNWAY_API_KEY` - Runway API 키 (영상 생성용)
- ✅ `NEXT_PUBLIC_SUPABASE_URL` - Supabase URL
- ✅ `SUPABASE_SERVICE_ROLE_KEY` - Supabase 키
- ✅ `PORT` - 포트 번호 (10000)

**확인 방법:**
1. 각 환경변수가 설정되어 있는지 확인
2. 값이 올바른지 확인 (특히 API 키)
3. 저장 후 서버 재시작

### 방법 3: 헬스체크 확인

브라우저에서 직접 테스트:
```
https://naver-keyword-tool.onrender.com/health
```

**예상 결과:**
- ✅ `{"status":"ok"}` → 서버 정상 작동
- ❌ `502 Bad Gateway` → 서버 다운
- ❌ `503 Service Unavailable` → 데이터베이스 연결 실패

### 방법 4: 로컬에서 테스트

로컬에서 서버를 실행하여 문제 확인:

```bash
# 1. 터미널 열기
# 2. 프로젝트 폴더로 이동
cd "D:\오연수사무실\개인\공부\최종251120"

# 3. 서버 실행
node server.js
```

**예상 출력:**
```
✅ Supabase 연결 성공
✅ Gemini API 키 확인 완료
✅ Runway API 키 확인 완료
🚀 서버가 포트 3003에서 실행 중입니다
```

**에러가 나오면:**
- `GEMINI_API_KEY is not set` → .env 파일에 키 추가 필요
- `RUNWAY_API_KEY is not set` → .env 파일에 키 추가 필요
- `Cannot connect to Supabase` → Supabase 연결 정보 확인

## 📝 체크리스트

다음 항목을 순서대로 확인하세요:

- [ ] Render 서버 상태 확인 (Live/Sleeping/Stopped)
- [ ] Render 로그에서 에러 메시지 확인
- [ ] 환경변수 확인 (GEMINI_API_KEY, RUNWAY_API_KEY 등)
- [ ] 헬스체크 테스트 (https://naver-keyword-tool.onrender.com/health)
- [ ] 로컬에서 서버 실행 테스트
- [ ] Supabase 테이블 확인 (shorts_videos 테이블 존재 여부)

## 🚨 자주 발생하는 문제

### 문제 1: "서버에 연결할 수 없습니다" (502 에러)
**원인**: Render 서버가 다운됨
**해결**: Render 대시보드에서 서버 재시작

### 문제 2: "데이터베이스 연결 오류" (503 에러)
**원인**: Supabase 연결 실패
**해결**: 
1. Render 환경변수에서 SUPABASE_URL, SUPABASE_KEY 확인
2. Supabase 대시보드에서 프로젝트 상태 확인

### 문제 3: "영상 생성 실패"
**원인**: Runway API 키 문제 또는 한도 초과
**해결**:
1. Render 환경변수에서 RUNWAY_API_KEY 확인
2. Runway 대시보드에서 사용량 확인

### 문제 4: "Gemini API 오류"
**원인**: 제미나이 API 키 문제 또는 한도 초과
**해결**:
1. Render 환경변수에서 GEMINI_API_KEY 확인
2. Google AI Studio에서 사용량 확인
3. **참고**: 제미나이 실패해도 기본 프롬프트로 영상 생성 가능

## 📞 추가 도움이 필요하신가요?

문제가 계속되면 다음 정보를 확인해주세요:
1. Render 로그의 최근 에러 메시지 (전체 복사)
2. 브라우저 콘솔의 에러 메시지 (전체 복사)
3. Render 서버 상태 (Live/Sleeping/Stopped)

