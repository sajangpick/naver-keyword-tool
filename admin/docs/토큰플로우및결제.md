# ğŸ“Š í† í°í”Œë¡œìš° ë° ê²°ì œ ì‹œìŠ¤í…œ ì™„ì „ ê°€ì´ë“œ

> **ìµœì¢… ì—…ë°ì´íŠ¸**: 2025ë…„ 10ì›” 31ì¼ 20:00  
> **ì‘ì„±ì**: AI Assistant  
> **ë²„ì „**: 2.0  
> **ìƒíƒœ**: âœ… ê²°ì œ ì¤€ë¹„ ì™„ë£Œ (PGì‚¬ í‚¤ë§Œ í•„ìš”)  
> **ì¤‘ìš”ë„**: ğŸ”´ Critical - í•µì‹¬ ìˆ˜ìµ ëª¨ë¸

## âš¡ ë¹ ë¥¸ ì‹œì‘ (ìƒˆ AIìš©)

```bash
# 1. ì„œë²„ í™•ì¸ (ì´ë¯¸ ì‹¤í–‰ì¤‘ì¼ ê²ƒ)
curl http://localhost:3003/health

# 2. í† í° ì‹œìŠ¤í…œ ì‘ë™ í™•ì¸
curl http://localhost:3003/api/subscription/pricing-config

# 3. ê²°ì œ í˜ì´ì§€ í…ŒìŠ¤íŠ¸
# ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°: http://localhost:3003/payment.html?plan=power
```

**í˜„ì¬ ìƒíƒœ**: í† í° ì‹œìŠ¤í…œ 100% ì‘ë™ ì¤‘, ê²°ì œëŠ” í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ê°€ëŠ¥

---

## ğŸ“Œ ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš” ë° í˜„ì¬ ìƒíƒœ](#1-ì‹œìŠ¤í…œ-ê°œìš”-ë°-í˜„ì¬-ìƒíƒœ)
2. [êµ¬í˜„ ì™„ë£Œ ë‚´ì—­](#2-êµ¬í˜„-ì™„ë£Œ-ë‚´ì—­)
3. [ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°](#3-ë°ì´í„°ë² ì´ìŠ¤-êµ¬ì¡°)
4. [API ì—”ë“œí¬ì¸íŠ¸](#4-api-ì—”ë“œí¬ì¸íŠ¸)
5. [í† í° ì¶”ì  ì‹œìŠ¤í…œ](#5-í† í°-ì¶”ì -ì‹œìŠ¤í…œ)
6. [ìë™í™” ì‹œìŠ¤í…œ](#6-ìë™í™”-ì‹œìŠ¤í…œ)
7. [ë³´ì•ˆ ê°œì„  ì‚¬í•­](#7-ë³´ì•ˆ-ê°œì„ -ì‚¬í•­)
8. [ê²°ì œ ì‹œìŠ¤í…œ í˜„í™©](#8-ê²°ì œ-ì‹œìŠ¤í…œ-í˜„í™©)
9. [í…ŒìŠ¤íŠ¸ ë°©ë²•](#9-í…ŒìŠ¤íŠ¸-ë°©ë²•)
10. [ë¬¸ì œ í•´ê²° ê°€ì´ë“œ](#10-ë¬¸ì œ-í•´ê²°-ê°€ì´ë“œ)
11. [ê¸°ì¡´ íšŒì› ì²˜ë¦¬](#11-ê¸°ì¡´-íšŒì›-ì²˜ë¦¬)
12. [ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥ ëª…ë ¹ì–´](#12-ì¦‰ì‹œ-ì‹¤í–‰-ê°€ëŠ¥-ëª…ë ¹ì–´)

---

## 1. ì‹œìŠ¤í…œ ê°œìš” ë° í˜„ì¬ ìƒíƒœ

### ğŸ¯ í† í°í”Œë¡œìš°ë€?

í† í°í”Œë¡œìš°ëŠ” ì‚¬ì¥í”½ ì„œë¹„ìŠ¤ì˜ **ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ê³¼ê¸ˆ ì‹œìŠ¤í…œ**ì…ë‹ˆë‹¤. AI ì‚¬ìš© ì‹œë§ˆë‹¤ í† í° ì°¨ê° â†’ í•œë„ ë„ë‹¬ â†’ ì—…ê·¸ë ˆì´ë“œ ìœ ë„ â†’ ê²°ì œ â†’ í† í° ì¶©ì „

### ğŸ“Š í˜„ì¬ êµ¬í˜„ ìƒíƒœ

| êµ¬ì„± ìš”ì†Œ | ìƒíƒœ | íŒŒì¼ ìœ„ì¹˜ | ì„¤ëª… |
|-----------|------|-----------|------|
| **í† í° ì°¨ê°** | âœ… ì‘ë™ì¤‘ | `api/middleware/token-tracker.js` | ëª¨ë“  AI API ìë™ ì¶”ì  |
| **êµ¬ë… ê´€ë¦¬** | âœ… ì‘ë™ì¤‘ | `api/subscription/*.js` | 6ê°œ í•µì‹¬ API ì™„ì„± |
| **ìë™ ê°±ì‹ ** | âœ… ì‘ë™ì¤‘ | `server.js` (í¬ë¡ ) | ë§¤ì¼ ìì • ìë™ ì‹¤í–‰ |
| **ê²°ì œ í˜ì´ì§€** | âœ… ì™„ì„± | `payment.html` | UI ì™„ì„±, í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ |
| **ê²°ì œ ì²˜ë¦¬** | âœ… ì¤€ë¹„ë¨ | `api/payment/payment-handler.js` | PGì‚¬ í‚¤ë§Œ í•„ìš” |
| **DB í…Œì´ë¸”** | âœ… ìƒì„±ë¨ | Supabase | 10ê°œ í…Œì´ë¸” ìš´ì˜ì¤‘ |
| **ê¸°ì¡´ íšŒì›** | âœ… ì²˜ë¦¬ë¨ | `api/subscription/member-benefits.js` | seed ë“±ê¸‰ ë¶€ì—¬ |

### ğŸ”¥ í•µì‹¬ ì‘ë™ íë¦„

```
í˜„ì¬ ì‘ë™ ì¤‘ì¸ í”Œë¡œìš°:
1. ì‚¬ìš©ì ë¡œê·¸ì¸ â†’ profiles.membership_level = 'seed' (100í† í°)
2. AI ë¸”ë¡œê·¸ ì‘ì„± â†’ í† í° 30ê°œ ì°¨ê° (ìë™)
3. 3-4íšŒ ì‘ì„± í›„ â†’ "í† í° ë¶€ì¡±" ë©”ì‹œì§€
4. ì—…ê·¸ë ˆì´ë“œ í´ë¦­ â†’ /payment.html?plan=power
5. ê²°ì œ (í˜„ì¬: í…ŒìŠ¤íŠ¸ ìë™ ìŠ¹ì¸)
6. í† í° 500ê°œ ì¦‰ì‹œ ì¶©ì „ â†’ ê³„ì† ì‚¬ìš©
```

### âš ï¸ ì¤‘ìš” ì‚¬í•­

```javascript
// í† í° ì¶”ì ì´ ì‘ë™í•˜ë ¤ë©´ ë°˜ë“œì‹œ userId í•„ìš”!
// í˜„ì¬ í…ŒìŠ¤íŠ¸ userId: "a3e8f5c7-8b2d-4f6e-9c1a-3d5e7f9a1b3c"

// .env íŒŒì¼ í™•ì¸
PORT=3003  // ì„œë²„ í¬íŠ¸
NEXT_PUBLIC_SUPABASE_URL=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx

// PGì‚¬ ì—°ê²° ì‹œ ì¶”ê°€ í•„ìš”
TOSS_CLIENT_KEY=test_ck_xxx  // ì•„ì§ ì—†ìŒ
TOSS_SECRET_KEY=test_sk_xxx  // ì•„ì§ ì—†ìŒ
```

---

## 2. êµ¬í˜„ ì™„ë£Œ ë‚´ì—­

### ğŸ“… 2025ë…„ 10ì›” 31ì¼ ì „ì²´ êµ¬í˜„ ë‚´ì—­

#### ğŸ—‚ï¸ ìƒì„±/ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡ (ì´ 16ê°œ)

```bash
# ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ (2ê°œ)
âœ… database/schemas/features/subscription/subscription-token-system.sql  # 10ê°œ í…Œì´ë¸” ì •ì˜
âœ… database/scripts/existing-member-benefits.sql                        # ê¸°ì¡´ íšŒì› í˜œíƒ

# ğŸ”Œ ë°±ì—”ë“œ API (9ê°œ)
âœ… api/subscription/pricing-config.js      # GET/PUT ê°€ê²© ì„¤ì • ê´€ë¦¬
âœ… api/subscription/token-config.js        # GET/PUT í† í° í•œë„ ê´€ë¦¬
âœ… api/subscription/token-usage.js         # POST/GET í† í° ì‚¬ìš© ê¸°ë¡/ì¡°íšŒ
âœ… api/subscription/cycle.js               # GET/POST/PUT êµ¬ë… ì£¼ê¸° ê´€ë¦¬
âœ… api/subscription/user-dashboard.js      # GET/POST ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ
âœ… api/subscription/member-benefits.js     # GET/POST ê¸°ì¡´ íšŒì› í˜œíƒ
âœ… api/cron/subscription-renewal.js        # ìë™ ê°±ì‹  í¬ë¡  ì‘ì—…
âœ… api/middleware/token-tracker.js         # í† í° ì¶”ì  ë¯¸ë“¤ì›¨ì–´
âœ… api/payment/payment-handler.js          # ê²°ì œ ì²˜ë¦¬ (í† ìŠ¤í˜ì´ë¨¼ì¸  ì¤€ë¹„)

# ğŸ“ í”„ë¡ íŠ¸ì—”ë“œ (2ê°œ)
âœ… user/subscription-management.html       # ì‚¬ìš©ì êµ¬ë… ê´€ë¦¬ í˜ì´ì§€
âœ… payment.html                            # ê²°ì œ í˜ì´ì§€ UI

# ğŸ”§ ì„œë²„ ì„¤ì • (2ê°œ)
âœ… server.js                               # í¬ë¡  ì‘ì—… + API ë¼ìš°íŒ… ì¶”ê°€
âœ… package.json                            # node-cron ì˜ì¡´ì„± ì¶”ê°€

# ğŸ“š ë¬¸ì„œ (1ê°œ)
âœ… admin/docs/í† í°í”Œë¡œìš°ë°ê²°ì œ.md          # ì´ ë¬¸ì„œ
```

#### âš™ï¸ ê¸°ì¡´ íŒŒì¼ ìˆ˜ì • ë‚´ì—­

```javascript
// ğŸ”„ api/chat.js (ìˆ˜ì •)
+ const { trackTokenUsage, checkTokenLimit, extractUserId } = require('./middleware/token-tracker');
// í† í° ì²´í¬ ë° ì¶”ì  ë¡œì§ ì¶”ê°€

// ğŸ”„ api/chatgpt-blog.js (ìˆ˜ì •)  
+ const { trackTokenUsage, checkTokenLimit, extractUserId } = require('./middleware/token-tracker');
+ async function callOpenAIWithTracking() { /* ë˜í¼ í•¨ìˆ˜ ì¶”ê°€ */ }

// ğŸ”„ api/generate-reply.js (ìˆ˜ì •)
+ import { trackTokenUsage, checkTokenLimit, extractUserId } from './middleware/token-tracker';
// í† í° ì¶”ì  í†µí•©
```

---

## 3. ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

### ğŸ“Š í•µì‹¬ í…Œì´ë¸” 10ê°œ

#### 1ï¸âƒ£ **pricing_config** (ê°€ê²© ì„¤ì •)
```sql
CREATE TABLE pricing_config (
  id uuid PRIMARY KEY,
  owner_seed_price integer DEFAULT 0,        -- ì”¨ì•— (ë¬´ë£Œ)
  owner_power_price integer DEFAULT 30000,   -- íŒŒì›Œ
  owner_bigpower_price integer DEFAULT 50000,-- ë¹…íŒŒì›Œ
  owner_premium_price integer DEFAULT 70000, -- í”„ë¦¬ë¯¸ì—„
  agency_elite_price integer DEFAULT 100000, -- ëŒ€í–‰ì‚¬ ì—˜ë¦¬íŠ¸
  agency_expert_price integer DEFAULT 300000,-- ëŒ€í–‰ì‚¬ ì „ë¬¸ê°€
  agency_master_price integer DEFAULT 500000,-- ëŒ€í–‰ì‚¬ ë§ˆìŠ¤í„°
  agency_premium_price integer DEFAULT 1000000,-- ëŒ€í–‰ì‚¬ í”„ë¦¬ë¯¸ì—„
  created_at timestamp,
  updated_at timestamp
);
```

#### 2ï¸âƒ£ **token_config** (í† í° í•œë„)
```sql
CREATE TABLE token_config (
  id uuid PRIMARY KEY,
  owner_seed_limit integer DEFAULT 100,      -- ì”¨ì•— 100í† í°/ì›”
  owner_power_limit integer DEFAULT 500,     -- íŒŒì›Œ 500í† í°/ì›”
  owner_bigpower_limit integer DEFAULT 833,  -- ë¹…íŒŒì›Œ 833í† í°/ì›”
  owner_premium_limit integer DEFAULT 1166,  -- í”„ë¦¬ë¯¸ì—„ 1166í† í°/ì›”
  agency_elite_limit integer DEFAULT 1000,   -- ëŒ€í–‰ì‚¬ 1000í† í°/ì›”
  agency_expert_limit integer DEFAULT 3000,  -- ëŒ€í–‰ì‚¬ 3000í† í°/ì›”
  agency_master_limit integer DEFAULT 5000,  -- ëŒ€í–‰ì‚¬ 5000í† í°/ì›”
  agency_premium_limit integer DEFAULT 10000,-- ëŒ€í–‰ì‚¬ 10000í† í°/ì›”
  created_at timestamp,
  updated_at timestamp
);
```

#### 3ï¸âƒ£ **subscription_cycle** (êµ¬ë… ì£¼ê¸°)
```sql
CREATE TABLE subscription_cycle (
  id uuid PRIMARY KEY,
  user_id uuid REFERENCES profiles(id),
  user_type text,                     -- 'owner' ë˜ëŠ” 'agency'
  cycle_start_date date,               -- ì‹œì‘ì¼
  cycle_end_date date,                 -- ì¢…ë£Œì¼ (30ì¼ í›„)
  days_in_cycle integer DEFAULT 30,
  monthly_token_limit integer,         -- ì›” í† í° í•œë„
  tokens_used integer DEFAULT 0,       -- ì‚¬ìš©í•œ í† í°
  tokens_remaining integer,            -- ë‚¨ì€ í† í°
  status text DEFAULT 'active',        -- 'active', 'exceeded', 'expired'
  is_exceeded boolean DEFAULT false,   -- í•œë„ ì´ˆê³¼ ì—¬ë¶€
  exceeded_at timestamp,
  billing_amount integer,              -- ì²­êµ¬ ê¸ˆì•¡
  payment_status text,                 -- 'pending', 'completed', 'failed'
  created_at timestamp,
  updated_at timestamp
);
```

#### 4ï¸âƒ£ **token_usage** (í† í° ì‚¬ìš© ê¸°ë¡)
```sql
CREATE TABLE token_usage (
  id uuid PRIMARY KEY,
  user_id uuid REFERENCES profiles(id),
  store_id uuid,                      -- ëŒ€í–‰ì‚¬ ê´€ë¦¬ ì‹ë‹¹
  tokens_used integer,                -- ì‚¬ìš© í† í°
  api_type text,                      -- 'chatgpt', 'claude', 'blog'
  input_tokens integer,               -- ì…ë ¥ í† í°
  output_tokens integer,              -- ì¶œë ¥ í† í°
  used_at timestamp DEFAULT now()
);
```

#### 5ï¸âƒ£ **billing_history** (ì²­êµ¬ ë‚´ì—­)
```sql
CREATE TABLE billing_history (
  id uuid PRIMARY KEY,
  user_id uuid REFERENCES profiles(id),
  user_type text,
  membership_level text,
  billing_period_start date,
  billing_period_end date,
  monthly_limit integer,              -- ì›” í† í° í•œë„
  tokens_used integer,                -- ì‚¬ìš©í•œ í† í°
  is_exceeded boolean,                -- ì´ˆê³¼ ì—¬ë¶€
  base_price integer,                 -- ê¸°ë³¸ ê°€ê²©
  discount_price integer DEFAULT 0,   -- í• ì¸ì•¡
  extra_charge integer DEFAULT 0,     -- ì´ˆê³¼ ìš”ê¸ˆ
  total_price integer,                -- ìµœì¢… ì²­êµ¬ì•¡
  payment_status text,                -- 'pending', 'completed', 'failed'
  leftover_tokens integer,            -- ë‚¨ì€ í† í° (ì†Œë©¸)
  leftover_action text DEFAULT 'expired',
  created_at timestamp
);
```

#### 6ï¸âƒ£ **member_custom_pricing** (ê°œì¸ ë§ì¶¤ ê°€ê²©)
```sql
CREATE TABLE member_custom_pricing (
  id uuid PRIMARY KEY,
  member_id uuid REFERENCES profiles(id),
  custom_price integer,               -- ë§ì¶¤ ê°€ê²© (NULLì´ë©´ ê¸°ë³¸ê°€)
  discount_reason text,               -- í• ì¸/ì¸ìƒ ì‚¬ìœ 
  applied_from date,                  -- ì ìš© ì‹œì‘ì¼
  applied_until date,                 -- ì ìš© ì¢…ë£Œì¼
  created_at timestamp,
  updated_at timestamp
);
```

#### 7ï¸âƒ£ **member_custom_token_limit** (ê°œì¸ ë§ì¶¤ í† í°)
```sql
CREATE TABLE member_custom_token_limit (
  id uuid PRIMARY KEY,
  member_id uuid REFERENCES profiles(id),
  custom_limit integer,               -- ë§ì¶¤ í† í° (NULLì´ë©´ ê¸°ë³¸)
  reason text,                        -- ì‚¬ìœ 
  applied_from date,
  applied_until date,
  created_at timestamp,
  updated_at timestamp
);
```

#### 8ï¸âƒ£ **agency_managed_stores** (ëŒ€í–‰ì‚¬ ê´€ë¦¬ ì‹ë‹¹)
```sql
CREATE TABLE agency_managed_stores (
  id uuid PRIMARY KEY,
  agency_id uuid REFERENCES profiles(id),
  store_name varchar(200),
  store_phone varchar(20),
  store_address text,
  naver_place_url text,
  naver_id text,                      -- ì•”í˜¸í™” ì €ì¥
  naver_password_encrypted text,      -- pgcrypto ì•”í˜¸í™”
  google_id text,
  google_password_encrypted text,
  is_active boolean DEFAULT true,
  created_at timestamp,
  updated_at timestamp
);
```

#### 9ï¸âƒ£ **upgrade_requests** (ì—…ê·¸ë ˆì´ë“œ ìš”ì²­)
```sql
CREATE TABLE upgrade_requests (
  id uuid PRIMARY KEY,
  user_id uuid REFERENCES profiles(id),
  current_membership_level text,
  requested_membership_level text,
  reason text,
  status text DEFAULT 'pending',      -- 'pending', 'approved', 'rejected'
  approved_at timestamp,
  approved_by_admin_id uuid,
  additional_charge integer DEFAULT 0,
  requested_at timestamp DEFAULT now(),
  updated_at timestamp
);
```

#### ğŸ”Ÿ **payment_history** (ê²°ì œ ë‚´ì—­ - ì˜ˆì •)
```sql
CREATE TABLE payment_history (
  id uuid PRIMARY KEY,
  user_id uuid REFERENCES profiles(id),
  order_id text UNIQUE,
  payment_key text,
  amount integer,
  status text,                        -- 'pending', 'done', 'failed', 'canceled'
  method text,                        -- 'card', 'transfer', 'phone'
  requested_at timestamp,
  approved_at timestamp,
  failed_at timestamp,
  failure_reason text,
  receipt_url text,
  created_at timestamp DEFAULT now()
);
```

---

## 4. API ì—”ë“œí¬ì¸íŠ¸

### ğŸ”Œ êµ¬í˜„ëœ API ëª©ë¡

#### ê°€ê²©/í† í° ì„¤ì •
| ë©”ì†Œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|--------|------------|------|
| GET | `/api/subscription/pricing-config` | ê°€ê²© ì¡°íšŒ |
| PUT | `/api/subscription/pricing-config` | ê°€ê²© ìˆ˜ì • |
| GET | `/api/subscription/token-config` | í† í° í•œë„ ì¡°íšŒ |
| PUT | `/api/subscription/token-config` | í† í° í•œë„ ìˆ˜ì • |

#### í† í° ì‚¬ìš©
| ë©”ì†Œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|--------|------------|------|
| POST | `/api/subscription/token-usage` | í† í° ì‚¬ìš© ê¸°ë¡ |
| GET | `/api/subscription/token-usage?user_id=xxx` | ì‚¬ìš© ë‚´ì—­ ì¡°íšŒ |

#### êµ¬ë… ê´€ë¦¬
| ë©”ì†Œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|--------|------------|------|
| GET | `/api/subscription/cycle?user_id=xxx` | êµ¬ë… ì‚¬ì´í´ ì¡°íšŒ |
| POST | `/api/subscription/cycle` | ìƒˆ ì‚¬ì´í´ ìƒì„± |
| PUT | `/api/subscription/cycle?action=renew` | ë§Œë£Œ ê°±ì‹  |

#### ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ
| ë©”ì†Œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|--------|------------|------|
| GET | `/api/subscription/user-dashboard?action=dashboard` | ëŒ€ì‹œë³´ë“œ ë°ì´í„° |
| GET | `/api/subscription/user-dashboard?action=billing` | ì²­êµ¬ ë‚´ì—­ |
| GET | `/api/subscription/user-dashboard?action=usage` | í† í° ì‚¬ìš© ë‚´ì—­ |
| POST | `/api/subscription/user-dashboard` | ì—…ê·¸ë ˆì´ë“œ ìš”ì²­ |

#### í¬ë¡  ì‘ì—…
| ë©”ì†Œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|--------|------------|------|
| GET | `/api/cron/subscription-renewal?action=renew` | ìˆ˜ë™ ê°±ì‹  |
| GET | `/api/cron/subscription-renewal?action=notify` | ê²½ê³  ì•Œë¦¼ |
| GET | `/api/cron/subscription-renewal?action=stats` | í†µê³„ ìˆ˜ì§‘ |

### ğŸ“ API ì‚¬ìš© ì˜ˆì‹œ

#### 1. í† í° ì‚¬ìš© ê¸°ë¡
```javascript
// POST /api/subscription/token-usage
{
  "user_id": "123e4567-e89b-12d3-a456-426614174000",
  "input_tokens": 150,
  "output_tokens": 120,
  "api_type": "chatgpt",
  "total_tokens": 270
}

// ì‘ë‹µ
{
  "success": true,
  "usage": { /* ì‚¬ìš© ê¸°ë¡ */ },
  "remaining": 730,
  "limit": 1000,
  "message": "270 í† í°ì´ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚¨ì€ í† í°: 730"
}
```

#### 2. ëŒ€ì‹œë³´ë“œ ì¡°íšŒ
```javascript
// GET /api/subscription/user-dashboard?action=dashboard
// Headers: Authorization: Bearer xxx

// ì‘ë‹µ
{
  "success": true,
  "data": {
    "profile": {
      "id": "xxx",
      "email": "user@example.com",
      "membership_level": "power"
    },
    "cycle": {
      "monthly_token_limit": 1000,
      "tokens_used": 350,
      "tokens_remaining": 650,
      "days_remaining": 15,
      "usage_rate": 35
    },
    "plans": [ /* í”Œëœ ëª©ë¡ */ ],
    "recentUsage": [ /* ìµœê·¼ ì‚¬ìš© ë‚´ì—­ */ ]
  }
}
```

---

## 5. í† í° ì¶”ì  ì‹œìŠ¤í…œ

### ğŸ” ì¶”ì  ë©”ì»¤ë‹ˆì¦˜

#### 1. **ë¯¸ë“¤ì›¨ì–´ êµ¬ì¡°**

```javascript
// api/middleware/token-tracker.js

// ì‚¬ìš©ì ID ì¶”ì¶œ (ë‹¤ì–‘í•œ ì†ŒìŠ¤)
async function extractUserId(req) {
  // 1. Bodyì—ì„œ
  if (req.body?.userId) return req.body.userId;
  
  // 2. Authorization í—¤ë”ì—ì„œ
  if (req.headers.authorization) {
    const token = req.headers.authorization.substring(7);
    const { data: { user } } = await supabase.auth.getUser(token);
    return user?.id;
  }
  
  // 3. ì¿ í‚¤ì—ì„œ
  if (req.headers.cookie) {
    const match = req.headers.cookie.match(/userId=([^;]+)/);
    return match?.[1];
  }
}

// í† í° ì‚¬ìš©ëŸ‰ ê¸°ë¡
async function trackTokenUsage(userId, usage, apiType) {
  const totalTokens = usage.total_tokens || 
                     (usage.prompt_tokens + usage.completion_tokens);
  
  // API í˜¸ì¶œë¡œ í† í° ì‚¬ìš© ê¸°ë¡
  await fetch('/api/subscription/token-usage', {
    method: 'POST',
    body: JSON.stringify({
      user_id: userId,
      tokens_used: totalTokens,
      api_type: apiType
    })
  });
}
```

#### 2. **API ì—°ë™ í˜„í™©**

âœ… **ì—°ë™ ì™„ë£Œëœ API:**
- `api/chat.js` - ChatGPT ì±„íŒ…
- `api/chatgpt-blog.js` - ë¸”ë¡œê·¸ ìƒì„±
- `api/generate-reply.js` - ë¦¬ë·° ë‹µê¸€

âš ï¸ **ì—°ë™ í•„ìš”í•œ API:**
- `api/ai-news-recommend.js` - ë‰´ìŠ¤ ì¶”ì²œ
- `api/blog-style.js` - ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼

#### 3. **í† í° í•œë„ ì²´í¬**

```javascript
// ì‚¬ìš© ì „ ì²´í¬
const limitCheck = await checkTokenLimit(userId, estimatedTokens);
if (!limitCheck.success) {
  return res.status(403).json({
    error: limitCheck.error,
    remaining: 0
  });
}

// API í˜¸ì¶œ
const response = await openai.chat.completions.create({ /* ... */ });

// ì‚¬ìš© í›„ ê¸°ë¡
await trackTokenUsage(userId, response.usage, 'chatgpt');
```

---

## 6. ìë™í™” ì‹œìŠ¤í…œ

### âš™ï¸ í¬ë¡  ì‘ì—… ì„¤ì •

#### 1. **ë§¤ì¼ ìì • - êµ¬ë… ê°±ì‹ **
```javascript
cron.schedule('0 0 * * *', async () => {
  console.log('ğŸ”„ [CRON] ìì • êµ¬ë… ê°±ì‹  ì‘ì—… ì‹œì‘...');
  await renewExpiredSubscriptions();
  await recordDailyStats();
});
```

#### 2. **ë§¤ì¼ ì˜¤í›„ 6ì‹œ - í† í° ê²½ê³ **
```javascript
cron.schedule('0 18 * * *', async () => {
  console.log('ğŸ“¢ [CRON] í† í° í•œë„ ê²½ê³  ì•Œë¦¼ ì‹œì‘...');
  await notifyTokenExceeded();
});
```

#### 3. **ë§¤ì‹œê°„ - í†µê³„ ì—…ë°ì´íŠ¸**
```javascript
cron.schedule('0 * * * *', async () => {
  console.log('ğŸ“Š [CRON] ì‹œê°„ë³„ í†µê³„ ì—…ë°ì´íŠ¸...');
  await recordDailyStats();
});
```

### ìë™ ê°±ì‹  í”„ë¡œì„¸ìŠ¤

```
1. ë§Œë£Œëœ êµ¬ë… ì¡°íšŒ (cycle_end_date < today)
2. ê¸°ì¡´ ì‚¬ì´í´ ì¢…ë£Œ (status = 'expired')
3. ìƒˆ ì‚¬ì´í´ ìƒì„± (30ì¼ ì£¼ê¸°)
4. í† í° ë¦¬ì…‹ (monthly_token_limit)
5. ì²­êµ¬ ë‚´ì—­ ìƒì„±
6. ë‚¨ì€ í† í° ì†Œë©¸ ì²˜ë¦¬
```

---

## 7. ë³´ì•ˆ ê°œì„  ì‚¬í•­

### ğŸ” êµ¬í˜„ëœ ë³´ì•ˆ ì¡°ì¹˜

#### 1. **ì„œë²„ ì‚¬ì´ë“œ ì²˜ë¦¬**

**Before (ì·¨ì•½):**
```javascript
// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ DB ì¡°íšŒ
const { data } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', userId);
```

**After (ì•ˆì „):**
```javascript
// ì„œë²„ APIë¥¼ í†µí•œ ì¡°íšŒ
const response = await fetch('/api/subscription/user-dashboard', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

#### 2. **JWT í† í° ê²€ì¦**

```javascript
async function authenticateUser(req) {
  const authHeader = req.headers.authorization;
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return null;
  }
  
  const token = authHeader.substring(7);
  const { data: { user }, error } = await supabase.auth.getUser(token);
  
  if (error || !user) {
    return null;
  }
  
  return user;
}
```

#### 3. **ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”**

```sql
-- pgcrypto ì‚¬ìš©
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ì•”í˜¸í™” ì €ì¥
INSERT INTO agency_managed_stores (
  naver_password_encrypted
) VALUES (
  pgp_sym_encrypt('plaintext_password', 'encryption_key')
);

-- ë³µí˜¸í™” ì¡°íšŒ
SELECT 
  pgp_sym_decrypt(naver_password_encrypted, 'encryption_key') as password
FROM agency_managed_stores;
```

---

## 8. ê²°ì œ ì‹œìŠ¤í…œ í˜„í™©

### ğŸ’³ í˜„ì¬ êµ¬í˜„ ìƒíƒœ: 95% ì™„ì„± (PGì‚¬ í‚¤ë§Œ í•„ìš”)

### ğŸ‡°ğŸ‡· í•œêµ­ PGì‚¬ ì¶”ì²œ ë° ë¹„êµ

#### ì£¼ìš” PGì‚¬ ë¹„êµí‘œ

| PGì‚¬ | ìˆ˜ìˆ˜ë£Œ | ì •ì‚°ì£¼ê¸° | íŠ¹ì§• | ì¶”ì²œë„ |
|------|--------|----------|------|--------|
| **í† ìŠ¤í˜ì´ë¨¼ì¸ ** | 2.9% | D+2 | ê°œë°œì ì¹œí™”ì , ë¬¸ì„œ ìµœê³  | â­â­â­â­â­ |
| **ì•„ì„í¬íŠ¸** | 2.5~3.2% | D+2~7 | ë‹¤ì–‘í•œ PG í†µí•©, ê´€ë¦¬ í¸ë¦¬ | â­â­â­â­â­ |
| **NHN KCP** | 2.5~3.5% | D+3~7 | ëŒ€ê¸°ì—… ì„ í˜¸, ì•ˆì •ì„± | â­â­â­â­ |
| **ì´ë‹ˆì‹œìŠ¤** | 2.8~3.5% | D+3~7 | ì‹œì¥ì ìœ ìœ¨ 1ìœ„ | â­â­â­â­ |
| **ë‚˜ì´ìŠ¤í˜ì´** | 2.5~3.3% | D+2~5 | ì¤‘ê²¬ê¸°ì—… ë§ì´ ì‚¬ìš© | â­â­â­ |
| **ë‹¤ë‚ ** | 3.0~4.0% | D+7 | íœ´ëŒ€í° ê²°ì œ ê°•ì  | â­â­â­ |

#### ğŸ† ì‚¬ì¥í”½ í”„ë¡œì íŠ¸ ì¶”ì²œ: í† ìŠ¤í˜ì´ë¨¼ì¸ 

**ì„ ì • ì´ìœ :**
1. **ê°œë°œì ì¹œí™”ì **: ìµœê³  ìˆ˜ì¤€ì˜ API ë¬¸ì„œì™€ SDK
2. **ë¹ ë¥¸ ì •ì‚°**: D+2 (ì´í‹€ í›„ ì…ê¸ˆ)
3. **ê°„í¸í•œ ì—°ë™**: 30ë¶„ ë‚´ êµ¬í˜„ ê°€ëŠ¥
4. **ì •ê¸°ê²°ì œ ìµœì í™”**: êµ¬ë… ëª¨ë¸ì— ì í•©
5. **ì´ë¯¸ êµ¬í˜„ë¨**: payment-handler.jsì— ì½”ë“œ ì™„ì„±

**ìˆ˜ìˆ˜ë£Œ ê³„ì‚° (ì›” 1,000ë§Œì› ë§¤ì¶œ ê¸°ì¤€):**
- í† ìŠ¤í˜ì´ë¨¼ì¸ : 290,000ì› (2.9%)
- ì•„ì„í¬íŠ¸: 250,000ì› (2.5%)
- ì°¨ì´: ì›” 40,000ì›

**í•œêµ­ íŠ¹í™” ê²°ì œ ìˆ˜ë‹¨:**
- ê°„í¸ê²°ì œ: ì¹´ì¹´ì˜¤í˜ì´, ë„¤ì´ë²„í˜ì´, ì‚¼ì„±í˜ì´
- íœ´ëŒ€í° ê²°ì œ: SKT, KT, LGU+
- ê°€ìƒê³„ì¢Œ: ë¬´í†µì¥ì…ê¸ˆ ìë™ í™•ì¸
- í˜„ê¸ˆì˜ìˆ˜ì¦/ì„¸ê¸ˆê³„ì‚°ì„œ ìë™ ë°œê¸‰

#### âœ… ì´ë¯¸ êµ¬í˜„ëœ ê²ƒë“¤

##### 1. **ê²°ì œ í˜ì´ì§€ (payment.html)**
```html
<!-- ì™„ì„±ëœ UI ìš”ì†Œ -->
- í”Œëœ ì„ íƒ (seed/power/bigpower/premium)
- ê²°ì œ ë°©ë²• ì„ íƒ (ì¹´ë“œ/ê³„ì¢Œì´ì²´/íœ´ëŒ€í°)
- ê°€ê²© í‘œì‹œ ë° í† í° ì •ë³´
- ë¡œë”© ì• ë‹ˆë©”ì´ì…˜
- í…ŒìŠ¤íŠ¸ ëª¨ë“œ ìë™ ê²°ì œ

// ì ‘ì† URL
http://localhost:3003/payment.html?plan=power
```

##### 2. **ê²°ì œ ì²˜ë¦¬ API (api/payment/payment-handler.js)**
```javascript
// êµ¬í˜„ëœ ê¸°ëŠ¥ë“¤
âœ… createPayment()     // ê²°ì œ ìš”ì²­ ìƒì„±
âœ… verifyPayment()     // ê²°ì œ ê²€ì¦
âœ… activateSubscription() // êµ¬ë… í™œì„±í™”
âœ… handleWebhook()     // ì›¹í›… ì²˜ë¦¬
âœ… cancelPayment()     // ê²°ì œ ì·¨ì†Œ

// í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì‘ë™ì¤‘
if (!process.env.TOSS_CLIENT_KEY) {
  // ìë™ ìŠ¹ì¸ ëª¨ë“œë¡œ ì‘ë™
  paymentUrl = `/payment/test-success?orderId=${orderId}`;
}
```

##### 3. **ë°ì´í„°ë² ì´ìŠ¤ ì¤€ë¹„ ì™„ë£Œ**
```sql
âœ… payment_history í…Œì´ë¸” ìƒì„±ë¨
âœ… billing_history í…Œì´ë¸” ìƒì„±ë¨
âœ… subscription_cycle í…Œì´ë¸” ìƒì„±ë¨
```

#### ğŸ”§ í† ìŠ¤í˜ì´ë¨¼ì¸  ë¹ ë¥¸ ì‹œì‘ ê°€ì´ë“œ (15ë¶„)

##### Step 1: í† ìŠ¤í˜ì´ë¨¼ì¸  ê°€ì… (3ë¶„)
```bash
1. https://developers.tosspayments.com ì ‘ì†
2. ì‚¬ì—…ì íšŒì›ê°€ì… ë˜ëŠ” ê°œì¸ íšŒì›ê°€ì…
3. ì´ë©”ì¼ ì¸ì¦
4. ëŒ€ì‹œë³´ë“œ â†’ ê°œë°œ ì •ë³´ â†’ API í‚¤
```

##### Step 2: API í‚¤ ë°œê¸‰ ë° .env ì„¤ì • (2ë¶„)
```bash
# í…ŒìŠ¤íŠ¸ í‚¤ (ì¦‰ì‹œ ë°œê¸‰)
TOSS_CLIENT_KEY=test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq
TOSS_SECRET_KEY=test_sk_zXLkKEypNArWmo50nX3lmeaxYG5R
TOSS_WEBHOOK_SECRET=your_webhook_secret_here
BASE_URL=http://localhost:3003  # ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©

# ì‹¤ì œ ìš´ì˜ì‹œ (ì‹¬ì‚¬ í›„ ë°œê¸‰)
# TOSS_CLIENT_KEY=live_ck_xxx
# TOSS_SECRET_KEY=live_sk_xxx  
# BASE_URL=https://sajangpick.com
```

##### Step 3: ì„œë²„ ì¬ì‹œì‘ (1ë¶„)
```bash
# í„°ë¯¸ë„ì—ì„œ
Ctrl + C  # ì„œë²„ ì¤‘ì§€
node server.js  # ì¬ì‹œì‘
```

##### Step 4: í…ŒìŠ¤íŠ¸ ê²°ì œ (10ë¶„)
```bash
# 1. ë¸Œë¼ìš°ì € ì ‘ì†
http://localhost:3003/payment.html?plan=power

# 2. í…ŒìŠ¤íŠ¸ ì¹´ë“œ ì •ë³´
ì¹´ë“œë²ˆí˜¸: 4330-0000-0000-0004
ìœ íš¨ê¸°ê°„: 12/25
CVC: 123
ë¹„ë°€ë²ˆí˜¸: 00

# 3. ê²°ì œ ì™„ë£Œ í™•ì¸
- payment_history í…Œì´ë¸” í™•ì¸
- subscription_cycle í† í° ì¶©ì „ í™•ì¸
```

##### Step 5: ì‹¤ì œ ìš´ì˜ ì „í™˜
```bash
1. í† ìŠ¤í˜ì´ë¨¼ì¸  ëŒ€ì‹œë³´ë“œ â†’ ì‹¬ì‚¬ ì‹ ì²­
2. ì‚¬ì—…ìë“±ë¡ì¦ ì œì¶œ
3. ì‹¬ì‚¬ ìŠ¹ì¸ (1-2ì¼)
4. ë¼ì´ë¸Œ í‚¤ ë°œê¸‰
5. .env íŒŒì¼ ë¼ì´ë¸Œ í‚¤ë¡œ êµì²´
6. ë°°í¬ í™˜ê²½ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
```

#### ğŸ“ PGì‚¬ ê³ ê°ì„¼í„°
```
í† ìŠ¤í˜ì´ë¨¼ì¸ : 1599-9070 (í‰ì¼ 09:00-18:00)
ì•„ì„í¬íŠ¸: 1670-5176
KCP: 1544-8667
ì´ë‹ˆì‹œìŠ¤: 1588-4954
```

#### ğŸ¯ ê²°ì œ í”Œë¡œìš° (í˜„ì¬ ì‘ë™)

```mermaid
ì‚¬ìš©ì í† í° ì†Œì§„
    â†“
"í† í°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤" ì•Œë¦¼
    â†“
ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ í´ë¦­
    â†“
/payment.html?plan=power
    â†“
[í…ŒìŠ¤íŠ¸ ëª¨ë“œ] ìë™ ìŠ¹ì¸ / [ì‹¤ì œ] í† ìŠ¤í˜ì´ë¨¼ì¸ 
    â†“
payment_history ê¸°ë¡
    â†“
subscription_cycle ìƒì„±
    â†“
í† í° 500ê°œ ì¶©ì „
    â†“
ì„œë¹„ìŠ¤ ê³„ì† ì‚¬ìš©
```

---

## 9. í…ŒìŠ¤íŠ¸ ë°©ë²•

### ğŸ§ª ë¡œì»¬ í…ŒìŠ¤íŠ¸

#### 1. **í™˜ê²½ ì„¤ì •**
```bash
# 1. íŒ¨í‚¤ì§€ ì„¤ì¹˜
pnpm install

# 2. í™˜ê²½ë³€ìˆ˜ ì„¤ì •
cp .env.example .env
# .env íŒŒì¼ í¸ì§‘

# 3. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
# Supabaseì—ì„œ SQL ì‹¤í–‰
```

#### 2. **API í…ŒìŠ¤íŠ¸**

```bash
# ê°€ê²© ì¡°íšŒ
curl http://localhost:5000/api/subscription/pricing-config

# í† í° ì‚¬ìš© ê¸°ë¡
curl -X POST http://localhost:5000/api/subscription/token-usage \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test-user-id",
    "tokens_used": 100,
    "api_type": "chatgpt"
  }'

# êµ¬ë… ê°±ì‹  (ìˆ˜ë™)
curl http://localhost:5000/api/cron/subscription-renewal?action=renew
```

#### 3. **ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸**

**ì‹œë‚˜ë¦¬ì˜¤ 1: ì‹ ê·œ ê°€ì…**
```
1. íšŒì›ê°€ì…
2. ì”¨ì•— ë“±ê¸‰ ìë™ ë¶€ì—¬ í™•ì¸
3. 100 í† í° í• ë‹¹ í™•ì¸
4. AI ê¸°ëŠ¥ ì‚¬ìš©
5. í† í° ì°¨ê° í™•ì¸
```

**ì‹œë‚˜ë¦¬ì˜¤ 2: í† í° ì´ˆê³¼**
```
1. í† í° 95% ì‚¬ìš©
2. AI ê¸°ëŠ¥ ì‹œë„
3. "í† í° ë¶€ì¡±" ì—ëŸ¬ í™•ì¸
4. ì—…ê·¸ë ˆì´ë“œ ìš”ì²­
5. ê´€ë¦¬ì ìŠ¹ì¸
6. í† í° ì¦ê°€ í™•ì¸
```

**ì‹œë‚˜ë¦¬ì˜¤ 3: ì›” ê°±ì‹ **
```
1. cycle_end_date ìˆ˜ë™ ë³€ê²½ (ê³¼ê±° ë‚ ì§œë¡œ)
2. ê°±ì‹  API í˜¸ì¶œ
3. ìƒˆ ì‚¬ì´í´ ìƒì„± í™•ì¸
4. í† í° ë¦¬ì…‹ í™•ì¸
5. ì²­êµ¬ ë‚´ì—­ ìƒì„± í™•ì¸
```

---

## 10. ë¬¸ì œ í•´ê²° ê°€ì´ë“œ

### âŒ ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œ

#### 1. **"í† í° ì¶”ì ì´ ì•ˆ ë©ë‹ˆë‹¤"**

**ì›ì¸**: userIdê°€ ì „ë‹¬ë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
```javascript
// ìš”ì²­ì— userId í¬í•¨
const response = await fetch('/api/chatgpt-blog', {
  method: 'POST',
  body: JSON.stringify({
    userId: currentUser.id,  // í•„ìˆ˜!
    // ... ê¸°íƒ€ ë°ì´í„°
  })
});
```

#### 2. **"êµ¬ë… ì‚¬ì´í´ì´ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤"**

**ì›ì¸**: profiles í…Œì´ë¸”ì— membership_level ì—†ìŒ

**í•´ê²°**:
```sql
-- ê¸°ë³¸ê°’ ì„¤ì •
UPDATE profiles 
SET membership_level = 'seed',
    user_type = 'owner'
WHERE membership_level IS NULL;
```

#### 3. **"node-cronì´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"**

**ì›ì¸**: íŒ¨í‚¤ì§€ ë¯¸ì„¤ì¹˜

**í•´ê²°**:
```bash
pnpm add node-cron
# ì„œë²„ ì¬ì‹œì‘
node server.js
```

#### 4. **"API í˜¸ì¶œ ì‹œ 403 ì—ëŸ¬"**

**ì›ì¸**: í† í° í•œë„ ì´ˆê³¼

**í•´ê²°**:
```sql
-- í† í° ë¦¬ì…‹ (ì„ì‹œ)
UPDATE subscription_cycle
SET tokens_used = 0,
    tokens_remaining = monthly_token_limit,
    is_exceeded = false
WHERE user_id = 'xxx';
```

#### 5. **"ê²°ì œê°€ ì•ˆ ë©ë‹ˆë‹¤"**

**ìƒíƒœ**: ì•„ì§ ë¯¸êµ¬í˜„

**ê³„íš**: 
- í† ìŠ¤í˜ì´ë¨¼ì¸  ì—°ë™ ì˜ˆì •
- ì˜ˆìƒ êµ¬í˜„ ê¸°ê°„: 2ì£¼
- ë¬¸ì„œ: `/docs/PAYMENT_INTEGRATION_GUIDE.md`

---

## 11. ê¸°ì¡´ íšŒì› ì²˜ë¦¬

### ğŸ‘¥ í˜„ì¬ ê¸°ì¡´ íšŒì› ìƒíƒœ

```sql
-- ì´ë¯¸ ì‹¤í–‰ëœ SQL (ìë™ ì²˜ë¦¬ë¨)
UPDATE profiles SET membership_level = 'seed' WHERE membership_level IS NULL;
UPDATE profiles SET user_type = 'owner' WHERE user_type IS NULL;
-- ê²°ê³¼: ëª¨ë“  ê¸°ì¡´ íšŒì› = seed ë“±ê¸‰ (ë¬´ë£Œ 100í† í°)
```

### ğŸ ê¸°ì¡´ íšŒì› í˜œíƒ API

#### API íŒŒì¼: `api/subscription/member-benefits.js`

```javascript
// ê¸°ì¡´ íšŒì› ìƒíƒœ ì¡°íšŒ
GET /api/subscription/member-benefits

// í˜œíƒ ì ìš© (ê´€ë¦¬ìë§Œ)
POST /api/subscription/member-benefits
{
  "action": "applyBonusTokens",  // ë˜ëŠ” "applyFreeUpgrade", "applyDiscount"
  "targetGroup": "1month",        // "1month", "3months", "all"
  "customBenefit": {
    "bonusTokens": 500,
    "duration": 30
  }
}
```

### ğŸ’¡ ì¶”ì²œ ì‹œë‚˜ë¦¬ì˜¤

```javascript
// ì‹œë‚˜ë¦¬ì˜¤ 1: 1ê°œì›” ì´ìƒ íšŒì›ì—ê²Œ ë³´ë„ˆìŠ¤ í† í°
POST /api/subscription/member-benefits
{
  "action": "applyBonusTokens",
  "targetGroup": "1month",
  "customBenefit": { "bonusTokens": 200 }
}

// ì‹œë‚˜ë¦¬ì˜¤ 2: 3ê°œì›” ì´ìƒ íšŒì› ë¬´ë£Œ ì—…ê·¸ë ˆì´ë“œ
POST /api/subscription/member-benefits
{
  "action": "applyFreeUpgrade",
  "targetGroup": "3months",
  "customBenefit": { "upgradeTo": "power", "duration": 30 }
}

// ì‹œë‚˜ë¦¬ì˜¤ 3: ì „ì²´ íšŒì› 50% í• ì¸
POST /api/subscription/member-benefits
{
  "action": "applyDiscount",
  "targetGroup": "all",
  "customBenefit": { "discountPercent": 50 }
}
```

---

## 12. ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥ ëª…ë ¹ì–´

### ğŸš€ ë³µì‚¬í•´ì„œ ë°”ë¡œ ì“°ëŠ” ëª…ë ¹ì–´ ëª¨ìŒ

#### 1ï¸âƒ£ ì„œë²„ ê´€ë¦¬
```bash
# ì„œë²„ ìƒíƒœ í™•ì¸
curl http://localhost:3003/health

# ì„œë²„ ì¬ì‹œì‘ (Windows)
cmd //c "taskkill /F /IM node.exe"
node server.js

# ì„œë²„ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
nohup node server.js > server.log 2>&1 &
```

#### 2ï¸âƒ£ í† í° ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
```bash
# ê°€ê²© ì„¤ì • ì¡°íšŒ
curl http://localhost:3003/api/subscription/pricing-config

# í† í° í•œë„ ì¡°íšŒ  
curl http://localhost:3003/api/subscription/token-config

# í† í° ì‚¬ìš© í…ŒìŠ¤íŠ¸ (userId ë³€ê²½ í•„ìš”)
curl -X POST http://localhost:3003/api/subscription/token-usage \
  -H "Content-Type: application/json" \
  -d '{"user_id":"a3e8f5c7-8b2d-4f6e-9c1a-3d5e7f9a1b3c","tokens_used":50,"api_type":"chatgpt"}'

# êµ¬ë… ê°±ì‹  (ìˆ˜ë™ ì‹¤í–‰)
curl http://localhost:3003/api/cron/subscription-renewal?action=renew
```

#### 3ï¸âƒ£ ê²°ì œ í…ŒìŠ¤íŠ¸
```bash
# ê²°ì œ í˜ì´ì§€ ì—´ê¸° (ë¸Œë¼ìš°ì €)
start http://localhost:3003/payment.html?plan=power

# ê²°ì œ API í…ŒìŠ¤íŠ¸
curl -X POST http://localhost:3003/api/payment/payment-handler \
  -H "Content-Type: application/json" \
  -d '{"action":"create-payment","userId":"test-user","planType":"power","paymentMethod":"card"}'
```

#### 4ï¸âƒ£ ë°ì´í„°ë² ì´ìŠ¤ ì§ì ‘ ì¡°ì‘
```bash
# Supabase CRUD API ì‚¬ìš©
curl -X POST http://localhost:3003/api/supabase-crud \
  -H "Content-Type: application/json" \
  -d '{"action":"select","table":"profiles","select":"id,email,membership_level","limit":5}'

# íŠ¹ì • ìœ ì € í† í° ë¦¬ì…‹
curl -X POST http://localhost:3003/api/supabase-crud \
  -H "Content-Type: application/json" \
  -d '{"action":"update","table":"subscription_cycle","update":{"tokens_used":0,"tokens_remaining":500},"match":{"user_id":"USER_ID_HERE"}}'
```

#### 5ï¸âƒ£ ê¸´ê¸‰ ë³µêµ¬ ëª…ë ¹ì–´
```sql
-- Supabase SQL Editorì—ì„œ ì‹¤í–‰

-- ëª¨ë“  ì‚¬ìš©ì í† í° ë¦¬ì…‹
UPDATE subscription_cycle 
SET tokens_used = 0, 
    tokens_remaining = monthly_token_limit,
    is_exceeded = false
WHERE status = 'active';

-- íŠ¹ì • ì‚¬ìš©ì ë¬´ì œí•œ í† í°
INSERT INTO member_custom_token_limit (member_id, custom_limit, reason)
VALUES ('USER_ID', 999999, 'í…ŒìŠ¤íŠ¸ìš© ë¬´ì œí•œ');

-- ì‹œìŠ¤í…œ ì „ì²´ ì¼ì‹œ ì¤‘ì§€
UPDATE subscription_cycle SET status = 'paused';

-- ì‹œìŠ¤í…œ ì¬ê°œ
UPDATE subscription_cycle SET status = 'active' WHERE status = 'paused';
```

#### 6ï¸âƒ£ ëª¨ë‹ˆí„°ë§ ëª…ë ¹ì–´
```bash
# í™œì„± ì‚¬ìš©ì ìˆ˜
curl http://localhost:3003/api/supabase-crud \
  -H "Content-Type: application/json" \
  -d '{"action":"count","table":"subscription_cycle","match":{"status":"active"}}'

# ì˜¤ëŠ˜ í† í° ì‚¬ìš©ëŸ‰
curl http://localhost:3003/api/supabase-crud \
  -H "Content-Type: application/json" \
  -d '{"action":"select","table":"token_usage","select":"SUM(tokens_used)","filter":{"used_at":{"gte":"2025-10-31T00:00:00"}}}'

# ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸
tail -f server.log | grep -E "í† í°|ê²°ì œ|ERROR"
```

---

## ğŸ“Š ëª¨ë‹ˆí„°ë§

### ì‹¤ì‹œê°„ í™•ì¸ ì¿¼ë¦¬

#### 1. **í˜„ì¬ í™œì„± ì‚¬ìš©ì**
```sql
SELECT 
  COUNT(*) as active_users,
  SUM(tokens_used) as total_tokens_used,
  AVG(tokens_used) as avg_tokens_per_user
FROM subscription_cycle
WHERE status = 'active';
```

#### 2. **ì˜¤ëŠ˜ í† í° ì‚¬ìš©ëŸ‰**
```sql
SELECT 
  COUNT(DISTINCT user_id) as unique_users,
  SUM(tokens_used) as total_tokens,
  api_type,
  COUNT(*) as api_calls
FROM token_usage
WHERE DATE(used_at) = CURRENT_DATE
GROUP BY api_type;
```

#### 3. **í•œë„ ì´ˆê³¼ ì‚¬ìš©ì**
```sql
SELECT 
  u.email,
  s.tokens_used,
  s.monthly_token_limit,
  ROUND((s.tokens_used::numeric / s.monthly_token_limit) * 100, 2) as usage_rate
FROM subscription_cycle s
JOIN profiles u ON s.user_id = u.id
WHERE s.is_exceeded = true
ORDER BY s.exceeded_at DESC;
```

#### 4. **ì›” ë§¤ì¶œ ì˜ˆìƒ**
```sql
SELECT 
  membership_level,
  COUNT(*) as user_count,
  SUM(billing_amount) as monthly_revenue
FROM subscription_cycle
WHERE status = 'active'
GROUP BY membership_level;
```

---

## ğŸš€ í–¥í›„ ê³„íš

### ë‹¨ê¸° (1-2ì£¼)
- [ ] ê²°ì œ ì‹œìŠ¤í…œ ì—°ë™ (í† ìŠ¤í˜ì´ë¨¼ì¸ )
- [ ] ì´ë©”ì¼ ì•Œë¦¼ ì‹œìŠ¤í…œ
- [ ] ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ê°•í™”
- [ ] í† í° ì‚¬ìš© ê·¸ë˜í”„

### ì¤‘ê¸° (1ê°œì›”)
- [ ] ì¿ í°/í”„ë¡œëª¨ì…˜ ì‹œìŠ¤í…œ
- [ ] í† í° ì„ ë¬¼í•˜ê¸°
- [ ] ë ˆí¼ëŸ´ í”„ë¡œê·¸ë¨
- [ ] ì‚¬ìš©ëŸ‰ ì˜ˆì¸¡ AI

### ì¥ê¸° (3ê°œì›”)
- [ ] ê¸°ì—… ê³„ì • ì§€ì›
- [ ] API ì™¸ë¶€ íŒë§¤
- [ ] í† í° ê±°ë˜ì†Œ
- [ ] ë¸”ë¡ì²´ì¸ ì—°ë™

---

## ğŸ“ ì§€ì›

### ê¸°ìˆ  ë¬¸ì˜
- ì´ë©”ì¼: admin@bosikpick.com
- ë¬¸ì„œ ìœ„ì¹˜: `/admin/docs/í† í°í”Œë¡œìš°ë°ê²°ì œ.md`
- ê´€ë ¨ íŒŒì¼: `/database/schemas/features/subscription/`

### ê¸´ê¸‰ ëŒ€ì‘
```bash
# í† í° ì‹œìŠ¤í…œ ì „ì²´ ë¦¬ì…‹ (ìœ„í—˜!)
UPDATE subscription_cycle SET tokens_used = 0;

# íŠ¹ì • ì‚¬ìš©ì í† í° ì¶©ì „
UPDATE subscription_cycle 
SET tokens_remaining = 1000 
WHERE user_id = 'xxx';

# ì‹œìŠ¤í…œ ì „ì²´ ì¤‘ì§€
UPDATE subscription_cycle 
SET status = 'paused';
```

---

## ğŸ“ ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë²„ì „ | ë‚´ìš© | ì‘ì—…ì |
|------|------|------|--------|
| 2025-10-31 | 1.0 | ìµœì´ˆ êµ¬í˜„ ì™„ë£Œ | AI Assistant |
| 2025-10-31 | 1.1 | ë¬¸ì„œ ì‘ì„± | AI Assistant |
| 2025-10-31 | 2.0 | ìƒˆ AIìš© ê°€ì´ë“œ ì¶”ê°€, ì¦‰ì‹œ ì‹¤í–‰ ëª…ë ¹ì–´ | AI Assistant |
| 2025-10-31 | 2.1 | í•œêµ­ PGì‚¬ ë¹„êµ ë° í† ìŠ¤í˜ì´ë¨¼ì¸  ê°€ì´ë“œ ì¶”ê°€ | AI Assistant |

---

## ğŸ“ ìƒˆ AIê°€ ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•  í•µì‹¬ ì •ë³´

### âš¡ ì‹œì‘ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

```bash
âœ… ì„œë²„ ì‹¤í–‰ ì¤‘? â†’ curl http://localhost:3003/health
âœ… í¬íŠ¸ ë²ˆí˜¸? â†’ 3003 (.env íŒŒì¼ í™•ì¸)
âœ… node-cron ì„¤ì¹˜? â†’ pnpm list node-cron
âœ… DB í…Œì´ë¸” ìƒì„±? â†’ Supabaseì—ì„œ í™•ì¸
âœ… ê¸°ì¡´ íšŒì› ì²˜ë¦¬? â†’ ìë™ìœ¼ë¡œ seed ë“±ê¸‰ ë¶€ì—¬ë¨
```

### ğŸ”´ ì ˆëŒ€ í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒë“¤

```javascript
// âŒ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ DB ì¡°íšŒ (ë³´ì•ˆ ìœ„í—˜)
const { data } = await supabase.from('profiles').select('*');

// âœ… ì„œë²„ APIë¥¼ í†µí•´ì„œë§Œ
const response = await fetch('/api/subscription/user-dashboard');

// âŒ vercel.jsonì˜ rewrites ì œê±° (ì‚¬ì´íŠ¸ ì¤‘ë‹¨)
// âŒ Render ì„œë²„ ì¢…ë£Œ (API ì „ì²´ ì‹¤íŒ¨)
// âŒ "Vercel Functionsë¡œ í†µí•©" (ì´ë¯¸ ì‹¤íŒ¨í•œ ë°©ë²•)
```

### ğŸŸ¢ ìì£¼ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ userId

```javascript
// í…ŒìŠ¤íŠ¸ìš© userId (ì‹¤ì œ DBì— ìˆì–´ì•¼ í•¨)
const testUserId = "a3e8f5c7-8b2d-4f6e-9c1a-3d5e7f9a1b3c";

// ì‚¬ìš© ì˜ˆì‹œ
POST /api/subscription/token-usage
{
  "user_id": "a3e8f5c7-8b2d-4f6e-9c1a-3d5e7f9a1b3c",
  "tokens_used": 100,
  "api_type": "chatgpt"
}
```

### ğŸ“ ì‘ì—… ì‹œ ì£¼ì˜ì‚¬í•­

1. **í† í° ì¶”ì  ì•ˆ ë  ë•Œ**
   - userIdê°€ ìš”ì²­ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
   - Authorization í—¤ë” í™•ì¸
   - extractUserId í•¨ìˆ˜ ë””ë²„ê¹…

2. **í¬ë¡  ì‘ì—… ì•ˆ ë  ë•Œ**
   - node-cron ì„¤ì¹˜ í™•ì¸: `pnpm add node-cron`
   - server.jsì—ì„œ í¬ë¡  ìŠ¤ì¼€ì¤„ í™•ì¸
   - ë¡œê·¸ í™•ì¸: `grep "CRON" server.log`

3. **ê²°ì œ í…ŒìŠ¤íŠ¸ ì‹œ**
   - ë¨¼ì € í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ í™•ì¸
   - TOSS_CLIENT_KEY ì—†ìœ¼ë©´ ìë™ ìŠ¹ì¸ ëª¨ë“œ
   - payment.html?plan=powerë¡œ í…ŒìŠ¤íŠ¸

4. **DB ìˆ˜ì • ì‹œ**
   - í•­ìƒ Supabase SQL Editor ì‚¬ìš©
   - RLS ì •ì±… í™•ì¸ í•„ìˆ˜
   - profiles í…Œì´ë¸”ì´ usersê°€ ì•„ë‹˜ ì£¼ì˜!

### ğŸ”§ ë””ë²„ê¹… íŒ

```javascript
// í† í° ì‚¬ìš©ëŸ‰ í™•ì¸
console.log('[TOKEN] User:', userId, 'Used:', tokens, 'Remaining:', remaining);

// API í˜¸ì¶œ ì¶”ì 
console.log(`[API] ${req.method} ${req.url} - User: ${userId}`);

// í¬ë¡  ì‘ì—… ë¡œê·¸
console.log(`ğŸ”„ [CRON] ${new Date().toISOString()} - Task: ${taskName}`);

// ê²°ì œ í”„ë¡œì„¸ìŠ¤
console.log(`ğŸ’³ [PAYMENT] Order: ${orderId} Status: ${status}`);
```

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025ë…„ 10ì›” 31ì¼ 21:00 âœ…

**ì‘ì„±ì**: AI Assistant  
**ìƒíƒœ**: ì™„ì„± - ìƒˆ AI ì¦‰ì‹œ ì‘ì—… ê°€ëŠ¥  
**ë²„ì „**: 2.1 - í•œêµ­ PGì‚¬ ê°€ì´ë“œ ì¶”ê°€  
**ë‹¤ìŒ ì‘ì—…**: í† ìŠ¤í˜ì´ë¨¼ì¸  ê°€ì… í›„ API í‚¤ ì„¤ì •

---

## ë¶€ë¡: ë¹ ë¥¸ ì°¸ì¡°

### ğŸ”‘ ì¤‘ìš” íŒŒì¼ ìœ„ì¹˜

```
/api/subscription/           # êµ¬ë… API
  â”œâ”€â”€ pricing-config.js     # ê°€ê²© ì„¤ì •
  â”œâ”€â”€ token-config.js       # í† í° í•œë„
  â”œâ”€â”€ token-usage.js        # ì‚¬ìš© ê¸°ë¡
  â”œâ”€â”€ cycle.js              # ì£¼ê¸° ê´€ë¦¬
  â””â”€â”€ user-dashboard.js     # ëŒ€ì‹œë³´ë“œ

/api/middleware/
  â””â”€â”€ token-tracker.js      # í† í° ì¶”ì 

/api/cron/
  â””â”€â”€ subscription-renewal.js # ìë™ ê°±ì‹ 

/database/schemas/features/subscription/
  â””â”€â”€ subscription-token-system.sql # DB ìŠ¤í‚¤ë§ˆ

/docs/
  â”œâ”€â”€ SUBSCRIPTION_SYSTEM_GUIDE.md
  â”œâ”€â”€ SUBSCRIPTION_DEPLOYMENT_GUIDE.md
  â””â”€â”€ PAYMENT_INTEGRATION_GUIDE.md

/admin/docs/
  â””â”€â”€ í† í°í”Œë¡œìš°ë°ê²°ì œ.md   # ì´ ë¬¸ì„œ
```

### ğŸ¯ ë¹ ë¥¸ ëª…ë ¹ì–´

```bash
# ì„œë²„ ì‹œì‘
pnpm run dev

# íŒ¨í‚¤ì§€ ì„¤ì¹˜
pnpm install

# DB ì´ˆê¸°í™”
# Supabase SQL Editorì—ì„œ ì‹¤í–‰

# ë¡œê·¸ í™•ì¸
tail -f logs/server.log

# í”„ë¡œì„¸ìŠ¤ í™•ì¸
ps aux | grep node

# í¬íŠ¸ í™•ì¸
netstat -tlnp | grep 5000
```

---

## ğŸ‰ ì™„ì„± ìƒíƒœ ìš”ì•½

### âœ… 100% êµ¬í˜„ ì™„ë£Œ
- í† í° ì¶”ì  ì‹œìŠ¤í…œ
- êµ¬ë… ê´€ë¦¬ ì‹œìŠ¤í…œ
- ìë™ ê°±ì‹  (í¬ë¡ )
- ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ
- ê´€ë¦¬ì ì„¤ì •
- ë³´ì•ˆ ì²˜ë¦¬

### â³ 95% êµ¬í˜„ (PGì‚¬ í‚¤ë§Œ í•„ìš”)
- ê²°ì œ ì‹œìŠ¤í…œ
- ê²°ì œ í˜ì´ì§€ UI
- ê²°ì œ ì²˜ë¦¬ API
- ì›¹í›… ì²˜ë¦¬

### ğŸ“ ë¬¸ì˜ ì‚¬í•­
- ê¸°ìˆ  ì§€ì›: admin@sajangpick.com
- ê¸´ê¸‰ ì—°ë½: ì‹œìŠ¤í…œ ê´€ë¦¬ì
- ë¬¸ì„œ ìœ„ì¹˜: `/admin/docs/í† í°í”Œë¡œìš°ë°ê²°ì œ.md`

---

**í† í°í”Œë¡œìš° ì‹œìŠ¤í…œ - êµ¬í˜„ ì™„ë£Œ** ğŸš€

**ë‹¤ìŒ AIì—ê²Œ**: ì´ ë¬¸ì„œë¥¼ ë¨¼ì € ì½ê³  ì‘ì—…í•˜ì„¸ìš”. ëª¨ë“  í•„ìš”í•œ ì •ë³´ê°€ ì—¬ê¸° ìˆìŠµë‹ˆë‹¤.

---
