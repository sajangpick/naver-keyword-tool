# 리뷰 모니터링 시스템 - 개발 가이드 (AI용)

> 🤖 **AI 개발자를 위한 완전 가이드**: 크롤링 + 알림톡 통합 개발

---

## 🎯 목표

**현재 상태**: 시스템 구조는 완성, 더미 데이터로 작동 중  
**개발 목표**: 실제 네이버 플레이스 크롤링 + 카카오 알림톡 발송 구현

---

## 📋 현재 상태 체크

### ✅ 이미 완료된 것
- DB 스키마 (테이블 3개: `review_monitoring`, `review_alerts`, `review_crawl_logs`)
- API 엔드포인트 (`api/review-monitoring.js`)
- 마이페이지 UI (`mypage.html`)
- 어드민 대시보드 (`admin/review-monitoring.html`)
- Vercel Cron (매일 3회 자동 실행)
- 시스템 플로우 (전체 구조)

### ⏳ 개발 필요 (이 가이드에서 다룸)
1. **크롤링**: `api/review-monitoring.js` 51-87줄 → 실제 Puppeteer 크롤링
2. **알림톡**: `api/kakao-alimtalk.js` → 3개 함수 구현

---

## 🔥 개발 우선순위

```
높음: 1. 크롤링 구현 (4-6시간) ⭐⭐⭐⭐⭐
높음: 2. 알림톡 구현 (3-4시간) ⭐⭐⭐⭐☆
```

**권장 순서**: 크롤링 → 알림톡 (크롤링이 선행되어야 알림 발송 가능)

---

# Part 1: 네이버 플레이스 크롤링 구현

## 📌 작업 개요

**파일**: `api/review-monitoring.js`  
**위치**: 51-87줄 (`crawlPlaceReviews` 함수)  
**현재**: 더미 리뷰 2개 반환  
**목표**: Puppeteer로 실제 네이버 플레이스 크롤링

---

## Step 1: Puppeteer 설치

```bash
pnpm add puppeteer
```

---

## Step 2: Puppeteer 설정 파일 생성

**새 파일 생성**: `api/utils/puppeteer-setup.js`

```javascript
const puppeteer = require('puppeteer');

/**
 * Puppeteer 브라우저 인스턴스 생성
 */
async function createBrowser() {
  const browser = await puppeteer.launch({
    headless: true,
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-dev-shm-usage',
      '--disable-accelerated-2d-canvas',
      '--disable-gpu',
      '--window-size=1920x1080'
    ]
  });
  
  return browser;
}

/**
 * 페이지 기본 설정
 */
async function setupPage(page) {
  // User Agent 설정 (봇 감지 회피)
  await page.setUserAgent(
    'Mozilla/5.0 (iPhone; CPU iPhone OS 14_7_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.1.2 Mobile/15E148 Safari/604.1'
  );
  
  // 타임아웃 설정
  await page.setDefaultTimeout(30000);
  
  // 뷰포트 설정 (모바일)
  await page.setViewport({ width: 375, height: 667 });
  
  return page;
}

module.exports = {
  createBrowser,
  setupPage
};
```

---

## Step 3: 크롤링 함수 구현

**파일 수정**: `api/review-monitoring.js` (51-87줄)

**기존 코드 삭제 후 아래로 교체:**

```javascript
const { createBrowser, setupPage } = require('./utils/puppeteer-setup');

/**
 * 네이버 플레이스 리뷰 크롤링
 */
async function crawlPlaceReviews(placeUrl) {
  let browser = null;
  
  try {
    console.log('[크롤링 시작]', placeUrl);
    
    // 플레이스 ID 추출
    const placeId = extractPlaceId(placeUrl);
    if (!placeId) {
      throw new Error('유효하지 않은 플레이스 URL');
    }
    
    // 브라우저 실행
    browser = await createBrowser();
    const page = await browser.newPage();
    await setupPage(page);
    
    // 방문자 리뷰 수집
    const visitorReviews = await crawlVisitorReviews(page, placeId);
    
    const allReviews = [...visitorReviews];
    
    console.log(`[크롤링 완료] 총 ${allReviews.length}개 리뷰`);
    
    return {
      success: true,
      reviews: allReviews,
      total: allReviews.length
    };
    
  } catch (error) {
    console.error('[크롤링 실패]', error);
    return {
      success: false,
      error: error.message,
      reviews: []
    };
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

/**
 * 방문자 리뷰 크롤링
 */
async function crawlVisitorReviews(page, placeId) {
  try {
    const url = `https://m.place.naver.com/restaurant/${placeId}/review/visitor`;
    console.log('[방문자 리뷰 크롤링]', url);
    
    await page.goto(url, { waitUntil: 'networkidle2' });
    await page.waitForTimeout(2000);
    
    // 리뷰 리스트 파싱
    const reviews = await page.evaluate(() => {
      const reviewElements = document.querySelectorAll('.list_review > li');
      const results = [];
      
      reviewElements.forEach((el, index) => {
        try {
          // 평점 추출
          const stars = el.querySelectorAll('.star_score .star_fill');
          const rating = stars.length;
          
          // 리뷰 내용 추출
          const contentEl = el.querySelector('.review_text');
          const content = contentEl ? contentEl.textContent.trim() : '';
          
          // 작성자명 추출
          const authorEl = el.querySelector('.reviewer_info .reviewer_name');
          const reviewer_name = authorEl ? authorEl.textContent.trim() : '익명';
          
          // 작성 시간 추출
          const timeEl = el.querySelector('.review_time');
          const timeText = timeEl ? timeEl.textContent.trim() : '';
          
          // 고유 ID 생성
          const external_id = `visitor_${Date.now()}_${index}`;
          
          if (content) {
            results.push({
              type: 'visitor',
              external_id,
              rating,
              content,
              reviewer_name,
              reviewed_at: new Date().toISOString()
            });
          }
        } catch (err) {
          console.error('리뷰 파싱 오류:', err);
        }
      });
      
      return results;
    });
    
    console.log(`[방문자 리뷰] ${reviews.length}개 수집`);
    return reviews;
    
  } catch (error) {
    console.error('[방문자 리뷰 크롤링 실패]', error);
    return [];
  }
}
```

**⚠️ 중요**: `extractPlaceId` 함수는 이미 존재함 (수정 불필요)

---

## Step 4: 로컬 테스트

**테스트 파일 생성**: `test-crawling.js` (프로젝트 루트)

```javascript
const { crawlPlaceReviews } = require('./api/review-monitoring');

async function test() {
  // 실제 플레이스 URL로 변경하세요
  const testUrl = 'https://m.place.naver.com/restaurant/1234567890';
  
  console.log('🧪 크롤링 테스트 시작...\n');
  
  const result = await crawlPlaceReviews(testUrl);
  
  console.log('\n📊 결과:');
  console.log('성공:', result.success);
  console.log('총 리뷰:', result.total);
  console.log('\n리뷰 목록:');
  result.reviews.forEach((review, i) => {
    console.log(`\n${i + 1}. [${review.rating}점] ${review.reviewer_name}`);
    console.log(`   ${review.content.substring(0, 50)}...`);
  });
}

test().catch(console.error);
```

**실행:**
```bash
node test-crawling.js
```

---

## Step 5: Render 환경 설정

**Render.com Dashboard → Environment Variables 추가:**

```env
PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=false
PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable
```

---

## Step 6: Git 커밋

```bash
git add api/utils/puppeteer-setup.js api/review-monitoring.js test-crawling.js
git commit -m "feat: 네이버 플레이스 실제 크롤링 구현

- Puppeteer 설치 및 설정
- crawlPlaceReviews() 함수 구현
- crawlVisitorReviews() 함수 구현
- 로컬 테스트 스크립트 추가"

git push origin main
```

---

## 크롤링 문제 해결

### 문제 1: Render에서 Puppeteer 실행 안 됨
**해결**: `puppeteer-setup.js`에 executable path 추가
```javascript
executablePath: process.env.PUPPETEER_EXECUTABLE_PATH || '/usr/bin/google-chrome-stable'
```

### 문제 2: 메모리 부족
**해결**: 이미지 로딩 비활성화
```javascript
await page.setRequestInterception(true);
page.on('request', (req) => {
  if (req.resourceType() === 'image') {
    req.abort();
  } else {
    req.continue();
  }
});
```

### 문제 3: 셀렉터가 안 맞음
**해결**: 최신 HTML 구조 확인 후 셀렉터 업데이트
- 네이버 플레이스 페이지 → 개발자 도구 → Elements 확인
- 클래스명이 변경되었을 수 있음

---

## 크롤링 체크리스트

- [ ] Puppeteer 설치 완료
- [ ] `api/utils/puppeteer-setup.js` 생성
- [ ] `api/review-monitoring.js` 수정 (51-87줄)
- [ ] 로컬 테스트 성공
- [ ] Render 환경변수 설정
- [ ] Git 커밋 완료
- [ ] 배포 후 어드민에서 수동 크롤링 테스트

---

# Part 2: 카카오 알림톡 구현

## 📌 작업 개요

**파일**: `api/kakao-alimtalk.js`  
**현재**: 함수 구조만 준비됨 (빈 함수)  
**목표**: 3개 함수 구현 (긴급 리뷰, 고평점 리뷰, 일일 요약)

---

## 사전 준비 (사용자 작업)

### ⏳ 1. 카카오 비즈니스 채널 생성
- 현재 상태: **이미 생성됨** ✅
- URL: https://center-pf.kakao.com/

### ⏳ 2. 알림톡 템플릿 등록 (3개)

**템플릿 등록 위치**: 카카오 비즈니스 센터 → 비즈메시지 → 알림톡 → 템플릿 관리

#### 템플릿 1: 긴급 리뷰 알림
```
템플릿 코드: urgent_review_alert
카테고리: 알림

내용:
[사장픽] 긴급 리뷰 알림 🚨

#{store_name}에 #{rating}점 리뷰가 등록되었습니다.

📝 리뷰 내용:
#{review_content}

👤 작성자: #{reviewer_name}
📅 작성 시간: #{reviewed_at}

즉시 확인하고 대응하세요!

버튼: [리뷰 확인하기] → #{place_url}
```

#### 템플릿 2: 고평점 리뷰 알림
```
템플릿 코드: high_rating_alert
카테고리: 알림

내용:
[사장픽] 칭찬 리뷰 도착! 🎉

#{store_name}에 #{rating}점 리뷰가 등록되었습니다.

📝 리뷰 내용:
#{review_content}

👤 작성자: #{reviewer_name}
📅 작성 시간: #{reviewed_at}

감사 댓글을 남겨보세요!

버튼: [리뷰 확인하기] → #{place_url}
```

#### 템플릿 3: 일일 요약
```
템플릿 코드: daily_summary
카테고리: 알림

내용:
[사장픽] 오늘의 리뷰 요약 📊

#{store_name}
기간: #{start_date} ~ #{end_date}

📈 통계:
- 총 리뷰: #{total_count}개
- 평균 평점: #{avg_rating}점
- 긴급 리뷰: #{urgent_count}개
- 고평점 리뷰: #{high_rating_count}개

버튼: [자세히 보기] → https://www.sajangpick.co.kr/mypage.html
```

**⏳ 승인 대기**: 1-3일 소요

---

## Step 1: 환경변수 설정

**`.env` 파일에 추가** (템플릿 승인 후):

```env
# 카카오 알림톡 API
KAKAO_REST_API_KEY=your_rest_api_key_here
KAKAO_SENDER_KEY=your_sender_key_here

# 템플릿 코드
KAKAO_TEMPLATE_URGENT=urgent_review_alert
KAKAO_TEMPLATE_HIGH_RATING=high_rating_alert
KAKAO_TEMPLATE_DAILY_SUMMARY=daily_summary
```

**키 발급 위치:**
- REST API Key: https://developers.kakao.com/console/app
- SENDER_KEY: 카카오 비즈니스 센터 → 알림톡 → 발신 프로필

---

## Step 2: axios 설치

```bash
pnpm add axios
```

---

## Step 3: 알림톡 함수 구현

**파일 수정**: `api/kakao-alimtalk.js` (전체 교체)

```javascript
const axios = require('axios');
const { createClient } = require('@supabase/supabase-js');

const KAKAO_ALIMTALK_URL = 'https://kapi.kakao.com/v1/api/talk/alimtalk/send';

/**
 * 긴급 리뷰 알림 발송 (1-2점)
 */
async function sendUrgentReviewAlert(userId, alertData) {
  try {
    console.log('[알림톡 발송] 긴급 리뷰:', alertData.id);
    
    // Supabase에서 사용자 전화번호 가져오기
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );
    
    const { data: profile } = await supabase
      .from('profiles')
      .select('phone_number')
      .eq('id', userId)
      .single();
    
    if (!profile || !profile.phone_number) {
      console.log('[알림톡 건너뜀] 전화번호 없음');
      return { success: false, reason: 'no_phone' };
    }
    
    // 템플릿 변수
    const templateArgs = {
      store_name: alertData.place_name,
      rating: alertData.rating.toString(),
      review_content: alertData.content.substring(0, 500),
      reviewer_name: alertData.reviewer_name,
      reviewed_at: formatDateTime(alertData.reviewed_at),
      place_url: alertData.place_url
    };
    
    // 알림톡 발송
    const response = await axios.post(
      KAKAO_ALIMTALK_URL,
      {
        receiver: profile.phone_number,
        template_id: process.env.KAKAO_TEMPLATE_URGENT,
        sender_key: process.env.KAKAO_SENDER_KEY,
        template_args: templateArgs
      },
      {
        headers: {
          'Authorization': `KakaoAK ${process.env.KAKAO_REST_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('[알림톡 발송 완료]', response.data);
    return { success: true };
    
  } catch (error) {
    console.error('[알림톡 발송 실패]', error.response?.data || error.message);
    return { success: false, error: error.message };
  }
}

/**
 * 고평점 리뷰 알림 발송 (5점)
 */
async function sendHighRatingAlert(userId, alertData) {
  try {
    console.log('[알림톡 발송] 고평점 리뷰:', alertData.id);
    
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );
    
    const { data: profile } = await supabase
      .from('profiles')
      .select('phone_number')
      .eq('id', userId)
      .single();
    
    if (!profile || !profile.phone_number) {
      return { success: false, reason: 'no_phone' };
    }
    
    const templateArgs = {
      store_name: alertData.place_name,
      rating: alertData.rating.toString(),
      review_content: alertData.content.substring(0, 500),
      reviewer_name: alertData.reviewer_name,
      reviewed_at: formatDateTime(alertData.reviewed_at),
      place_url: alertData.place_url
    };
    
    const response = await axios.post(
      KAKAO_ALIMTALK_URL,
      {
        receiver: profile.phone_number,
        template_id: process.env.KAKAO_TEMPLATE_HIGH_RATING,
        sender_key: process.env.KAKAO_SENDER_KEY,
        template_args: templateArgs
      },
      {
        headers: {
          'Authorization': `KakaoAK ${process.env.KAKAO_REST_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('[알림톡 발송 완료]', response.data);
    return { success: true };
    
  } catch (error) {
    console.error('[알림톡 발송 실패]', error.response?.data || error.message);
    return { success: false, error: error.message };
  }
}

/**
 * 일일 요약 리포트 발송
 */
async function sendDailySummary(userId, summaryData) {
  try {
    console.log('[알림톡 발송] 일일 요약:', userId);
    
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );
    
    const { data: profile } = await supabase
      .from('profiles')
      .select('phone_number')
      .eq('id', userId)
      .single();
    
    if (!profile || !profile.phone_number) {
      return { success: false, reason: 'no_phone' };
    }
    
    const templateArgs = {
      store_name: summaryData.store_name,
      start_date: summaryData.start_date,
      end_date: summaryData.end_date,
      total_count: summaryData.total_count.toString(),
      avg_rating: summaryData.avg_rating.toFixed(1),
      urgent_count: summaryData.urgent_count.toString(),
      high_rating_count: summaryData.high_rating_count.toString()
    };
    
    const response = await axios.post(
      KAKAO_ALIMTALK_URL,
      {
        receiver: profile.phone_number,
        template_id: process.env.KAKAO_TEMPLATE_DAILY_SUMMARY,
        sender_key: process.env.KAKAO_SENDER_KEY,
        template_args: templateArgs
      },
      {
        headers: {
          'Authorization': `KakaoAK ${process.env.KAKAO_REST_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('[알림톡 발송 완료]', response.data);
    return { success: true };
    
  } catch (error) {
    console.error('[알림톡 발송 실패]', error.response?.data || error.message);
    return { success: false, error: error.message };
  }
}

/**
 * 날짜/시간 포맷팅
 */
function formatDateTime(isoString) {
  const date = new Date(isoString);
  return date.toLocaleString('ko-KR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

module.exports = {
  sendUrgentReviewAlert,
  sendHighRatingAlert,
  sendDailySummary
};
```

---

## Step 4: Render 환경변수 설정

**Render.com Dashboard → Environment Variables 추가:**

```env
KAKAO_REST_API_KEY=your_key
KAKAO_SENDER_KEY=your_key
KAKAO_TEMPLATE_URGENT=urgent_review_alert
KAKAO_TEMPLATE_HIGH_RATING=high_rating_alert
KAKAO_TEMPLATE_DAILY_SUMMARY=daily_summary
```

---

## Step 5: Git 커밋

```bash
git add api/kakao-alimtalk.js
git commit -m "feat: 카카오 알림톡 연동 완료

- sendUrgentReviewAlert() 구현
- sendHighRatingAlert() 구현
- sendDailySummary() 구현
- Supabase 연동 (전화번호 조회)
- 템플릿 변수 치환"

git push origin main
```

---

## 알림톡 문제 해결

### 문제 1: 발송 실패 (error_code: -401)
**원인**: API Key 오류  
**해결**: 
```javascript
// "KakaoAK " 띄어쓰기 확인!
'Authorization': `KakaoAK ${process.env.KAKAO_REST_API_KEY}`
```

### 문제 2: 발송 실패 (error_code: -9999)
**원인**: 템플릿 변수 불일치  
**해결**: 템플릿에 선언된 변수명과 정확히 일치하는지 확인
```javascript
// ✅ 정확
template_args: { store_name: '맛있는 식당' }

// ❌ 틀림
template_args: { storeName: '맛있는 식당' }
```

### 문제 3: 전화번호 없음
**원인**: profiles 테이블에 phone_number 없음  
**해결**: 
1. 회원가입 시 전화번호 입력 필수화
2. 전화번호 없으면 알림 발송 건너뛰기 (이미 구현됨)

---

## 알림톡 체크리스트

- [ ] 카카오 비즈니스 채널 생성 완료 (사용자)
- [ ] 알림톡 사용 신청 완료 (사용자)
- [ ] 템플릿 3개 등록 완료 (사용자)
- [ ] 템플릿 승인 완료 (1-3일 대기)
- [ ] 환경변수 설정 완료 (.env, Render)
- [ ] axios 설치 완료
- [ ] `api/kakao-alimtalk.js` 구현 완료
- [ ] Git 커밋 완료
- [ ] 테스트 발송 성공

---

# 🧪 통합 테스트

## 전체 플로우 테스트

### 1. 마이페이지에서 모니터링 활성화
```
1. https://www.sajangpick.co.kr/mypage.html 접속
2. 가게 정보에 플레이스 URL 입력
3. 리뷰 모니터링 활성화
4. 알림 설정 (저평점 ✅, 고평점 ✅)
5. 저장
```

### 2. 어드민에서 수동 크롤링 실행
```
1. https://www.sajangpick.co.kr/admin/review-monitoring.html 접속
2. "수동 크롤링 실행" 버튼 클릭
3. 1-2분 대기
4. 결과 확인
```

### 3. 알림톡 수신 확인
```
1. 카카오톡 앱 열기
2. 긴급 리뷰 알림 수신 확인
3. 버튼 클릭 → 네이버 플레이스 이동 확인
```

---

# 📊 완료 체크리스트

## Part 1: 크롤링
- [ ] Puppeteer 설치
- [ ] `api/utils/puppeteer-setup.js` 생성
- [ ] `api/review-monitoring.js` 수정
- [ ] 로컬 테스트 성공
- [ ] Render 환경변수 설정
- [ ] Git 커밋 & 푸시
- [ ] 배포 후 수동 크롤링 테스트

## Part 2: 알림톡
- [ ] 템플릿 3개 등록 (사용자)
- [ ] 템플릿 승인 대기 (1-3일)
- [ ] 환경변수 설정 (.env, Render)
- [ ] axios 설치
- [ ] `api/kakao-alimtalk.js` 구현
- [ ] Git 커밋 & 푸시
- [ ] 테스트 발송 성공

## Part 3: 통합 테스트
- [ ] 마이페이지 모니터링 활성화
- [ ] 어드민 수동 크롤링 실행
- [ ] 알림톡 수신 확인
- [ ] Cron 자동 실행 확인 (다음날)

---

# 🔗 관련 파일 위치

```
api/
├── review-monitoring.js (51-87줄) ← 크롤링 함수 수정
├── kakao-alimtalk.js ← 알림톡 함수 구현
└── utils/
    └── puppeteer-setup.js ← 신규 생성

database/schemas/features/review/
└── review-monitoring.sql ← DB 스키마 (수정 불필요)

admin/
└── review-monitoring.html ← 어드민 대시보드 (수정 불필요)

mypage.html ← 마이페이지 (수정 불필요)
vercel.json ← Cron 설정 (수정 불필요)
```

---

# 💰 예상 비용

**알림톡 비용**: 메시지당 8-15원

**예상 월 비용 (회원 100명 기준)**:
- 하루 평균 10개 알림 × 100명 = 1,000건/일
- 1,000건 × 10원 = 10,000원/일
- **월 약 30만원**

---

# 🎯 다음 단계 (추가 개발)

## 우선순위 중간
1. **마이페이지 최근 리뷰 표시** (1-2시간)
   - `mypage.html` → `loadRecentReviews()` 함수 구현
   - Supabase에서 데이터 가져와서 렌더링

2. **블로그 리뷰 크롤링** (2-3시간)
   - `api/review-monitoring.js` → `crawlBlogReviews()` 함수 추가

## 우선순위 낮음
3. **일일 요약 리포트 Cron** (1-2시간)
4. **리뷰 감정 분석 개선** (3-4시간)

---

**작성일**: 2025-10-30  
**업데이트**: 크롤링 또는 알림톡 구현 완료 후  
**AI**: 이 가이드대로 순차적으로 개발하세요

