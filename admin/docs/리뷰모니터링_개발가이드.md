# ë¦¬ë·° ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ - ê°œë°œ ê°€ì´ë“œ (AIìš©)

> ğŸ¤– **AI ê°œë°œìë¥¼ ìœ„í•œ ì™„ì „ ê°€ì´ë“œ**: í¬ë¡¤ë§ + ì•Œë¦¼í†¡ í†µí•© ê°œë°œ

---

## ğŸ¯ ëª©í‘œ

**í˜„ì¬ ìƒíƒœ**: ì‹œìŠ¤í…œ êµ¬ì¡°ëŠ” ì™„ì„±, ë”ë¯¸ ë°ì´í„°ë¡œ ì‘ë™ ì¤‘  
**ê°œë°œ ëª©í‘œ**: ì‹¤ì œ ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í¬ë¡¤ë§ + ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ë°œì†¡ êµ¬í˜„

---

## ğŸ“‹ í˜„ì¬ ìƒíƒœ ì²´í¬

### âœ… ì´ë¯¸ ì™„ë£Œëœ ê²ƒ
- DB ìŠ¤í‚¤ë§ˆ (í…Œì´ë¸” 3ê°œ: `review_monitoring`, `review_alerts`, `review_crawl_logs`)
- API ì—”ë“œí¬ì¸íŠ¸ (`api/review-monitoring.js`)
- ë§ˆì´í˜ì´ì§€ UI (`mypage.html`)
- ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ (`admin/review-monitoring.html`)
- Vercel Cron (ë§¤ì¼ 3íšŒ ìë™ ì‹¤í–‰)
- ì‹œìŠ¤í…œ í”Œë¡œìš° (ì „ì²´ êµ¬ì¡°)

### â³ ê°œë°œ í•„ìš” (ì´ ê°€ì´ë“œì—ì„œ ë‹¤ë£¸)
1. **í¬ë¡¤ë§**: `api/review-monitoring.js` 51-87ì¤„ â†’ ì‹¤ì œ Puppeteer í¬ë¡¤ë§
2. **ì•Œë¦¼í†¡**: `api/kakao-alimtalk.js` â†’ 3ê°œ í•¨ìˆ˜ êµ¬í˜„

---

## ğŸ”¥ ê°œë°œ ìš°ì„ ìˆœìœ„

```
ë†’ìŒ: 1. í¬ë¡¤ë§ êµ¬í˜„ (4-6ì‹œê°„) â­â­â­â­â­
ë†’ìŒ: 2. ì•Œë¦¼í†¡ êµ¬í˜„ (3-4ì‹œê°„) â­â­â­â­â˜†
```

**ê¶Œì¥ ìˆœì„œ**: í¬ë¡¤ë§ â†’ ì•Œë¦¼í†¡ (í¬ë¡¤ë§ì´ ì„ í–‰ë˜ì–´ì•¼ ì•Œë¦¼ ë°œì†¡ ê°€ëŠ¥)

---

# Part 1: ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í¬ë¡¤ë§ êµ¬í˜„

## ğŸ“Œ ì‘ì—… ê°œìš”

**íŒŒì¼**: `api/review-monitoring.js`  
**ìœ„ì¹˜**: 51-87ì¤„ (`crawlPlaceReviews` í•¨ìˆ˜)  
**í˜„ì¬**: ë”ë¯¸ ë¦¬ë·° 2ê°œ ë°˜í™˜  
**ëª©í‘œ**: Puppeteerë¡œ ì‹¤ì œ ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í¬ë¡¤ë§

---

## Step 1: Puppeteer ì„¤ì¹˜

```bash
pnpm add puppeteer
```

---

## Step 2: Puppeteer ì„¤ì • íŒŒì¼ ìƒì„±

**ìƒˆ íŒŒì¼ ìƒì„±**: `api/utils/puppeteer-setup.js`

```javascript
const puppeteer = require('puppeteer');

/**
 * Puppeteer ë¸Œë¼ìš°ì € ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
 */
async function createBrowser() {
  const browser = await puppeteer.launch({
    headless: true,
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-dev-shm-usage',
      '--disable-accelerated-2d-canvas',
      '--disable-gpu',
      '--window-size=1920x1080'
    ]
  });
  
  return browser;
}

/**
 * í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
 */
async function setupPage(page) {
  // User Agent ì„¤ì • (ë´‡ ê°ì§€ íšŒí”¼)
  await page.setUserAgent(
    'Mozilla/5.0 (iPhone; CPU iPhone OS 14_7_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.1.2 Mobile/15E148 Safari/604.1'
  );
  
  // íƒ€ì„ì•„ì›ƒ ì„¤ì •
  await page.setDefaultTimeout(30000);
  
  // ë·°í¬íŠ¸ ì„¤ì • (ëª¨ë°”ì¼)
  await page.setViewport({ width: 375, height: 667 });
  
  return page;
}

module.exports = {
  createBrowser,
  setupPage
};
```

---

## Step 3: í¬ë¡¤ë§ í•¨ìˆ˜ êµ¬í˜„

**íŒŒì¼ ìˆ˜ì •**: `api/review-monitoring.js` (51-87ì¤„)

**ê¸°ì¡´ ì½”ë“œ ì‚­ì œ í›„ ì•„ë˜ë¡œ êµì²´:**

```javascript
const { createBrowser, setupPage } = require('./utils/puppeteer-setup');

/**
 * ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë¦¬ë·° í¬ë¡¤ë§
 */
async function crawlPlaceReviews(placeUrl) {
  let browser = null;
  
  try {
    console.log('[í¬ë¡¤ë§ ì‹œì‘]', placeUrl);
    
    // í”Œë ˆì´ìŠ¤ ID ì¶”ì¶œ
    const placeId = extractPlaceId(placeUrl);
    if (!placeId) {
      throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ í”Œë ˆì´ìŠ¤ URL');
    }
    
    // ë¸Œë¼ìš°ì € ì‹¤í–‰
    browser = await createBrowser();
    const page = await browser.newPage();
    await setupPage(page);
    
    // ë°©ë¬¸ì ë¦¬ë·° ìˆ˜ì§‘
    const visitorReviews = await crawlVisitorReviews(page, placeId);
    
    const allReviews = [...visitorReviews];
    
    console.log(`[í¬ë¡¤ë§ ì™„ë£Œ] ì´ ${allReviews.length}ê°œ ë¦¬ë·°`);
    
    return {
      success: true,
      reviews: allReviews,
      total: allReviews.length
    };
    
  } catch (error) {
    console.error('[í¬ë¡¤ë§ ì‹¤íŒ¨]', error);
    return {
      success: false,
      error: error.message,
      reviews: []
    };
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

/**
 * ë°©ë¬¸ì ë¦¬ë·° í¬ë¡¤ë§
 */
async function crawlVisitorReviews(page, placeId) {
  try {
    const url = `https://m.place.naver.com/restaurant/${placeId}/review/visitor`;
    console.log('[ë°©ë¬¸ì ë¦¬ë·° í¬ë¡¤ë§]', url);
    
    await page.goto(url, { waitUntil: 'networkidle2' });
    await page.waitForTimeout(2000);
    
    // ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ íŒŒì‹±
    const reviews = await page.evaluate(() => {
      const reviewElements = document.querySelectorAll('.list_review > li');
      const results = [];
      
      reviewElements.forEach((el, index) => {
        try {
          // í‰ì  ì¶”ì¶œ
          const stars = el.querySelectorAll('.star_score .star_fill');
          const rating = stars.length;
          
          // ë¦¬ë·° ë‚´ìš© ì¶”ì¶œ
          const contentEl = el.querySelector('.review_text');
          const content = contentEl ? contentEl.textContent.trim() : '';
          
          // ì‘ì„±ìëª… ì¶”ì¶œ
          const authorEl = el.querySelector('.reviewer_info .reviewer_name');
          const reviewer_name = authorEl ? authorEl.textContent.trim() : 'ìµëª…';
          
          // ì‘ì„± ì‹œê°„ ì¶”ì¶œ
          const timeEl = el.querySelector('.review_time');
          const timeText = timeEl ? timeEl.textContent.trim() : '';
          
          // ê³ ìœ  ID ìƒì„±
          const external_id = `visitor_${Date.now()}_${index}`;
          
          if (content) {
            results.push({
              type: 'visitor',
              external_id,
              rating,
              content,
              reviewer_name,
              reviewed_at: new Date().toISOString()
            });
          }
        } catch (err) {
          console.error('ë¦¬ë·° íŒŒì‹± ì˜¤ë¥˜:', err);
        }
      });
      
      return results;
    });
    
    console.log(`[ë°©ë¬¸ì ë¦¬ë·°] ${reviews.length}ê°œ ìˆ˜ì§‘`);
    return reviews;
    
  } catch (error) {
    console.error('[ë°©ë¬¸ì ë¦¬ë·° í¬ë¡¤ë§ ì‹¤íŒ¨]', error);
    return [];
  }
}
```

**âš ï¸ ì¤‘ìš”**: `extractPlaceId` í•¨ìˆ˜ëŠ” ì´ë¯¸ ì¡´ì¬í•¨ (ìˆ˜ì • ë¶ˆí•„ìš”)

---

## Step 4: ë¡œì»¬ í…ŒìŠ¤íŠ¸

**í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„±**: `test-crawling.js` (í”„ë¡œì íŠ¸ ë£¨íŠ¸)

```javascript
const { crawlPlaceReviews } = require('./api/review-monitoring');

async function test() {
  // ì‹¤ì œ í”Œë ˆì´ìŠ¤ URLë¡œ ë³€ê²½í•˜ì„¸ìš”
  const testUrl = 'https://m.place.naver.com/restaurant/1234567890';
  
  console.log('ğŸ§ª í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸ ì‹œì‘...\n');
  
  const result = await crawlPlaceReviews(testUrl);
  
  console.log('\nğŸ“Š ê²°ê³¼:');
  console.log('ì„±ê³µ:', result.success);
  console.log('ì´ ë¦¬ë·°:', result.total);
  console.log('\në¦¬ë·° ëª©ë¡:');
  result.reviews.forEach((review, i) => {
    console.log(`\n${i + 1}. [${review.rating}ì ] ${review.reviewer_name}`);
    console.log(`   ${review.content.substring(0, 50)}...`);
  });
}

test().catch(console.error);
```

**ì‹¤í–‰:**
```bash
node test-crawling.js
```

---

## Step 5: Render í™˜ê²½ ì„¤ì •

**Render.com Dashboard â†’ Environment Variables ì¶”ê°€:**

```env
PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=false
PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable
```

---

## Step 6: Git ì»¤ë°‹

```bash
git add api/utils/puppeteer-setup.js api/review-monitoring.js test-crawling.js
git commit -m "feat: ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì‹¤ì œ í¬ë¡¤ë§ êµ¬í˜„

- Puppeteer ì„¤ì¹˜ ë° ì„¤ì •
- crawlPlaceReviews() í•¨ìˆ˜ êµ¬í˜„
- crawlVisitorReviews() í•¨ìˆ˜ êµ¬í˜„
- ë¡œì»¬ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€"

git push origin main
```

---

## í¬ë¡¤ë§ ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: Renderì—ì„œ Puppeteer ì‹¤í–‰ ì•ˆ ë¨
**í•´ê²°**: `puppeteer-setup.js`ì— executable path ì¶”ê°€
```javascript
executablePath: process.env.PUPPETEER_EXECUTABLE_PATH || '/usr/bin/google-chrome-stable'
```

### ë¬¸ì œ 2: ë©”ëª¨ë¦¬ ë¶€ì¡±
**í•´ê²°**: ì´ë¯¸ì§€ ë¡œë”© ë¹„í™œì„±í™”
```javascript
await page.setRequestInterception(true);
page.on('request', (req) => {
  if (req.resourceType() === 'image') {
    req.abort();
  } else {
    req.continue();
  }
});
```

### ë¬¸ì œ 3: ì…€ë ‰í„°ê°€ ì•ˆ ë§ìŒ
**í•´ê²°**: ìµœì‹  HTML êµ¬ì¡° í™•ì¸ í›„ ì…€ë ‰í„° ì—…ë°ì´íŠ¸
- ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í˜ì´ì§€ â†’ ê°œë°œì ë„êµ¬ â†’ Elements í™•ì¸
- í´ë˜ìŠ¤ëª…ì´ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìŒ

---

## í¬ë¡¤ë§ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Puppeteer ì„¤ì¹˜ ì™„ë£Œ
- [ ] `api/utils/puppeteer-setup.js` ìƒì„±
- [ ] `api/review-monitoring.js` ìˆ˜ì • (51-87ì¤„)
- [ ] ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] Render í™˜ê²½ë³€ìˆ˜ ì„¤ì •
- [ ] Git ì»¤ë°‹ ì™„ë£Œ
- [ ] ë°°í¬ í›„ ì–´ë“œë¯¼ì—ì„œ ìˆ˜ë™ í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸

---

# Part 2: ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ êµ¬í˜„

## ğŸ“Œ ì‘ì—… ê°œìš”

**íŒŒì¼**: `api/kakao-alimtalk.js`  
**í˜„ì¬**: í•¨ìˆ˜ êµ¬ì¡°ë§Œ ì¤€ë¹„ë¨ (ë¹ˆ í•¨ìˆ˜)  
**ëª©í‘œ**: 3ê°œ í•¨ìˆ˜ êµ¬í˜„ (ê¸´ê¸‰ ë¦¬ë·°, ê³ í‰ì  ë¦¬ë·°, ì¼ì¼ ìš”ì•½)

---

## ì‚¬ì „ ì¤€ë¹„ (ì‚¬ìš©ì ì‘ì—…)

### â³ 1. ì¹´ì¹´ì˜¤ ë¹„ì¦ˆë‹ˆìŠ¤ ì±„ë„ ìƒì„±
- í˜„ì¬ ìƒíƒœ: **ì´ë¯¸ ìƒì„±ë¨** âœ…
- URL: https://center-pf.kakao.com/

### â³ 2. ì•Œë¦¼í†¡ í…œí”Œë¦¿ ë“±ë¡ (3ê°œ)

**í…œí”Œë¦¿ ë“±ë¡ ìœ„ì¹˜**: ì¹´ì¹´ì˜¤ ë¹„ì¦ˆë‹ˆìŠ¤ ì„¼í„° â†’ ë¹„ì¦ˆë©”ì‹œì§€ â†’ ì•Œë¦¼í†¡ â†’ í…œí”Œë¦¿ ê´€ë¦¬

#### í…œí”Œë¦¿ 1: ê¸´ê¸‰ ë¦¬ë·° ì•Œë¦¼
```
í…œí”Œë¦¿ ì½”ë“œ: urgent_review_alert
ì¹´í…Œê³ ë¦¬: ì•Œë¦¼

ë‚´ìš©:
[ì‚¬ì¥í”½] ê¸´ê¸‰ ë¦¬ë·° ì•Œë¦¼ ğŸš¨

#{store_name}ì— #{rating}ì  ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.

ğŸ“ ë¦¬ë·° ë‚´ìš©:
#{review_content}

ğŸ‘¤ ì‘ì„±ì: #{reviewer_name}
ğŸ“… ì‘ì„± ì‹œê°„: #{reviewed_at}

ì¦‰ì‹œ í™•ì¸í•˜ê³  ëŒ€ì‘í•˜ì„¸ìš”!

ë²„íŠ¼: [ë¦¬ë·° í™•ì¸í•˜ê¸°] â†’ #{place_url}
```

#### í…œí”Œë¦¿ 2: ê³ í‰ì  ë¦¬ë·° ì•Œë¦¼
```
í…œí”Œë¦¿ ì½”ë“œ: high_rating_alert
ì¹´í…Œê³ ë¦¬: ì•Œë¦¼

ë‚´ìš©:
[ì‚¬ì¥í”½] ì¹­ì°¬ ë¦¬ë·° ë„ì°©! ğŸ‰

#{store_name}ì— #{rating}ì  ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.

ğŸ“ ë¦¬ë·° ë‚´ìš©:
#{review_content}

ğŸ‘¤ ì‘ì„±ì: #{reviewer_name}
ğŸ“… ì‘ì„± ì‹œê°„: #{reviewed_at}

ê°ì‚¬ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!

ë²„íŠ¼: [ë¦¬ë·° í™•ì¸í•˜ê¸°] â†’ #{place_url}
```

#### í…œí”Œë¦¿ 3: ì¼ì¼ ìš”ì•½
```
í…œí”Œë¦¿ ì½”ë“œ: daily_summary
ì¹´í…Œê³ ë¦¬: ì•Œë¦¼

ë‚´ìš©:
[ì‚¬ì¥í”½] ì˜¤ëŠ˜ì˜ ë¦¬ë·° ìš”ì•½ ğŸ“Š

#{store_name}
ê¸°ê°„: #{start_date} ~ #{end_date}

ğŸ“ˆ í†µê³„:
- ì´ ë¦¬ë·°: #{total_count}ê°œ
- í‰ê·  í‰ì : #{avg_rating}ì 
- ê¸´ê¸‰ ë¦¬ë·°: #{urgent_count}ê°œ
- ê³ í‰ì  ë¦¬ë·°: #{high_rating_count}ê°œ

ë²„íŠ¼: [ìì„¸íˆ ë³´ê¸°] â†’ https://www.sajangpick.co.kr/mypage.html
```

**â³ ìŠ¹ì¸ ëŒ€ê¸°**: 1-3ì¼ ì†Œìš”

---

## Step 1: í™˜ê²½ë³€ìˆ˜ ì„¤ì •

**`.env` íŒŒì¼ì— ì¶”ê°€** (í…œí”Œë¦¿ ìŠ¹ì¸ í›„):

```env
# ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ API
KAKAO_REST_API_KEY=your_rest_api_key_here
KAKAO_SENDER_KEY=your_sender_key_here

# í…œí”Œë¦¿ ì½”ë“œ
KAKAO_TEMPLATE_URGENT=urgent_review_alert
KAKAO_TEMPLATE_HIGH_RATING=high_rating_alert
KAKAO_TEMPLATE_DAILY_SUMMARY=daily_summary
```

**í‚¤ ë°œê¸‰ ìœ„ì¹˜:**
- REST API Key: https://developers.kakao.com/console/app
- SENDER_KEY: ì¹´ì¹´ì˜¤ ë¹„ì¦ˆë‹ˆìŠ¤ ì„¼í„° â†’ ì•Œë¦¼í†¡ â†’ ë°œì‹  í”„ë¡œí•„

---

## Step 2: axios ì„¤ì¹˜

```bash
pnpm add axios
```

---

## Step 3: ì•Œë¦¼í†¡ í•¨ìˆ˜ êµ¬í˜„

**íŒŒì¼ ìˆ˜ì •**: `api/kakao-alimtalk.js` (ì „ì²´ êµì²´)

```javascript
const axios = require('axios');
const { createClient } = require('@supabase/supabase-js');

const KAKAO_ALIMTALK_URL = 'https://kapi.kakao.com/v1/api/talk/alimtalk/send';

/**
 * ê¸´ê¸‰ ë¦¬ë·° ì•Œë¦¼ ë°œì†¡ (1-2ì )
 */
async function sendUrgentReviewAlert(userId, alertData) {
  try {
    console.log('[ì•Œë¦¼í†¡ ë°œì†¡] ê¸´ê¸‰ ë¦¬ë·°:', alertData.id);
    
    // Supabaseì—ì„œ ì‚¬ìš©ì ì „í™”ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );
    
    const { data: profile } = await supabase
      .from('profiles')
      .select('phone_number')
      .eq('id', userId)
      .single();
    
    if (!profile || !profile.phone_number) {
      console.log('[ì•Œë¦¼í†¡ ê±´ë„ˆëœ€] ì „í™”ë²ˆí˜¸ ì—†ìŒ');
      return { success: false, reason: 'no_phone' };
    }
    
    // í…œí”Œë¦¿ ë³€ìˆ˜
    const templateArgs = {
      store_name: alertData.place_name,
      rating: alertData.rating.toString(),
      review_content: alertData.content.substring(0, 500),
      reviewer_name: alertData.reviewer_name,
      reviewed_at: formatDateTime(alertData.reviewed_at),
      place_url: alertData.place_url
    };
    
    // ì•Œë¦¼í†¡ ë°œì†¡
    const response = await axios.post(
      KAKAO_ALIMTALK_URL,
      {
        receiver: profile.phone_number,
        template_id: process.env.KAKAO_TEMPLATE_URGENT,
        sender_key: process.env.KAKAO_SENDER_KEY,
        template_args: templateArgs
      },
      {
        headers: {
          'Authorization': `KakaoAK ${process.env.KAKAO_REST_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('[ì•Œë¦¼í†¡ ë°œì†¡ ì™„ë£Œ]', response.data);
    return { success: true };
    
  } catch (error) {
    console.error('[ì•Œë¦¼í†¡ ë°œì†¡ ì‹¤íŒ¨]', error.response?.data || error.message);
    return { success: false, error: error.message };
  }
}

/**
 * ê³ í‰ì  ë¦¬ë·° ì•Œë¦¼ ë°œì†¡ (5ì )
 */
async function sendHighRatingAlert(userId, alertData) {
  try {
    console.log('[ì•Œë¦¼í†¡ ë°œì†¡] ê³ í‰ì  ë¦¬ë·°:', alertData.id);
    
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );
    
    const { data: profile } = await supabase
      .from('profiles')
      .select('phone_number')
      .eq('id', userId)
      .single();
    
    if (!profile || !profile.phone_number) {
      return { success: false, reason: 'no_phone' };
    }
    
    const templateArgs = {
      store_name: alertData.place_name,
      rating: alertData.rating.toString(),
      review_content: alertData.content.substring(0, 500),
      reviewer_name: alertData.reviewer_name,
      reviewed_at: formatDateTime(alertData.reviewed_at),
      place_url: alertData.place_url
    };
    
    const response = await axios.post(
      KAKAO_ALIMTALK_URL,
      {
        receiver: profile.phone_number,
        template_id: process.env.KAKAO_TEMPLATE_HIGH_RATING,
        sender_key: process.env.KAKAO_SENDER_KEY,
        template_args: templateArgs
      },
      {
        headers: {
          'Authorization': `KakaoAK ${process.env.KAKAO_REST_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('[ì•Œë¦¼í†¡ ë°œì†¡ ì™„ë£Œ]', response.data);
    return { success: true };
    
  } catch (error) {
    console.error('[ì•Œë¦¼í†¡ ë°œì†¡ ì‹¤íŒ¨]', error.response?.data || error.message);
    return { success: false, error: error.message };
  }
}

/**
 * ì¼ì¼ ìš”ì•½ ë¦¬í¬íŠ¸ ë°œì†¡
 */
async function sendDailySummary(userId, summaryData) {
  try {
    console.log('[ì•Œë¦¼í†¡ ë°œì†¡] ì¼ì¼ ìš”ì•½:', userId);
    
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );
    
    const { data: profile } = await supabase
      .from('profiles')
      .select('phone_number')
      .eq('id', userId)
      .single();
    
    if (!profile || !profile.phone_number) {
      return { success: false, reason: 'no_phone' };
    }
    
    const templateArgs = {
      store_name: summaryData.store_name,
      start_date: summaryData.start_date,
      end_date: summaryData.end_date,
      total_count: summaryData.total_count.toString(),
      avg_rating: summaryData.avg_rating.toFixed(1),
      urgent_count: summaryData.urgent_count.toString(),
      high_rating_count: summaryData.high_rating_count.toString()
    };
    
    const response = await axios.post(
      KAKAO_ALIMTALK_URL,
      {
        receiver: profile.phone_number,
        template_id: process.env.KAKAO_TEMPLATE_DAILY_SUMMARY,
        sender_key: process.env.KAKAO_SENDER_KEY,
        template_args: templateArgs
      },
      {
        headers: {
          'Authorization': `KakaoAK ${process.env.KAKAO_REST_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('[ì•Œë¦¼í†¡ ë°œì†¡ ì™„ë£Œ]', response.data);
    return { success: true };
    
  } catch (error) {
    console.error('[ì•Œë¦¼í†¡ ë°œì†¡ ì‹¤íŒ¨]', error.response?.data || error.message);
    return { success: false, error: error.message };
  }
}

/**
 * ë‚ ì§œ/ì‹œê°„ í¬ë§·íŒ…
 */
function formatDateTime(isoString) {
  const date = new Date(isoString);
  return date.toLocaleString('ko-KR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

module.exports = {
  sendUrgentReviewAlert,
  sendHighRatingAlert,
  sendDailySummary
};
```

---

## Step 4: Render í™˜ê²½ë³€ìˆ˜ ì„¤ì •

**Render.com Dashboard â†’ Environment Variables ì¶”ê°€:**

```env
KAKAO_REST_API_KEY=your_key
KAKAO_SENDER_KEY=your_key
KAKAO_TEMPLATE_URGENT=urgent_review_alert
KAKAO_TEMPLATE_HIGH_RATING=high_rating_alert
KAKAO_TEMPLATE_DAILY_SUMMARY=daily_summary
```

---

## Step 5: Git ì»¤ë°‹

```bash
git add api/kakao-alimtalk.js
git commit -m "feat: ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ì—°ë™ ì™„ë£Œ

- sendUrgentReviewAlert() êµ¬í˜„
- sendHighRatingAlert() êµ¬í˜„
- sendDailySummary() êµ¬í˜„
- Supabase ì—°ë™ (ì „í™”ë²ˆí˜¸ ì¡°íšŒ)
- í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜"

git push origin main
```

---

## ì•Œë¦¼í†¡ ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: ë°œì†¡ ì‹¤íŒ¨ (error_code: -401)
**ì›ì¸**: API Key ì˜¤ë¥˜  
**í•´ê²°**: 
```javascript
// "KakaoAK " ë„ì–´ì“°ê¸° í™•ì¸!
'Authorization': `KakaoAK ${process.env.KAKAO_REST_API_KEY}`
```

### ë¬¸ì œ 2: ë°œì†¡ ì‹¤íŒ¨ (error_code: -9999)
**ì›ì¸**: í…œí”Œë¦¿ ë³€ìˆ˜ ë¶ˆì¼ì¹˜  
**í•´ê²°**: í…œí”Œë¦¿ì— ì„ ì–¸ëœ ë³€ìˆ˜ëª…ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
```javascript
// âœ… ì •í™•
template_args: { store_name: 'ë§›ìˆëŠ” ì‹ë‹¹' }

// âŒ í‹€ë¦¼
template_args: { storeName: 'ë§›ìˆëŠ” ì‹ë‹¹' }
```

### ë¬¸ì œ 3: ì „í™”ë²ˆí˜¸ ì—†ìŒ
**ì›ì¸**: profiles í…Œì´ë¸”ì— phone_number ì—†ìŒ  
**í•´ê²°**: 
1. íšŒì›ê°€ì… ì‹œ ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ìˆ˜í™”
2. ì „í™”ë²ˆí˜¸ ì—†ìœ¼ë©´ ì•Œë¦¼ ë°œì†¡ ê±´ë„ˆë›°ê¸° (ì´ë¯¸ êµ¬í˜„ë¨)

---

## ì•Œë¦¼í†¡ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì¹´ì¹´ì˜¤ ë¹„ì¦ˆë‹ˆìŠ¤ ì±„ë„ ìƒì„± ì™„ë£Œ (ì‚¬ìš©ì)
- [ ] ì•Œë¦¼í†¡ ì‚¬ìš© ì‹ ì²­ ì™„ë£Œ (ì‚¬ìš©ì)
- [ ] í…œí”Œë¦¿ 3ê°œ ë“±ë¡ ì™„ë£Œ (ì‚¬ìš©ì)
- [ ] í…œí”Œë¦¿ ìŠ¹ì¸ ì™„ë£Œ (1-3ì¼ ëŒ€ê¸°)
- [ ] í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ (.env, Render)
- [ ] axios ì„¤ì¹˜ ì™„ë£Œ
- [ ] `api/kakao-alimtalk.js` êµ¬í˜„ ì™„ë£Œ
- [ ] Git ì»¤ë°‹ ì™„ë£Œ
- [ ] í…ŒìŠ¤íŠ¸ ë°œì†¡ ì„±ê³µ

---

# ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸

## ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸

### 1. ë§ˆì´í˜ì´ì§€ì—ì„œ ëª¨ë‹ˆí„°ë§ í™œì„±í™”
```
1. https://www.sajangpick.co.kr/mypage.html ì ‘ì†
2. ê°€ê²Œ ì •ë³´ì— í”Œë ˆì´ìŠ¤ URL ì…ë ¥
3. ë¦¬ë·° ëª¨ë‹ˆí„°ë§ í™œì„±í™”
4. ì•Œë¦¼ ì„¤ì • (ì €í‰ì  âœ…, ê³ í‰ì  âœ…)
5. ì €ì¥
```

### 2. ì–´ë“œë¯¼ì—ì„œ ìˆ˜ë™ í¬ë¡¤ë§ ì‹¤í–‰
```
1. https://www.sajangpick.co.kr/admin/review-monitoring.html ì ‘ì†
2. "ìˆ˜ë™ í¬ë¡¤ë§ ì‹¤í–‰" ë²„íŠ¼ í´ë¦­
3. 1-2ë¶„ ëŒ€ê¸°
4. ê²°ê³¼ í™•ì¸
```

### 3. ì•Œë¦¼í†¡ ìˆ˜ì‹  í™•ì¸
```
1. ì¹´ì¹´ì˜¤í†¡ ì•± ì—´ê¸°
2. ê¸´ê¸‰ ë¦¬ë·° ì•Œë¦¼ ìˆ˜ì‹  í™•ì¸
3. ë²„íŠ¼ í´ë¦­ â†’ ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì´ë™ í™•ì¸
```

---

# ğŸ“Š ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

## Part 1: í¬ë¡¤ë§
- [ ] Puppeteer ì„¤ì¹˜
- [ ] `api/utils/puppeteer-setup.js` ìƒì„±
- [ ] `api/review-monitoring.js` ìˆ˜ì •
- [ ] ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] Render í™˜ê²½ë³€ìˆ˜ ì„¤ì •
- [ ] Git ì»¤ë°‹ & í‘¸ì‹œ
- [ ] ë°°í¬ í›„ ìˆ˜ë™ í¬ë¡¤ë§ í…ŒìŠ¤íŠ¸

## Part 2: ì•Œë¦¼í†¡
- [ ] í…œí”Œë¦¿ 3ê°œ ë“±ë¡ (ì‚¬ìš©ì)
- [ ] í…œí”Œë¦¿ ìŠ¹ì¸ ëŒ€ê¸° (1-3ì¼)
- [ ] í™˜ê²½ë³€ìˆ˜ ì„¤ì • (.env, Render)
- [ ] axios ì„¤ì¹˜
- [ ] `api/kakao-alimtalk.js` êµ¬í˜„
- [ ] Git ì»¤ë°‹ & í‘¸ì‹œ
- [ ] í…ŒìŠ¤íŠ¸ ë°œì†¡ ì„±ê³µ

## Part 3: í†µí•© í…ŒìŠ¤íŠ¸
- [ ] ë§ˆì´í˜ì´ì§€ ëª¨ë‹ˆí„°ë§ í™œì„±í™”
- [ ] ì–´ë“œë¯¼ ìˆ˜ë™ í¬ë¡¤ë§ ì‹¤í–‰
- [ ] ì•Œë¦¼í†¡ ìˆ˜ì‹  í™•ì¸
- [ ] Cron ìë™ ì‹¤í–‰ í™•ì¸ (ë‹¤ìŒë‚ )

---

# ğŸ”— ê´€ë ¨ íŒŒì¼ ìœ„ì¹˜

```
api/
â”œâ”€â”€ review-monitoring.js (51-87ì¤„) â† í¬ë¡¤ë§ í•¨ìˆ˜ ìˆ˜ì •
â”œâ”€â”€ kakao-alimtalk.js â† ì•Œë¦¼í†¡ í•¨ìˆ˜ êµ¬í˜„
â””â”€â”€ utils/
    â””â”€â”€ puppeteer-setup.js â† ì‹ ê·œ ìƒì„±

database/schemas/features/review/
â””â”€â”€ review-monitoring.sql â† DB ìŠ¤í‚¤ë§ˆ (ìˆ˜ì • ë¶ˆí•„ìš”)

admin/
â””â”€â”€ review-monitoring.html â† ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ (ìˆ˜ì • ë¶ˆí•„ìš”)

mypage.html â† ë§ˆì´í˜ì´ì§€ (ìˆ˜ì • ë¶ˆí•„ìš”)
vercel.json â† Cron ì„¤ì • (ìˆ˜ì • ë¶ˆí•„ìš”)
```

---

# ğŸ’° ì˜ˆìƒ ë¹„ìš©

**ì•Œë¦¼í†¡ ë¹„ìš©**: ë©”ì‹œì§€ë‹¹ 8-15ì›

**ì˜ˆìƒ ì›” ë¹„ìš© (íšŒì› 100ëª… ê¸°ì¤€)**:
- í•˜ë£¨ í‰ê·  10ê°œ ì•Œë¦¼ Ã— 100ëª… = 1,000ê±´/ì¼
- 1,000ê±´ Ã— 10ì› = 10,000ì›/ì¼
- **ì›” ì•½ 30ë§Œì›**

---

# ğŸ¯ ë‹¤ìŒ ë‹¨ê³„ (ì¶”ê°€ ê°œë°œ)

## ìš°ì„ ìˆœìœ„ ì¤‘ê°„
1. **ë§ˆì´í˜ì´ì§€ ìµœê·¼ ë¦¬ë·° í‘œì‹œ** (1-2ì‹œê°„)
   - `mypage.html` â†’ `loadRecentReviews()` í•¨ìˆ˜ êµ¬í˜„
   - Supabaseì—ì„œ ë°ì´í„° ê°€ì ¸ì™€ì„œ ë Œë”ë§

2. **ë¸”ë¡œê·¸ ë¦¬ë·° í¬ë¡¤ë§** (2-3ì‹œê°„)
   - `api/review-monitoring.js` â†’ `crawlBlogReviews()` í•¨ìˆ˜ ì¶”ê°€

## ìš°ì„ ìˆœìœ„ ë‚®ìŒ
3. **ì¼ì¼ ìš”ì•½ ë¦¬í¬íŠ¸ Cron** (1-2ì‹œê°„)
4. **ë¦¬ë·° ê°ì • ë¶„ì„ ê°œì„ ** (3-4ì‹œê°„)

---

**ì‘ì„±ì¼**: 2025-10-30  
**ì—…ë°ì´íŠ¸**: í¬ë¡¤ë§ ë˜ëŠ” ì•Œë¦¼í†¡ êµ¬í˜„ ì™„ë£Œ í›„  
**AI**: ì´ ê°€ì´ë“œëŒ€ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ê°œë°œí•˜ì„¸ìš”

