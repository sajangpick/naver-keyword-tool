<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë‰´ìŠ¤ ê´€ë¦¬ - ì‚¬ì¥í”½ ê´€ë¦¬ì</title>
    
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    
    <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="/admin/assets/admin-common.css" />
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
      .news-controls {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
        position: sticky;
        top: var(--header-height, 72px);
        z-index: 90;
        background: white;
        padding: 20px 0;
        margin-top: 0;
        margin-left: -32px;
        margin-right: -32px;
        padding-left: 32px;
        padding-right: 32px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-bottom: 1px solid var(--border);
      }
      
      @media (max-width: 768px) {
        .news-controls {
          top: var(--header-height, 72px);
          margin-left: -20px;
          margin-right: -20px;
          padding-left: 20px;
          padding-right: 20px;
        }
      }

      .naver-section-container {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .naver-section-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        border-bottom: 2px solid var(--border);
        align-items: center;
        justify-content: space-between;
      }

      .naver-section-tab {
        padding: 12px 24px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .naver-section-tab:hover {
        color: var(--accent);
        background: rgba(3, 199, 90, 0.05);
      }

      .naver-section-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
        background: rgba(3, 199, 90, 0.05);
      }

      .naver-sort-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .naver-sort-btn {
        padding: 8px 16px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .naver-sort-btn:hover {
        background: rgba(3, 199, 90, 0.1);
        border-color: var(--accent);
        color: var(--accent);
      }

      .naver-sort-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .naver-section-content {
        display: none;
      }

      .naver-section-content.active {
        display: block;
      }

      .naver-section-group {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fafafa;
        padding: 20px;
      }

      .naver-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .naver-section-title {
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .naver-section-link {
        font-size: 13px;
        color: var(--accent);
        font-weight: 600;
        text-decoration: none;
      }

      .naver-section-link:hover {
        text-decoration: underline;
      }

      .naver-news-meta {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 16px;
      }

      .naver-section-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .naver-section-item {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        padding: 14px 16px;
        position: relative;
      }

      .naver-section-item-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--text);
        line-height: 1.4;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .naver-section-item-title a {
        color: inherit;
        text-decoration: none;
      }

      .naver-section-item-title a:hover {
        text-decoration: underline;
      }

      .naver-section-item-time {
        font-size: 12px;
        color: var(--text-secondary);
        font-weight: 400;
        white-space: nowrap;
      }

      .naver-section-item-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }

      .naver-section-item-summary {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
      }

      .naver-section-item-source {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        word-break: break-all;
      }

      .naver-section-item-source a {
        color: var(--accent);
        text-decoration: none;
        font-weight: 600;
      }

      .naver-section-item-source a:hover {
        text-decoration: underline;
      }

      .naver-section-edit-btn {
        position: absolute;
        top: 14px;
        right: 16px;
        border: 1px solid var(--info);
        background: white;
        color: var(--info);
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
      }

      .naver-section-edit-btn:hover {
        background: rgba(59, 130, 246, 0.08);
      }

      .naver-news-loading {
        display: none !important; /* ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€ (ì‚¬ìš©ì ìš”ì²­) */
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 24px;
        color: var(--text-secondary);
        font-size: 15px;
      }

      .naver-news-error {
        display: none;
        padding: 16px;
        border-radius: 10px;
        background: rgba(239, 68, 68, 0.1);
        color: #b91c1c;
        font-size: 14px;
        font-weight: 600;
        white-space: pre-line;
        line-height: 1.6;
      }

      .naver-news-loading i {
        font-size: 18px;
      }

      .naver-news-meta-view {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        background: #f8f9fb;
        margin-bottom: 20px;
      }

      .naver-news-meta-view h3 {
        font-size: 18px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .naver-news-meta-content {
        display: grid;
        gap: 12px;
        font-size: 14px;
        color: var(--text-secondary);
      }

      .naver-news-meta-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .naver-news-meta-row strong {
        color: var(--text);
      }

      .naver-news-meta-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .naver-news-badge {
        background: white;
        border-radius: 20px;
        border: 1px solid var(--border);
        padding: 4px 10px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
      }

      .category-filter {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .category-btn {
        padding: 8px 16px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }

      .category-btn:hover {
        background: rgba(3, 199, 90, 0.1);
        border-color: var(--accent);
      }

      .category-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .category-selectors {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .category-pill {
        padding: 8px 16px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }

      .category-pill:hover {
        background: rgba(3, 199, 90, 0.1);
        border-color: var(--accent);
      }

      .category-pill.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .news-grid {
        display: grid;
        gap: 16px;
      }

      .news-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        gap: 20px;
        transition: all 0.2s;
      }

      .news-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .panel-sorts {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .sort-btn {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
      }

      .sort-btn.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .sort-btn:hover {
        background: rgba(3, 199, 90, 0.1);
        border-color: var(--accent);
      }

      .panel-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .news-image {
        width: 120px;
        height: 120px;
        border-radius: 8px;
        object-fit: cover;
        background: var(--bg);
        flex-shrink: 0;
      }

      .news-placeholder {
        width: 120px;
        height: 120px;
        border-radius: 8px;
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        flex-shrink: 0;
      }

      .news-content {
        flex: 1;
        min-width: 0;
      }

      .news-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 8px;
      }

      .news-category {
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
      }

      .category-policy { background: #E8F5E9; color: #2E7D32; }
      .category-trend { background: #E3F2FD; color: #1565C0; }
      .category-management { background: #FFF3E0; color: #EF6C00; }
      .category-ingredients { background: #F3E5F5; color: #7B1FA2; }
      .category-technology { background: #FCE4EC; color: #C2185B; }

      .news-featured {
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        background: #FFE082;
        color: #F57F17;
      }

      .news-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text);
      }

      .news-excerpt {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 12px;
        display: -webkit-box;
        line-clamp: 2;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .news-meta {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 12px;
      }

      .news-actions {
        display: flex;
        gap: 8px;
      }

      .news-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
        transition: all 0.2s;
      }

      .news-btn:hover {
        background: var(--bg);
      }

      .news-btn.edit {
        color: var(--info);
        border-color: var(--info);
      }

      .news-btn.edit:hover {
        background: rgba(59, 130, 246, 0.1);
      }

      .news-btn.delete {
        color: var(--danger);
        border-color: var(--danger);
      }

      .news-btn.delete:hover {
        background: rgba(239, 68, 68, 0.1);
      }

      /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      /* AI ë‰´ìŠ¤ í•´ì„ ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
      .ai-analysis-sidebar {
        position: fixed;
        top: 0;
        right: -500px;
        width: 500px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 10001;
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
      }

      .ai-analysis-sidebar.active {
        right: 0;
      }

      .ai-analysis-sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        z-index: 10000;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .ai-analysis-sidebar-overlay.active {
        display: block;
        opacity: 1;
      }

      .ai-analysis-sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--border);
        background: var(--primary);
        color: white;
      }

      .ai-analysis-sidebar-title {
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .ai-analysis-sidebar-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background 0.2s;
      }

      .ai-analysis-sidebar-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .ai-analysis-sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      .ai-analysis-loading {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
      }

      .ai-analysis-loading i {
        font-size: 32px;
        margin-bottom: 16px;
        color: var(--primary);
      }

      .ai-analysis-result {
        line-height: 1.8;
        color: var(--text);
        white-space: pre-wrap;
        word-break: break-word;
      }

      .ai-analysis-result h3 {
        color: var(--primary);
        margin-top: 0;
        margin-bottom: 16px;
        font-size: 20px;
      }

      .ai-analysis-result p {
        margin-bottom: 12px;
      }

      .ai-analysis-result ul,
      .ai-analysis-result ol {
        margin-left: 20px;
        margin-bottom: 12px;
      }

      .ai-analysis-result li {
        margin-bottom: 8px;
      }

      #aiAnalysisEditableContent {
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      #aiAnalysisEditableContent:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(3, 199, 90, 0.1);
        outline: none;
      }

      #aiAnalysisEditableContent:hover {
        border-color: var(--primary);
      }

      #aiEditBtn {
        background: #03c75a !important;
        color: white !important;
        border: 2px solid #03c75a !important;
      }

      #aiEditBtn:hover {
        background: #02b350 !important;
        border-color: #02b350 !important;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(3, 199, 90, 0.35) !important;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 900px;
        max-height: 95vh;
        overflow-y: auto;
        padding: 24px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: none;
        background: var(--bg);
        cursor: pointer;
        font-size: 18px;
        transition: all 0.2s;
      }

      .modal-close:hover {
        background: var(--border);
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text);
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(3, 199, 90, 0.1);
      }

      .form-input-with-action {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .form-input-with-action .form-input {
        flex: 1;
      }

      .form-action-btn {
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid var(--accent);
        background: white;
        color: var(--accent);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .form-action-btn:hover {
        background: rgba(3, 199, 90, 0.1);
      }

      .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }

      .form-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
      }

      .form-checkbox input {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .editor-container {
        height: 200px;
        margin-bottom: 16px;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-primary:hover {
        background: #02b350;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(3, 199, 90, 0.3) !important;
      }

      .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(3, 199, 90, 0.2) !important;
      }

      .btn-secondary {
        background: var(--bg);
        color: var(--text);
      }

      .btn-secondary:hover {
        background: var(--border);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 24px;
      }

      .page-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }

      .page-btn:hover {
        background: var(--bg);
      }

      .page-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .ai-recommend-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        color: white;
      }

      .ai-recommend-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .ai-recommend-desc {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 16px;
      }

      .ai-recommend-btn {
        background: white;
        color: #667eea;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }

      .ai-recommend-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }

      .ai-suggestions {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }

      .ai-suggestion-card {
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .ai-suggestion-card:hover {
        background: rgba(255,255,255,0.2);
        transform: translateX(4px);
      }

      .ai-suggestion-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .ai-suggestion-summary {
        font-size: 13px;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <!-- ì‚¬ì´ë“œë°” ìë™ ìƒì„± -->
    
    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="admin-main">
      <!-- í—¤ë” ìë™ ìƒì„± -->
      
      <div class="content">
        <!-- ë‰´ìŠ¤ ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="ai-recommend-section" id="newsSearchSection">
          <div class="ai-recommend-title">ğŸ” ì†Œìƒê³µì¸ ë‰´ìŠ¤ ê²€ìƒ‰</div>
          <div class="ai-recommend-desc">
            ì •ì±…ì§€ì›ê¸ˆ, ì™¸ì‹ íŠ¸ë Œë“œ, ì„±ê³µì‚¬ë¡€ ë“± ì‹ë‹¹ ëŒ€í‘œë‹˜ê»˜ ìœ ìš©í•œ ìµœì‹  ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”
          </div>
          
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <input 
              type="text" 
              id="newsKeyword" 
              placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì†Œìƒê³µì¸ ì§€ì›ê¸ˆ, ë°°ë‹¬ íŠ¸ë Œë“œ)"
              style="flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
              onkeypress="if(event.key === 'Enter') searchNews()"
            />
            <select 
              id="newsCategory" 
              style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
              onchange="loadCategoryKeywords()"
            >
              <option value="all">ì „ì²´</option>
              <option value="policy">ì •ì±…/ì§€ì›ê¸ˆ</option>
              <option value="trend">ì™¸ì‹ íŠ¸ë Œë“œ</option>
              <option value="success">ì„±ê³µì‚¬ë¡€</option>
              <option value="ingredient">ì‹ì¬ë£Œ/ì›ê°€</option>
              <option value="regulation">ê·œì œ/ì˜ë¬´ì‚¬í•­</option>
            </select>
            <button class="ai-recommend-btn" onclick="searchNews()">
              <i class="fas fa-search"></i> ê²€ìƒ‰
            </button>
          </div>
          
          <div id="keywordSuggestions" style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;"></div>
          <div class="ai-suggestions" id="searchResults"></div>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ -->
        <div class="news-controls">
          <button class="btn btn-primary" onclick="openModal()">
            <i class="fas fa-plus"></i> ìƒˆ ë‰´ìŠ¤ ì‘ì„±
          </button>
          <button class="btn btn-secondary" id="collectNewsButton" onclick="collectNewsData()">
            <i class="fas fa-database"></i> ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘
          </button>
          <button class="btn" id="deleteAllNewsButton" onclick="deleteAllNews()" style="background: #ef4444; color: white; border-color: #ef4444; margin-left: auto;">
            <i class="fas fa-trash-alt"></i> ëª¨ë“  ë‰´ìŠ¤ ì‚­ì œ
          </button>
        </div>

        <!-- ë„¤ì´ë²„ ë‰´ìŠ¤ íŒ¨ë„ -->
        <div class="panel" id="naverNewsPanel" style="display: none;">
          <div class="panel-header">
            <h2 class="panel-title">ğŸŒ ë„¤ì´ë²„ ì†Œìƒê³µì¸ ê´€ë ¨ ë‰´ìŠ¤</h2>
            <div class="naver-news-meta" id="naverNewsTimestamp"></div>
          </div>
          <div class="naver-news-loading" id="naverNewsLoading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>ë„¤ì´ë²„ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
          </div>
          <div class="naver-news-error" id="naverNewsError"></div>
          <div class="naver-section-tabs" id="naverSectionTabs" style="display: none;">
            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
              <button class="naver-section-tab active" data-section="social" onclick="switchNaverSection('social')">
                <span>ğŸ‘¥</span> ì‚¬íšŒ
              </button>
              <button class="naver-section-tab" data-section="economy" onclick="switchNaverSection('economy')">
                <span>ğŸ’°</span> ê²½ì œ
              </button>
            </div>
            <div class="naver-sort-controls" style="display: flex; gap: 8px; align-items: center;">
              <button class="naver-sort-btn active" data-sort="latest" onclick="setNaverSort('latest')">
                <i class="fas fa-clock"></i> ìµœì‹ ìˆœ
              </button>
              <button class="naver-sort-btn" data-sort="views" onclick="setNaverSort('views')">
                <i class="fas fa-eye"></i> ì¡°íšŒìˆœ
              </button>
            </div>
          </div>
          <div class="naver-section-container" id="naverNewsList"></div>
        </div>


      </div>
    </main>

    <!-- ë‰´ìŠ¤ ì‘ì„±/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="newsModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">ìƒˆ ë‰´ìŠ¤ ì‘ì„±</h2>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>

        <form id="newsForm">
          <input type="hidden" id="newsId" />

          <div class="form-group">
            <label class="form-label">ì œëª© *</label>
            <input type="text" class="form-input" id="newsTitle" required placeholder="ë‰´ìŠ¤ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
          </div>

          <div class="form-group">
            <label class="form-label">ì¹´í…Œê³ ë¦¬ *</label>
            <input type="hidden" id="newsCategoryInput" />
            <div class="category-selectors" role="group" aria-label="ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ ì„ íƒ">
              <button type="button" class="category-pill" data-category="policy" onclick="setModalCategory('policy')">ğŸ›ï¸ ì •ì±…/ë²•ê·œ</button>
              <button type="button" class="category-pill" data-category="trend" onclick="setModalCategory('trend')">ğŸ“ˆ íŠ¸ë Œë“œ</button>
              <button type="button" class="category-pill" data-category="management" onclick="setModalCategory('management')">ğŸ’¡ ê²½ì˜ íŒ</button>
              <button type="button" class="category-pill" data-category="ingredients" onclick="setModalCategory('ingredients')">ğŸ½ï¸ ì‹ìì¬</button>
              <button type="button" class="category-pill" data-category="technology" onclick="setModalCategory('technology')">ğŸ› ï¸ ê¸°ìˆ /ë„êµ¬</button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">ì›ë¬¸ ë§í¬</label>
            <div class="form-input-with-action">
              <input type="url" class="form-input" id="newsSource" placeholder="https://example.com/article" />
              <button type="button" class="form-action-btn" onclick="crawlSourceLink()">í¬ë¡¤ë§</button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">ë‚´ìš© *</label>
            <div class="editor-container" id="editor"></div>
          </div>

          <div class="form-group">
            <label class="form-label">ì´ë¯¸ì§€ URL (ì„ íƒ)</label>
            <input type="url" class="form-input" id="newsImage" placeholder="https://example.com/image.jpg" />
          </div>

          <div class="form-checkbox">
            <input type="checkbox" id="newsFeatured" />
            <label for="newsFeatured">â­ ì¤‘ìš” ë‰´ìŠ¤ë¡œ í‘œì‹œ</label>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary">ì €ì¥</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ë„¤ì´ë²„ ë‰´ìŠ¤ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="naverNewsModal">
      <div class="modal-content" style="max-width: 640px;">
        <div class="modal-header">
          <div class="modal-title">ë„¤ì´ë²„ ë‰´ìŠ¤ ìˆ˜ì •</div>
          <button type="button" class="modal-close" onclick="closeNaverNewsModal()">&times;</button>
        </div>
        <div class="naver-news-meta-view" id="naverNewsMetaView" style="display: none;">
          <h3>ğŸ§¾ ê¸°ì‚¬ ì •ë³´</h3>
          <div class="naver-news-meta-content" id="naverNewsMetaContent"></div>
        </div>
        <form id="naverNewsForm">
          <div class="form-group">
            <label class="form-label" for="naverNewsTitle">ì œëª©</label>
            <input id="naverNewsTitle" class="form-input" type="text" />
          </div>
          <div class="form-group">
            <label class="form-label" for="naverNewsLink">ë§í¬</label>
            <input id="naverNewsLink" class="form-input" type="url" />
          </div>
          <div class="form-group">
            <label class="form-label" for="naverNewsPress">ì–¸ë¡ ì‚¬</label>
            <input id="naverNewsPress" class="form-input" type="text" />
          </div>
          <div class="form-group">
            <label class="form-label" for="naverNewsJournalist">ê¸°ì</label>
            <input id="naverNewsJournalist" class="form-input" type="text" />
          </div>
          <div class="form-group">
            <label class="form-label" for="naverNewsPublished">ì…ë ¥ ì‹œê°</label>
            <input id="naverNewsPublished" class="form-input" type="text" />
          </div>
          <div class="form-group">
            <label class="form-label" for="naverNewsModified">ìˆ˜ì • ì‹œê°</label>
            <input id="naverNewsModified" class="form-input" type="text" />
          </div>
          <div class="form-group">
            <label class="form-label" for="naverNewsSource">ì¶œì²˜</label>
            <input id="naverNewsSource" class="form-input" type="text" />
          </div>
          <div class="form-group">
            <label class="form-label" for="naverNewsImage">ì´ë¯¸ì§€ URL</label>
            <div class="form-input-with-action">
              <input id="naverNewsImage" class="form-input" type="url" placeholder="https://example.com/image.jpg" onchange="updateNaverNewsImagePreview(this.value)" onblur="if(this.value.trim()) updateNaverNewsImagePreview(this.value)" />
              <button type="button" class="form-action-btn" onclick="previewNaverNewsImage()">ë¯¸ë¦¬ë³´ê¸°</button>
            </div>
            <div id="naverNewsImagePreview" style="margin-top: 8px; display: none;">
              <img id="naverNewsImagePreviewImg" src="" alt="ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border);" />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="naverNewsSummary">
              <span>ë‚´ìš©</span>
            </label>
            <textarea id="naverNewsSummary" class="form-input" style="min-height: 120px;"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-primary" onclick="analyzeNaverNews()" style="width: 100%; padding: 14px 24px; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(3, 199, 90, 0.2); transition: all 0.3s ease; border: none;">
              <i class="fas fa-brain"></i> AIë‰´ìŠ¤í•´ì„
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- AI ë‰´ìŠ¤ í•´ì„ íŒì—… (ì˜¤ë¥¸ìª½ ìŠ¬ë¼ì´ë“œ) -->
    <div class="ai-analysis-sidebar" id="aiAnalysisSidebar">
      <div class="ai-analysis-sidebar-header">
        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
          <button type="button" class="ai-analysis-sidebar-back" onclick="closeAIAnalysisSidebar()" style="padding: 8px; background: transparent; border: none; color: white; cursor: pointer; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; width: 36px; height: 36px;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
            <i class="fas fa-arrow-left" style="font-size: 18px;"></i>
          </button>
          <div class="ai-analysis-sidebar-title">
            <i class="fas fa-brain"></i> AI ë‰´ìŠ¤ í•´ì„
          </div>
        </div>
        <button type="button" class="ai-analysis-sidebar-close" onclick="closeAIAnalysisSidebar()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="ai-analysis-sidebar-content" id="aiAnalysisContent">
        <div class="ai-analysis-loading" id="aiAnalysisLoading" style="display: none;">
          <i class="fas fa-spinner fa-spin"></i>
          <p>AIê°€ ë‰´ìŠ¤ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>
        <div class="ai-analysis-result" id="aiAnalysisResult"></div>
      </div>
    </div>
    <div class="ai-analysis-sidebar-overlay" id="aiAnalysisOverlay" onclick="closeAIAnalysisSidebar()"></div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/admin/assets/admin-bootstrap.js" defer></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="/admin/assets/admin-sidebar.js"></script>
    <script src="/admin/assets/admin-header.js"></script>
    <script src="/admin/assets/admin-utils.js"></script>
    
    <script>
      // ì¶œì²˜ í¬ë§·íŒ… ê´€ë ¨ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
      function normalizeUrl(value) {
        if (!value) return '';
        const trimmed = value.trim();
        if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) return trimmed;
        if (trimmed.startsWith('//')) return `https:${trimmed}`;
        if (trimmed.startsWith('/')) return `https://news.naver.com${trimmed}`;
        if (trimmed.includes('.')) return `https://${trimmed}`;
        return '';
      }

      function formatPublicationDate(value) {
        if (!value) return '';
        const trimmed = value.trim();
        if (/^\d{4}\.\d{1,2}\.\d{1,2}/.test(trimmed)) return trimmed;
        if (/^\d{4}-\d{1,2}-\d{1,2}/.test(trimmed)) {
          return trimmed.replace(/-/g, '.').replace(/\s+/, ' ');
        }
        return trimmed;
      }

      function buildSourceCitationString({ press, title, publishedAt }) {
        const parts = [];
        if (press && press.trim()) {
          parts.push(press.trim());
        }
        if (title && title.trim()) {
          parts.push(`ã€Œ${title.trim()}ã€`);
        }
        let citation = parts.join(' ');
        const datePart = formatPublicationDate(publishedAt);
        if (datePart) {
          citation = citation ? `${citation} (${datePart})` : `(${datePart})`;
        }
        return citation.trim();
      }

      function splitCitationAndUrl(value) {
        if (!value) return { citation: '', url: '' };
        const urlMatch = value.match(/https?:\/\/\S+/);
        if (!urlMatch) return { citation: value.trim(), url: '' };
        const url = urlMatch[0].replace(/[),.]+$/, '');
        let citation = value.replace(urlMatch[0], '').replace(/[,\s]+$/, '').trim();
        citation = citation.replace(/^ì¶œì²˜[:ï¼š]\s*/i, '').trim();
        return { citation, url };
      }

      function formatSourceDisplay(item) {
        if (!item || typeof item !== 'object') return '';

        const citationBase =
          (item.sourceCitation && item.sourceCitation.trim()) ||
          buildSourceCitationString({
            press: item.press,
            title: item.title,
            publishedAt: item.publishedAt,
          });
        const url = normalizeUrl(item.sourceUrl || item.link || '');

        if (!citationBase && !url) return '';

        let output = 'ì¶œì²˜: ';
        if (citationBase) {
          output += escapeHtml(citationBase);
        }
        if (url) {
          output += citationBase ? ', ' : '';
          output += `<a href="${url}" target="_blank" rel="noopener">${escapeHtml(url)}</a>`;
        }
        return output;
      }

      // ë¡œì»¬ ê°œë°œ í™˜ê²½ê³¼ í”„ë¡œë•ì…˜ í™˜ê²½ ìë™ ê°ì§€
      const isLocalhost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
      const isProduction = !isLocalhost; // ë°°í¬ í™˜ê²½ í™•ì¸
      const API_BASE = isLocalhost ? 'http://localhost:3003' : '';
      // ë°°í¬ í™˜ê²½ì—ì„œëŠ” Vercel í”„ë¡ì‹œë§Œ ì‚¬ìš© (CORS ë¬¸ì œ ë°©ì§€)
      const PRIMARY_RENDER_BASE = isProduction ? null : 'https://naver-keyword-tool.onrender.com';
      const LEGACY_RENDER_BASE = isProduction ? null : 'https://naver-keyword-tool.onrender.com';
      const FALLBACK_RENDER_BASES = [PRIMARY_RENDER_BASE, LEGACY_RENDER_BASE].filter(Boolean);
      const RETRYABLE_STATUS = new Set([404, 408, 500, 502, 503, 504, 521, 522, 523]);
      const NAVER_SECTION_CONFIG = {
        social: {
          label: 'ì‚¬íšŒ',
          icon: 'ğŸ‘¥',
          sectionUrl: 'https://news.naver.com/section/102'
        },
        economy: {
          label: 'ê²½ì œ',
          icon: 'ğŸ’°',
          sectionUrl: 'https://news.naver.com/section/101'
        }
      };

      function cloneRequestOptions(options) {
        if (!options) return undefined;
        const cloned = { ...options };
        if (options.headers instanceof Headers) {
          cloned.headers = new Headers(options.headers);
        } else if (options.headers) {
          cloned.headers = { ...options.headers };
        }

        if (options.body instanceof FormData) {
          const formDataCopy = new FormData();
          options.body.forEach((value, key) => formDataCopy.append(key, value));
          cloned.body = formDataCopy;
        } else if (options.body instanceof URLSearchParams) {
          cloned.body = new URLSearchParams(options.body);
        } else if (options.body instanceof Blob) {
          cloned.body = options.body.slice(0, options.body.size, options.body.type);
        } else if (options.body !== undefined) {
          cloned.body = options.body;
        }

        return cloned;
      }

      async function fetchWithFallback(path, options) {
        const targets = [];

        // ë¡œì»¬ í™˜ê²½: localhost ë¨¼ì € ì‹œë„
        if (API_BASE) {
          targets.push(`${API_BASE}${path}`);
        }
        
        // ë°°í¬ í™˜ê²½: Vercel í”„ë¡ì‹œ ê²½ë¡œë§Œ ì‚¬ìš© (CORS ë¬¸ì œ ë°©ì§€)
        // ë¡œì»¬ í™˜ê²½: Vercel í”„ë¡ì‹œ ê²½ë¡œë„ ì‹œë„ (ì„œë²„ê°€ ì—†ì„ ë•Œ)
        if (!API_BASE || isLocalhost) {
          targets.push(path); // Vercel í”„ë¡ì‹œ ê²½ë¡œ: /api/naver-section-news
        }

        // ë¡œì»¬ í™˜ê²½ì—ì„œë§Œ ì§ì ‘ Render ì„œë²„ ì—°ê²° ì‹œë„ (fallback)
        if (isLocalhost && FALLBACK_RENDER_BASES.length > 0) {
          FALLBACK_RENDER_BASES.forEach((host) => {
            if (!host) return;
            const absolutePath = `${host}${path}`;
            if (!targets.includes(absolutePath)) {
              targets.push(absolutePath);
            }
          });
        }

        console.log(`[fetchWithFallback] ìš”ì²­ ëŒ€ìƒ: ${targets.join(', ')}`);

        let lastError = null;
        let lastResponse = null;

        for (let index = 0; index < targets.length; index += 1) {
          const target = targets[index];

          try {
            // signalì´ ìˆìœ¼ë©´ ì·¨ì†Œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (options?.signal?.aborted) {
              throw new DOMException('ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'AbortError');
            }

            console.log(`[fetchWithFallback] ì‹œë„ ${index + 1}/${targets.length}: ${target}`);
            const response = await fetch(target, cloneRequestOptions(options));

            if (response.ok) {
              console.log(`[fetchWithFallback] ì„±ê³µ: ${target}`);
              return response;
            }

            console.warn(`[fetchWithFallback] ì‹¤íŒ¨ (${response.status}): ${target}`);
            lastResponse = response;

            if (RETRYABLE_STATUS.has(response.status) && index < targets.length - 1) {
              console.log(`[fetchWithFallback] ì¬ì‹œë„ ê°€ëŠ¥í•œ ìƒíƒœ ì½”ë“œ: ${response.status}`);
              continue;
            }

            return response;
          } catch (error) {
            // AbortErrorì¸ ê²½ìš° ì¦‰ì‹œ ì¤‘ë‹¨
            if (error.name === 'AbortError' || options?.signal?.aborted) {
              throw error;
            }
            console.error(`[fetchWithFallback] ì—ëŸ¬ (${target}):`, error);
            lastError = error;
          }
        }

        if (lastResponse) {
          console.error(`[fetchWithFallback] ëª¨ë“  ì‹œë„ ì‹¤íŒ¨, ë§ˆì§€ë§‰ ì‘ë‹µ ë°˜í™˜: ${lastResponse.status}`);
          return lastResponse;
        }
        if (lastError) {
          console.error(`[fetchWithFallback] ëª¨ë“  ì‹œë„ ì‹¤íŒ¨, ì—ëŸ¬ ë°œìƒ:`, lastError);
          throw lastError;
        }
        throw new Error('API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

    function buildNewsSectionHtml(sectionKey, items = []) {
      const config = NAVER_SECTION_CONFIG[sectionKey];
      if (!config) return '';

      if (!Array.isArray(items) || items.length === 0) {
        return `
          <div class="naver-section-content" data-section="${sectionKey}">
            <div class="naver-section-group">
              <div class="naver-section-header">
                <div class="naver-section-title">${config.icon} ${config.label} ì£¼ìš” ë‰´ìŠ¤</div>
                <a class="naver-section-link" href="${config.sectionUrl}" target="_blank" rel="noopener">ì„¹ì…˜ ë°”ë¡œê°€ê¸°</a>
              </div>
              <div class="naver-section-item-summary">í‘œì‹œí•  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
            </div>
          </div>
        `;
      }

      // ì •ë ¬ ì ìš©
      const sortedItems = sortNaverNewsItems(items);

      // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
      const totalPages = Math.ceil(sortedItems.length / ITEMS_PER_PAGE);
      const startIndex = (currentNaverPage - 1) * ITEMS_PER_PAGE;
      const endIndex = startIndex + ITEMS_PER_PAGE;
      const paginatedItems = sortedItems.slice(startIndex, endIndex);

      const listHtml = paginatedItems.map((item, index) => {
        const globalIndex = startIndex + index;
        const order = startIndex + index + 1; // ì „ì²´ ìˆœë²ˆ í‘œì‹œ
        const titleText = escapeHtml(item?.title || '');
        const summary = item?.summary ? escapeHtml(item.summary) : '';
        const press = item?.press ? escapeHtml(item.press) : '';
        const journalist = item?.journalist ? escapeHtml(item.journalist) : '';
        const published = item?.publishedAt ? escapeHtml(item.publishedAt) : '';
        const modified = item?.modifiedAt ? escapeHtml(item.modifiedAt) : '';
        const sourceDisplay = formatSourceDisplay(item);

        let linkHtml = titleText;
        if (item?.link) {
          const safeLink = item.link.startsWith('http')
            ? item.link
            : `https://news.naver.com${item.link}`;
          linkHtml = `<a href="${safeLink}" target="_blank" rel="noopener">${titleText}</a>`;
        }

        // ì‹œê°„ í¬ë§·íŒ…
        let timeDisplay = '';
        
        // publishedAtì´ ì´ë¯¸ "2025.11.11. ì˜¤í›„ 4:58" í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        if (published) {
          // ì´ë¯¸ í¬ë§·íŒ…ëœ í˜•ì‹ì¸ì§€ í™•ì¸ (ì˜ˆ: "2025.11.11. ì˜¤í›„ 4:58")
          if (/^\d{4}\.\d{2}\.\d{2}\. (ì˜¤ì „|ì˜¤í›„) \d{1,2}:\d{2}$/.test(published)) {
            timeDisplay = `<span class="naver-section-item-time">${published}</span>`;
          } else {
            // í¬ë§·íŒ…ë˜ì§€ ì•Šì€ ê²½ìš° íŒŒì‹± ì‹œë„
            try {
              // "2025-11-12 00:06:32" í˜•ì‹ì¸ì§€ í™•ì¸
              let dateToParse = published;
              if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(published)) {
                dateToParse = published.replace(' ', 'T');
              }
              const publishedDate = new Date(dateToParse);
              if (!Number.isNaN(publishedDate.getTime())) {
                const year = publishedDate.getFullYear();
                const month = String(publishedDate.getMonth() + 1).padStart(2, '0');
                const day = String(publishedDate.getDate()).padStart(2, '0');
                const hours = publishedDate.getHours();
                const minutes = String(publishedDate.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
                const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
                const timeText = `${year}.${month}.${day}. ${ampm} ${displayHours}:${minutes}`;
                timeDisplay = `<span class="naver-section-item-time">${timeText}</span>`;
              } else {
                // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë¬¸ìì—´ ì‚¬ìš©
                timeDisplay = `<span class="naver-section-item-time">${published}</span>`;
              }
            } catch (e) {
              // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë¬¸ìì—´ ì‚¬ìš©
              timeDisplay = `<span class="naver-section-item-time">${published}</span>`;
            }
          }
        } else if (item?._collectedAt) {
          // publishedAtì´ ì—†ìœ¼ë©´ _collectedAt ì‚¬ìš©
          const collectedDate = new Date(item._collectedAt);
          if (!Number.isNaN(collectedDate.getTime())) {
            const year = collectedDate.getFullYear();
            const month = String(collectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(collectedDate.getDate()).padStart(2, '0');
            const hours = collectedDate.getHours();
            const minutes = String(collectedDate.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
            const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
            const timeText = `${year}.${month}.${day}. ${ampm} ${displayHours}:${minutes}`;
            timeDisplay = `<span class="naver-section-item-time">${timeText}</span>`;
          }
        }

        const metaParts = [];
        if (press) metaParts.push(`ğŸ—ï¸ ${press}`);
        if (journalist) metaParts.push(`âœï¸ ${journalist}`);
        if (published) metaParts.push(`ğŸ“† ${published}`);
        if (modified) metaParts.push(`ğŸ› ï¸ ${modified}`);

        return `
          <div class="naver-section-item">
            <button class="naver-section-edit-btn" onclick="openNaverNewsModal('${sectionKey}', ${globalIndex})">
              <i class="fas fa-edit"></i> ìˆ˜ì •
            </button>
            <div class="naver-section-item-title">
              <span>${order}. ${linkHtml}</span>
              ${timeDisplay}
            </div>
            ${metaParts.length > 0 ? `<div class="naver-section-item-meta">${metaParts.map((part) => `<span>${part}</span>`).join('')}</div>` : ''}
            ${sourceDisplay ? `<div class="naver-section-item-source">${sourceDisplay}</div>` : ''}
            ${summary ? `<div class="naver-section-item-summary">${summary}</div>` : ''}
          </div>
        `;
      }).join('');

      return `
        <div class="naver-section-content" data-section="${sectionKey}">
          <div class="naver-section-group">
            <div class="naver-section-header">
              <div class="naver-section-title">${config.icon} ${config.label} ì£¼ìš” ë‰´ìŠ¤</div>
              <a class="naver-section-link" href="${config.sectionUrl}" target="_blank" rel="noopener">ì„¹ì…˜ ë°”ë¡œê°€ê¸°</a>
            </div>
            <div class="naver-section-list">
              ${listHtml}
            </div>
            ${totalPages > 1 ? buildPaginationHtml(sectionKey, currentNaverPage, totalPages) : ''}
          </div>
        </div>
      `;
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ HTML ìƒì„±
    function buildPaginationHtml(sectionKey, currentPage, totalPages) {
      let paginationHtml = '<div class="pagination" style="margin-top: 24px; display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;">';
      
      // ì´ì „ í˜ì´ì§€ í™”ì‚´í‘œ
      if (currentPage > 1) {
        paginationHtml += `<button class="page-btn" onclick="goToNaverPage(${currentPage - 1})" title="ì´ì „ í˜ì´ì§€">
          <i class="fas fa-chevron-left"></i>
        </button>`;
      } else {
        paginationHtml += `<button class="page-btn" disabled style="opacity: 0.3; cursor: not-allowed;">
          <i class="fas fa-chevron-left"></i>
        </button>`;
      }

      // í˜ì´ì§€ ë²ˆí˜¸ í‘œì‹œ (1~10 ë˜ëŠ” í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€)
      const maxPagesToShow = 10;
      let startPage = 1;
      let endPage = Math.min(maxPagesToShow, totalPages);

      if (totalPages > maxPagesToShow) {
        if (currentPage > 6) {
          startPage = currentPage - 4;
          endPage = Math.min(currentPage + 5, totalPages);
          
          // ì²« í˜ì´ì§€ í‘œì‹œ
          if (startPage > 1) {
            paginationHtml += `<button class="page-btn ${1 === currentPage ? 'active' : ''}" onclick="goToNaverPage(1)">1</button>`;
            if (startPage > 2) {
              paginationHtml += `<span style="padding: 0 4px;">...</span>`;
            }
          }
        }
      }

      // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ë“¤
      for (let i = startPage; i <= endPage; i++) {
        paginationHtml += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToNaverPage(${i})">${i}</button>`;
      }

      // ë§ˆì§€ë§‰ í˜ì´ì§€ í‘œì‹œ (10ê°œ ì´ìƒì¼ ë•Œ)
      if (totalPages > maxPagesToShow && endPage < totalPages) {
        if (endPage < totalPages - 1) {
          paginationHtml += `<span style="padding: 0 4px;">...</span>`;
        }
        paginationHtml += `<button class="page-btn ${totalPages === currentPage ? 'active' : ''}" onclick="goToNaverPage(${totalPages})">${totalPages}</button>`;
      }

      // ë‹¤ìŒ í˜ì´ì§€ í™”ì‚´í‘œ
      if (currentPage < totalPages) {
        paginationHtml += `<button class="page-btn" onclick="goToNaverPage(${currentPage + 1})" title="ë‹¤ìŒ í˜ì´ì§€">
          <i class="fas fa-chevron-right"></i>
        </button>`;
      } else {
        paginationHtml += `<button class="page-btn" disabled style="opacity: 0.3; cursor: not-allowed;">
          <i class="fas fa-chevron-right"></i>
        </button>`;
      }

      paginationHtml += '</div>';
      return paginationHtml;
    }

    // í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
    function goToNaverPage(page) {
      if (page < 1) return;
      
      const sections = naverSectionData.sections || {};
      const currentSectionItems = sections[currentNaverSection] || [];
      const totalPages = Math.ceil(currentSectionItems.length / ITEMS_PER_PAGE);
      
      if (page > totalPages) return;
      
      currentNaverPage = page;
      renderNaverNews();
      
      // í˜ì´ì§€ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      const list = document.getElementById('naverNewsList');
      if (list) {
        list.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    let currentNaverSection = 'social'; // ê¸°ë³¸ê°’: ì‚¬íšŒ
    let currentNaverSort = 'latest'; // ê¸°ë³¸ê°’: ìµœì‹ ìˆœ
    let currentNaverPage = 1; // í˜„ì¬ í˜ì´ì§€
    const ITEMS_PER_PAGE = 10; // í˜ì´ì§€ë‹¹ ì•„ì´í…œ ìˆ˜

    function switchNaverSection(sectionKey) {
      currentNaverSection = sectionKey;
      currentNaverPage = 1; // ì„¹ì…˜ ë³€ê²½ ì‹œ ì²« í˜ì´ì§€ë¡œ ë¦¬ì…‹
      
      // íƒ­ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.naver-section-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.section === sectionKey);
      });
      
      // ì„¹ì…˜ ì½˜í…ì¸  í‘œì‹œ/ìˆ¨ê¹€
      document.querySelectorAll('.naver-section-content').forEach(content => {
        content.classList.toggle('active', content.dataset.section === sectionKey);
      });
    }

    function setNaverSort(sort) {
      // ê°™ì€ ì •ë ¬ì„ ì„ íƒí•´ë„ ë‹¤ì‹œ ë Œë”ë§ (ì‚¬ìš©ìê°€ ë‹¤ì‹œ ì •ë ¬í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆìŒ)
      currentNaverSort = sort;

      // ì •ë ¬ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.naver-sort-btn').forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.sort === sort);
      });

      // í˜ì´ì§€ë¥¼ 1ë¡œ ë¦¬ì…‹ (ì •ë ¬ ë³€ê²½ ì‹œ ì²« í˜ì´ì§€ë¡œ)
      currentNaverPage = 1;

      // ë‰´ìŠ¤ ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
      renderNaverNews();
      
      // ì •ë ¬ ì™„ë£Œ ë©”ì‹œì§€ (ì„ íƒì‚¬í•­)
      console.log(`âœ… ì •ë ¬ ì™„ë£Œ: ${sort === 'latest' ? 'ìµœì‹ ìˆœ' : 'ì¡°íšŒìˆœ'}`);
    }

    // ë‰´ìŠ¤ ì•„ì´í…œ ì •ë ¬ í•¨ìˆ˜
    function sortNaverNewsItems(items) {
      if (!Array.isArray(items) || items.length === 0) {
        return items;
      }

      const sorted = [...items];

      if (currentNaverSort === 'views') {
        // ì¡°íšŒìˆœ ì •ë ¬ (ì¡°íšŒìˆ˜ê°€ ë†’ì€ ìˆœ)
        sorted.sort((a, b) => {
          const viewsA = parseInt(a.views || a.viewCount || 0);
          const viewsB = parseInt(b.views || b.viewCount || 0);
          // ì¡°íšŒìˆ˜ê°€ ê°™ìœ¼ë©´ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
          if (viewsA === viewsB) {
            const dateA = new Date(a.publishedAt || a._collectedAt || 0);
            const dateB = new Date(b.publishedAt || b._collectedAt || 0);
            return dateB.getTime() - dateA.getTime();
          }
          return viewsB - viewsA;
        });
      } else {
        // ìµœì‹ ìˆœ ì •ë ¬ (ë°œí–‰ì¼ì´ ìµœì‹ ì¸ ìˆœ) - ê¸°ë³¸ê°’
        sorted.sort((a, b) => {
          // publishedAtì„ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ _collectedAt ì‚¬ìš©
          let dateA = null;
          let dateB = null;
          
          // publishedAt íŒŒì‹± ì‹œë„
          if (a.publishedAt) {
            // "2025.11.13. ì˜¤ì „ 5:00" í˜•ì‹ì¸ ê²½ìš°
            if (typeof a.publishedAt === 'string' && a.publishedAt.includes('.')) {
              try {
                // "2025.11.13. ì˜¤ì „ 5:00" -> "2025-11-13 05:00" ë³€í™˜
                const dateStr = a.publishedAt
                  .replace(/(\d{4})\.(\d{1,2})\.(\d{1,2})\.\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2})/, (match, year, month, day, ampm, hour, minute) => {
                    let h = parseInt(hour);
                    if (ampm === 'ì˜¤í›„' && h !== 12) h += 12;
                    if (ampm === 'ì˜¤ì „' && h === 12) h = 0;
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${h.toString().padStart(2, '0')}:${minute}:00`;
                  });
                dateA = new Date(dateStr);
              } catch (e) {
                dateA = new Date(a.publishedAt);
              }
            } else {
              dateA = new Date(a.publishedAt);
            }
          }
          
          if (b.publishedAt) {
            if (typeof b.publishedAt === 'string' && b.publishedAt.includes('.')) {
              try {
                const dateStr = b.publishedAt
                  .replace(/(\d{4})\.(\d{1,2})\.(\d{1,2})\.\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2})/, (match, year, month, day, ampm, hour, minute) => {
                    let h = parseInt(hour);
                    if (ampm === 'ì˜¤í›„' && h !== 12) h += 12;
                    if (ampm === 'ì˜¤ì „' && h === 12) h = 0;
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${h.toString().padStart(2, '0')}:${minute}:00`;
                  });
                dateB = new Date(dateStr);
              } catch (e) {
                dateB = new Date(b.publishedAt);
              }
            } else {
              dateB = new Date(b.publishedAt);
            }
          }
          
          // publishedAtì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ _collectedAt ì‚¬ìš©
          if (!dateA || isNaN(dateA.getTime())) {
            dateA = a._collectedAt ? new Date(a._collectedAt) : new Date(0);
          }
          if (!dateB || isNaN(dateB.getTime())) {
            dateB = b._collectedAt ? new Date(b._collectedAt) : new Date(0);
          }
          
          // ìµœì‹ ì´ ìœ„ë¡œ (í° ê°’ì´ ìœ„ë¡œ)
          return dateB.getTime() - dateA.getTime();
        });
      }

      return sorted;
    }

    // localStorageì— ë„¤ì´ë²„ ë‰´ìŠ¤ ë°ì´í„° ì €ì¥
    function saveNaverNewsToStorage() {
      try {
        const dataToSave = {
          sections: naverSectionData.sections,
          fetchedAt: naverSectionData.fetchedAt instanceof Date 
            ? naverSectionData.fetchedAt.toISOString() 
            : (naverSectionData.fetchedAt || null)
        };
        
        // ì €ì¥ ì „ ë°ì´í„° í™•ì¸
        const totalCount = Object.keys(dataToSave.sections || {}).reduce((sum, key) => {
          const items = dataToSave.sections[key] || [];
          return sum + (Array.isArray(items) ? items.length : 0);
        }, 0);
        
        localStorage.setItem('naverNewsData', JSON.stringify(dataToSave));
        
        console.log(`ğŸ’¾ localStorage ì €ì¥ ì„±ê³µ: ì´ ${totalCount}ê°œì˜ ë‰´ìŠ¤ ì €ì¥ë¨`);
        return true;
      } catch (error) {
        console.error('âŒ ë„¤ì´ë²„ ë‰´ìŠ¤ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
        // ì €ì¥ ì‹¤íŒ¨ ì‹œì—ë„ ê³„ì† ì§„í–‰ (ì•ˆì „)
        return false;
      }
    }

    // localStorageì—ì„œ ë„¤ì´ë²„ ë‰´ìŠ¤ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadNaverNewsFromStorage() {
      try {
        const savedData = localStorage.getItem('naverNewsData');
        if (savedData) {
          const parsed = JSON.parse(savedData);
          const sections = parsed.sections || {};
          
          // í—¤ë“œë¼ì¸ ì„¹ì…˜ ì œê±° (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
          if (sections.headline) {
            delete sections.headline;
          }
          
          // NAVER_SECTION_CONFIGì— ì •ì˜ëœ ì„¹ì…˜ë§Œ ìœ ì§€
          const validSections = {};
          Object.keys(NAVER_SECTION_CONFIG).forEach(key => {
            if (sections[key] && Array.isArray(sections[key])) {
              validSections[key] = sections[key];
            }
          });
          
          naverSectionData.sections = validSections;
          if (parsed.fetchedAt) {
            const date = new Date(parsed.fetchedAt);
            naverSectionData.fetchedAt = Number.isNaN(date.getTime()) ? null : date;
          } else {
            naverSectionData.fetchedAt = null;
          }
          
          // ì •ë¦¬ëœ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì €ì¥
          if (Object.keys(validSections).length > 0) {
            saveNaverNewsToStorage();
            
            const totalCount = Object.keys(validSections).reduce((sum, key) => {
              const items = validSections[key] || [];
              return sum + (Array.isArray(items) ? items.length : 0);
            }, 0);
            
            console.log(`ğŸ“¥ localStorageì—ì„œ ë‰´ìŠ¤ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ì´ ${totalCount}ê°œ`);
            return true;
          }
          
          return false;
        }
      } catch (error) {
        console.error('âŒ ë„¤ì´ë²„ ë‰´ìŠ¤ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
      }
      return false;
    }

    function renderNaverNews() {
      const list = document.getElementById('naverNewsList');
      const timestampEl = document.getElementById('naverNewsTimestamp');
      const tabsEl = document.getElementById('naverSectionTabs');
      if (!list || !timestampEl) return;

      if (naverSectionData.fetchedAt instanceof Date) {
        timestampEl.textContent = `ê°€ì ¸ì˜¨ ì‹œê°: ${naverSectionData.fetchedAt.toLocaleString('ko-KR')}`;
      } else {
        timestampEl.textContent = '';
      }

      const sections = naverSectionData.sections || {};
      
      // í—¤ë“œë¼ì¸ ì„¹ì…˜ ì œê±° (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
      if (sections.headline) {
        delete sections.headline;
      }
      
      ensureNaverSectionDefaults();
      
      // NAVER_SECTION_CONFIGì— ì •ì˜ëœ ì„¹ì…˜ë§Œ ì‚¬ìš©
      const sectionHtml = Object.keys(NAVER_SECTION_CONFIG)
        .map((key) => {
          const items = sections[key] || [];
          return buildNewsSectionHtml(key, items);
        })
        .join('');

      if (sectionHtml.trim()) {
        list.innerHTML = sectionHtml;
        
        // íƒ­ í‘œì‹œ
        if (tabsEl) {
          tabsEl.style.display = 'flex';
        }
        
        // ê¸°ë³¸ì ìœ¼ë¡œ ì²« ë²ˆì§¸ ì„¹ì…˜(ì‚¬íšŒ) í™œì„±í™”
        switchNaverSection(currentNaverSection);
      } else {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“°</div>
            <div>í‘œì‹œí•  ë„¤ì´ë²„ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div style="margin-top: 8px; font-size: 14px; color: #666;">"ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”.</div>
          </div>
        `;
        if (tabsEl) {
          tabsEl.style.display = 'none';
        }
      }

      // ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ localStorageì— ì €ì¥ (ë‰´ìŠ¤ê°€ ê³„ì† ìœ ì§€ë˜ë„ë¡)
      saveNaverNewsToStorage();
    }

    function ensureNaverSectionDefaults() {
      if (!naverSectionData.sections || typeof naverSectionData.sections !== 'object') {
        return;
      }

      Object.keys(naverSectionData.sections).forEach((key) => {
        const items = naverSectionData.sections[key];
        if (!Array.isArray(items)) return;

        items.forEach((item) => {
          if (item && typeof item === 'object') {
            const normalizedUrl = normalizeUrl(item.sourceUrl || item.source || item.link || '');
            item.sourceUrl = normalizedUrl;
            item.source = normalizedUrl;
            if (item.sourceCitation) {
              const { citation, url } = splitCitationAndUrl(item.sourceCitation);
              item.sourceCitation = citation;
              if (!item.sourceUrl && url) {
                item.sourceUrl = normalizeUrl(url);
                item.source = item.sourceUrl;
              }
            }
            if (!item.journalist) {
              item.journalist = '';
            }
            if (!item.publishedAt) {
              item.publishedAt = item.datetime || '';
            }
            if (!item.modifiedAt) {
              item.modifiedAt = '';
            }
            if (item.datetime) {
              delete item.datetime;
            }
            if (!item.sourceCitation) {
              item.sourceCitation = buildSourceCitationString({
                press: item.press,
                title: item.title,
                publishedAt: item.publishedAt,
              });
            }
          }
        });
      });
    }

    // ì§„í–‰ ì¤‘ì¸ ìš”ì²­ ì·¨ì†Œë¥¼ ìœ„í•œ ë³€ìˆ˜
    let collectNewsAbortController = null;

    async function collectNewsData() {
      const button = document.getElementById('collectNewsButton');
      const panel = document.getElementById('naverNewsPanel');
      const list = document.getElementById('naverNewsList');
      const loadingEl = document.getElementById('naverNewsLoading');
      const errorEl = document.getElementById('naverNewsError');
      const timestampEl = document.getElementById('naverNewsTimestamp');

      if (!panel || !list || !loadingEl || !errorEl || !timestampEl) {
        console.warn('ë„¤ì´ë²„ ë‰´ìŠ¤ ì˜ì—­ì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ì´ë¯¸ ì§„í–‰ ì¤‘ì´ë©´ ì·¨ì†Œ
      if (collectNewsAbortController) {
        collectNewsAbortController.abort();
        collectNewsAbortController = null;
        if (button) {
          button.disabled = false;
          button.innerHTML = '<i class="fas fa-database"></i> ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘';
        }
        return;
      }

      panel.style.display = 'block';
      // ë¦¬ìŠ¤íŠ¸ë¥¼ ë¹„ìš°ì§€ ì•Šê³  ê¸°ì¡´ ë°ì´í„° ìœ ì§€
      errorEl.style.display = 'none';
      errorEl.textContent = '';
      // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€ (ì‚¬ìš©ì ìš”ì²­)
      loadingEl.style.display = 'none';

      // AbortController ìƒì„±
      collectNewsAbortController = new AbortController();

      // ì›ë˜ ë²„íŠ¼ ìƒíƒœ ì €ì¥ (í•¨ìˆ˜ ìŠ¤ì½”í”„ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
      let originalButtonText = button ? button.innerHTML : '';
      let originalButtonOnclick = button ? button.onclick : null;

      if (button) {
        button.disabled = false; // ì·¨ì†Œë¥¼ ìœ„í•´ ë¹„í™œì„±í™”í•˜ì§€ ì•ŠìŒ
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (í´ë¦­í•˜ì—¬ ì·¨ì†Œ)';
        button.style.cursor = 'pointer';
        button.onclick = () => {
          if (collectNewsAbortController) {
            collectNewsAbortController.abort();
            collectNewsAbortController = null;
            // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
            button.disabled = false;
            button.innerHTML = originalButtonText || '<i class="fas fa-database"></i> ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘';
            button.onclick = originalButtonOnclick || collectNewsData;
            button.style.cursor = 'pointer';
            errorEl.textContent = 'ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            errorEl.style.display = 'block';
          }
        };
      }

      try {
        // ê¸°ì¡´ ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸° (localStorageì—ì„œ)
        const hasExistingData = loadNaverNewsFromStorage();
        const existingSections = hasExistingData ? (naverSectionData.sections || {}) : {};
        
        // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¨¼ì € í‘œì‹œ (ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì—ë„ ë‰´ìŠ¤ê°€ ë³´ì´ë„ë¡)
        if (hasExistingData && Object.keys(existingSections).length > 0) {
          naverSectionData.sections = existingSections;
          renderNaverNews();
          console.log('âœ… ê¸°ì¡´ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¨¼ì € í‘œì‹œí–ˆìŠµë‹ˆë‹¤.');
        }
        
        // íƒ€ì„ì•„ì›ƒ 2ë¶„ìœ¼ë¡œ ì„¤ì •
        console.log('ğŸ”„ API í˜¸ì¶œ ì‹œì‘: /api/naver-section-news');
        // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        const cacheBuster = `?t=${Date.now()}`;
        const result = await fetchJson(`/api/naver-section-news${cacheBuster}`, {
          signal: collectNewsAbortController.signal,
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache'
          }
        }, 120000);

        console.log('âœ… API ì‘ë‹µ ë°›ìŒ:', {
          success: result.success,
          hasData: !!result.data,
          dataKeys: result.data ? Object.keys(result.data) : [],
          counts: result.counts,
          errors: result.errors
        });

        if (!result.success) {
          console.error('âŒ API í˜¸ì¶œ ì‹¤íŒ¨:', result.error);
          throw new Error(result.error || 'ë„¤ì´ë²„ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }

        // APIê°€ ì„±ê³µí–ˆìœ¼ë©´ ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸° (ë°ì´í„°ê°€ ì—†ì–´ë„ ì •ìƒ ì²˜ë¦¬)
        errorEl.style.display = 'none';
        errorEl.textContent = '';
        
        // result.dataê°€ ì—†ì–´ë„ ì •ìƒ ì²˜ë¦¬ (ë¹ˆ ê°ì²´ë¡œ ì²˜ë¦¬)
        if (!result.data) {
          console.warn('âš ï¸ ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¹ˆ ë°ì´í„°ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.');
          // ì—ëŸ¬ë¥¼ throwí•˜ì§€ ì•Šê³  ë¹ˆ ê°ì²´ë¡œ ì²˜ë¦¬
          // ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ë˜ë¯€ë¡œ ë¬¸ì œì—†ìŒ
          // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
          if (button) {
            button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ë°ì´í„° ì—†ìŒ';
            button.style.background = '#ef4444';
            button.style.color = 'white';
            setTimeout(() => {
              button.innerHTML = originalButtonText || '<i class="fas fa-database"></i> ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘';
              button.style.background = '';
              button.style.color = '';
            }, 3000);
          }
          errorEl.textContent = 'âš ï¸ ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\nì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
          errorEl.style.display = 'block';
          errorEl.style.background = 'rgba(239, 68, 68, 0.1)';
          errorEl.style.borderColor = '#ef4444';
          return; // ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ
        }
        
        // ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        const hasAnyData = Object.keys(NAVER_SECTION_CONFIG).some(key => {
          const items = newSections[key] || [];
          return items.length > 0;
        });
        
        if (!hasAnyData) {
          console.warn('âš ï¸ API ì‘ë‹µì€ ì„±ê³µí–ˆì§€ë§Œ ëª¨ë“  ì„¹ì…˜ì˜ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
          if (button) {
            button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ë°ì´í„° ì—†ìŒ';
            button.style.background = '#ef4444';
            button.style.color = 'white';
            setTimeout(() => {
              button.innerHTML = originalButtonText || '<i class="fas fa-database"></i> ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘';
              button.style.background = '';
              button.style.color = '';
            }, 3000);
          }
          errorEl.textContent = 'âš ï¸ API ì‘ë‹µì€ ì„±ê³µí–ˆì§€ë§Œ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.\n\nì„œë²„ì˜ í¬ë¡¤ë§ ë¡œì§ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
          errorEl.style.display = 'block';
          errorEl.style.background = 'rgba(239, 68, 68, 0.1)';
          errorEl.style.borderColor = '#ef4444';
          return; // ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ
        }

        // fetchedAtì„ í•­ìƒ í˜„ì¬ ì‹œê°ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ë°ì´í„° ìˆ˜ì§‘ ì‹œê°)
        const now = new Date();
        naverSectionData.fetchedAt = now;
        
        // ìƒˆë¡œìš´ ë°ì´í„°ì™€ ê¸°ì¡´ ë°ì´í„° ë³‘í•© (ìµœì‹  ë°ì´í„°ê°€ ìœ„ë¡œ ì˜¤ë„ë¡)
        const newSections = result.data || {};
        
        // API ì‘ë‹µì—ì„œ counts ì •ë³´ í™•ì¸
        if (result.counts) {
          console.log('í¬ë¡¤ë§ ê²°ê³¼:', {
            ì‚¬íšŒ: result.counts.social,
            ê²½ì œ: result.counts.economy,
            ì „ì²´: result.counts.total,
          });
        }

        // ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ë¡œê·¸ ì¶œë ¥
        if (result.errors) {
          console.warn('í¬ë¡¤ë§ ì¤‘ ì¼ë¶€ ì—ëŸ¬ ë°œìƒ:', result.errors);
        }
        
        // ê° ì„¹ì…˜ë³„ë¡œ ë³‘í•©
        let totalNewItems = 0;
        let totalExistingItems = 0;
        
        Object.keys(NAVER_SECTION_CONFIG).forEach(sectionKey => {
          const newItems = newSections[sectionKey] || [];
          const existingItems = existingSections[sectionKey] || [];
          
          console.log(`ğŸ“Š ${sectionKey} ì„¹ì…˜: ìƒˆ ë°ì´í„° ${newItems.length}ê°œ, ê¸°ì¡´ ë°ì´í„° ${existingItems.length}ê°œ`);
          
          // ìƒˆ ë°ì´í„°ì˜ ë§í¬ ëª©ë¡ ì¶œë ¥ (ë””ë²„ê¹…)
          if (newItems.length > 0) {
            console.log(`ğŸ”— ìƒˆ ë°ì´í„° ë§í¬ ìƒ˜í”Œ (ìµœëŒ€ 5ê°œ):`, newItems.slice(0, 5).map(item => item?.link || 'ë§í¬ ì—†ìŒ'));
          }
          
          // ê¸°ì¡´ ë°ì´í„°ì˜ ë§í¬ ëª©ë¡ ìƒ˜í”Œ ì¶œë ¥ (ë””ë²„ê¹…)
          if (existingItems.length > 0) {
            const existingLinks = existingItems.slice(0, 5).map(item => item?.link || 'ë§í¬ ì—†ìŒ');
            console.log(`ğŸ”— ê¸°ì¡´ ë°ì´í„° ë§í¬ ìƒ˜í”Œ (ìµœëŒ€ 5ê°œ):`, existingLinks);
          }
          
          // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ Set (ë§í¬ ê¸°ì¤€)
          const linkSet = new Set();
          const mergedItems = [];
          
          // ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ë¨¼ì € ì¶”ê°€ (ìµœì‹ ì´ ìœ„ë¡œ)
          let newAddedCount = 0;
          let duplicateCount = 0;
          newItems.forEach(item => {
            const link = item?.link || '';
            if (!link) {
              console.warn(`âš ï¸ ë§í¬ê°€ ì—†ëŠ” ìƒˆ ì•„ì´í…œ ë°œê²¬:`, item?.title || 'ì œëª© ì—†ìŒ');
              return;
            }
            if (!linkSet.has(link)) {
              linkSet.add(link);
              mergedItems.push({
                ...item,
                _collectedAt: now.getTime() // ìˆ˜ì§‘ ì‹œê° ì¶”ê°€
              });
              newAddedCount++;
            } else {
              duplicateCount++;
            }
          });
          
          if (duplicateCount > 0) {
            console.log(`ğŸ”„ ${sectionKey} ì„¹ì…˜: ì¤‘ë³µëœ ìƒˆ ë°ì´í„° ${duplicateCount}ê°œ ì œê±°ë¨`);
          }
          
          // ê¸°ì¡´ ë°ì´í„° ì¶”ê°€ (ì¤‘ë³µ ì œì™¸) - ê¸°ì¡´ ë°ì´í„°ëŠ” ê³„ì† ìœ ì§€
          let existingKeptCount = 0;
          existingItems.forEach(item => {
            const link = item?.link || '';
            if (link && !linkSet.has(link)) {
              linkSet.add(link);
              mergedItems.push(item);
              existingKeptCount++;
            }
          });
          
          totalNewItems += newAddedCount;
          totalExistingItems += existingKeptCount;
          
          console.log(`âœ… ${sectionKey} ì„¹ì…˜ ë³‘í•© ì™„ë£Œ: ìƒˆë¡œ ì¶”ê°€ ${newAddedCount}ê°œ, ê¸°ì¡´ ìœ ì§€ ${existingKeptCount}ê°œ, ì´ ${mergedItems.length}ê°œ`);
          
          // ìƒˆ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê²½ê³ 
          if (newItems.length > 0 && newAddedCount === 0) {
            console.warn(`âš ï¸ ${sectionKey} ì„¹ì…˜: APIì—ì„œ ${newItems.length}ê°œ ë°ì´í„°ë¥¼ ë°›ì•˜ì§€ë§Œ ëª¨ë‘ ì¤‘ë³µì…ë‹ˆë‹¤.`);
          }
          
          // ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ì´ ìœ„ë¡œ)
          mergedItems.sort((a, b) => {
            const dateA = new Date(a.publishedAt || a._collectedAt || 0);
            const dateB = new Date(b.publishedAt || b._collectedAt || 0);
            return dateB.getTime() - dateA.getTime();
          });
          
          // ë¬´ì œí•œ ì €ì¥ (ëª¨ë“  ë‰´ìŠ¤ë¥¼ ì €ì¥)
          existingSections[sectionKey] = mergedItems;
          
          console.log(`ğŸ’¾ ${sectionKey} ì„¹ì…˜ ì €ì¥: ${existingSections[sectionKey].length}ê°œ (ë¬´ì œí•œ)`);
        });
        
        // naverSectionDataì— í• ë‹¹ (ì¤‘ìš”: ì´ë ‡ê²Œ í•´ì•¼ renderNaverNews()ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        naverSectionData.sections = existingSections;
        
        console.log('ğŸ“¦ ì „ì²´ ì„¹ì…˜ ë°ì´í„° í• ë‹¹ ì™„ë£Œ:', {
          social: naverSectionData.sections?.social?.length || 0,
          economy: naverSectionData.sections?.economy?.length || 0,
          total: Object.keys(naverSectionData.sections).reduce((sum, key) => {
            const items = naverSectionData.sections[key] || [];
            return sum + (Array.isArray(items) ? items.length : 0);
          }, 0)
        });
        
        // localStorageì— ì €ì¥ (ë Œë”ë§ ì „ì— ë¨¼ì € ì €ì¥)
        const saveResult = saveNaverNewsToStorage();
        console.log('ğŸ’¾ localStorage ì €ì¥ ì™„ë£Œ:', saveResult ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
        
        // ë Œë”ë§ ì „ì— fetchedAtì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
        console.log('ğŸ“Š ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ ìš”ì•½:', {
          fetchedAt: naverSectionData.fetchedAt,
          fetchedAtString: naverSectionData.fetchedAt?.toLocaleString('ko-KR'),
          socialCount: naverSectionData.sections?.social?.length || 0,
          economyCount: naverSectionData.sections?.economy?.length || 0,
          newSocialCount: newSections.social?.length || 0,
          newEconomyCount: newSections.economy?.length || 0,
          apiCounts: result.counts,
          apiErrors: result.errors,
        });
        
        // í˜ì´ì§€ë¥¼ 1ë¡œ ë¦¬ì…‹ (ìƒˆ ë°ì´í„° ìˆ˜ì§‘ ì‹œ ì²« í˜ì´ì§€ë¡œ)
        currentNaverPage = 1;
        
        // ë‰´ìŠ¤ ëª©ë¡ ê°•ì œ ì—…ë°ì´íŠ¸ (ë°ì´í„°ê°€ ì œëŒ€ë¡œ ë°˜ì˜ë˜ë„ë¡)
        console.log('ğŸ”„ ë‰´ìŠ¤ ëª©ë¡ ë Œë”ë§ ì‹œì‘...', {
          sectionsCount: Object.keys(naverSectionData.sections || {}).length,
          socialCount: naverSectionData.sections?.social?.length || 0,
          economyCount: naverSectionData.sections?.economy?.length || 0
        });
        renderNaverNews();
        console.log('âœ… ë‰´ìŠ¤ ëª©ë¡ ë Œë”ë§ ì™„ë£Œ');
        
        // ë Œë”ë§ í›„ íŒ¨ë„ì´ ë³´ì´ëŠ”ì§€ í™•ì¸
        if (panel && panel.style.display === 'none') {
          panel.style.display = 'block';
          console.log('ğŸ“‹ íŒ¨ë„ í‘œì‹œë¨');
        }
        
        // localStorageì— ë‹¤ì‹œ í•œ ë²ˆ ì €ì¥ (í™•ì‹¤í•˜ê²Œ)
        saveNaverNewsToStorage();
        
        // ì—…ë°ì´íŠ¸ ì™„ë£Œ ë©”ì‹œì§€
        const totalNewsCount = Object.keys(naverSectionData.sections).reduce((sum, key) => {
          const items = naverSectionData.sections[key] || [];
          return sum + (Array.isArray(items) ? items.length : 0);
        }, 0);
        
        console.log(`âœ… ë‰´ìŠ¤ ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ! ì´ ${totalNewsCount}ê°œì˜ ë‰´ìŠ¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        console.log(`ğŸ“ˆ ìš”ì•½: ìƒˆë¡œ ì¶”ê°€ ${totalNewItems}ê°œ, ê¸°ì¡´ ìœ ì§€ ${totalExistingItems}ê°œ`);
        
        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
        if (button) {
          if (totalNewItems > 0) {
            // ìƒˆ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì„±ê³µ ë©”ì‹œì§€
            button.innerHTML = `<i class="fas fa-check-circle"></i> ìˆ˜ì§‘ ì™„ë£Œ! (ìƒˆ ë‰´ìŠ¤ ${totalNewItems}ê°œ)`;
            button.style.background = '#03c75a';
            button.style.color = 'white';
            setTimeout(() => {
              button.innerHTML = originalButtonText || '<i class="fas fa-database"></i> ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘';
              button.style.background = '';
              button.style.color = '';
            }, 3000);
          } else {
            // ìƒˆ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê²½ê³  ë©”ì‹œì§€
            button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ìƒˆ ë‰´ìŠ¤ ì—†ìŒ';
            button.style.background = '#f59e0b';
            button.style.color = 'white';
            setTimeout(() => {
              button.innerHTML = originalButtonText || '<i class="fas fa-database"></i> ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘';
              button.style.background = '';
              button.style.color = '';
            }, 3000);
            
            // ì—ëŸ¬ ë©”ì‹œì§€ ì˜ì—­ì— ì•ˆë‚´ í‘œì‹œ
            errorEl.textContent = `âš ï¸ ìƒˆë¡œìš´ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nAPIì—ì„œ ë°›ì€ ë°ì´í„°ê°€ ëª¨ë‘ ê¸°ì¡´ ë°ì´í„°ì™€ ì¤‘ë³µë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`;
            errorEl.style.display = 'block';
            errorEl.style.background = 'rgba(245, 158, 11, 0.1)';
            errorEl.style.borderColor = '#f59e0b';
          }
        }
        
        // ìƒˆ ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        if (totalNewItems > 0) {
          errorEl.style.display = 'none';
          errorEl.textContent = '';
          errorEl.style.background = '';
          errorEl.style.borderColor = '';
        }
        
        console.log('âœ… ë‰´ìŠ¤ ë°ì´í„° ì €ì¥ ì™„ë£Œ. localStorageì— ì˜êµ¬ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        // ìƒë‹¨ì— ìœ ì§€í•˜ê¸° ìœ„í•´ ìŠ¤í¬ë¡¤ ì´ë™ ì œê±°
      } catch (error) {
        console.error('ë„¤ì´ë²„ ì„¹ì…˜ ë‰´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', error);
        console.error('ì—ëŸ¬ ìƒì„¸ ì •ë³´:', {
          name: error?.name,
          message: error?.message,
          status: error?.status,
          stack: error?.stack,
          hostname: window.location.hostname,
          href: window.location.href,
        });
        
        // ì·¨ì†Œëœ ìš”ì²­ì¸ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
        if (error?.name === 'AbortError') {
          console.log('ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          // ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€í•˜ê³  ë Œë”ë§
          if (naverSectionData.sections && Object.keys(naverSectionData.sections).length > 0) {
            renderNaverNews();
          }
          return;
        }
        
        // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€í•˜ê³  ë Œë”ë§
        if (naverSectionData.sections && Object.keys(naverSectionData.sections).length > 0) {
          console.log('âš ï¸ ì—ëŸ¬ ë°œìƒí–ˆì§€ë§Œ ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€í•©ë‹ˆë‹¤.');
          renderNaverNews();
        }
        
        // ë” ìì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ ìƒì„±
        let errorMessage = 'ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        const isLocal = ['localhost', '127.0.0.1'].includes(window.location.hostname);
        
        // íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ ì²˜ë¦¬
        if (error?.name === 'TimeoutError' || error?.message?.includes('ì‹œê°„ì´ ì´ˆê³¼')) {
          errorMessage = 'âš ï¸ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. (2ë¶„)\n\nì„œë²„ ì‘ë‹µì´ ë„ˆë¬´ ëŠë¦½ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n\në¡œì»¬ í™˜ê²½ì¸ ê²½ìš° ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
        }
        // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ì¸ ê²½ìš° (ë¨¼ì € ì²´í¬)
        else if (error?.name === 'TypeError' || error?.message?.includes('fetch') || error?.message?.includes('Failed') || error?.message?.includes('CORS')) {
          if (isLocal) {
            errorMessage = 'âš ï¸ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në¡œì»¬ í™˜ê²½ì—ì„œëŠ” ì„œë²„ë¥¼ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤:\n\n1. í„°ë¯¸ë„ì„ ì—´ê³ \n2. ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰:\n   node server.js\n   ë˜ëŠ”\n   pnpm run dev\n\nì„œë²„ê°€ ì‹¤í–‰ë˜ë©´ http://localhost:3003 ì—ì„œ APIë¥¼ ì œê³µí•©ë‹ˆë‹¤.';
          } else {
            // ë°°í¬ í™˜ê²½ì—ì„œëŠ” ë” ì¹œì ˆí•œ ë©”ì‹œì§€
            errorMessage = 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n\në¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
          }
        }
        // HTTP ìƒíƒœ ì½”ë“œ ì—ëŸ¬
        else if (error?.status) {
          if (error.status === 404) {
            if (isLocal) {
              errorMessage = 'âš ï¸ API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (404)\n\në¡œì»¬ í™˜ê²½ì—ì„œëŠ” ì„œë²„ë¥¼ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤:\n\n1. í„°ë¯¸ë„ì„ ì—´ê³ \n2. ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰:\n   node server.js\n   ë˜ëŠ”\n   pnpm run dev\n\nì„œë²„ê°€ ì‹¤í–‰ë˜ë©´ http://localhost:3003/api/naver-section-news ì—ì„œ APIë¥¼ ì œê³µí•©ë‹ˆë‹¤.';
            } else {
              errorMessage = 'API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (404)\n\nì„œë²„ê°€ ë°°í¬ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
            }
          } else if (error.status === 500) {
            errorMessage = 'ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (500) ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          } else if (error.status >= 502 && error.status <= 504) {
            errorMessage = 'ì„œë²„ê°€ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (502-504) ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          } else {
            errorMessage = `ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${error.status})`;
          }
        } else if (error?.message) {
          errorMessage = error.message;
        }
        
        errorEl.textContent = errorMessage;
        errorEl.style.display = 'block';
        // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ (ë¦¬ìŠ¤íŠ¸ë¥¼ ë¹„ìš°ì§€ ì•ŠìŒ)
        // list.innerHTML = ''; // ì œê±°: ê¸°ì¡´ ë‰´ìŠ¤ê°€ ë³´ì´ë„ë¡ ìœ ì§€
      } finally {
        // AbortController ì •ë¦¬
        collectNewsAbortController = null;
        
        loadingEl.style.display = 'none';
        if (button) {
          button.disabled = false;
          // ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬ (ì„±ê³µ ì‹œì—ëŠ” ì´ë¯¸ ë³µêµ¬ë˜ì—ˆì„ ìˆ˜ ìˆìŒ)
          if (button.innerHTML.includes('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘') || button.innerHTML.includes('ìˆ˜ì§‘ ì™„ë£Œ')) {
            button.innerHTML = originalButtonText || '<i class="fas fa-database"></i> ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘';
            button.onclick = originalButtonOnclick || collectNewsData;
            button.style.cursor = 'pointer';
            button.style.background = '';
            button.style.color = '';
          }
        }
      }
    }

    function openNaverNewsModal(sectionKey, index) {
      const modal = document.getElementById('naverNewsModal');
      const form = document.getElementById('naverNewsForm');
      if (!modal || !form) return;

      const sectionItems = naverSectionData.sections?.[sectionKey];
      if (!Array.isArray(sectionItems) || !sectionItems[index]) {
        alert('ë‰´ìŠ¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const item = sectionItems[index];
      naverEditingState = { sectionKey, index };

      // ë””ë²„ê¹…: item ê°ì²´ í™•ì¸
      console.log('ë‰´ìŠ¤ ì•„ì´í…œ ë°ì´í„°:', item);

      const titleInput = document.getElementById('naverNewsTitle');
      const linkInput = document.getElementById('naverNewsLink');
      const pressInput = document.getElementById('naverNewsPress');
      const journalistInput = document.getElementById('naverNewsJournalist');
      const publishedInput = document.getElementById('naverNewsPublished');
      const modifiedInput = document.getElementById('naverNewsModified');
      const summaryInput = document.getElementById('naverNewsSummary');
      const sourceInput = document.getElementById('naverNewsSource');
      const imageInput = document.getElementById('naverNewsImage');
      const metaView = document.getElementById('naverNewsMetaView');
      const metaContent = document.getElementById('naverNewsMetaContent');

      // ëª¨ë“  í•„ë“œì— ê°’ ì„¤ì •
      if (titleInput) titleInput.value = item?.title || '';
      if (linkInput) linkInput.value = item?.link || '';
      if (pressInput) pressInput.value = item?.press || '';
      
      // ê¸°ì í•„ë“œ: ì—¬ëŸ¬ ê°€ëŠ¥í•œ í•„ë“œëª… í™•ì¸
      if (journalistInput) {
        journalistInput.value = item?.journalist || 
                                 item?.journalistName || 
                                 item?.byline || 
                                 '';
      }
      
      // ì…ë ¥ ì‹œê° í•„ë“œ: ì—¬ëŸ¬ ê°€ëŠ¥í•œ í•„ë“œëª… í™•ì¸
      if (publishedInput) {
        publishedInput.value = item?.publishedAt || 
                               item?.publishedAtDisplay || 
                               item?.datetime || 
                               item?.date || 
                               '';
      }
      
      // ìˆ˜ì • ì‹œê° í•„ë“œ
      if (modifiedInput) {
        modifiedInput.value = item?.modifiedAt || 
                              item?.modifiedAtDisplay || 
                              item?.updateDate || 
                              '';
      }
      
      // ì¶œì²˜ í•„ë“œ ì„¤ì •
      if (sourceInput) {
        // sourceCitationì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ buildSourceCitationStringìœ¼ë¡œ ìƒì„±
        let sourceValue = item?.sourceCitation || '';
        if (!sourceValue) {
          sourceValue = buildSourceCitationString({
            press: item?.press || '',
            title: item?.title || '',
            publishedAt: item?.publishedAt || item?.publishedAtDisplay || ''
          });
        }
        sourceInput.value = sourceValue || '';
      }
      
      if (summaryInput) summaryInput.value = item?.summary || '';
      if (imageInput) {
        imageInput.value = item?.imageUrl || item?.image || '';
        if (imageInput.value) {
          updateNaverNewsImagePreview(imageInput.value);
        } else {
          hideNaverNewsImagePreview();
        }
      }

      if (metaView && metaContent) {
        metaView.style.display = 'none';
        metaContent.innerHTML = '';
      }

      modal.classList.add('active');
      if (summaryInput) {
        const fallbackSummary = item?.summary || '';
        summaryInput.value = fallbackSummary;
        // ë§í¬ê°€ ìˆìœ¼ë©´ í•­ìƒ ìë™ìœ¼ë¡œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì–¸ë¡ ì‚¬, ê¸°ì, ì‹œê°„, ì¶œì²˜, ë³¸ë¬¸ ë“±)
        if (item?.link) {
          populateNaverNewsSummaryFromLink(item?.link, fallbackSummary).catch(error => {
            // ì—ëŸ¬ ë°œìƒ ì‹œ ì¡°ìš©íˆ ì²˜ë¦¬ (ì´ë¯¸ ì…ë ¥ëœ ê°’ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
            console.warn('ë³¸ë¬¸ ìë™ ë¡œë“œ ì‹¤íŒ¨:', error);
          });
        }
      }
    }

    function closeNaverNewsModal() {
      const modal = document.getElementById('naverNewsModal');
      const form = document.getElementById('naverNewsForm');
      const metaView = document.getElementById('naverNewsMetaView');
      const metaContent = document.getElementById('naverNewsMetaContent');
      if (modal) {
        modal.classList.remove('active');
      }
      if (form) {
        form.reset();
      }
      if (metaView) {
        metaView.style.display = 'none';
      }
      if (metaContent) {
        metaContent.innerHTML = '';
      }
      naverEditingState = null;
    }

    function handleNaverNewsSubmit(event) {
      event.preventDefault();
      if (!naverEditingState) {
        closeNaverNewsModal();
        return;
      }

      const { sectionKey, index } = naverEditingState;
      const sectionItems = naverSectionData.sections?.[sectionKey];
      if (!Array.isArray(sectionItems) || !sectionItems[index]) {
        alert('ë‰´ìŠ¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        closeNaverNewsModal();
        return;
      }

      const title = document.getElementById('naverNewsTitle')?.value?.trim() || '';
      const link = document.getElementById('naverNewsLink')?.value?.trim() || '';
      const press = document.getElementById('naverNewsPress')?.value?.trim() || '';
      const journalist = document.getElementById('naverNewsJournalist')?.value?.trim() || '';
      const publishedAt = document.getElementById('naverNewsPublished')?.value?.trim() || '';
      const modifiedAt = document.getElementById('naverNewsModified')?.value?.trim() || '';
      const summary = document.getElementById('naverNewsSummary')?.value?.trim() || '';
      const imageUrl = document.getElementById('naverNewsImage')?.value?.trim() || '';
      const sourceInputValue = (document.getElementById('naverNewsSource')?.value || '').trim();
      const { citation: sourceCitation, url: citationUrl } = splitCitationAndUrl(sourceInputValue);
      const sourceInput = document.getElementById('naverNewsSource');
      if (sourceInput) {
        sourceInput.value = sourceCitation;
      }
      const sourceUrl =
        normalizeUrl(citationUrl) ||
        sectionItems[index].sourceUrl ||
        normalizeUrl(link) ||
        '';

      sectionItems[index] = {
        ...sectionItems[index],
        title,
        link,
        press,
        journalist,
        publishedAt,
        modifiedAt,
        summary,
        imageUrl,
        image: imageUrl,
        sourceCitation,
        sourceUrl,
        source: sourceUrl
      };

      renderNaverNews();
      // localStorageì— ì €ì¥
      saveNaverNewsToStorage();
      closeNaverNewsModal();
    }

    async function populateNaverNewsSummaryFromLink(link, fallbackSummary = '') {
      const summaryInput = document.getElementById('naverNewsSummary');
      const pressInput = document.getElementById('naverNewsPress');
      const journalistInput = document.getElementById('naverNewsJournalist');
      const publishedInput = document.getElementById('naverNewsPublished');
      const modifiedInput = document.getElementById('naverNewsModified');
      const sourceInput = document.getElementById('naverNewsSource');
      
      if (!link) return;

      // originalPlaceholderë¥¼ í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ ì •ì˜ (finally ë¸”ë¡ì—ì„œ ì‚¬ìš©)
      const originalPlaceholder = summaryInput ? (summaryInput.getAttribute('placeholder') || '') : '';

      // ëª¨ë“  ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
      if (summaryInput) {
        summaryInput.disabled = true;
        summaryInput.placeholder = 'ê¸°ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
      }

      try {
        const encodedUrl = encodeURIComponent(link);
        const result = await fetchJson(`/api/news-fetch?url=${encodedUrl}`);

        if (!result.success || !result.data) {
          throw new Error(result.error || 'ê¸°ì‚¬ ë³¸ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }

        // ë””ë²„ê¹…: API ì‘ë‹µ í™•ì¸
        console.log('API ì‘ë‹µ ë°ì´í„°:', {
          hasPlainText: !!result.data.plainText,
          plainTextLength: result.data.plainText?.length || 0,
          plainTextPreview: result.data.plainText?.substring(0, 200),
          hasText: !!result.data.text,
          textLength: result.data.text?.length || 0,
          textPreview: result.data.text?.substring(0, 200),
          hasRawText: !!result.data.rawText,
          rawTextLength: result.data.rawText?.length || 0,
          rawTextPreview: result.data.rawText?.substring(0, 200),
          hasContent: !!result.data.content,
          contentLength: result.data.content?.length || 0,
          hasRawPage: !!result.data.rawPage,
          rawPageLength: result.data.rawPage?.length || 0
        });

        const details = extractArticleDetails(result.data);
        
        // ë””ë²„ê¹…: ì¶”ì¶œëœ details í™•ì¸
        console.log('ì¶”ì¶œëœ details:', {
          hasSummary: !!details.summary,
          summaryLength: details.summary?.length || 0,
          summaryPreview: details.summary?.substring(0, 200)
        });
        
        // summaryê°€ ì—†ìœ¼ë©´ ê²½ê³ 
        if (!details.summary || details.summary.length < 50) {
          console.warn('âš ï¸ ë³¸ë¬¸ ì¶”ì¶œ ì‹¤íŒ¨! summaryê°€ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.', {
            summary: details.summary,
            articleDataKeys: Object.keys(result.data)
          });
        }
        
        // ë³¸ë¬¸ ë‚´ìš©ì€ í•­ìƒ ìƒˆë¡œ ê°€ì ¸ì˜¨ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸°
        summaryInput.value = details.summary || '';

        // ì´ë¯¸ì§€ URL ì„¤ì • (ì´ë¯¸ ê°’ì´ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ìƒˆë¡œ ê°€ì ¸ì˜¨ ê°’ ì‚¬ìš©)
        const imageInput = document.getElementById('naverNewsImage');
        if (imageInput) {
          const currentImageUrl = imageInput.value?.trim();
          if (result.data.imageUrl) {
            // ìƒˆë¡œ ê°€ì ¸ì˜¨ ì´ë¯¸ì§€ URLì´ ìˆìœ¼ë©´ ì‚¬ìš©
            imageInput.value = result.data.imageUrl;
            updateNaverNewsImagePreview(result.data.imageUrl);
          } else if (currentImageUrl) {
            // ê¸°ì¡´ ì´ë¯¸ì§€ URLì´ ìˆìœ¼ë©´ ìœ ì§€
            updateNaverNewsImagePreview(currentImageUrl);
          } else {
            // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
            hideNaverNewsImagePreview();
          }
        }

        const journalistInput = document.getElementById('naverNewsJournalist');
        if (journalistInput) {
          // ê¸°ì ì •ë³´ëŠ” ìƒˆë¡œ ê°€ì ¸ì˜¨ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸°
          const journalistValue =
            details.journalist ||
            details.meta?.journalistName ||
            result.data.byline ||
            '';
          if (journalistValue) {
            journalistInput.value = journalistValue;
          }
        }

        const publishedInput = document.getElementById('naverNewsPublished');
        if (publishedInput) {
          // ì…ë ¥ ì‹œê°ì€ ìƒˆë¡œ ê°€ì ¸ì˜¨ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸°
          let publishedValue = '';
          if (details.meta?.publishedAtRaw) {
            try {
              const date = new Date(details.meta.publishedAtRaw.replace(' ', 'T'));
              if (!Number.isNaN(date.getTime())) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = date.getHours();
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
                const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
                publishedValue = `${year}.${month}.${day}. ${ampm} ${displayHours}:${minutes}`;
              }
            } catch (e) {
              // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ ê°’ ì‚¬ìš©
            }
          }
          
          if (!publishedValue) {
            publishedValue =
              details.publishedAt ||
              details.meta?.publishedAtDisplay ||
              '';
          }
          if (publishedValue) {
            publishedInput.value = publishedValue;
          }
        }

        const modifiedInput = document.getElementById('naverNewsModified');
        if (modifiedInput) {
          // ìˆ˜ì • ì‹œê°ì€ ìƒˆë¡œ ê°€ì ¸ì˜¨ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸°
          let modifiedValue = '';
          if (details.meta?.modifiedAtRaw) {
            try {
              const date = new Date(details.meta.modifiedAtRaw.replace(' ', 'T'));
              if (!Number.isNaN(date.getTime())) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = date.getHours();
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
                const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
                modifiedValue = `${year}.${month}.${day}. ${ampm} ${displayHours}:${minutes}`;
              }
            } catch (e) {
              // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ ê°’ ì‚¬ìš©
            }
          }
          
          if (!modifiedValue) {
            modifiedValue =
              details.modifiedAt ||
              details.meta?.modifiedAtDisplay ||
              '';
          }
          if (modifiedValue) {
            modifiedInput.value = modifiedValue;
          }
        }

        const pressInput = document.getElementById('naverNewsPress');
        const sourceInput = document.getElementById('naverNewsSource');
        const titleInput = document.getElementById('naverNewsTitle');
        const normalizedSourceUrl = normalizeUrl(details.sourceUrl || link);
        
        // ì–¸ë¡ ì‚¬ ì •ë³´: API ì‘ë‹µì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê±°ë‚˜ detailsì—ì„œ ê°€ì ¸ì˜¤ê¸° (ìƒˆë¡œ ê°€ì ¸ì˜¨ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸°)
        let pressValue = '';
        if (result.data.press) {
          pressValue = result.data.press;
        } else if (details.press) {
          pressValue = details.press;
        } else if (details.meta?.pressName) {
          pressValue = details.meta.pressName;
        }
        
        if (pressInput && pressValue) {
          pressInput.value = pressValue;
        }
        const citationTitle =
          titleInput?.value?.trim() ||
          details.articleTitle ||
          details.meta?.articleTitle ||
          details.title ||
          '';
        const publishedValue =
          document.getElementById('naverNewsPublished')?.value?.trim() ||
          details.publishedAt ||
          details.meta?.publishedAtDisplay ||
          '';
        const citationValue =
          buildSourceCitationString({
            press: pressValue,
            title: citationTitle,
            publishedAt: publishedValue,
          }) || sourceInput?.value?.trim() || '';

        if (sourceInput) {
          sourceInput.value = citationValue;
        }

        renderNaverNewsMeta(details.meta);

        if (naverEditingState) {
          const { sectionKey, index } = naverEditingState;
          const items = naverSectionData.sections?.[sectionKey];
          if (Array.isArray(items) && items[index]) {
            const target = items[index];
            target.title = titleInput?.value?.trim() || target.title;
            target.press = pressValue || target.press;
            target.journalist = document.getElementById('naverNewsJournalist')?.value?.trim() || target.journalist;
            // publishedAtì€ ì´ë¯¸ í¬ë§·íŒ…ëœ ê°’ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            target.publishedAt = publishedInput?.value?.trim() || target.publishedAt;
            target.modifiedAt = modifiedInput?.value?.trim() || target.modifiedAt;
            target.summary = summaryInput.value?.trim() || target.summary;
            target.imageUrl = imageInput?.value?.trim() || target.imageUrl;
            target.image = target.imageUrl;
            target.sourceCitation = citationValue;
            target.sourceUrl = normalizedSourceUrl || target.sourceUrl;
            target.source = target.sourceUrl;
          }
        }
        // ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ localStorageì— ì €ì¥
        saveNaverNewsToStorage();
      } catch (error) {
        console.error('ë„¤ì´ë²„ ë‰´ìŠ¤ ë³¸ë¬¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        summaryInput.value = fallbackSummary || '';
        // ì—ëŸ¬ ë©”ì‹œì§€ëŠ” ì½˜ì†”ì—ë§Œ ì¶œë ¥í•˜ê³  ì‚¬ìš©ìì—ê²ŒëŠ” ì¡°ìš©íˆ ì²˜ë¦¬
        // (ì´ë¯¸ ì €ì¥ëœ ë³¸ë¬¸ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        if (!fallbackSummary) {
          // ë³¸ë¬¸ì´ ì—†ì„ ë•Œë§Œ ê²½ê³  í‘œì‹œ
          console.warn('ê¸°ì‚¬ ë³¸ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
        renderNaverNewsMeta(null);
      } finally {
        summaryInput.disabled = false;
        summaryInput.placeholder = originalPlaceholder;
      }
    }

    function previewNaverNewsImage() {
      const imageInput = document.getElementById('naverNewsImage');
      if (!imageInput) return;
      
      const imageUrl = imageInput.value.trim();
      if (!imageUrl) {
        alert('ì´ë¯¸ì§€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      updateNaverNewsImagePreview(imageUrl);
    }

    function updateNaverNewsImagePreview(imageUrl) {
      const previewDiv = document.getElementById('naverNewsImagePreview');
      const previewImg = document.getElementById('naverNewsImagePreviewImg');
      
      if (!previewDiv || !previewImg) return;
      
      if (imageUrl) {
        previewImg.src = imageUrl;
        previewImg.onerror = function() {
          alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          hideNaverNewsImagePreview();
        };
        previewDiv.style.display = 'block';
      } else {
        hideNaverNewsImagePreview();
      }
    }

    function hideNaverNewsImagePreview() {
      const previewDiv = document.getElementById('naverNewsImagePreview');
      if (previewDiv) {
        previewDiv.style.display = 'none';
      }
    }

    function openAIAnalysisSidebar() {
      const sidebar = document.getElementById('aiAnalysisSidebar');
      const overlay = document.getElementById('aiAnalysisOverlay');
      if (sidebar) {
        sidebar.classList.add('active');
      }
      if (overlay) {
        overlay.classList.add('active');
      }
    }

    function closeAIAnalysisSidebar() {
      const sidebar = document.getElementById('aiAnalysisSidebar');
      const overlay = document.getElementById('aiAnalysisOverlay');
      if (sidebar) {
        sidebar.classList.remove('active');
      }
      if (overlay) {
        overlay.classList.remove('active');
      }
    }

    // AI í•´ì„ í¸ì§‘ ëª¨ë“œ í† ê¸€
    function toggleAIAnalysisEdit() {
      const editableContent = document.getElementById('aiAnalysisEditableContent');
      const editBtn = document.getElementById('aiEditBtn');
      
      if (!editableContent || !editBtn) return;
      
      const isEditable = editableContent.contentEditable === 'true';
      
      if (isEditable) {
        // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
        editableContent.contentEditable = 'false';
        editBtn.innerHTML = '<i class="fas fa-edit" style="font-size: 12px; color: white !important;"></i> <span style="color: white !important;">í¸ì§‘</span>';
        editBtn.style.setProperty('background', '#03c75a', 'important');
        editBtn.style.setProperty('color', 'white', 'important');
        editBtn.style.setProperty('border-color', '#03c75a', 'important');
        // í¸ì§‘ëœ ë‚´ìš© ì €ì¥
        saveAIAnalysisContent();
      } else {
        // í¸ì§‘ ëª¨ë“œ ì‹œì‘
        editableContent.contentEditable = 'true';
        editBtn.innerHTML = '<i class="fas fa-check" style="font-size: 12px; color: white !important;"></i> <span style="color: white !important;">ì™„ë£Œ</span>';
        editBtn.style.setProperty('background', '#02b350', 'important');
        editBtn.style.setProperty('color', 'white', 'important');
        editBtn.style.setProperty('border-color', '#02b350', 'important');
        
        // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ
        const contentEl = document.getElementById('aiAnalysisContent');
        if (contentEl) {
          contentEl.scrollTop = 0;
        }
        
        // í¬ì»¤ìŠ¤ ì£¼ê¸°
        editableContent.focus();
      }
    }

    // AI í•´ì„ ë‚´ìš© ì €ì¥ (í¸ì§‘ëœ ë‚´ìš©)
    function saveAIAnalysisContent() {
      const editableContent = document.getElementById('aiAnalysisEditableContent');
      if (editableContent) {
        // í¸ì§‘ëœ ë‚´ìš©ì„ localStorageì— ì €ì¥ (ì„ íƒì‚¬í•­)
        const content = editableContent.innerHTML;
        localStorage.setItem('aiAnalysisLastContent', content);
      }
    }

    // ì‚¬ì¥í”½ì— ì—…ë¡œë“œ
    async function uploadToSajangpick() {
      try {
        const editableContent = document.getElementById('aiAnalysisEditableContent');
        if (!editableContent) {
          alert('ì—…ë¡œë“œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ì œëª©ê³¼ ì¶œì²˜ ì •ë³´ ì¶”ì¶œ
        const titleInput = document.getElementById('naverNewsTitle');
        const pressInput = document.getElementById('naverNewsPress');
        const journalistInput = document.getElementById('naverNewsJournalist');
        const publishedInput = document.getElementById('naverNewsPublished');
        const linkInput = document.getElementById('naverNewsLink');
        const imageInput = document.getElementById('naverNewsImage');

        const newsTitle = titleInput?.value?.trim() || '';
        const newsPress = pressInput?.value?.trim() || '';
        const newsJournalist = journalistInput?.value?.trim() || '';
        const newsPublished = publishedInput?.value?.trim() || '';
        const newsLink = linkInput?.value?.trim() || '';
        const newsImage = imageInput?.value?.trim() || '';

        if (!newsTitle) {
          alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        // í¸ì§‘ëœ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        const content = editableContent.innerHTML;

        // HTMLì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (ì´ë¯¸ì§€ì™€ ë§í¬ëŠ” ìœ ì§€)
        let textContent = content
          .replace(/<h2[^>]*>.*?<\/h2>/gi, '') // ì œëª© ì œê±° (ì´ë¯¸ ë³„ë„ë¡œ ì €ì¥)
          .replace(/<div[^>]*>.*?<\/div>/gi, '') // div ì œê±°
          .replace(/<p[^>]*>/gi, '\n') // p íƒœê·¸ë¥¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ
          .replace(/<\/p>/gi, '')
          .replace(/<br\s*\/?>/gi, '\n')
          .replace(/<strong[^>]*>/gi, '')
          .replace(/<\/strong>/gi, '')
          .replace(/<[^>]+>/g, '') // ë‚˜ë¨¸ì§€ HTML íƒœê·¸ ì œê±°
          .trim();

        // ì¶œì²˜ ì •ë³´ë¥¼ êµ¬ì¡°í™”ëœ í˜•ì‹ìœ¼ë¡œ ì €ì¥
        const sourceCitation = {
          press: newsPress || '',
          journalist: newsJournalist || '',
          publishedAt: newsPublished || '',
          link: newsLink || ''
        };

        // ì¹´í…Œê³ ë¦¬ ê²°ì •: AIê°€ ê°ì§€í•œ ì¹´í…Œê³ ë¦¬ ë˜ëŠ” ê¸°ë³¸ê°’
        const newsCategory = window.detectedNewsCategory || 'ì •ì±…/ë²•ê·œ';
        console.log('ğŸ“‚ ì—…ë¡œë“œí•  ì¹´í…Œê³ ë¦¬:', newsCategory);

        // ë‰´ìŠ¤ ê²Œì‹œíŒì— ì €ì¥
        const body = {
          title: newsTitle,
          content: textContent,
          content_html: content, // HTML ë²„ì „ë„ ì €ì¥
          category: newsCategory, // AIê°€ ê°ì§€í•œ ì¹´í…Œê³ ë¦¬ ì‚¬ìš©
          image_url: newsImage || null,
          source_url: newsLink || null,
          source_citation: JSON.stringify(sourceCitation), // JSON í˜•ì‹ìœ¼ë¡œ ì €ì¥
          is_featured: false
        };

        // AdminUtils.adminFetch ì‚¬ìš© (ìë™ìœ¼ë¡œ ì„¸ì…˜ ì²˜ë¦¬)
        let result;
        if (window.AdminUtils && typeof window.AdminUtils.adminFetch === 'function') {
          try {
            result = await window.AdminUtils.adminFetch('/api/news-board', {
              method: 'POST',
              body: JSON.stringify(body)
            });
            // adminFetchëŠ” ì„±ê³µ ì‹œ ì§ì ‘ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ success ì²´í¬ ë¶ˆí•„ìš”
            if (result && result.success === false) {
              throw new Error(result.error || 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          } catch (error) {
            // adminFetchê°€ ì—ëŸ¬ë¥¼ throwí•˜ë©´ ê·¸ëŒ€ë¡œ ì „ë‹¬
            throw error;
          }
        } else {
          // AdminUtilsê°€ ì—†ì„ ê²½ìš° ì§ì ‘ ì²˜ë¦¬
          let supabaseClient = null;
          
          // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ supabase í´ë¼ì´ì–¸íŠ¸ ê°€ì ¸ì˜¤ê¸° ì‹œë„
          if (window.AdminBootstrap && typeof window.AdminBootstrap.getSupabaseClient === 'function') {
            supabaseClient = await window.AdminBootstrap.getSupabaseClient();
          } else if (window.supabaseClient) {
            supabaseClient = window.supabaseClient;
          } else if (window.supabase && typeof window.supabase.auth === 'object') {
            supabaseClient = window.supabase;
          } else {
            // Supabaseê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ì ì‹œ ëŒ€ê¸°
            let retries = 0;
            while (retries < 10 && !supabaseClient) {
              await new Promise(resolve => setTimeout(resolve, 200));
              if (window.AdminBootstrap && typeof window.AdminBootstrap.getSupabaseClient === 'function') {
                supabaseClient = await window.AdminBootstrap.getSupabaseClient();
              } else if (window.supabaseClient) {
                supabaseClient = window.supabaseClient;
              } else if (window.supabase && typeof window.supabase.auth === 'object') {
                supabaseClient = window.supabase;
              }
              retries++;
            }
            
            if (!supabaseClient) {
              throw new Error('Supabase í´ë¼ì´ì–¸íŠ¸ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
          }
          
          // ì„¸ì…˜ ê°€ì ¸ì˜¤ê¸° (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
          let session = null;
          let retries = 0;
          while (retries < 5 && !session) {
            const { data: { session: currentSession }, error } = await supabaseClient.auth.getSession();
            if (!error && currentSession) {
              session = currentSession;
              break;
            }
            if (retries < 4) {
              await new Promise(resolve => setTimeout(resolve, 300));
            }
            retries++;
          }
          
          if (!session) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ê´€ë¦¬ì í˜ì´ì§€ì— ë¡œê·¸ì¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            return;
          }

          const token = session.access_token;
          
          result = await fetchJson('/api/news-board', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
          });
          
          // fetchJsonì„ ì‚¬ìš©í•œ ê²½ìš° success ì²´í¬
          if (!result.success) {
            throw new Error(result.error || 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        }

        // ì—…ë¡œë“œ ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ
        showUploadSuccessModal();

      } catch (error) {
        console.error('ì‚¬ì¥í”½ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ì‚¬ì¥í”½ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    async function analyzeNaverNews() {
      const titleInput = document.getElementById('naverNewsTitle');
      const summaryInput = document.getElementById('naverNewsSummary');
      const linkInput = document.getElementById('naverNewsLink');
      const pressInput = document.getElementById('naverNewsPress');
      const publishedInput = document.getElementById('naverNewsPublished');
      
      if (!titleInput || !summaryInput) {
        alert('ë‰´ìŠ¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const title = titleInput.value.trim();
      const content = summaryInput.value.trim();
      const link = linkInput?.value?.trim() || '';
      const press = pressInput?.value?.trim() || '';
      const publishedAt = publishedInput?.value?.trim() || '';
      
      if (!title && !content) {
        alert('ì œëª© ë˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì‚¬ì´ë“œë°” ì—´ê¸°
      openAIAnalysisSidebar();
      
      // ë¡œë”© í‘œì‹œ
      const loadingEl = document.getElementById('aiAnalysisLoading');
      const resultEl = document.getElementById('aiAnalysisResult');
      if (loadingEl) loadingEl.style.display = 'block';
      if (resultEl) resultEl.innerHTML = '';
      
      // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
      const analyzeBtn = event?.target?.closest('button');
      const originalText = analyzeBtn ? analyzeBtn.innerHTML : '';
      if (analyzeBtn) {
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI ë¶„ì„ ì¤‘...';
      }
      
      try {
        const result = await fetchJson('/api/news-ai-summary', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title,
            content,
            url: link,
            press: press,
            publishedAt: publishedAt
          })
        });
        
        if (!result.success) {
          throw new Error(result.error || 'AI ë‰´ìŠ¤ í•´ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        // í•´ì„ ê²°ê³¼ë¥¼ ì‚¬ì´ë“œë°”ì— í‘œì‹œ
        const analysis = result.analysis || result.data;
        
        // ì¹´í…Œê³ ë¦¬ ìë™ ì„ íƒ
        const detectedCategory = result.category || analysis?.category || result.data?.category;
        if (detectedCategory) {
          console.log('âœ… AIê°€ ê°ì§€í•œ ì¹´í…Œê³ ë¦¬:', detectedCategory);
          // ì¹´í…Œê³ ë¦¬ ë§¤í•‘: APIì˜ ì¹´í…Œê³ ë¦¬ ì½”ë“œë¥¼ DB ì¹´í…Œê³ ë¦¬ë¡œ ë³€í™˜
          const categoryMap = {
            'policy': 'ì •ì±…/ë²•ê·œ',
            'trend': 'íŠ¸ë Œë“œ',
            'management': 'ê²½ì˜ íŒ',
            'ingredients': 'ì‹ìì¬ ì •ë³´',
            'technology': 'ê¸°ìˆ /ë„êµ¬'
          };
          const dbCategory = categoryMap[detectedCategory] || 'ì •ì±…/ë²•ê·œ';
          
          // ì „ì—­ ë³€ìˆ˜ì— ì¹´í…Œê³ ë¦¬ ì €ì¥ (ì—…ë¡œë“œ ì‹œ ì‚¬ìš©)
          window.detectedNewsCategory = dbCategory;
          console.log('ğŸ’¾ ì €ì¥ëœ ì¹´í…Œê³ ë¦¬:', dbCategory);
        }
        
        if (analysis) {
          const analysisText = analysis.summary || analysis.content || '';
          
          // ë””ë²„ê¹…: ì›ë³¸ í…ìŠ¤íŠ¸ í™•ì¸
          console.log('ğŸ” AI í•´ì„ ì›ë³¸ í…ìŠ¤íŠ¸:', {
            hasAnalysis: !!analysis,
            hasSummary: !!analysis.summary,
            hasContent: !!analysis.content,
            textLength: analysisText.length,
            textPreview: analysisText.substring(0, 500),
            detectedCategory: detectedCategory
          });
          
          if (resultEl) {
            // ì œëª©ê³¼ ì¶œì²˜ ì •ë³´ ì¶”ì¶œ
            const titleInput = document.getElementById('naverNewsTitle');
            const pressInput = document.getElementById('naverNewsPress');
            const journalistInput = document.getElementById('naverNewsJournalist');
            const publishedInput = document.getElementById('naverNewsPublished');
            const linkInput = document.getElementById('naverNewsLink');
            const imageInput = document.getElementById('naverNewsImage');
            
            const newsTitle = titleInput?.value?.trim() || title || '';
            const newsPress = pressInput?.value?.trim() || press || '';
            const newsJournalist = journalistInput?.value?.trim() || '';
            const newsPublished = publishedInput?.value?.trim() || publishedAt || '';
            const newsLink = linkInput?.value?.trim() || link || '';
            const newsImage = imageInput?.value?.trim() || '';
            
            // ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ ì´ëª¨ì§€ì™€ êµ¬ì¡°ë¥¼ HTMLë¡œ ë³€í™˜
            let formattedText = escapeHtml(analysisText);
            
            // ë””ë²„ê¹…: ë³€í™˜ ì „ í…ìŠ¤íŠ¸ í™•ì¸
            console.log('ğŸ“ ë³€í™˜ ì „ formattedText ê¸¸ì´:', formattedText.length);
            console.log('ğŸ“ ë³€í™˜ ì „ formattedText ë¯¸ë¦¬ë³´ê¸°:', formattedText.substring(0, 500));
            
            // ## ë§ˆí¬ë‹¤ìš´ í—¤ë” ì œê±°
            formattedText = formattedText.replace(/^##+\s*/gm, '');
            
            // ì œëª© ì„¹ì…˜ ì²˜ë¦¬ (ë§¨ ìœ„ì—)
            formattedText = formattedText.replace(/ğŸ“Œ\s*ì œëª©[^:]*:\s*(.+?)(?=\n|$)/g, '');
            
            // ì„¹ì…˜ ì œëª©ì„ ë¨¼ì € ì²˜ë¦¬ (êµµê²Œ ì²˜ë¦¬, border ì œê±°, ê³µë°± ì ˆë°˜)
            // "ì‰½ê²Œ í’€ì–´ì„œ" ë¬¸êµ¬ ì œê±°í•˜ê³ , ì„¹ì…˜ ì œëª©ê³¼ ë‚´ìš©ì„ í•¨ê»˜ ì²˜ë¦¬
            formattedText = formattedText
              .replace(/ğŸ“°\s*1ï¸âƒ£\s*ë‰´ìŠ¤ í•µì‹¬ ìš”ì•½[^\n]*(\([^)]*\))?[^\n]*\n/g, '<div style="color: var(--primary); margin-top: 12px; margin-bottom: 8px; font-size: 18px; font-weight: 700;"><strong>ğŸ“° 1ï¸âƒ£ ë‰´ìŠ¤ í•µì‹¬ ìš”ì•½</strong></div>')
              .replace(/ğŸ’¬\s*2ï¸âƒ£\s*ì‚¬ì¥ë‹˜ ëˆˆë†’ì´ í•´ì„\s*\n/g, '<div style="color: var(--primary); margin-top: 12px; margin-bottom: 8px; font-size: 18px; font-weight: 700;"><strong>ğŸ’¬ 2ï¸âƒ£ ì‚¬ì¥ë‹˜ ëˆˆë†’ì´ í•´ì„</strong></div>')
              .replace(/ğŸ’¡\s*2ï¸âƒ£\s*ì†Œìƒê³µì¸ ê´€ì  ì¬í•´ì„\s*\n/g, '<div style="color: var(--primary); margin-top: 12px; margin-bottom: 8px; font-size: 18px; font-weight: 700;"><strong>ğŸ’¬ 2ï¸âƒ£ ì‚¬ì¥ë‹˜ ëˆˆë†’ì´ í•´ì„</strong></div>')
              .replace(/ğŸ“Œ\s*3ï¸âƒ£\s*í˜„ì‹¤ì  ì¡°ì–¸[^\n]*\n/g, '<div style="color: var(--primary); margin-top: 12px; margin-bottom: 8px; font-size: 18px; font-weight: 700;"><strong>ğŸ“Œ 3ï¸âƒ£ í˜„ì‹¤ì  ì¡°ì–¸ 3ê°€ì§€ (ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” íŒ)</strong></div>')
              .replace(/ğŸ“Œ\s*3ï¸âƒ£\s*ì‹¤í–‰ í¬ì¸íŠ¸\s*\n/g, '<div style="color: var(--primary); margin-top: 12px; margin-bottom: 8px; font-size: 18px; font-weight: 700;"><strong>ğŸ“Œ 3ï¸âƒ£ í˜„ì‹¤ì  ì¡°ì–¸ 3ê°€ì§€ (ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” íŒ)</strong></div>');
            
            // ì¶œì²˜ ì •ë³´ ì„¹ì…˜ ì²˜ë¦¬ (ë§¨ ë°‘ì—)
            formattedText = formattedText.replace(/ğŸ“‹\s*ì¶œì²˜ ì •ë³´[\s\S]*$/g, '');
            
            // ì‹¤í–‰ í¬ì¸íŠ¸ì˜ ë¦¬ìŠ¤íŠ¸ í•­ëª© ì²˜ë¦¬ (- ë¡œ ì‹œì‘í•˜ëŠ” í•­ëª©)
            // ë¨¼ì € ì—°ì†ëœ ë¦¬ìŠ¤íŠ¸ í•­ëª©ì„ ì°¾ì•„ì„œ ulë¡œ ê°ì‹¸ê¸°
            formattedText = formattedText.replace(/((?:^-\s*.+$(?:\n|$)){2,})/gm, (match) => {
              const items = match.trim().split(/\n/).filter(line => line.trim().startsWith('-'));
              const listItems = items.map(item => {
                const text = item.replace(/^-\s*/, '').trim();
                return `<li style="margin-bottom: 4px; padding-left: 8px; position: relative; padding-left: 24px;">${text}</li>`;
              }).join('');
              return `<ul style="margin-left: 20px; margin-bottom: 8px; list-style-type: none; padding-left: 0;">${listItems}</ul>`;
            });
            
            // ë‹¨ì¼ ë¦¬ìŠ¤íŠ¸ í•­ëª©ë„ ì²˜ë¦¬
            formattedText = formattedText.replace(/^-\s*(.+)$/gm, '<li style="margin-bottom: 4px; padding-left: 24px; position: relative;">$1</li>');
            
            // ê²½ê³  ë¬¸êµ¬ ìŠ¤íƒ€ì¼ë§
            formattedText = formattedText.replace(/âš ï¸/g, '<span style="color: #f59e0b; font-weight: 600;">âš ï¸</span>');
            
            // ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±° (HTML íƒœê·¸ ë‚´ë¶€ëŠ” ì œì™¸)
            // ë¨¼ì € HTML íƒœê·¸ë¥¼ ì„ì‹œë¡œ ë³´í˜¸
            const tagPlaceholders = [];
            let tagIndex = 0;
            formattedText = formattedText.replace(/<[^>]+>/g, (match) => {
                const placeholder = `__TAG_${tagIndex}__`;
                tagPlaceholders[tagIndex] = match;
                tagIndex++;
                return placeholder;
            });
            
            // ê³µë°± ì •ë¦¬ (íƒœê·¸ê°€ ì•„ë‹Œ ë¶€ë¶„ë§Œ)
            formattedText = formattedText
              .replace(/[ \t]+/g, ' ') // ì—°ì†ëœ ê³µë°±/íƒ­ì„ í•˜ë‚˜ë¡œ
              .replace(/\n\s*\n\s*\n+/g, '\n\n') // ì—°ì†ëœ ì¤„ë°”ê¿ˆì„ ë‘ ê°œë¡œ
              .trim();
            
            // íƒœê·¸ ë³µì›
            tagPlaceholders.forEach((tag, index) => {
                formattedText = formattedText.replace(`__TAG_${index}__`, tag);
            });
            
            // ì—°ì†ëœ ì¤„ë°”ê¿ˆì„ ë‹¨ë½ìœ¼ë¡œ ë³€í™˜
            formattedText = formattedText
              .split(/\n\n+/)
              .map(para => {
                para = para.trim();
                if (!para) return '';
                // ì´ë¯¸ div, ul, li íƒœê·¸ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ, ì—†ìœ¼ë©´ p íƒœê·¸ë¡œ ê°ì‹¸ê¸°
                if (para.startsWith('<div') || para.startsWith('<ul') || para.startsWith('<li') || para.startsWith('<h')) {
                  return para;
                }
                return `<p style="margin-bottom: 6px; line-height: 1.8;">${para}</p>`;
              })
              .filter(p => p)
              .join('');
            
            // ë‹¨ì¼ ì¤„ë°”ê¿ˆì€ brë¡œ ë³€í™˜ (íƒœê·¸ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
            formattedText = formattedText.replace(/\n(?![^<]*>)/g, '<br>');
            
            // ë””ë²„ê¹…: ë³€í™˜ í›„ ìµœì¢… í…ìŠ¤íŠ¸ í™•ì¸
            console.log('âœ… ë³€í™˜ í›„ formattedText ê¸¸ì´:', formattedText.length);
            console.log('âœ… ë³€í™˜ í›„ formattedText ë¯¸ë¦¬ë³´ê¸°:', formattedText.substring(0, 1000));
            console.log('âœ… ì„¹ì…˜ ì œëª© í¬í•¨ ì—¬ë¶€:', {
              hasSummarySection: formattedText.includes('ë‰´ìŠ¤ í•µì‹¬ ìš”ì•½'),
              hasInterpretationSection: formattedText.includes('ì‚¬ì¥ë‹˜ ëˆˆë†’ì´ í•´ì„'),
              hasAdviceSection: formattedText.includes('í˜„ì‹¤ì  ì¡°ì–¸')
            });
            
            // ì¶œì²˜ ì •ë³´ HTML ìƒì„± (ë³¸ë¬¸ì´ ìˆì„ ë•Œë§Œ ìœ„ìª½ ì—¬ë°± ì¶”ê°€)
            const sourceMarginTop = formattedText.trim() ? '20px' : '12px';
            let sourceInfoHtml = `<div style="margin-top: ${sourceMarginTop}; padding-top: 10px; border-top: 2px solid var(--border);">`;
            sourceInfoHtml += '<h4 style="color: var(--text-secondary); margin-bottom: 6px; font-size: 14px; font-weight: 600;">ğŸ“‹ ì¶œì²˜ ì •ë³´</h4>';
            sourceInfoHtml += '<div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">';
            if (newsPress) {
              sourceInfoHtml += `<div style="margin-bottom: 6px;">ğŸ“° ì–¸ë¡ ì‚¬: <strong>${escapeHtml(newsPress)}</strong></div>`;
            }
            if (newsJournalist) {
              sourceInfoHtml += `<div style="margin-bottom: 6px;">âœï¸ ê¸°ì: <strong>${escapeHtml(newsJournalist)}</strong></div>`;
            }
            if (newsPublished) {
              sourceInfoHtml += `<div style="margin-bottom: 6px;">ğŸ• ì…ë ¥ ì‹œê°: <strong>${escapeHtml(newsPublished)}</strong></div>`;
            }
            if (newsLink) {
              sourceInfoHtml += `<div style="margin-bottom: 6px;">ğŸ”— ì›ë¬¸ ë§í¬: <a href="${escapeHtml(newsLink)}" target="_blank" rel="noopener" style="color: var(--primary); text-decoration: underline;">${escapeHtml(newsLink)}</a></div>`;
            }
            sourceInfoHtml += '</div></div>';
            
            // AIë‰´ìŠ¤ í•´ì„ ì œëª©ê³¼ í¸ì§‘ ë²„íŠ¼
            const titleAndEditHtml = `<div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
              <h3 style="color: var(--primary); font-size: 18px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-brain" style="color: var(--primary);"></i> AIë‰´ìŠ¤ í•´ì„
              </h3>
              <button id="aiEditBtn" type="button" onclick="toggleAIAnalysisEdit()" style="padding: 8px 16px; background: #03c75a !important; color: white !important; border: 2px solid #03c75a !important; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 6px rgba(3, 199, 90, 0.25); transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-edit" style="font-size: 12px; color: white !important;"></i> <span style="color: white !important;">í¸ì§‘</span>
              </button>
            </div>`;
            
            // ê¸°ì‚¬ ì œëª© HTML ìƒì„± (ì´ë¯¸ì§€ ìœ„ì— í‘œì‹œ)
            const newsTitleHtml = newsTitle ? `<div style="margin-bottom: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary);">
              <h2 style="color: var(--text); font-size: 20px; font-weight: 700; margin: 0; line-height: 1.4;">${escapeHtml(newsTitle)}</h2>
            </div>` : '';
            
            // ì´ë¯¸ì§€ HTML ìƒì„± (ì œëª© ì•„ë˜, ë³¸ë¬¸ ìœ„ì—)
            const imageHtml = newsImage ? `<div style="margin-bottom: 16px;"><img src="${escapeHtml(newsImage)}" alt="ë‰´ìŠ¤ ì´ë¯¸ì§€" style="max-width: 100%; border-radius: 8px; border: 1px solid var(--border);" /></div>` : '';
            
            // í¸ì§‘ ë¶ˆê°€ëŠ¥í•œ ì˜ì—­ (ê¸°ë³¸ ìƒíƒœ) - ë‰´ìŠ¤ ì œëª© ì œê±° (ì¤‘ë³µ ë°©ì§€)
            // formattedTextê°€ ë¹„ì–´ìˆìœ¼ë©´ ë¹ˆ ê³µê°„ ìµœì†Œí™”
            const contentPadding = formattedText.trim() ? '16px' : '0';
            const contentMinHeight = formattedText.trim() ? '200px' : 'auto';
            const editableContent = `<div id="aiAnalysisEditableContent" contenteditable="false" style="line-height: 1.8; color: var(--text); min-height: ${contentMinHeight}; padding: ${contentPadding}; border: 1px solid var(--border); border-radius: 8px; background: white; outline: none;">${imageHtml}${formattedText}</div>`;
            
            // ì‚¬ì¥í”½ ì—…ë¡œë“œ ë²„íŠ¼ HTML
            const uploadButtonHtml = `<div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--border);">
              <button type="button" class="btn btn-primary" onclick="uploadToSajangpick()" style="width: 100%; padding: 14px 24px; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(3, 199, 90, 0.2); transition: all 0.3s ease; border: none;">
                <i class="fas fa-upload"></i> ì‚¬ì¥í”½ ì—…ë¡œë“œ
              </button>
            </div>`;
            
            resultEl.innerHTML = titleAndEditHtml + newsTitleHtml + editableContent + sourceInfoHtml + uploadButtonHtml;
          }
        } else {
          if (resultEl) {
            resultEl.innerHTML = '<p style="color: var(--danger);">AI í•´ì„ ê²°ê³¼ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
          }
        }
      } catch (error) {
        console.error('AI ë‰´ìŠ¤ í•´ì„ ì‹¤íŒ¨:', error);
        if (resultEl) {
          resultEl.innerHTML = `<p style="color: var(--danger);">AI ë‰´ìŠ¤ í•´ì„ ì‹¤íŒ¨: ${escapeHtml(error.message || error)}</p>`;
        }
      } finally {
        if (loadingEl) loadingEl.style.display = 'none';
        if (analyzeBtn) {
          analyzeBtn.disabled = false;
          analyzeBtn.innerHTML = originalText || '<i class="fas fa-brain"></i> AIë‰´ìŠ¤í•´ì„';
        }
      }
    }

    function extractArticleDetails(articleData) {
      const details = {
        summary: '',
        publishedAt: '',
        modifiedAt: '',
        journalist: '',
        title: '',
        sourceUrl: '',
        meta: null
      };

      if (!articleData || typeof articleData !== 'object') {
        return details;
      }

      details.title = articleData.title || articleData.articleTitle || '';
      details.press = articleData.press || articleData.publisher || articleData.sourceName || '';

      if (articleData.byline && !details.journalist) {
        details.journalist = String(articleData.byline).trim();
      }

      if (articleData.journalist) {
        details.journalist = String(articleData.journalist).trim();
      }
      if (articleData.publishedAt || articleData.datetime || articleData.date) {
        const candidate = articleData.publishedAt || articleData.datetime || articleData.date;
        if (candidate) {
          details.publishedAt = String(candidate).trim();
        }
      }
      if (articleData.modifiedAt || articleData.updateDate) {
        const candidate = articleData.modifiedAt || articleData.updateDate;
        if (candidate) {
          details.modifiedAt = String(candidate).trim();
        }
      }
      if (articleData.sourceUrl || articleData.url) {
        details.sourceUrl = String(articleData.sourceUrl || articleData.url).trim();
      }

      // í…ìŠ¤íŠ¸ ë²„ì „ì„ ìš°ì„  ì‚¬ìš© (HTML íŒŒì‹± ì˜¤ë¥˜ ë°©ì§€)
      const textCandidates = [articleData.plainText, articleData.text, articleData.rawText].filter(Boolean);
      for (const text of textCandidates) {
        if (text && typeof text === 'string' && text.trim().length > 50) {
          const normalized = normalizeArticleText(text);
          if (normalized && normalized.length > 50) {
            details.summary = normalized;
            break;
          }
        }
      }

      // í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ HTMLì—ì„œ ì¶”ì¶œ
      if (!details.summary) {
        const htmlCandidates = [articleData.content, articleData.rawHtml].filter(Boolean);
        for (const html of htmlCandidates) {
          if (html && typeof html === 'string') {
            const text = normalizeArticleText(htmlToPlainText(html));
            if (text && text.length > 50) {
              details.summary = text;
              break;
            }
          }
        }
      }
      
      // ì—¬ì „íˆ ì—†ìœ¼ë©´ rawPageì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„
      if (!details.summary && articleData.rawPage) {
        try {
          console.log('rawPageì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„...');
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = articleData.rawPage;
          const dicArea = tempDiv.querySelector('#dic_area');
          console.log('rawPageì—ì„œ #dic_area ì°¾ê¸°:', {
            found: !!dicArea,
            textLength: dicArea ? (dicArea.textContent || dicArea.innerText || '').trim().length : 0
          });
          
          if (dicArea) {
            // <br> íƒœê·¸ë¥¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜
            const dicAreaClone = dicArea.cloneNode(true);
            dicAreaClone.querySelectorAll('br').forEach((br) => {
              const newline = document.createTextNode('\n');
              br.replaceWith(newline);
            });
            
            let text = dicAreaClone.textContent || dicAreaClone.innerText || '';
            text = normalizeArticleText(text);
            console.log('rawPageì—ì„œ ì¶”ì¶œí•œ í…ìŠ¤íŠ¸:', {
              length: text.length,
              preview: text.substring(0, 200)
            });
            
            if (text && text.length > 50) {
              details.summary = text;
              console.log('âœ… rawPageì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì„±ê³µ!');
            }
          }
        } catch (e) {
          console.warn('rawPageì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨:', e);
        }
      }

      const publishedAtCandidates = [
        articleData.publishedAt,
        articleData.pubDate,
        articleData.publishDate,
        articleData.date,
        articleData.createdAt
      ].filter((value) => typeof value === 'string' && value.trim().length > 0);
      if (publishedAtCandidates.length > 0) {
      details.publishedAt = publishedAtCandidates[0].trim();
      }

      const sourceCandidates = [
        articleData.sourceUrl,
        articleData.source,
        articleData.originUrl,
        articleData.originalUrl,
        articleData.link
      ].filter((value) => typeof value === 'string' && value.trim().length > 0);
      if (sourceCandidates.length > 0) {
        details.sourceUrl = sourceCandidates[0].trim();
      }

      const metaInfo = parseArticleMeta(articleData);
      if (metaInfo) {
        details.meta = metaInfo;
        // data-date-time ì†ì„±ì„ ìš°ì„  ì‚¬ìš© (í˜•ì‹: "2025-11-12 00:06:32")
        if (metaInfo.publishedAtRaw) {
          try {
            const date = new Date(metaInfo.publishedAtRaw.replace(' ', 'T'));
            if (!Number.isNaN(date.getTime())) {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              const hours = date.getHours();
              const minutes = String(date.getMinutes()).padStart(2, '0');
              const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
              const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
              details.publishedAt = `${year}.${month}.${day}. ${ampm} ${displayHours}:${minutes}`;
            }
          } catch (e) {
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‚¬ìš©
            if (!details.publishedAt && metaInfo.publishedAtDisplay) {
              details.publishedAt = metaInfo.publishedAtDisplay;
            }
          }
        } else if (!details.publishedAt && metaInfo.publishedAtDisplay) {
          details.publishedAt = metaInfo.publishedAtDisplay;
        }
        
        // data-modify-date-time ì†ì„±ì„ ìš°ì„  ì‚¬ìš©
        if (metaInfo.modifiedAtRaw) {
          try {
            const date = new Date(metaInfo.modifiedAtRaw.replace(' ', 'T'));
            if (!Number.isNaN(date.getTime())) {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              const hours = date.getHours();
              const minutes = String(date.getMinutes()).padStart(2, '0');
              const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
              const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
              details.modifiedAt = `${year}.${month}.${day}. ${ampm} ${displayHours}:${minutes}`;
            }
          } catch (e) {
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‚¬ìš©
            if (!details.modifiedAt && metaInfo.modifiedAtDisplay) {
              details.modifiedAt = metaInfo.modifiedAtDisplay;
            }
          }
        } else if (!details.modifiedAt && metaInfo.modifiedAtDisplay) {
          details.modifiedAt = metaInfo.modifiedAtDisplay;
        }
        
        if (!details.journalist && metaInfo.journalistName) {
          details.journalist = metaInfo.journalistName;
        }
        if (!details.sourceUrl && metaInfo.originalLink) {
          details.sourceUrl = metaInfo.originalLink;
        }
        if (!details.title && metaInfo.articleTitle) {
          details.title = metaInfo.articleTitle;
        }
      }

      return details;
    }

    function parseArticleMeta(articleData) {
      const rawHtml =
        articleData?.rawPage ||
        articleData?.fullHtml ||
        articleData?.html ||
        articleData?.rawHtml ||
        '';

      if (!rawHtml || typeof rawHtml !== 'string') {
        return null;
      }

      let doc;
      try {
        const parser = new DOMParser();
        doc = parser.parseFromString(rawHtml, 'text/html');
      } catch (error) {
        console.warn('ê¸°ì‚¬ ë©”íƒ€ íŒŒì‹± ì‹¤íŒ¨:', error);
        return null;
      }

      if (!doc) return null;

      const journalistEl = doc.querySelector('.media_end_head_journalist_name');
      const journalistLinkEl = doc.querySelector('.media_end_head_journalist_box');
      const publishedEl = doc.querySelector('.media_end_head_info_datestamp_time._ARTICLE_DATE_TIME');
      const modifiedEl = doc.querySelector('.media_end_head_info_datestamp_time._ARTICLE_MODIFY_DATE_TIME');
      const originalLinkEl = doc.querySelector('.media_end_head_origin_link');
      const reactionTotalEl = doc.querySelector('._reactionModule .u_likeit_text._count');
      const reactionItems = Array.from(doc.querySelectorAll('.u_likeit_list'));
      const commentCountEl = doc.querySelector('#comment_count');
      const pressLogoAlt = doc.querySelector('.media_end_head_top_logo img')?.getAttribute('alt')?.trim();
      const pressMeta = doc.querySelector('meta[property="og:article:author"]')?.getAttribute('content')?.trim();

      const reactions = reactionItems
        .map((item) => {
          const label = item.querySelector('._label')?.textContent?.trim();
          const count = item.querySelector('._count')?.textContent?.trim();
          if (!label || !count) return null;
          return { label, count };
        })
        .filter(Boolean);

      const journalistLinkRaw = journalistLinkEl?.getAttribute('href') || '';
      const journalistLink =
        journalistLinkRaw && journalistLinkRaw.startsWith('http')
          ? journalistLinkRaw
          : journalistLinkRaw
          ? `https://media.naver.com${journalistLinkRaw}`
          : '';

      const originalLinkRaw = originalLinkEl?.getAttribute('href') || '';
      const originalLink =
        originalLinkRaw && originalLinkRaw.startsWith('http')
          ? originalLinkRaw
          : originalLinkRaw
          ? `https://n.news.naver.com${originalLinkRaw}`
          : '';

      return {
        journalistName: journalistEl?.textContent?.trim() || '',
        journalistLink,
        publishedAtDisplay: publishedEl?.textContent?.trim() || '',
        publishedAtRaw: publishedEl?.getAttribute('data-date-time') || '',
        modifiedAtDisplay: modifiedEl?.textContent?.trim() || '',
        modifiedAtRaw: modifiedEl?.getAttribute('data-modify-date-time') || '',
        originalLink,
        originalLinkLabel: originalLinkEl?.textContent?.trim() || '',
        articleTitle:
          doc.querySelector('meta[property="og:title"]')?.getAttribute('content') ||
          doc.title ||
          '',
        pressName: pressLogoAlt || pressMeta || '',
        reactionTotal: reactionTotalEl?.textContent?.trim() || '',
        reactions,
        commentCount: commentCountEl?.textContent?.trim() || '',
      };
    }

    function renderNaverNewsMeta(meta) {
      const metaView = document.getElementById('naverNewsMetaView');
      const metaContent = document.getElementById('naverNewsMetaContent');
      if (!metaView || !metaContent) return;

      if (!meta) {
        metaView.style.display = 'none';
        metaContent.innerHTML = '';
        return;
      }

      const rows = [];

      if (meta.journalistName) {
        const journalistLink = meta.journalistLink
          ? `<a href="${meta.journalistLink}" target="_blank" rel="noopener">${escapeHtml(meta.journalistName)}</a>`
          : escapeHtml(meta.journalistName);
        rows.push(`
          <div class="naver-news-meta-row">
            <strong>ê¸°ì</strong>
            <span>${journalistLink}</span>
          </div>
        `);
      }

      if (meta.publishedAtDisplay || meta.modifiedAtDisplay) {
        rows.push(`
          <div class="naver-news-meta-row">
            <strong>ë°œí–‰Â·ìˆ˜ì •</strong>
            <span>
              ${meta.publishedAtDisplay ? `ì…ë ¥: ${escapeHtml(meta.publishedAtDisplay)}` : ''}
              ${meta.modifiedAtDisplay ? `<br/>ìˆ˜ì •: ${escapeHtml(meta.modifiedAtDisplay)}` : ''}
            </span>
          </div>
        `);
      }

      if (meta.originalLink) {
        const label = meta.originalLinkLabel || meta.originalLink;
        rows.push(`
          <div class="naver-news-meta-row">
            <strong>ì›ë¬¸</strong>
            <a href="${meta.originalLink}" target="_blank" rel="noopener">${escapeHtml(label)}</a>
          </div>
        `);
      }

      if (meta.reactionTotal || (Array.isArray(meta.reactions) && meta.reactions.length > 0)) {
        const badges = Array.isArray(meta.reactions)
          ? meta.reactions
              .map(
                (reaction) => `
                <span class="naver-news-badge">
                  ${escapeHtml(reaction.label)}
                  <span>${escapeHtml(reaction.count)}</span>
                </span>
              `,
              )
              .join('')
          : '';
        rows.push(`
          <div class="naver-news-meta-row">
            <strong>ë°˜ì‘</strong>
            <div class="naver-news-meta-badges">
              ${meta.reactionTotal ? `<span class="naver-news-badge">ì´ ë°˜ì‘ ${escapeHtml(meta.reactionTotal)}</span>` : ''}
              ${badges}
            </div>
          </div>
        `);
      }

      if (meta.commentCount) {
        rows.push(`
          <div class="naver-news-meta-row">
            <strong>ëŒ“ê¸€</strong>
            <span>${escapeHtml(meta.commentCount)}</span>
          </div>
        `);
      }

      metaContent.innerHTML = rows.join('');
      metaView.style.display = rows.length > 0 ? 'block' : 'none';
    }

    function htmlToPlainText(html) {
      if (!html) return '';
      const temp = document.createElement('div');
      temp.innerHTML = html;
      return temp.textContent || temp.innerText || '';
    }

    function normalizeArticleText(value) {
      if (!value) return '';
      return String(value)
        .replace(/\r\n/g, '\n')
        .replace(/\u00a0/g, ' ')
        .split('\n')
        .map((line) => line.trim())
        .filter((line) => line.length > 0)
        .join('\n\n');
    }

    async function crawlSourceLink() {
      const sourceInput = document.getElementById('newsSource');
      if (!sourceInput) return;

      const url = sourceInput.value.trim();
      if (!url) {
        alert('ë¨¼ì € ì›ë¬¸ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        sourceInput.focus();
        return;
      }

      const button = document.querySelector('.form-action-btn[onclick="crawlSourceLink()"]');
      const originalLabel = button ? button.innerHTML : '';

      try {
        if (button) {
          button.disabled = true;
          button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }

        const encodedUrl = encodeURIComponent(url);
        const result = await fetchJson(`/api/news-fetch?url=${encodedUrl}`);

        if (!result.success || !result.data) {
          throw new Error(result.error || 'ì›ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }

        const { title, content, sourceUrl, text, rawHtml, rawText } = result.data;
        const titleInput = document.getElementById('newsTitle');
        if (title && titleInput && !titleInput.value.trim()) {
          titleInput.value = title;
        }

        const finalSource = sourceUrl || url;
        sourceInput.value = finalSource;

        const sanitizeLength = (html) => {
          if (!html) return 0;
          const tmp = document.createElement('div');
          tmp.innerHTML = html;
          return tmp.textContent.replace(/\s+/g, ' ').trim().length;
        };

        const textToHtml = (value) => {
          if (!value) return '';
          return value
            .split(/\n+/)
            .map((segment) => segment.trim())
            .filter((segment) => segment.length > 0)
            .map((segment) => `<p>${escapeHtml(segment)}</p>`)
            .join('');
        };

        let htmlContent = '';
        const contentLength = sanitizeLength(content);

        if (content && contentLength >= 40) {
          htmlContent = content.trim();
        } else if (rawHtml && sanitizeLength(rawHtml) >= 40) {
          htmlContent = rawHtml.trim();
        } else if (text && text.trim()) {
          htmlContent = textToHtml(text);
        } else if (rawText && rawText.trim()) {
          htmlContent = textToHtml(rawText);
        }

        if (!htmlContent) {
          throw new Error('ê¸°ì‚¬ ë³¸ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        if (finalSource && !htmlContent.includes(finalSource)) {
          htmlContent += `<p><br></p><p>ì¶œì²˜: <a href="${finalSource}" target="_blank" rel="noopener">${finalSource}</a></p>`;
        }

        quill.root.innerHTML = htmlContent;
        alert('âœ… ì›ë¬¸ì„ ë¶ˆëŸ¬ì™€ì„œ ì—ë””í„°ì— ì±„ì› ìŠµë‹ˆë‹¤.');
      } catch (error) {
        console.error('crawlSourceLink error:', error);
        alert('ì›ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error?.message || error));
      } finally {
        if (button) {
          button.disabled = false;
          button.innerHTML = originalLabel || 'í¬ë¡¤ë§';
        }
      }
    }

      async function fetchJson(path, options, timeout = 120000) {
        // íƒ€ì„ì•„ì›ƒ ì„¤ì • (ê¸°ë³¸ 120ì´ˆ = 2ë¶„)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
          // optionsì— signal ì¶”ê°€
          const fetchOptions = {
            ...options,
            signal: controller.signal
          };
          
          const response = await fetchWithFallback(path, fetchOptions);
          clearTimeout(timeoutId);
          
          const text = await response.text();
          let data = {};

          if (text) {
            try {
              data = JSON.parse(text);
            } catch (parseError) {
              data = { error: text };
            }
          }

          if (!response.ok) {
            const message = data?.error || `ìš”ì²­ ì‹¤íŒ¨ (${response.status})`;
            const error = new Error(message);
            error.status = response.status;
            error.data = data;
            throw error;
          }

          return data;
        } catch (error) {
          clearTimeout(timeoutId);
          
          // íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ ì²˜ë¦¬
          if (error.name === 'AbortError' || error.name === 'TimeoutError') {
            const timeoutError = new Error(`ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. (${timeout / 1000}ì´ˆ)`);
            timeoutError.name = 'TimeoutError';
            throw timeoutError;
          }
          
          // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ì¸ ê²½ìš° ì›ë³¸ ì—ëŸ¬ ì •ë³´ë¥¼ ìœ ì§€
          if (error.name === 'TypeError' || error.message?.includes('fetch') || error.message?.includes('Failed')) {
            // ì›ë³¸ ì—ëŸ¬ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ì—¬ ìƒìœ„ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•¨
            throw error;
          }
          // ë‹¤ë¥¸ ì—ëŸ¬ë„ ê·¸ëŒ€ë¡œ ì „ë‹¬
          throw error;
        }
      }

      let quill;
      let editingNewsId = null;
      let naverSectionData = {
        sections: {},
        fetchedAt: null
      };
      let naverEditingState = null;

      function setModalCategory(category) {
        const input = document.getElementById('newsCategoryInput');
        if (input) {
          input.value = category || '';
        }

        document.querySelectorAll('.category-pill').forEach((button) => {
          button.classList.toggle('active', button.dataset.category === category);
        });
      }

      function getModalCategory() {
        const input = document.getElementById('newsCategoryInput');
        return input ? input.value : '';
      }

      // Quill ì—ë””í„° ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', () => {
        quill = new Quill('#editor', {
          theme: 'snow',
          placeholder: 'ë‰´ìŠ¤ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline', 'strike'],
              ['blockquote', 'code-block'],
              [{ 'header': 1 }, { 'header': 2 }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'color': [] }, { 'background': [] }],
              ['link'],
              ['clean']
            ]
          }
        });

        // localStorageì—ì„œ ë„¤ì´ë²„ ë‰´ìŠ¤ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í‘œì‹œ)
        loadNaverNewsFromStorage();
        const panel = document.getElementById('naverNewsPanel');
        const sections = naverSectionData.sections || {};
        
        // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ í‘œì‹œ
        const hasData = Object.keys(NAVER_SECTION_CONFIG).some(key => {
          const items = sections[key] || [];
          return Array.isArray(items) && items.length > 0;
        });
        
        if (panel && hasData) {
          // íŒ¨ë„ í‘œì‹œ
          panel.style.display = 'block';
          // ë‰´ìŠ¤ ë Œë”ë§
          renderNaverNews();
          console.log('âœ… localStorageì—ì„œ ë‰´ìŠ¤ ë°ì´í„° ìë™ ë¡œë“œ ì™„ë£Œ:', {
            social: sections.social?.length || 0,
            economy: sections.economy?.length || 0,
            total: Object.keys(sections).reduce((sum, key) => {
              const items = sections[key] || [];
              return sum + (Array.isArray(items) ? items.length : 0);
            }, 0),
          });
        } else if (panel) {
          // ë°ì´í„°ê°€ ì—†ì–´ë„ íŒ¨ë„ì€ í‘œì‹œ (ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ)
          panel.style.display = 'block';
          renderNaverNews();
        }

        // í¼ ì œì¶œ
        document.getElementById('newsForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await saveNews();
        });

        const naverForm = document.getElementById('naverNewsForm');
        if (naverForm) {
          naverForm.addEventListener('submit', handleNaverNewsSubmit);
        }
      });

      // ëª¨ë‹¬ ì—´ê¸°
      function openModal(newsId = null) {
        editingNewsId = newsId;
        document.getElementById('newsModal').classList.add('active');
        setModalCategory(null);
        
        if (newsId) {
          document.getElementById('modalTitle').textContent = 'ë‰´ìŠ¤ ìˆ˜ì •';
          loadNewsDetail(newsId);
        } else {
          document.getElementById('modalTitle').textContent = 'ìƒˆ ë‰´ìŠ¤ ì‘ì„±';
          document.getElementById('newsForm').reset();
          quill.setContents([]);
          editingNewsId = null;
          setModalCategory(null);
        }
      }

      // ëª¨ë‹¬ ë‹«ê¸°
      function closeModal() {
        document.getElementById('newsModal').classList.remove('active');
        document.getElementById('newsForm').reset();
        quill.setContents([]);
        editingNewsId = null;
        setModalCategory(null);
      }

      // ë‰´ìŠ¤ ìƒì„¸ ë¡œë“œ
      async function loadNewsDetail(id) {
        try {
          const token = localStorage.getItem('access_token');
          const result = await fetchJson(`/api/news-board?id=${id}`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (result.success && result.data) {
            document.getElementById('newsId').value = result.data.id;
            document.getElementById('newsTitle').value = result.data.title;
            setModalCategory(result.data.category);
            document.getElementById('newsImage').value = result.data.image_url || '';
            document.getElementById('newsSource').value = result.data.source_url || '';
            document.getElementById('newsFeatured').checked = result.data.is_featured;
            quill.root.innerHTML = result.data.content;
          }
        } catch (error) {
          console.error('Load news detail error:', error);
          alert('ë‰´ìŠ¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ë‰´ìŠ¤ ì €ì¥
      async function saveNews() {
        const title = document.getElementById('newsTitle').value.trim();
        const category = getModalCategory();
        
        const content = quill.root.innerHTML;
        
        const image_url = document.getElementById('newsImage').value.trim();
        const source_url = document.getElementById('newsSource').value.trim();
        const is_featured = document.getElementById('newsFeatured').checked;

        if (!title || !category || !content) {
          alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        try {
          const token = localStorage.getItem('access_token');
          const method = editingNewsId ? 'PUT' : 'POST';
          const body = {
            title,
            category,
            content,
            image_url: image_url || null,
            source_url: source_url || null,
            is_featured
          };

          if (editingNewsId) {
            body.id = editingNewsId;
          }

          const result = await fetchJson('/api/news-board', {
            method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
          });

          if (!result.success) {
            throw new Error(result.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          alert(editingNewsId ? 'ë‰´ìŠ¤ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë‰´ìŠ¤ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeModal();

        } catch (error) {
          console.error('Save news error:', error);
          alert('ë‰´ìŠ¤ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      // ë‰´ìŠ¤ ê²€ìƒ‰
      async function searchNews() {
        const keyword = document.getElementById('newsKeyword').value;
        const category = document.getElementById('newsCategory').value;
        const resultsEl = document.getElementById('searchResults');
        
        resultsEl.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ëŠ” ì¤‘...</div>';

        try {
          const query = new URLSearchParams({
            keyword,
            category,
            display: 10
          });
          const result = await fetchJson(`/api/news-search?${query.toString()}`);

          if (!result.success) {
            throw new Error(result.error || 'ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          if (!result.items || result.items.length === 0) {
            resultsEl.innerHTML = '<div class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
          }

          // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
          resultsEl.innerHTML = `
            <div style="margin-top: 20px;">
              <h3 style="margin-bottom: 16px;">"${result.searchQuery}" ê²€ìƒ‰ ê²°ê³¼ (${result.total}ê±´)</h3>
              <div class="news-grid">
                ${result.items.map((item, index) => `
                  <div class="news-card" style="cursor: pointer;" onclick="selectSearchResult(${index})">
                    <div class="news-placeholder">ğŸ“°</div>
                    <div class="news-content">
                      <div class="news-header">
                        <span class="news-category category-${item.category === 'ì •ì±…/ì§€ì›ê¸ˆ' ? 'policy' : 'trend'}">
                          ${item.category}
                        </span>
                        ${item.importance >= 4 ? '<span class="news-featured">ì¤‘ìš”</span>' : ''}
                      </div>
                      <div class="news-title">${item.title}</div>
                      <div class="news-excerpt">${item.description}</div>
                      <div class="news-meta">
                        <span><i class="far fa-calendar"></i> ${item.formattedDate}</span>
                        <span><i class="fas fa-star"></i> ì¤‘ìš”ë„: ${item.importance}/5</span>
                      </div>
                      <div class="news-actions">
                        <button class="news-btn" onclick="event.stopPropagation(); getAISummary(${index})">
                          <i class="fas fa-magic"></i> AI ìš”ì•½
                        </button>
                        <button class="news-btn edit" onclick="event.stopPropagation(); editFromSearch(${index})">
                          <i class="fas fa-edit"></i> í¸ì§‘í•˜ì—¬ ë°œí–‰
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;

          // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
          window.searchResults = result.items;

        } catch (error) {
          console.error('Search error:', error);
          resultsEl.innerHTML = `<div class="empty-state" style="color: var(--danger);">ê²€ìƒ‰ ì‹¤íŒ¨: ${error.message}</div>`;
        }
      }

      // ì¹´í…Œê³ ë¦¬ë³„ ì¶”ì²œ í‚¤ì›Œë“œ ë¡œë“œ
      function loadCategoryKeywords() {
        const category = document.getElementById('newsCategory').value;
        const suggestionsEl = document.getElementById('keywordSuggestions');
        
        const keywords = {
          policy: ['ì†Œìƒê³µì¸ ì§€ì›ê¸ˆ', 'ì™¸ì‹ì—… ì§€ì›', 'ì„ëŒ€ë£Œ ì§€ì›', 'ë°°ë‹¬ì•± ìˆ˜ìˆ˜ë£Œ'],
          trend: ['ì™¸ì‹ íŠ¸ë Œë“œ', 'ë°°ë‹¬ íŠ¸ë Œë“œ', 'MZì„¸ëŒ€ ì™¸ì‹', 'ë§›ì§‘ ë§ˆì¼€íŒ…'],
          success: ['ì‹ë‹¹ ì„±ê³µì‚¬ë¡€', 'ë§¤ì¶œ ì¦ëŒ€', 'ì¸ìŠ¤íƒ€ê·¸ë¨ ë§ˆì¼€íŒ…'],
          ingredient: ['ì‹ì¬ë£Œ ê°€ê²©', 'ì›ìì¬ ë™í–¥'],
          regulation: ['ìœ„ìƒ ì ê²€', 'ì˜ì—… ê·œì œ', 'ìŒì‹ì  ì˜ë¬´ì‚¬í•­']
        };

        if (category === 'all' || !keywords[category]) {
          suggestionsEl.innerHTML = '';
          return;
        }

        suggestionsEl.innerHTML = keywords[category].map(kw => 
          `<button class="category-btn" onclick="setKeyword('${kw}')" style="font-size: 12px; padding: 6px 12px;">
            ${kw}
          </button>`
        ).join('');
      }

      // í‚¤ì›Œë“œ ì„¤ì •
      function setKeyword(keyword) {
        document.getElementById('newsKeyword').value = keyword;
        searchNews();
      }

      // ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ
      function selectSearchResult(index) {
        const item = window.searchResults[index];
        window.open(item.link, '_blank');
      }

      // AI ìš”ì•½ ë°›ê¸°
      async function getAISummary(index) {
        const item = window.searchResults[index];
        const btn = event?.target;
        const originalText = btn ? btn.innerHTML : '';

        if (btn) {
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI ë¶„ì„ ì¤‘...';
        }

        try {
          const result = await fetchJson('/api/news-ai-summary', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              title: item.title,
              description: item.description,
              url: item.link
            })
          });

          if (!result.success) {
            throw new Error(result.error || 'AI ìš”ì•½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          // ìš”ì•½ ê²°ê³¼ í‘œì‹œ
          alert(`ğŸ¤– AI ë¶„ì„ ê²°ê³¼\n\n` +
                `ğŸ“Œ í•µì‹¬ ìš”ì•½:\n${result.aiSummary.summary}\n\n` +
                `ğŸ’¡ ì‹¤ì§ˆì  ë„ì›€:\n${result.aiSummary.benefit}\n\n` +
                `âœ… ì•¡ì…˜ ì•„ì´í…œ:\n${result.aiSummary.action}\n\n` +
                `â­ ì¤‘ìš”ë„: ${result.aiSummary.importance}/5\n` +
                `ğŸ“‚ ì¹´í…Œê³ ë¦¬: ${result.aiSummary.category}`);

        } catch (error) {
          console.error('AI summary error:', error);
          alert('AI ìš”ì•½ ì‹¤íŒ¨: ' + error.message);
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalText || '<i class="fas fa-magic"></i> AI ìš”ì•½';
          }
        }
      }

      // ê²€ìƒ‰ ê²°ê³¼ë¥¼ í¸ì§‘ ëª¨ë‹¬ë¡œ
      async function editFromSearch(index) {
        const triggerBtn = event?.currentTarget;
        const originalBtnLabel = triggerBtn ? triggerBtn.innerHTML : '';
        const item = window.searchResults[index];
        const sourceUrl = item.originallink || item.link;
        const loadingMessage = '<p>ì›ë¬¸ ì „ì²´ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';

        if (triggerBtn) {
          triggerBtn.disabled = true;
          triggerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        }

        openModal();

        // í¼ì— ê¸°ë³¸ ë°ì´í„° ì±„ìš°ê¸°
        document.getElementById('newsTitle').value = item.title;
        document.getElementById('newsSource').value = sourceUrl || '';
        quill.root.innerHTML = loadingMessage;

        // ì¹´í…Œê³ ë¦¬ ìë™ ì„ íƒ
        const categoryMap = {
          'ì •ì±…/ì§€ì›ê¸ˆ': 'policy',
          'íŠ¸ë Œë“œ': 'trend',
          'ì„±ê³µì‚¬ë¡€': 'management',
          'ë°°ë‹¬/í”Œë«í¼': 'technology',
          'ì‹ì¬ë£Œ/ì›ê°€': 'ingredients'
        };
        
        const mappedCategory = categoryMap[item.category];
        setModalCategory(mappedCategory || null);

        try {
          const encodedUrl = encodeURIComponent(sourceUrl || item.link);
          const result = await fetchJson(`/api/news-fetch?url=${encodedUrl}`);

          if (result.success && result.data && result.data.content) {
            const articleContent = result.data.content.trim();
            const finalSource = result.data.sourceUrl || sourceUrl || item.link;
            document.getElementById('newsSource').value = finalSource || '';
            quill.root.innerHTML = articleContent
              ? `${articleContent}<p><br></p><p>ì¶œì²˜: <a href="${finalSource}" target="_blank" rel="noopener">${finalSource}</a></p>`
              : createFallbackContent(item, sourceUrl);
          } else {
            document.getElementById('newsSource').value = sourceUrl || item.link || '';
            quill.root.innerHTML = createFallbackContent(item, sourceUrl);
            alert('ì›ë¬¸ì„ ëª¨ë‘ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìš”ì•½ë³¸ìœ¼ë¡œ ì±„ì›Œë‘˜ê²Œìš”.');
          }
        } catch (error) {
          console.error('ì›ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
          document.getElementById('newsSource').value = sourceUrl || item.link || '';
          quill.root.innerHTML = createFallbackContent(item, sourceUrl);
          alert('ì›ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìš”ì•½ë³¸ìœ¼ë¡œ ì±„ì›Œë‘˜ê²Œìš”.');
        } finally {
          if (triggerBtn) {
            triggerBtn.disabled = false;
            triggerBtn.innerHTML = originalBtnLabel || '<i class="fas fa-edit"></i> í¸ì§‘í•˜ì—¬ ë°œí–‰';
          }
        }
      }

      function createFallbackContent(item, sourceUrl) {
        const safeText = (item.description || '').replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
        const link = sourceUrl || item.link;
        const linkHtml = link
          ? `<p>ì¶œì²˜: <a href="${link}" target="_blank" rel="noopener">${link}</a></p>`
          : '';
        return `<p>${safeText}</p><p><br></p>${linkHtml}`;
      }

      // AI ë‰´ìŠ¤ ì¶”ì²œ (ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€)
      async function getAIRecommendations() {
        const suggestionsEl = document.getElementById('aiSuggestions');
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIê°€ ë‰´ìŠ¤ë¥¼ ì°¾ëŠ” ì¤‘...';

        try {
          const token = localStorage.getItem('access_token');
          const result = await fetchJson('/api/ai-news-recommend', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              category: null
            })
          });

          if (!result.success || !result.data) {
            throw new Error(result.error || 'AI ì¶”ì²œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          // AI ì œì•ˆ ì¹´ë“œ ìƒì„±
          suggestionsEl.innerHTML = result.data.map((suggestion, index) => `
            <div class="ai-suggestion-card" onclick="selectAISuggestion(${index}, ${JSON.stringify(suggestion).replace(/"/g, '&quot;')})">
              <div class="ai-suggestion-title">${suggestion.title}</div>
              <div class="ai-suggestion-summary">${suggestion.summary}</div>
              <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                ğŸ’¡ ${suggestion.why_useful}
              </div>
            </div>
          `).join('');

          // ì œì•ˆ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
          window.aiSuggestions = result.data;

        } catch (error) {
          console.error('AI recommendations error:', error);
          alert('AI ì¶”ì²œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
          suggestionsEl.innerHTML = '';
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'AI ë‰´ìŠ¤ ì¶”ì²œë°›ê¸°';
        }
      }

      // AI ì œì•ˆ ì„ íƒ
      function selectAISuggestion(index, fallbackSuggestion) {
        const suggestion = window.aiSuggestions ? window.aiSuggestions[index] : fallbackSuggestion;
        
        if (!suggestion) {
          alert('ì œì•ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        openModal();
        document.getElementById('newsTitle').value = suggestion.title;
        setModalCategory(suggestion.category || null);
        quill.root.innerHTML = suggestion.content;
        
        // ëª¨ë‹¬ì´ ì—´ë¦¬ë©´ AI ì„¹ì…˜ ë‹«ê¸°
        document.getElementById('aiSuggestions').innerHTML = '';
      }

      function mapCategoryToClass(category) {
        if (!category) return 'policy';
        const normalized = category.toLowerCase();

        if (normalized.includes('ì •ì±…') || normalized.includes('ì§€ì›')) return 'policy';
        if (normalized.includes('íŠ¸ë Œë“œ')) return 'trend';
        if (normalized.includes('ì„±ê³µ') || normalized.includes('ê²½ì˜')) return 'management';
        if (normalized.includes('ì‹ì¬ë£Œ') || normalized.includes('ì›ê°€')) return 'ingredients';
        if (normalized.includes('ê¸°ìˆ ') || normalized.includes('í”Œë«í¼') || normalized.includes('ë°°ë‹¬')) return 'technology';

        return 'policy';
      }

      function escapeHtml(text = '') {
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // ê´€ë¦¬ìê°€ ì‘ì„±í•˜ì§€ ì•Šì€ ë‰´ìŠ¤ë§Œ ì‚­ì œ
      async function deleteNonAdminNews() {
        if (!confirm('âš ï¸ ê´€ë¦¬ìê°€ ì‘ì„±í•˜ì§€ ì•Šì€ ë‰´ìŠ¤ë§Œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ê´€ë¦¬ìê°€ news-management.htmlì—ì„œ ì‘ì„±í•œ ë‰´ìŠ¤ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) {
          return;
        }

        const button = document.getElementById('deleteNonAdminNewsButton');
        const originalText = button.innerHTML;

        try {
          button.disabled = true;
          button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì‚­ì œ ì¤‘...';

          // AdminUtilsë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ëœ ìš”ì²­ ë³´ë‚´ê¸°
          let result;
          if (window.AdminUtils && typeof window.AdminUtils.adminFetch === 'function') {
            result = await window.AdminUtils.adminFetch('/api/news-board?nonAdmin=true', {
              method: 'DELETE'
            });
          } else {
            // AdminUtilsê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì²˜ë¦¬
            const token = localStorage.getItem('access_token');
            if (!token) {
              throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }

            result = await fetchJson('/api/news-board?nonAdmin=true', {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
          }

          if (!result.success) {
            throw new Error(result.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          alert(`âœ… ì„±ê³µ!\n\n${result.message}\nì‚­ì œëœ ë‰´ìŠ¤ ìˆ˜: ${result.deletedCount || 0}ê°œ`);
          
          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ì„ íƒì‚¬í•­)
          if (confirm('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.location.reload();
          }

        } catch (error) {
          console.error('ê´€ë¦¬ì ì™¸ ë‰´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (error.message || error));
        } finally {
          button.disabled = false;
          button.innerHTML = originalText;
        }
      }

      // ëª¨ë“  ë‰´ìŠ¤ ì‚­ì œ
      async function deleteAllNews() {
        if (!confirm('âš ï¸ ì •ë§ë¡œ ëª¨ë“  ë‰´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
          return;
        }

        if (!confirm('âš ï¸ í•œ ë²ˆ ë” í™•ì¸í•©ë‹ˆë‹¤.\n\nì •ë§ë¡œ ëª¨ë“  ë‰´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        const button = document.getElementById('deleteAllNewsButton');
        const originalText = button.innerHTML;

        try {
          button.disabled = true;
          button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì‚­ì œ ì¤‘...';

          // AdminUtilsë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ëœ ìš”ì²­ ë³´ë‚´ê¸°
          let result;
          if (window.AdminUtils && typeof window.AdminUtils.adminFetch === 'function') {
            result = await window.AdminUtils.adminFetch('/api/news-board?all=true', {
              method: 'DELETE'
            });
          } else {
            // AdminUtilsê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì²˜ë¦¬
            const token = localStorage.getItem('access_token');
            if (!token) {
              throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }

            result = await fetchJson('/api/news-board?all=true', {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
          }

          if (!result.success) {
            throw new Error(result.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          alert(`âœ… ì„±ê³µ!\n\nëª¨ë“  ë‰´ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚­ì œëœ ë‰´ìŠ¤ ìˆ˜: ${result.deletedCount || 'ì•Œ ìˆ˜ ì—†ìŒ'}`);
          
          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ì„ íƒì‚¬í•­)
          if (confirm('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.location.reload();
          }

        } catch (error) {
          console.error('ëª¨ë“  ë‰´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (error.message || error));
        } finally {
          button.disabled = false;
          button.innerHTML = originalText;
        }
      }
    </script>

    <!-- ì—…ë¡œë“œ ì„±ê³µ ëª¨ë‹¬ -->
    <div id="uploadSuccessModal" class="upload-success-modal" style="display: none;">
      <div class="upload-success-modal-overlay"></div>
      <div class="upload-success-modal-content">
        <div class="upload-success-modal-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2 class="upload-success-modal-title">ì—…ë¡œë“œ ì™„ë£Œ!</h2>
        <p class="upload-success-modal-message">ì‚¬ì¥í”½ì— ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <div class="upload-success-modal-buttons">
          <button class="upload-success-btn upload-success-btn-primary" onclick="goToNewsBoard()">
            <i class="fas fa-external-link-alt"></i> ì‚¬ì¥í”½ìœ¼ë¡œ ì´ë™
          </button>
          <button class="upload-success-btn upload-success-btn-secondary" onclick="closeUploadSuccessModal()">
            <i class="fas fa-times"></i> ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>

    <style>
      .upload-success-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .upload-success-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }

      .upload-success-modal-content {
        position: relative;
        background: white;
        border-radius: 16px;
        padding: 40px;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .upload-success-modal-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 24px;
        background: linear-gradient(135deg, #03c75a 0%, #02a84a 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: white;
        box-shadow: 0 8px 24px rgba(3, 199, 90, 0.3);
      }

      .upload-success-modal-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 12px;
      }

      .upload-success-modal-message {
        font-size: 16px;
        color: var(--text-secondary);
        margin: 0 0 32px;
        line-height: 1.6;
      }

      .upload-success-modal-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .upload-success-btn {
        padding: 14px 28px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        min-width: 140px;
        justify-content: center;
      }

      .upload-success-btn-primary {
        background: var(--accent, #03c75a);
        color: white;
        box-shadow: 0 4px 12px rgba(3, 199, 90, 0.3);
      }

      .upload-success-btn-primary:hover {
        background: #02a84a;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(3, 199, 90, 0.4);
      }

      .upload-success-btn-secondary {
        background: #f5f5f5;
        color: var(--text-primary);
        border: 1px solid var(--border);
      }

      .upload-success-btn-secondary:hover {
        background: #e8e8e8;
        transform: translateY(-2px);
      }

      @media (max-width: 480px) {
        .upload-success-modal-content {
          padding: 32px 24px;
        }

        .upload-success-modal-buttons {
          flex-direction: column;
        }

        .upload-success-btn {
          width: 100%;
        }
      }
    </style>

    <script>
      // ì—…ë¡œë“œ ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ
      function showUploadSuccessModal() {
        const modal = document.getElementById('uploadSuccessModal');
        if (modal) {
          modal.style.display = 'flex';
        }
      }

      // ì—…ë¡œë“œ ì„±ê³µ ëª¨ë‹¬ ë‹«ê¸°
      function closeUploadSuccessModal() {
        const modal = document.getElementById('uploadSuccessModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      // ë‰´ìŠ¤ ê²Œì‹œíŒìœ¼ë¡œ ì´ë™
      function goToNewsBoard() {
        window.location.href = '/news-board.html';
      }

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('uploadSuccessModal');
        if (modal) {
          const overlay = modal.querySelector('.upload-success-modal-overlay');
          if (overlay) {
            overlay.addEventListener('click', closeUploadSuccessModal);
          }
        }
      });
    </script>
  </body>
</html>

