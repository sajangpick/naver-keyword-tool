<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë‰´ìŠ¤ ê´€ë¦¬ - ì‚¬ì¥í”½ ê´€ë¦¬ì</title>
    
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    
    <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="/admin/assets/admin-common.css" />
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
      .news-controls {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .category-filter {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .category-btn {
        padding: 8px 16px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }

      .category-btn:hover {
        background: rgba(3, 199, 90, 0.1);
        border-color: var(--accent);
      }

      .category-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .news-grid {
        display: grid;
        gap: 16px;
      }

      .news-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        gap: 20px;
        transition: all 0.2s;
      }

      .news-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }

      .news-image {
        width: 120px;
        height: 120px;
        border-radius: 8px;
        object-fit: cover;
        background: var(--bg);
        flex-shrink: 0;
      }

      .news-placeholder {
        width: 120px;
        height: 120px;
        border-radius: 8px;
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        flex-shrink: 0;
      }

      .news-content {
        flex: 1;
        min-width: 0;
      }

      .news-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 8px;
      }

      .news-category {
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
      }

      .category-policy { background: #E8F5E9; color: #2E7D32; }
      .category-trend { background: #E3F2FD; color: #1565C0; }
      .category-management { background: #FFF3E0; color: #EF6C00; }
      .category-ingredients { background: #F3E5F5; color: #7B1FA2; }
      .category-technology { background: #FCE4EC; color: #C2185B; }

      .news-featured {
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        background: #FFE082;
        color: #F57F17;
      }

      .news-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text);
      }

      .news-excerpt {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 12px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .news-meta {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 12px;
      }

      .news-actions {
        display: flex;
        gap: 8px;
      }

      .news-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
        transition: all 0.2s;
      }

      .news-btn:hover {
        background: var(--bg);
      }

      .news-btn.edit {
        color: var(--info);
        border-color: var(--info);
      }

      .news-btn.edit:hover {
        background: rgba(59, 130, 246, 0.1);
      }

      .news-btn.delete {
        color: var(--danger);
        border-color: var(--danger);
      }

      .news-btn.delete:hover {
        background: rgba(239, 68, 68, 0.1);
      }

      /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 900px;
        max-height: 95vh;
        overflow-y: auto;
        padding: 24px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: none;
        background: var(--bg);
        cursor: pointer;
        font-size: 18px;
        transition: all 0.2s;
      }

      .modal-close:hover {
        background: var(--border);
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text);
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(3, 199, 90, 0.1);
      }

      .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }

      .form-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
      }

      .form-checkbox input {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .editor-container {
        height: 200px;
        margin-bottom: 16px;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-primary:hover {
        background: #02b350;
      }

      .btn-secondary {
        background: var(--bg);
        color: var(--text);
      }

      .btn-secondary:hover {
        background: var(--border);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 24px;
      }

      .page-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }

      .page-btn:hover {
        background: var(--bg);
      }

      .page-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .ai-recommend-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        color: white;
      }

      .ai-recommend-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .ai-recommend-desc {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 16px;
      }

      .ai-recommend-btn {
        background: white;
        color: #667eea;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }

      .ai-recommend-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }

      .ai-suggestions {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }

      .ai-suggestion-card {
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .ai-suggestion-card:hover {
        background: rgba(255,255,255,0.2);
        transform: translateX(4px);
      }

      .ai-suggestion-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .ai-suggestion-summary {
        font-size: 13px;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <!-- ì‚¬ì´ë“œë°” ìë™ ìƒì„± -->
    
    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="admin-main">
      <!-- í—¤ë” ìë™ ìƒì„± -->
      
      <div class="content">
        <!-- ë‰´ìŠ¤ ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="ai-recommend-section" id="newsSearchSection">
          <div class="ai-recommend-title">ğŸ” ì†Œìƒê³µì¸ ë‰´ìŠ¤ ê²€ìƒ‰</div>
          <div class="ai-recommend-desc">
            ì •ì±…ì§€ì›ê¸ˆ, ì™¸ì‹ íŠ¸ë Œë“œ, ì„±ê³µì‚¬ë¡€ ë“± ì‹ë‹¹ ëŒ€í‘œë‹˜ê»˜ ìœ ìš©í•œ ìµœì‹  ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”
          </div>
          
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <input 
              type="text" 
              id="newsKeyword" 
              placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì†Œìƒê³µì¸ ì§€ì›ê¸ˆ, ë°°ë‹¬ íŠ¸ë Œë“œ)"
              style="flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
              onkeypress="if(event.key === 'Enter') searchNews()"
            />
            <select 
              id="newsCategory" 
              style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
              onchange="loadCategoryKeywords()"
            >
              <option value="all">ì „ì²´</option>
              <option value="policy">ì •ì±…/ì§€ì›ê¸ˆ</option>
              <option value="trend">ì™¸ì‹ íŠ¸ë Œë“œ</option>
              <option value="success">ì„±ê³µì‚¬ë¡€</option>
              <option value="ingredient">ì‹ì¬ë£Œ/ì›ê°€</option>
              <option value="regulation">ê·œì œ/ì˜ë¬´ì‚¬í•­</option>
            </select>
            <button class="ai-recommend-btn" onclick="searchNews()">
              <i class="fas fa-search"></i> ê²€ìƒ‰
            </button>
          </div>
          
          <div id="keywordSuggestions" style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;"></div>
          <div class="ai-suggestions" id="searchResults"></div>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ -->
        <div class="news-controls">
          <button class="btn btn-primary" onclick="openModal()">
            <i class="fas fa-plus"></i> ìƒˆ ë‰´ìŠ¤ ì‘ì„±
          </button>

          <div class="category-filter">
            <button class="category-btn active" data-category="all" onclick="filterCategory('all')">
              ì „ì²´
            </button>
            <button class="category-btn" data-category="policy" onclick="filterCategory('policy')">
              ğŸ›ï¸ ì •ì±…/ë²•ê·œ
            </button>
            <button class="category-btn" data-category="trend" onclick="filterCategory('trend')">
              ğŸ“ˆ íŠ¸ë Œë“œ
            </button>
            <button class="category-btn" data-category="management" onclick="filterCategory('management')">
              ğŸ’¡ ê²½ì˜ íŒ
            </button>
            <button class="category-btn" data-category="ingredients" onclick="filterCategory('ingredients')">
              ğŸ½ï¸ ì‹ìì¬
            </button>
            <button class="category-btn" data-category="technology" onclick="filterCategory('technology')">
              ğŸ› ï¸ ê¸°ìˆ /ë„êµ¬
            </button>
          </div>
        </div>

        <!-- ë‰´ìŠ¤ ëª©ë¡ -->
        <div class="panel">
          <div class="panel-header">
            <h2 class="panel-title">ğŸ“° ë‰´ìŠ¤ ëª©ë¡</h2>
          </div>
          
          <div class="news-grid" id="newsList">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i>
              <div>ë¡œë”© ì¤‘...</div>
            </div>
          </div>

          <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </main>

    <!-- ë‰´ìŠ¤ ì‘ì„±/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="newsModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">ìƒˆ ë‰´ìŠ¤ ì‘ì„±</h2>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>

        <form id="newsForm">
          <input type="hidden" id="newsId" />

          <div class="form-group">
            <label class="form-label">ì œëª© *</label>
            <input type="text" class="form-input" id="newsTitle" required placeholder="ë‰´ìŠ¤ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
          </div>

          <div class="form-group">
            <label class="form-label">ì¹´í…Œê³ ë¦¬ *</label>
            <select class="form-select" id="newsCategory" required>
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="policy">ğŸ›ï¸ ì •ì±…/ë²•ê·œ</option>
              <option value="trend">ğŸ“ˆ íŠ¸ë Œë“œ</option>
              <option value="management">ğŸ’¡ ê²½ì˜ íŒ</option>
              <option value="ingredients">ğŸ½ï¸ ì‹ìì¬</option>
              <option value="technology">ğŸ› ï¸ ê¸°ìˆ /ë„êµ¬</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">ë‚´ìš© *</label>
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
              <button type="button" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="toggleHTMLMode()">
                <i class="fas fa-code"></i> HTML ëª¨ë“œ
              </button>
              <span id="htmlModeIndicator" style="display: none; color: #EF6C00; font-size: 13px; font-weight: 600; align-self: center;">
                ğŸ“ HTML ì§ì ‘ ì…ë ¥ ëª¨ë“œ
              </span>
            </div>
            <div class="editor-container" id="editor"></div>
            <textarea id="htmlEditor" style="display: none; width: 100%; height: 200px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px;"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">ì´ë¯¸ì§€ URL (ì„ íƒ)</label>
            <input type="url" class="form-input" id="newsImage" placeholder="https://example.com/image.jpg" />
          </div>

          <div class="form-group">
            <label class="form-label">ì›ë¬¸ ë§í¬ (ì„ íƒ)</label>
            <input type="url" class="form-input" id="newsSource" placeholder="https://example.com/article" />
          </div>

          <div class="form-checkbox">
            <input type="checkbox" id="newsFeatured" />
            <label for="newsFeatured">â­ ì¤‘ìš” ë‰´ìŠ¤ë¡œ í‘œì‹œ</label>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary">ì €ì¥</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="/admin/assets/admin-sidebar.js"></script>
    <script src="/admin/assets/admin-header.js"></script>
    <script src="/admin/assets/admin-utils.js"></script>
    
    <script>
      // ë¡œì»¬ ê°œë°œ í™˜ê²½ê³¼ í”„ë¡œë•ì…˜ í™˜ê²½ ìë™ ê°ì§€
      const isLocalhost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
      const API_BASE = isLocalhost ? 'http://localhost:3003' : '';
      const PRIMARY_RENDER_BASE = 'https://sajangpick-kwon-teamjang.onrender.com';
      const LEGACY_RENDER_BASE = 'https://naver-keyword-tool.onrender.com';
      const FALLBACK_RENDER_BASES = [PRIMARY_RENDER_BASE, LEGACY_RENDER_BASE].filter(Boolean);
      const RETRYABLE_STATUS = new Set([404, 408, 500, 502, 503, 504, 521, 522, 523]);

      function cloneRequestOptions(options) {
        if (!options) return undefined;
        const cloned = { ...options };
        if (options.headers instanceof Headers) {
          cloned.headers = new Headers(options.headers);
        } else if (options.headers) {
          cloned.headers = { ...options.headers };
        }

        if (options.body instanceof FormData) {
          const formDataCopy = new FormData();
          options.body.forEach((value, key) => formDataCopy.append(key, value));
          cloned.body = formDataCopy;
        } else if (options.body instanceof URLSearchParams) {
          cloned.body = new URLSearchParams(options.body);
        } else if (options.body instanceof Blob) {
          cloned.body = options.body.slice(0, options.body.size, options.body.type);
        } else if (options.body !== undefined) {
          cloned.body = options.body;
        }

        return cloned;
      }

      async function fetchWithFallback(path, options) {
        const targets = [];

        if (API_BASE) {
          targets.push(`${API_BASE}${path}`);
        } else {
          targets.push(path);
        }

        FALLBACK_RENDER_BASES.forEach((host) => {
          if (!host) return;
          const absolutePath = `${host}${path}`;
          if (!targets.includes(absolutePath)) {
            targets.push(absolutePath);
          }
        });

        let lastError = null;
        let lastResponse = null;

        for (let index = 0; index < targets.length; index += 1) {
          const target = targets[index];

          try {
            const response = await fetch(target, cloneRequestOptions(options));

            if (response.ok) {
              return response;
            }

            lastResponse = response;

            if (RETRYABLE_STATUS.has(response.status) && index < targets.length - 1) {
              continue;
            }

            return response;
          } catch (error) {
            lastError = error;
          }
        }

        if (lastResponse) return lastResponse;
        if (lastError) throw lastError;
        throw new Error('API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

      async function fetchJson(path, options) {
        const response = await fetchWithFallback(path, options);
        const text = await response.text();
        let data = {};

        if (text) {
          try {
            data = JSON.parse(text);
          } catch (parseError) {
            data = { error: text };
          }
        }

        if (!response.ok) {
          const message = data?.error || `ìš”ì²­ ì‹¤íŒ¨ (${response.status})`;
          const error = new Error(message);
          error.status = response.status;
          error.data = data;
          throw error;
        }

        return data;
      }

      let quill;
      let currentPage = 1;
      let currentCategory = 'all';
      let editingNewsId = null;
      let isHTMLMode = false;

      // Quill ì—ë””í„° ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', () => {
        quill = new Quill('#editor', {
          theme: 'snow',
          placeholder: 'ë‰´ìŠ¤ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline', 'strike'],
              ['blockquote', 'code-block'],
              [{ 'header': 1 }, { 'header': 2 }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'color': [] }, { 'background': [] }],
              ['link'],
              ['clean']
            ]
          }
        });

        loadNews();

        // í¼ ì œì¶œ
        document.getElementById('newsForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await saveNews();
        });
      });

      // ë‰´ìŠ¤ ëª©ë¡ ë¡œë“œ
      async function loadNews(page = 1) {
        currentPage = page;
        const newsList = document.getElementById('newsList');
        
        try {
          const params = new URLSearchParams({
            page,
            limit: 10
          });

          if (currentCategory !== 'all') {
            params.append('category', currentCategory);
          }

          const result = await fetchJson(`/api/news-board?${params.toString()}`);

          if (!result.success || !result.data) {
            throw new Error(result.error || 'ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }

          if (result.data.length === 0) {
            newsList.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“°</div>
                <div>ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>
              </div>
            `;
            document.getElementById('pagination').innerHTML = '';
            return;
          }

          // ë‰´ìŠ¤ ì¹´ë“œ ìƒì„±
          newsList.innerHTML = result.data.map(news => {
            const categoryLabels = {
              policy: 'ì •ì±…/ë²•ê·œ',
              trend: 'íŠ¸ë Œë“œ',
              management: 'ê²½ì˜ íŒ',
              ingredients: 'ì‹ìì¬',
              technology: 'ê¸°ìˆ /ë„êµ¬'
            };

            const excerpt = news.content.replace(/<[^>]*>/g, '').substring(0, 150);
            const createdAt = new Date(news.created_at).toLocaleDateString('ko-KR');

            return `
              <div class="news-card">
                ${news.image_url 
                  ? `<img src="${news.image_url}" alt="${news.title}" class="news-image" />`
                  : `<div class="news-placeholder">ğŸ“°</div>`
                }
                <div class="news-content">
                  <div class="news-header">
                    <span class="news-category category-${news.category}">
                      ${categoryLabels[news.category] || news.category}
                    </span>
                    ${news.is_featured ? '<span class="news-featured">â­ ì¤‘ìš”</span>' : ''}
                  </div>
                  <div class="news-title">${news.title}</div>
                  <div class="news-excerpt">${excerpt}...</div>
                  <div class="news-meta">
                    <span><i class="fas fa-calendar"></i> ${createdAt}</span>
                    <span><i class="fas fa-eye"></i> ${news.views}íšŒ</span>
                    ${news.source_url ? '<span><i class="fas fa-link"></i> ì›ë¬¸ ë§í¬</span>' : ''}
                  </div>
                  <div class="news-actions">
                    <button class="news-btn edit" onclick="editNews(${news.id})">
                      <i class="fas fa-edit"></i> ìˆ˜ì •
                    </button>
                    <button class="news-btn delete" onclick="deleteNews(${news.id})">
                      <i class="fas fa-trash"></i> ì‚­ì œ
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          // í˜ì´ì§€ë„¤ì´ì…˜
          renderPagination(result.pagination);

        } catch (error) {
          console.error('Load news error:', error);
          newsList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">âš ï¸</div>
              <div>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>
              <div style="font-size: 14px; margin-top: 8px;">${error.message}</div>
            </div>
          `;
        }
      }

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      function renderPagination(pagination) {
        const paginationEl = document.getElementById('pagination');
        if (!pagination || pagination.totalPages <= 1) {
          paginationEl.innerHTML = '';
          return;
        }

        let html = '';
        
        // ì´ì „ ë²„íŠ¼
        if (pagination.page > 1) {
          html += `<button class="page-btn" onclick="loadNews(${pagination.page - 1})">â†</button>`;
        }

        // í˜ì´ì§€ ë²ˆí˜¸
        for (let i = 1; i <= pagination.totalPages; i++) {
          if (i === pagination.page) {
            html += `<button class="page-btn active">${i}</button>`;
          } else if (i === 1 || i === pagination.totalPages || Math.abs(i - pagination.page) <= 2) {
            html += `<button class="page-btn" onclick="loadNews(${i})">${i}</button>`;
          } else if (i === pagination.page - 3 || i === pagination.page + 3) {
            html += `<span style="padding: 8px;">...</span>`;
          }
        }

        // ë‹¤ìŒ ë²„íŠ¼
        if (pagination.page < pagination.totalPages) {
          html += `<button class="page-btn" onclick="loadNews(${pagination.page + 1})">â†’</button>`;
        }

        paginationEl.innerHTML = html;
      }

      // ì¹´í…Œê³ ë¦¬ í•„í„°
      function filterCategory(category) {
        currentCategory = category;
        
        // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.category === category);
        });

        loadNews(1);
      }

      // HTML ëª¨ë“œ í† ê¸€
      function toggleHTMLMode() {
        isHTMLMode = !isHTMLMode;
        const editor = document.getElementById('editor');
        const htmlEditor = document.getElementById('htmlEditor');
        const indicator = document.getElementById('htmlModeIndicator');

        if (isHTMLMode) {
          // HTML ëª¨ë“œë¡œ ì „í™˜
          htmlEditor.value = quill.root.innerHTML;
          editor.style.display = 'none';
          htmlEditor.style.display = 'block';
          indicator.style.display = 'inline';
        } else {
          // ì—ë””í„° ëª¨ë“œë¡œ ì „í™˜
          quill.root.innerHTML = htmlEditor.value;
          htmlEditor.style.display = 'none';
          editor.style.display = 'block';
          indicator.style.display = 'none';
        }
      }

      // ëª¨ë‹¬ ì—´ê¸°
      function openModal(newsId = null) {
        editingNewsId = newsId;
        document.getElementById('newsModal').classList.add('active');
        
        // HTML ëª¨ë“œ ì´ˆê¸°í™”
        isHTMLMode = false;
        document.getElementById('editor').style.display = 'block';
        document.getElementById('htmlEditor').style.display = 'none';
        document.getElementById('htmlModeIndicator').style.display = 'none';
        
        if (newsId) {
          document.getElementById('modalTitle').textContent = 'ë‰´ìŠ¤ ìˆ˜ì •';
          loadNewsDetail(newsId);
        } else {
          document.getElementById('modalTitle').textContent = 'ìƒˆ ë‰´ìŠ¤ ì‘ì„±';
          document.getElementById('newsForm').reset();
          quill.setContents([]);
          editingNewsId = null;
        }
      }

      // ëª¨ë‹¬ ë‹«ê¸°
      function closeModal() {
        document.getElementById('newsModal').classList.remove('active');
        document.getElementById('newsForm').reset();
        quill.setContents([]);
        editingNewsId = null;
      }

      // ë‰´ìŠ¤ ìƒì„¸ ë¡œë“œ
      async function loadNewsDetail(id) {
        try {
          const token = localStorage.getItem('access_token');
          const result = await fetchJson(`/api/news-board?id=${id}`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (result.success && result.data) {
            document.getElementById('newsId').value = result.data.id;
            document.getElementById('newsTitle').value = result.data.title;
            document.getElementById('newsCategory').value = result.data.category;
            document.getElementById('newsImage').value = result.data.image_url || '';
            document.getElementById('newsSource').value = result.data.source_url || '';
            document.getElementById('newsFeatured').checked = result.data.is_featured;
            quill.root.innerHTML = result.data.content;
          }
        } catch (error) {
          console.error('Load news detail error:', error);
          alert('ë‰´ìŠ¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ë‰´ìŠ¤ ì €ì¥
      async function saveNews() {
        const title = document.getElementById('newsTitle').value.trim();
        const category = document.getElementById('newsCategory').value;
        
        // HTML ëª¨ë“œì¼ ê²½ìš° textareaì—ì„œ, ì•„ë‹ˆë©´ ì—ë””í„°ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        const content = isHTMLMode 
          ? document.getElementById('htmlEditor').value 
          : quill.root.innerHTML;
        
        const image_url = document.getElementById('newsImage').value.trim();
        const source_url = document.getElementById('newsSource').value.trim();
        const is_featured = document.getElementById('newsFeatured').checked;

        if (!title || !category || !content) {
          alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        try {
          const token = localStorage.getItem('access_token');
          const method = editingNewsId ? 'PUT' : 'POST';
          const body = {
            title,
            category,
            content,
            image_url: image_url || null,
            source_url: source_url || null,
            is_featured
          };

          if (editingNewsId) {
            body.id = editingNewsId;
          }

          const result = await fetchJson('/api/news-board', {
            method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
          });

          if (!result.success) {
            throw new Error(result.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          alert(editingNewsId ? 'ë‰´ìŠ¤ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë‰´ìŠ¤ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeModal();
          loadNews(currentPage);

        } catch (error) {
          console.error('Save news error:', error);
          alert('ë‰´ìŠ¤ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      // ë‰´ìŠ¤ ìˆ˜ì •
      function editNews(id) {
        openModal(id);
      }

      // ë‰´ìŠ¤ ì‚­ì œ
      async function deleteNews(id) {
        if (!confirm('ì •ë§ ì´ ë‰´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        try {
          const token = localStorage.getItem('access_token');
          const result = await fetchJson(`/api/news-board?id=${id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!result.success) {
            throw new Error(result.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          alert('ë‰´ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadNews(currentPage);

        } catch (error) {
          console.error('Delete news error:', error);
          alert('ë‰´ìŠ¤ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      // ë‰´ìŠ¤ ê²€ìƒ‰
      async function searchNews() {
        const keyword = document.getElementById('newsKeyword').value;
        const category = document.getElementById('newsCategory').value;
        const resultsEl = document.getElementById('searchResults');
        
        resultsEl.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ëŠ” ì¤‘...</div>';

        try {
          const query = new URLSearchParams({
            keyword,
            category,
            display: 10
          });
          const result = await fetchJson(`/api/news-search?${query.toString()}`);

          if (!result.success) {
            throw new Error(result.error || 'ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          if (!result.items || result.items.length === 0) {
            resultsEl.innerHTML = '<div class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
          }

          // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
          resultsEl.innerHTML = `
            <div style="margin-top: 20px;">
              <h3 style="margin-bottom: 16px;">"${result.searchQuery}" ê²€ìƒ‰ ê²°ê³¼ (${result.total}ê±´)</h3>
              <div class="news-grid">
                ${result.items.map((item, index) => `
                  <div class="news-card" style="cursor: pointer;" onclick="selectSearchResult(${index})">
                    <div class="news-placeholder">ğŸ“°</div>
                    <div class="news-content">
                      <div class="news-header">
                        <span class="news-category category-${item.category === 'ì •ì±…/ì§€ì›ê¸ˆ' ? 'policy' : 'trend'}">
                          ${item.category}
                        </span>
                        ${item.importance >= 4 ? '<span class="news-featured">ì¤‘ìš”</span>' : ''}
                      </div>
                      <div class="news-title">${item.title}</div>
                      <div class="news-excerpt">${item.description}</div>
                      <div class="news-meta">
                        <span><i class="far fa-calendar"></i> ${item.formattedDate}</span>
                        <span><i class="fas fa-star"></i> ì¤‘ìš”ë„: ${item.importance}/5</span>
                      </div>
                      <div class="news-actions">
                        <button class="news-btn" onclick="event.stopPropagation(); getAISummary(${index})">
                          <i class="fas fa-magic"></i> AI ìš”ì•½
                        </button>
                        <button class="news-btn edit" onclick="event.stopPropagation(); editFromSearch(${index})">
                          <i class="fas fa-edit"></i> í¸ì§‘í•˜ì—¬ ë°œí–‰
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;

          // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
          window.searchResults = result.items;

        } catch (error) {
          console.error('Search error:', error);
          resultsEl.innerHTML = `<div class="empty-state" style="color: var(--danger);">ê²€ìƒ‰ ì‹¤íŒ¨: ${error.message}</div>`;
        }
      }

      // ì¹´í…Œê³ ë¦¬ë³„ ì¶”ì²œ í‚¤ì›Œë“œ ë¡œë“œ
      function loadCategoryKeywords() {
        const category = document.getElementById('newsCategory').value;
        const suggestionsEl = document.getElementById('keywordSuggestions');
        
        const keywords = {
          policy: ['ì†Œìƒê³µì¸ ì§€ì›ê¸ˆ', 'ì™¸ì‹ì—… ì§€ì›', 'ì„ëŒ€ë£Œ ì§€ì›', 'ë°°ë‹¬ì•± ìˆ˜ìˆ˜ë£Œ'],
          trend: ['ì™¸ì‹ íŠ¸ë Œë“œ', 'ë°°ë‹¬ íŠ¸ë Œë“œ', 'MZì„¸ëŒ€ ì™¸ì‹', 'ë§›ì§‘ ë§ˆì¼€íŒ…'],
          success: ['ì‹ë‹¹ ì„±ê³µì‚¬ë¡€', 'ë§¤ì¶œ ì¦ëŒ€', 'ì¸ìŠ¤íƒ€ê·¸ë¨ ë§ˆì¼€íŒ…'],
          ingredient: ['ì‹ì¬ë£Œ ê°€ê²©', 'ì›ìì¬ ë™í–¥'],
          regulation: ['ìœ„ìƒ ì ê²€', 'ì˜ì—… ê·œì œ', 'ìŒì‹ì  ì˜ë¬´ì‚¬í•­']
        };

        if (category === 'all' || !keywords[category]) {
          suggestionsEl.innerHTML = '';
          return;
        }

        suggestionsEl.innerHTML = keywords[category].map(kw => 
          `<button class="category-btn" onclick="setKeyword('${kw}')" style="font-size: 12px; padding: 6px 12px;">
            ${kw}
          </button>`
        ).join('');
      }

      // í‚¤ì›Œë“œ ì„¤ì •
      function setKeyword(keyword) {
        document.getElementById('newsKeyword').value = keyword;
        searchNews();
      }

      // ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ
      function selectSearchResult(index) {
        const item = window.searchResults[index];
        window.open(item.link, '_blank');
      }

      // AI ìš”ì•½ ë°›ê¸°
      async function getAISummary(index) {
        const item = window.searchResults[index];
        const btn = event?.target;
        const originalText = btn ? btn.innerHTML : '';

        if (btn) {
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI ë¶„ì„ ì¤‘...';
        }

        try {
          const result = await fetchJson('/api/news-ai-summary', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              title: item.title,
              description: item.description,
              url: item.link
            })
          });

          if (!result.success) {
            throw new Error(result.error || 'AI ìš”ì•½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          // ìš”ì•½ ê²°ê³¼ í‘œì‹œ
          alert(`ğŸ¤– AI ë¶„ì„ ê²°ê³¼\n\n` +
                `ğŸ“Œ í•µì‹¬ ìš”ì•½:\n${result.aiSummary.summary}\n\n` +
                `ğŸ’¡ ì‹¤ì§ˆì  ë„ì›€:\n${result.aiSummary.benefit}\n\n` +
                `âœ… ì•¡ì…˜ ì•„ì´í…œ:\n${result.aiSummary.action}\n\n` +
                `â­ ì¤‘ìš”ë„: ${result.aiSummary.importance}/5\n` +
                `ğŸ“‚ ì¹´í…Œê³ ë¦¬: ${result.aiSummary.category}`);

        } catch (error) {
          console.error('AI summary error:', error);
          alert('AI ìš”ì•½ ì‹¤íŒ¨: ' + error.message);
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalText || '<i class="fas fa-magic"></i> AI ìš”ì•½';
          }
        }
      }

      // ê²€ìƒ‰ ê²°ê³¼ë¥¼ í¸ì§‘ ëª¨ë‹¬ë¡œ
      function editFromSearch(index) {
        const item = window.searchResults[index];
        openModal();
        
        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        document.getElementById('newsTitle').value = item.title;
        quill.root.innerHTML = `<p>${item.description}</p><p><br></p><p>ì›ë¬¸: <a href="${item.link}" target="_blank">${item.link}</a></p>`;
        
        // ì¹´í…Œê³ ë¦¬ ìë™ ì„ íƒ
        const categoryMap = {
          'ì •ì±…/ì§€ì›ê¸ˆ': 'policy',
          'íŠ¸ë Œë“œ': 'trend',
          'ì„±ê³µì‚¬ë¡€': 'management',
          'ë°°ë‹¬/í”Œë«í¼': 'technology',
          'ì‹ì¬ë£Œ/ì›ê°€': 'ingredients'
        };
        
        const categorySelect = document.getElementById('newsCategory');
        if (categoryMap[item.category]) {
          categorySelect.value = categoryMap[item.category];
        }
      }

      // AI ë‰´ìŠ¤ ì¶”ì²œ (ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€)
      async function getAIRecommendations() {
        const suggestionsEl = document.getElementById('aiSuggestions');
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIê°€ ë‰´ìŠ¤ë¥¼ ì°¾ëŠ” ì¤‘...';

        try {
          const token = localStorage.getItem('access_token');
          const result = await fetchJson('/api/ai-news-recommend', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              category: currentCategory === 'all' ? null : currentCategory
            })
          });

          if (!result.success || !result.data) {
            throw new Error(result.error || 'AI ì¶”ì²œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          // AI ì œì•ˆ ì¹´ë“œ ìƒì„±
          suggestionsEl.innerHTML = result.data.map((suggestion, index) => `
            <div class="ai-suggestion-card" onclick="selectAISuggestion(${index}, ${JSON.stringify(suggestion).replace(/"/g, '&quot;')})">
              <div class="ai-suggestion-title">${suggestion.title}</div>
              <div class="ai-suggestion-summary">${suggestion.summary}</div>
              <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                ğŸ’¡ ${suggestion.why_useful}
              </div>
            </div>
          `).join('');

          // ì œì•ˆ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
          window.aiSuggestions = result.data;

        } catch (error) {
          console.error('AI recommendations error:', error);
          alert('AI ì¶”ì²œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
          suggestionsEl.innerHTML = '';
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'AI ë‰´ìŠ¤ ì¶”ì²œë°›ê¸°';
        }
      }

      // AI ì œì•ˆ ì„ íƒ
      function selectAISuggestion(index, fallbackSuggestion) {
        const suggestion = window.aiSuggestions ? window.aiSuggestions[index] : fallbackSuggestion;
        
        if (!suggestion) {
          alert('ì œì•ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        openModal();
        document.getElementById('newsTitle').value = suggestion.title;
        document.getElementById('newsCategory').value = suggestion.category;
        quill.root.innerHTML = suggestion.content;
        
        // ëª¨ë‹¬ì´ ì—´ë¦¬ë©´ AI ì„¹ì…˜ ë‹«ê¸°
        document.getElementById('aiSuggestions').innerHTML = '';
      }
    </script>
  </body>
</html>

