<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>회원 결과물 관리 - 사장픽 관리자</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="/admin/assets/admin-common.css" />
    <style>
      .creations-stats .stat-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        box-shadow: var(--shadow-sm);
      }

      .stat-label {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text);
      }

      .stat-hint {
        font-size: 12px;
        color: var(--text-muted);
      }

      .filters-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 16px;
      }

      .type-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .type-chip {
        border: 1px solid var(--border);
        background: white;
        color: var(--text);
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .type-chip.active {
        background: var(--naver-green);
        border-color: var(--naver-green);
        color: white;
        box-shadow: 0 6px 14px rgba(3, 199, 90, 0.25);
      }

      .chip-count {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
      }

      .filter-controls {
        display: flex;
        gap: 8px;
        flex: 1;
        min-width: 260px;
      }

      .filter-controls input,
      .filter-controls select {
        flex: 1;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: white;
        font-size: 14px;
      }

      .filter-controls select {
        max-width: 220px;
      }

      .table-wrapper {
        overflow-x: auto;
      }

      .creations-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 960px;
      }

      .creations-table th,
      .creations-table td {
        padding: 14px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        font-size: 14px;
      }

      .creations-table th {
        background: #f9fafb;
        font-weight: 600;
        color: var(--text-secondary);
      }

      .user-name {
        font-weight: 700;
        color: var(--text);
      }

      .user-email {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .type-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        margin-right: 6px;
      }

      .type-badge.blog {
        background: #dbeafe;
        color: #1d4ed8;
      }

      .type-badge.review {
        background: #fef3c7;
        color: #92400e;
      }

      .type-badge.video {
        background: #fce7f3;
        color: #9f1239;
      }

      .content-preview {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--text-secondary);
        font-size: 13px;
      }

      .content-preview:hover {
        white-space: normal;
        overflow: visible;
        position: absolute;
        background: white;
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 10;
        max-width: 400px;
      }

      .date-text {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .empty-row td {
        text-align: center;
        padding: 40px 12px;
        color: var(--text-muted);
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 16px;
      }

      .page-btn {
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .page-btn:hover:not(:disabled) {
        background: var(--naver-green);
        color: white;
        border-color: var(--naver-green);
      }

      .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .page-info {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.75);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        z-index: 2000;
      }

      .loading-overlay.hidden {
        display: none;
      }

      .loading-overlay .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #e5e7eb;
        border-top: 4px solid var(--naver-green);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 3000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .modal-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text);
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
      }

      .modal-close:hover {
        background: #f3f4f6;
      }

      .modal-body {
        line-height: 1.6;
        color: var(--text);
        white-space: pre-wrap;
        word-break: break-word;
      }

      @media (max-width: 1024px) {
        .filter-controls {
          flex-direction: column;
        }

        .filter-controls select {
          max-width: 100%;
        }
      }

      @media (max-width: 640px) {
        .filters-row {
          flex-direction: column;
        }

        .type-tabs {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <main class="admin-main">
      <header class="admin-header">
        <div class="header-left">
          <div class="page-icon">
            <i class="fa-solid fa-folder-open"></i>
          </div>
          <div class="page-info">
            <h1 class="page-title">회원 결과물 관리</h1>
            <p class="page-subtitle">
              회원들이 생성한 블로그, 리뷰 답글, 영상 등 모든 결과물을 확인할 수 있습니다.
            </p>
          </div>
        </div>
        <div class="header-right">
          <button class="header-btn" id="refreshBtn" title="새로고침">
            <i class="fa-solid fa-rotate-right"></i>
          </button>
        </div>
      </header>
      <div class="content">
        <section class="stats-grid creations-stats">
          <article class="stat-card">
            <p class="stat-label">전체 결과물</p>
            <p class="stat-value" id="stat-total">0</p>
            <span class="stat-hint">누적 기준</span>
          </article>
          <article class="stat-card">
            <p class="stat-label">블로그</p>
            <p class="stat-value" id="stat-blog">0</p>
            <span class="stat-hint">생성된 블로그</span>
          </article>
          <article class="stat-card">
            <p class="stat-label">리뷰 답글</p>
            <p class="stat-value" id="stat-review">0</p>
            <span class="stat-hint">생성된 답글</span>
          </article>
          <article class="stat-card">
            <p class="stat-label">영상</p>
            <p class="stat-value" id="stat-video">0</p>
            <span class="stat-hint">생성된 영상</span>
          </article>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h2 class="panel-title">
              <i class="fa-solid fa-list"></i> 결과물 목록
            </h2>
            <div class="panel-actions">
              <button class="btn btn-secondary" id="resetFiltersBtn">
                <i class="fa-solid fa-arrow-rotate-left"></i> 필터 초기화
              </button>
            </div>
          </div>

          <div class="filters-row">
            <div class="type-tabs" id="typeTabs">
              <button class="type-chip active" data-type="all">
                전체 <span class="chip-count" id="count-all">0</span>
              </button>
              <button class="type-chip" data-type="blog">
                블로그 <span class="chip-count" id="count-blog">0</span>
              </button>
              <button class="type-chip" data-type="review">
                리뷰 답글 <span class="chip-count" id="count-review">0</span>
              </button>
              <button class="type-chip" data-type="video">
                영상 <span class="chip-count" id="count-video">0</span>
              </button>
            </div>
            <div class="filter-controls">
              <input
                type="text"
                id="searchInput"
                placeholder="제목, 내용, 회원명 검색"
                autocomplete="off"
              />
              <select id="userSelect">
                <option value="">전체 회원</option>
              </select>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="creations-table">
              <thead>
                <tr>
                  <th>타입</th>
                  <th>회원 정보</th>
                  <th>제목</th>
                  <th>내용 미리보기</th>
                  <th>생성일</th>
                  <th>작업</th>
                </tr>
              </thead>
              <tbody id="creationsTableBody">
                <tr class="empty-row">
                  <td colspan="6">데이터를 불러오는 중입니다...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="pagination" id="pagination"></div>
        </section>
      </div>
    </main>

    <!-- 상세보기 모달 -->
    <div id="detailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modalTitle">상세 정보</h3>
          <button class="modal-close" id="modalClose">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
        <div class="modal-body" id="modalBody"></div>
      </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="spinner"></div>
      <p>데이터를 불러오는 중입니다...</p>
    </div>

    <script src="/admin/assets/admin-sidebar.js?v=20251128" defer></script>
    <script src="/assets/analytics.js"></script>
    <script>
      (function () {
        "use strict";

        let currentType = "all";
        let currentPage = 1;
        let currentSearch = "";
        let currentUserId = "";
        let allUsers = [];
        let allData = [];

        const loadingOverlay = document.getElementById("loadingOverlay");
        const creationsTableBody = document.getElementById("creationsTableBody");
        const pagination = document.getElementById("pagination");
        const searchInput = document.getElementById("searchInput");
        const userSelect = document.getElementById("userSelect");
        const refreshBtn = document.getElementById("refreshBtn");
        const resetFiltersBtn = document.getElementById("resetFiltersBtn");
        const typeTabs = document.getElementById("typeTabs");
        const detailModal = document.getElementById("detailModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalBody = document.getElementById("modalBody");
        const modalClose = document.getElementById("modalClose");

        // 날짜 포맷팅
        function formatDate(dateString) {
          if (!dateString) return "-";
          const date = new Date(dateString);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // 타입 뱃지 텍스트
        function getTypeLabel(type) {
          const labels = {
            blog: "블로그",
            review: "리뷰 답글",
            video: "영상",
          };
          return labels[type] || type;
        }

        // 데이터 로드
        async function loadData() {
          try {
            loadingOverlay.classList.remove("hidden");

            const params = new URLSearchParams({
              type: currentType,
              page: currentPage,
              limit: 50,
            });

            if (currentSearch) {
              params.append("search", currentSearch);
            }

            if (currentUserId) {
              params.append("userId", currentUserId);
            }

            const response = await fetch(`/api/admin/member-creations?${params}`);
            const result = await response.json();

            if (!result.success) {
              throw new Error(result.error || "데이터 로드 실패");
            }

            allData = result.data || [];
            updateTable();
            updateStats(result.stats);
            updatePagination(result.pagination);
            updateTypeCounts(result.stats);
            await loadUsers();
          } catch (error) {
            console.error("데이터 로드 오류:", error);
            creationsTableBody.innerHTML = `
              <tr class="empty-row">
                <td colspan="6">오류가 발생했습니다: ${error.message}</td>
              </tr>
            `;
          } finally {
            loadingOverlay.classList.add("hidden");
          }
        }

        // 회원 목록 로드
        async function loadUsers() {
          try {
            const response = await fetch("/api/admin/members?limit=1000");
            const result = await response.json();

            if (result.success && result.members) {
              allUsers = result.members;
              updateUserSelect();
            }
          } catch (error) {
            console.error("회원 목록 로드 오류:", error);
          }
        }

        // 회원 선택 드롭다운 업데이트
        function updateUserSelect() {
          userSelect.innerHTML = '<option value="">전체 회원</option>';
          allUsers.forEach((user) => {
            const option = document.createElement("option");
            option.value = user.id;
            option.textContent = `${user.name || "이름 없음"} (${user.email || "이메일 없음"})`;
            if (user.id === currentUserId) {
              option.selected = true;
            }
            userSelect.appendChild(option);
          });
        }

        // 통계 업데이트
        function updateStats(stats) {
          document.getElementById("stat-total").textContent =
            stats?.total || 0;
          document.getElementById("stat-blog").textContent = stats?.blog || 0;
          document.getElementById("stat-review").textContent =
            stats?.review || 0;
          document.getElementById("stat-video").textContent = stats?.video || 0;
        }

        // 타입별 카운트 업데이트
        function updateTypeCounts(stats) {
          document.getElementById("count-all").textContent = stats?.total || 0;
          document.getElementById("count-blog").textContent = stats?.blog || 0;
          document.getElementById("count-review").textContent =
            stats?.review || 0;
          document.getElementById("count-video").textContent = stats?.video || 0;
        }

        // 테이블 업데이트
        function updateTable() {
          if (allData.length === 0) {
            creationsTableBody.innerHTML = `
              <tr class="empty-row">
                <td colspan="6">표시할 결과물이 없습니다.</td>
              </tr>
            `;
            return;
          }

          creationsTableBody.innerHTML = allData
            .map((item) => {
              const contentPreview = item.content
                ? item.content.substring(0, 100) + (item.content.length > 100 ? "..." : "")
                : "-";

              return `
                <tr>
                  <td>
                    <span class="type-badge ${item.type}">${getTypeLabel(item.type)}</span>
                  </td>
                  <td>
                    <div class="user-name">${item.user_name || "알 수 없음"}</div>
                    <div class="user-email">${item.user_email || ""}</div>
                  </td>
                  <td>
                    <strong>${item.title || "제목 없음"}</strong>
                  </td>
                  <td>
                    <div class="content-preview" title="${item.content || ""}">
                      ${contentPreview}
                    </div>
                  </td>
                  <td>
                    <div class="date-text">${formatDate(item.created_at)}</div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="showDetail('${item.id}', '${item.type}')">
                      <i class="fa-solid fa-eye"></i> 상세보기
                    </button>
                  </td>
                </tr>
              `;
            })
            .join("");
        }

        // 페이지네이션 업데이트
        function updatePagination(pagination) {
          if (!pagination || pagination.totalPages <= 1) {
            pagination.innerHTML = "";
            return;
          }

          const { page, totalPages } = pagination;
          let html = "";

          // 이전 버튼
          html += `
            <button class="page-btn" ${page <= 1 ? "disabled" : ""} onclick="goToPage(${page - 1})">
              <i class="fa-solid fa-chevron-left"></i>
            </button>
          `;

          // 페이지 번호
          html += `<span class="page-info">${page} / ${totalPages}</span>`;

          // 다음 버튼
          html += `
            <button class="page-btn" ${page >= totalPages ? "disabled" : ""} onclick="goToPage(${page + 1})">
              <i class="fa-solid fa-chevron-right"></i>
            </button>
          `;

          pagination.innerHTML = html;
        }

        // 페이지 이동
        window.goToPage = function (page) {
          currentPage = page;
          loadData();
        };

        // 상세보기
        window.showDetail = async function (id, type) {
          const item = allData.find((d) => d.id === id && d.type === type);
          if (!item) {
            alert("결과물을 찾을 수 없습니다.");
            return;
          }

          let detailHtml = "";

          detailHtml += `<p><strong>타입:</strong> ${getTypeLabel(item.type)}</p>`;
          detailHtml += `<p><strong>회원:</strong> ${item.user_name} (${item.user_email})</p>`;
          detailHtml += `<p><strong>제목:</strong> ${item.title || "제목 없음"}</p>`;
          detailHtml += `<p><strong>생성일:</strong> ${formatDate(item.created_at)}</p>`;
          detailHtml += `<p><strong>수정일:</strong> ${formatDate(item.updated_at)}</p>`;

          if (item.metadata) {
            detailHtml += `<hr style="margin: 20px 0;" />`;
            detailHtml += `<p><strong>추가 정보:</strong></p>`;
            detailHtml += `<pre style="background: #f9fafb; padding: 12px; border-radius: 8px; overflow-x: auto;">${JSON.stringify(item.metadata, null, 2)}</pre>`;
          }

          detailHtml += `<hr style="margin: 20px 0;" />`;
          detailHtml += `<p><strong>내용:</strong></p>`;
          detailHtml += `<div style="background: #f9fafb; padding: 16px; border-radius: 8px; white-space: pre-wrap; word-break: break-word;">${item.content || "내용 없음"}</div>`;

          modalTitle.textContent = `${getTypeLabel(item.type)} 상세 정보`;
          modalBody.innerHTML = detailHtml;
          detailModal.classList.add("active");
        };

        // 모달 닫기
        modalClose.addEventListener("click", () => {
          detailModal.classList.remove("active");
        });

        detailModal.addEventListener("click", (e) => {
          if (e.target === detailModal) {
            detailModal.classList.remove("active");
          }
        });

        // 타입 필터 변경
        typeTabs.addEventListener("click", (e) => {
          const chip = e.target.closest(".type-chip");
          if (!chip) return;

          typeTabs.querySelectorAll(".type-chip").forEach((c) => {
            c.classList.remove("active");
          });
          chip.classList.add("active");

          currentType = chip.dataset.type;
          currentPage = 1;
          loadData();
        });

        // 검색
        let searchTimeout;
        searchInput.addEventListener("input", (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            currentSearch = e.target.value.trim();
            currentPage = 1;
            loadData();
          }, 500);
        });

        // 회원 필터
        userSelect.addEventListener("change", (e) => {
          currentUserId = e.target.value;
          currentPage = 1;
          loadData();
        });

        // 새로고침
        refreshBtn.addEventListener("click", () => {
          loadData();
        });

        // 필터 초기화
        resetFiltersBtn.addEventListener("click", () => {
          currentType = "all";
          currentSearch = "";
          currentUserId = "";
          currentPage = 1;

          typeTabs.querySelectorAll(".type-chip").forEach((c) => {
            c.classList.remove("active");
          });
          typeTabs.querySelector('[data-type="all"]').classList.add("active");

          searchInput.value = "";
          userSelect.value = "";

          loadData();
        });

        // 초기 로드
        loadData();
      })();
    </script>
  </body>
</html>

