<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>í† í° ëŒ€ì‹œë³´ë“œ - ì‚¬ì¥í”½ ê´€ë¦¬ì</title>
    
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    
    <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="/admin/assets/admin-common.css" />
    
    <style>
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }

      .subtitle {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 24px;
      }

      /* í†µê³„ ì¹´ë“œ */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 24px;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .stat-card.green {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      }

      .stat-card.orange {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .stat-card.blue {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      .stat-card .icon {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 48px;
        opacity: 0.3;
      }

      .stat-card .label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 8px;
      }

      .stat-card .value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .stat-card .change {
        font-size: 12px;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* ì°¨íŠ¸ ì¹´ë“œ */
      .chart-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .chart-title {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
      }

      /* í…Œì´ë¸” */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      .data-table thead {
        background: #f9fafb;
        border-bottom: 2px solid var(--border);
      }

      .data-table th {
        padding: 12px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .data-table td {
        padding: 12px;
        font-size: 14px;
        color: #374151;
        border-bottom: 1px solid #f3f4f6;
      }

      .data-table tbody tr:hover {
        background: #fafafa;
      }

      /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--accent);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .progress-fill.warning {
        background: #f59e0b;
      }

      .progress-fill.danger {
        background: #ef4444;
      }

      /* íƒœê·¸ */
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge.success {
        background: #dcfce7;
        color: #16a34a;
      }

      .badge.warning {
        background: #fef3c7;
        color: #d97706;
      }

      .badge.danger {
        background: #fee2e2;
        color: #dc2626;
      }

      .badge.info {
        background: #dbeafe;
        color: #2563eb;
      }

      /* í•„í„° */
      .filter-bar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .filter-label {
        font-size: 12px;
        color: #6b7280;
        font-weight: 600;
      }

      .filter-select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        background: white;
      }

      .btn {
        padding: 8px 16px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .btn.secondary {
        background: white;
        color: #374151;
        border: 1px solid var(--border);
      }

      /* ë¦¬í”„ë ˆì‹œ ì¸ë””ì¼€ì´í„° */
      .refresh-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 4px 8px;
        background: #f3f4f6;
        border-radius: 4px;
        font-size: 12px;
        color: #6b7280;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
      }

      .empty-state {
        text-align: center;
        padding: 60px;
        color: #9ca3af;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
    </style>
  </head>
  <body class="admin-body">
    <!-- ì‚¬ì´ë“œë°” -->
    <div id="admin-sidebar"></div>

    <!-- í—¤ë” -->
    <div id="header"></div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content">
      <div class="container">
        <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
          <h1 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 28px; color: #111827;">
            <i class="fas fa-coins" style="color: var(--accent);"></i>
            í† í° ëŒ€ì‹œë³´ë“œ
          </h1>
          <div class="refresh-indicator">
            <i class="fas fa-sync-alt"></i>
            <span id="lastUpdate">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
          </div>
        </div>
        <div class="subtitle">ì‹¤ì‹œê°„ í† í° ì‚¬ìš© í˜„í™© ë° í†µê³„</div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
          <div class="stat-card">
            <i class="fas fa-users icon"></i>
            <div class="label">ì „ì²´ í™œì„± ì‚¬ìš©ì</div>
            <div class="value" id="activeUsers">-</div>
            <div class="change">
              <i class="fas fa-arrow-up"></i>
              <span id="userChange">+0% ì „ì›” ëŒ€ë¹„</span>
            </div>
          </div>

          <div class="stat-card green">
            <i class="fas fa-coins icon"></i>
            <div class="label">ì˜¤ëŠ˜ ì‚¬ìš© í† í°</div>
            <div class="value" id="todayTokens">-</div>
            <div class="change">
              <i class="fas fa-arrow-up"></i>
              <span id="tokenChange">+0% ì–´ì œ ëŒ€ë¹„</span>
            </div>
          </div>

          <div class="stat-card orange">
            <i class="fas fa-chart-line icon"></i>
            <div class="label">ì›”ê°„ ì´ ì‚¬ìš©ëŸ‰</div>
            <div class="value" id="monthlyTokens">-</div>
            <div class="change">
              <span id="monthlyRate">0% ì‚¬ìš©ë¥ </span>
            </div>
          </div>

          <div class="stat-card blue">
            <i class="fas fa-won-sign icon"></i>
            <div class="label">ì˜ˆìƒ ì›” ë§¤ì¶œ</div>
            <div class="value" id="monthlyRevenue">-</div>
            <div class="change">
              <i class="fas fa-arrow-up"></i>
              <span id="revenueChange">+0% ì „ì›” ëŒ€ë¹„</span>
            </div>
          </div>
        </div>

        <!-- í•„í„° -->
        <div class="filter-bar">
          <div class="filter-item">
            <label class="filter-label">ê¸°ê°„</label>
            <select class="filter-select" id="periodFilter" onchange="loadDashboardData()">
              <option value="today">ì˜¤ëŠ˜</option>
              <option value="week" selected>ì´ë²ˆ ì£¼</option>
              <option value="month">ì´ë²ˆ ë‹¬</option>
              <option value="all">ì „ì²´</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label">íšŒì› ìœ í˜•</label>
            <select class="filter-select" id="userTypeFilter" onchange="loadDashboardData()">
              <option value="all">ì „ì²´</option>
              <option value="owner">ì‹ë‹¹ ëŒ€í‘œ</option>
              <option value="agency">ëŒ€í–‰ì‚¬</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label">ë©¤ë²„ì‹­</label>
            <select class="filter-select" id="membershipFilter" onchange="loadDashboardData()">
              <option value="all">ì „ì²´</option>
              <option value="seed">ì”¨ì•—</option>
              <option value="power">íŒŒì›Œ</option>
              <option value="bigpower">ë¹…íŒŒì›Œ</option>
              <option value="premium">í”„ë¦¬ë¯¸ì—„</option>
            </select>
          </div>
          <div class="filter-item" style="margin-left: auto;">
            <label class="filter-label">&nbsp;</label>
            <button class="btn" onclick="loadDashboardData()">
              <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
            </button>
          </div>
        </div>

        <!-- ì‚¬ìš©ëŸ‰ ì°¨íŠ¸ -->
        <div class="chart-card">
          <div class="chart-header">
            <h2 class="chart-title">
              <i class="fas fa-chart-area" style="color: var(--accent); margin-right: 8px;"></i>
              í† í° ì‚¬ìš© ì¶”ì´
            </h2>
            <div>
              <button class="btn secondary" onclick="exportData()">
                <i class="fas fa-download"></i> ë°ì´í„° ë‚´ë³´ë‚´ê¸°
              </button>
            </div>
          </div>
          <div id="usageChart" style="height: 300px;">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> ì°¨íŠ¸ ë¡œë”© ì¤‘...
            </div>
          </div>
        </div>

        <!-- ìƒìœ„ ì‚¬ìš©ì í…Œì´ë¸” -->
        <div class="chart-card">
          <div class="chart-header">
            <h2 class="chart-title">
              <i class="fas fa-trophy" style="color: #f59e0b; margin-right: 8px;"></i>
              ìƒìœ„ í† í° ì‚¬ìš©ì
            </h2>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>ìˆœìœ„</th>
                <th>ì‚¬ìš©ì</th>
                <th>ë©¤ë²„ì‹­</th>
                <th>ì‚¬ìš©ëŸ‰</th>
                <th>í•œë„</th>
                <th>ì‚¬ìš©ë¥ </th>
                <th>ìƒíƒœ</th>
              </tr>
            </thead>
            <tbody id="topUsersTable">
              <tr>
                <td colspan="7" class="loading">
                  <i class="fas fa-spinner fa-spin"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- í•œë„ ì´ˆê³¼ ì‚¬ìš©ì -->
        <div class="chart-card">
          <div class="chart-header">
            <h2 class="chart-title">
              <i class="fas fa-exclamation-triangle" style="color: #ef4444; margin-right: 8px;"></i>
              í•œë„ ì´ˆê³¼ ì‚¬ìš©ì
            </h2>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>ì‚¬ìš©ì</th>
                <th>ë©¤ë²„ì‹­</th>
                <th>ì‚¬ìš©ëŸ‰</th>
                <th>í•œë„</th>
                <th>ì´ˆê³¼ëŸ‰</th>
                <th>ì´ˆê³¼ ì‹œê°„</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="exceededUsersTable">
              <tr>
                <td colspan="7" class="empty-state">
                  <i class="fas fa-check-circle"></i>
                  <div>í•œë„ ì´ˆê³¼ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="/admin/assets/admin-bootstrap.js" defer></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // ==================== ì„¤ì • ====================
      
      let supabase;
      let chartInstance = null;

      // ==================== ì´ˆê¸°í™” ====================

      window.addEventListener('load', async function() {
        supabase = await AdminBootstrap.getSupabaseClient();
        await AdminBootstrap.initializeHeader();
        await AdminBootstrap.initializeSidebar();
        await loadDashboardData();
        
        // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(loadDashboardData, 30000);
      });

      // ==================== ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ====================

      async function loadDashboardData() {
        try {
          const period = document.getElementById('periodFilter').value;
          const userType = document.getElementById('userTypeFilter').value;
          const membership = document.getElementById('membershipFilter').value;

          // 1. í†µê³„ ë°ì´í„° ë¡œë“œ
          await loadStatistics(period, userType, membership);
          
          // 2. ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
          await loadChartData(period);
          
          // 3. ìƒìœ„ ì‚¬ìš©ì ë¡œë“œ
          await loadTopUsers(period);
          
          // 4. í•œë„ ì´ˆê³¼ ì‚¬ìš©ì ë¡œë“œ
          await loadExceededUsers();
          
          // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
          document.getElementById('lastUpdate').textContent = 
            `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}`;
        } catch (error) {
          console.error('âŒ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }

      // ==================== í†µê³„ ë¡œë“œ ====================

      async function loadStatistics(period, userType, membership) {
        try {
          // í™œì„± ì‚¬ìš©ì ìˆ˜
          let query = supabase
            .from('subscription_cycle')
            .select('*', { count: 'exact' })
            .eq('status', 'active');
          
          if (userType !== 'all') {
            query = query.eq('user_type', userType);
          }
          
          const { count: activeCount } = await query;
          document.getElementById('activeUsers').textContent = activeCount || 0;

          // ì˜¤ëŠ˜ ì‚¬ìš© í† í°
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          const { data: todayUsage } = await supabase
            .from('token_usage')
            .select('tokens_used')
            .gte('used_at', today.toISOString());
          
          const todayTotal = todayUsage?.reduce((sum, u) => sum + u.tokens_used, 0) || 0;
          document.getElementById('todayTokens').textContent = todayTotal.toLocaleString('ko-KR');

          // ì›”ê°„ ì´ ì‚¬ìš©ëŸ‰
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          const { data: monthlyUsage } = await supabase
            .from('token_usage')
            .select('tokens_used')
            .gte('used_at', monthStart.toISOString());
          
          const monthlyTotal = monthlyUsage?.reduce((sum, u) => sum + u.tokens_used, 0) || 0;
          document.getElementById('monthlyTokens').textContent = monthlyTotal.toLocaleString('ko-KR');

          // ì˜ˆìƒ ì›” ë§¤ì¶œ
          const { data: subscriptions } = await supabase
            .from('subscription_cycle')
            .select('billing_amount')
            .eq('status', 'active');
          
          const revenue = subscriptions?.reduce((sum, s) => sum + s.billing_amount, 0) || 0;
          document.getElementById('monthlyRevenue').textContent = 
            `â‚©${revenue.toLocaleString('ko-KR')}`;
        } catch (error) {
          console.error('âŒ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }

      // ==================== ì°¨íŠ¸ ë¡œë“œ ====================

      async function loadChartData(period) {
        try {
          const ctx = document.getElementById('usageChart');
          
          // ê¸°ê°„ë³„ ë°ì´í„° ì¡°íšŒ
          let startDate = new Date();
          if (period === 'today') {
            startDate.setHours(0, 0, 0, 0);
          } else if (period === 'week') {
            startDate.setDate(startDate.getDate() - 7);
            startDate.setHours(0, 0, 0, 0);
          } else if (period === 'month') {
            startDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
            startDate.setHours(0, 0, 0, 0);
          } else {
            startDate = new Date('2025-01-01');
          }

          console.log('ğŸ“Š ì°¨íŠ¸ ê¸°ê°„ í•„í„°:', period, 'ì‹œì‘ì¼:', startDate.toISOString());

          const { data: usageData, error } = await supabase
            .from('token_usage')
            .select('tokens_used, used_at')
            .gte('used_at', startDate.toISOString())
            .order('used_at');

          if (error) {
            console.error('âŒ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
            throw error;
          }

          console.log('ğŸ“Š ì¡°íšŒëœ ë°ì´í„° ìˆ˜:', usageData?.length || 0);

          // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í•‘ (YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ í†µì¼)
          const grouped = {};
          usageData?.forEach(item => {
            const date = new Date(item.used_at);
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            grouped[dateKey] = (grouped[dateKey] || 0) + item.tokens_used;
          });

          // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬
          const sortedDates = Object.keys(grouped).sort();
          
          // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
          const labels = sortedDates.map(date => {
            const d = new Date(date);
            return `${d.getMonth() + 1}/${d.getDate()}`;
          });
          const data = sortedDates.map(date => grouped[date]);

          console.log('ğŸ“Š ì°¨íŠ¸ ë°ì´í„°:', { labels, data });

          // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
          if (chartInstance) {
            chartInstance.destroy();
          }

          ctx.innerHTML = '<canvas id="tokenChart"></canvas>';
          const canvas = document.getElementById('tokenChart');
          
          chartInstance = new Chart(canvas, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'í† í° ì‚¬ìš©ëŸ‰',
                data: data,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  titleFont: {
                    weight: 'bold',
                    size: 14
                  },
                  bodyFont: {
                    weight: 'bold',
                    size: 13
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    color: '#000000',
                    font: {
                      weight: 'bold',
                      size: 12
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000000',
                    font: {
                      weight: 'bold',
                      size: 12
                    },
                    callback: function(value) {
                      return value.toLocaleString('ko-KR');
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            }
          });
        } catch (error) {
          console.error('âŒ ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
          document.getElementById('usageChart').innerHTML = 
            '<div class="empty-state">ì°¨íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
        }
      }

      // ==================== ìƒìœ„ ì‚¬ìš©ì ë¡œë“œ ====================

      async function loadTopUsers(period) {
        try {
          // ê¸°ê°„ë³„ ì‹œì‘ì¼ ê³„ì‚°
          let startDate = new Date();
          if (period === 'today') {
            startDate.setHours(0, 0, 0, 0);
          } else if (period === 'week') {
            startDate.setDate(startDate.getDate() - 7);
            startDate.setHours(0, 0, 0, 0);
          } else if (period === 'month') {
            startDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
            startDate.setHours(0, 0, 0, 0);
          } else {
            startDate = new Date('2025-01-01');
          }

          console.log('ğŸ“Š ìƒìœ„ ì‚¬ìš©ì ê¸°ê°„ í•„í„°:', period, 'ì‹œì‘ì¼:', startDate.toISOString());

          // ê¸°ê°„ë³„ í† í° ì‚¬ìš©ëŸ‰ ì§‘ê³„
          const { data: usageData, error: usageError } = await supabase
            .from('token_usage')
            .select('user_id, tokens_used')
            .gte('used_at', startDate.toISOString());

          if (usageError) {
            console.error('âŒ í† í° ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì˜¤ë¥˜:', usageError);
            throw usageError;
          }

          // ì‚¬ìš©ìë³„ë¡œ í† í° ì‚¬ìš©ëŸ‰ í•©ê³„ ê³„ì‚°
          const userUsageMap = {};
          usageData?.forEach(item => {
            if (item.user_id) {
              userUsageMap[item.user_id] = (userUsageMap[item.user_id] || 0) + item.tokens_used;
            }
          });

          // ì‚¬ìš©ëŸ‰ ìˆœìœ¼ë¡œ ì •ë ¬
          const sortedUsers = Object.entries(userUsageMap)
            .map(([userId, totalUsage]) => ({ userId, totalUsage }))
            .sort((a, b) => b.totalUsage - a.totalUsage)
            .slice(0, 10); // ìƒìœ„ 10ëª…

          if (sortedUsers.length === 0) {
            const tbody = document.getElementById('topUsersTable');
            tbody.innerHTML = `
              <tr>
                <td colspan="7" class="empty-state">
                  <i class="fas fa-users"></i>
                  <div>í•´ë‹¹ ê¸°ê°„ì— ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </td>
              </tr>
            `;
            return;
          }

          // ì‚¬ìš©ì ì •ë³´ì™€ êµ¬ë… ì •ë³´ ì¡°íšŒ
          const userIds = sortedUsers.map(u => u.userId);
          const { data: profiles } = await supabase
            .from('profiles')
            .select('id, email')
            .in('id', userIds);

          const { data: cycles } = await supabase
            .from('subscription_cycle')
            .select('user_id, user_type, monthly_token_limit, status')
            .in('user_id', userIds)
            .eq('status', 'active');

          // í”„ë¡œí•„ê³¼ êµ¬ë… ì •ë³´ë¥¼ ë§µìœ¼ë¡œ ë³€í™˜
          const profileMap = {};
          profiles?.forEach(p => {
            profileMap[p.id] = p;
          });

          const cycleMap = {};
          cycles?.forEach(c => {
            cycleMap[c.user_id] = c;
          });

          // í…Œì´ë¸” ë Œë”ë§
          const tbody = document.getElementById('topUsersTable');
          tbody.innerHTML = sortedUsers.map((user, index) => {
            const profile = profileMap[user.userId];
            const cycle = cycleMap[user.userId];
            const limit = cycle?.monthly_token_limit || 0;
            const usageRate = limit > 0 ? (user.totalUsage / limit * 100).toFixed(1) : 0;
            const statusClass = usageRate >= 90 ? 'danger' : usageRate >= 70 ? 'warning' : 'success';
            
            return `
              <tr>
                <td><strong>${index + 1}</strong></td>
                <td>${profile?.email || 'Unknown'}</td>
                <td><span class="badge info">${cycle ? getMembershipName(cycle.user_type) : '-'}</span></td>
                <td>${user.totalUsage.toLocaleString('ko-KR')}</td>
                <td>${limit.toLocaleString('ko-KR')}</td>
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="progress-bar" style="width: 100px;">
                      <div class="progress-fill ${statusClass}" style="width: ${Math.min(usageRate, 100)}%"></div>
                    </div>
                    <span>${usageRate}%</span>
                  </div>
                </td>
                <td><span class="badge ${statusClass}">${getStatusLabel(statusClass)}</span></td>
              </tr>
            `;
          }).join('');

          console.log('ğŸ“Š ìƒìœ„ ì‚¬ìš©ì ë¡œë“œ ì™„ë£Œ:', sortedUsers.length, 'ëª…');
        } catch (error) {
          console.error('âŒ ìƒìœ„ ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨:', error);
          const tbody = document.getElementById('topUsersTable');
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
              </td>
            </tr>
          `;
        }
      }

      // ==================== í•œë„ ì´ˆê³¼ ì‚¬ìš©ì ë¡œë“œ ====================

      async function loadExceededUsers() {
        try {
          const { data: exceeded } = await supabase
            .from('subscription_cycle')
            .select(`
              *,
              profiles:user_id (email)
            `)
            .eq('is_exceeded', true)
            .order('exceeded_at', { ascending: false });

          const tbody = document.getElementById('exceededUsersTable');
          
          if (!exceeded || exceeded.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="7" class="empty-state">
                  <i class="fas fa-check-circle"></i>
                  <div>í•œë„ ì´ˆê³¼ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </td>
              </tr>
            `;
            return;
          }

          tbody.innerHTML = exceeded.map(user => {
            const exceeded = user.tokens_used - user.monthly_token_limit;
            const exceededTime = user.exceeded_at ? 
              new Date(user.exceeded_at).toLocaleString('ko-KR') : '-';
            
            return `
              <tr>
                <td>${user.profiles?.email || 'Unknown'}</td>
                <td><span class="badge info">${getMembershipName(user.user_type)}</span></td>
                <td>${user.tokens_used.toLocaleString('ko-KR')}</td>
                <td>${user.monthly_token_limit.toLocaleString('ko-KR')}</td>
                <td style="color: #dc2626; font-weight: 600;">
                  +${exceeded.toLocaleString('ko-KR')}
                </td>
                <td>${exceededTime}</td>
                <td>
                  <button class="btn secondary" onclick="resetUserTokens('${user.user_id}')">
                    í† í° ë¦¬ì…‹
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        } catch (error) {
          console.error('âŒ í•œë„ ì´ˆê³¼ ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }

      // ==================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ====================

      function getMembershipName(type) {
        const names = {
          'seed': 'ì”¨ì•—',
          'power': 'íŒŒì›Œ',
          'bigpower': 'ë¹…íŒŒì›Œ',
          'premium': 'í”„ë¦¬ë¯¸ì—„',
          'elite': 'ì—˜ë¦¬íŠ¸',
          'expert': 'ì „ë¬¸ê°€',
          'master': 'ë§ˆìŠ¤í„°'
        };
        return names[type] || type;
      }

      function getStatusLabel(status) {
        const labels = {
          'success': 'ì •ìƒ',
          'warning': 'ì£¼ì˜',
          'danger': 'ì´ˆê³¼'
        };
        return labels[status] || 'ì •ìƒ';
      }

      async function resetUserTokens(userId) {
        if (!confirm('ì •ë§ë¡œ ì´ ì‚¬ìš©ìì˜ í† í°ì„ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
          const { error } = await supabase
            .from('subscription_cycle')
            .update({
              tokens_used: 0,
              tokens_remaining: 0,
              is_exceeded: false,
              exceeded_at: null
            })
            .eq('user_id', userId);

          if (error) throw error;

          alert('í† í°ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.');
          await loadDashboardData();
        } catch (error) {
          console.error('âŒ í† í° ë¦¬ì…‹ ì‹¤íŒ¨:', error);
          alert('í† í° ë¦¬ì…‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      function exportData() {
        alert('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
      }
    </script>
    
    <!-- Admin ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="../assets/admin-sidebar.js"></script>
    <script src="../assets/admin-header.js"></script>
    <script src="../assets/admin-common.js"></script>
  </body>
</html>