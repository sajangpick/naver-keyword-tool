<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>토큰 대시보드 - 어드민</title>
  <link rel="stylesheet" href="../assets/admin-common.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 15px;
    }

    .stat-title {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .stat-change {
      font-size: 13px;
      color: #666;
    }

    .stat-change.positive {
      color: #22c55e;
    }

    .stat-change.negative {
      color: #ef4444;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .filter-buttons {
      display: flex;
      gap: 10px;
    }

    .filter-btn {
      padding: 6px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: white;
      color: #666;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .filter-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .users-table-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .search-box {
      position: relative;
      width: 300px;
    }

    .search-box input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }

    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table th {
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid #f3f4f6;
      color: #6b7280;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .users-table td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #333;
      font-size: 14px;
    }

    .users-table tr:hover {
      background: #f9fafb;
    }

    .plan-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .plan-seed {
      background: #e5e7eb;
      color: #6b7280;
    }

    .plan-power {
      background: #dbeafe;
      color: #2563eb;
    }

    .plan-bigpower {
      background: #fce7f3;
      color: #ec4899;
    }

    .plan-premium {
      background: #f3e8ff;
      color: #9333ea;
    }

    .usage-bar {
      width: 100px;
      height: 8px;
      background: #f3f4f6;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .usage-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }

    .usage-low {
      background: #22c55e;
    }

    .usage-medium {
      background: #f59e0b;
    }

    .usage-high {
      background: #ef4444;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 4px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      background: white;
      color: #666;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      border-color: #667eea;
      color: #667eea;
      background: #f0f4ff;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }

    .loading i {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .alert-box {
      background: #fef2f2;
      border: 1px solid #fee2e2;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      color: #dc2626;
      display: none;
    }

    .alert-box.warning {
      background: #fef3c7;
      border-color: #fde68a;
      color: #d97706;
    }

    .alert-box.info {
      background: #dbeafe;
      border-color: #bfdbfe;
      color: #1e40af;
    }
  </style>
</head>
<body class="admin-body">
  <!-- 사이드바 -->
  <div id="admin-sidebar"></div>
  
  <!-- 메인 컨텐츠 -->
  <div class="admin-main">
    <!-- 헤더 -->
    <header class="admin-header">
      <h1>📊 토큰 대시보드</h1>
      <button class="btn btn-primary" onclick="refreshDashboard()">
        <i class="fas fa-sync-alt"></i> 새로고침
      </button>
    </header>
    
    <!-- 컨텐츠 -->
    <div class="admin-content">
      <!-- 알림 박스 -->
      <div class="alert-box warning" id="alertBox" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="alertMessage"></span>
      </div>

      <!-- 통계 카드 -->
      <div class="dashboard-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background: #e0f2fe;">
            <i class="fas fa-users" style="color: #0284c7;"></i>
          </div>
          <div class="stat-title">전체 활성 사용자</div>
          <div class="stat-value" id="totalActiveUsers">0</div>
          <div class="stat-change" id="userChange">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: #dcfce7;">
            <i class="fas fa-coins" style="color: #16a34a;"></i>
          </div>
          <div class="stat-title">오늘 사용된 토큰</div>
          <div class="stat-value" id="todayTokens">0</div>
          <div class="stat-change" id="tokenChange">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: #fef3c7;">
            <i class="fas fa-chart-line" style="color: #d97706;"></i>
          </div>
          <div class="stat-title">평균 사용률</div>
          <div class="stat-value" id="avgUsageRate">0%</div>
          <div class="stat-change" id="usageChange">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: #fee2e2;">
            <i class="fas fa-exclamation-circle" style="color: #dc2626;"></i>
          </div>
          <div class="stat-title">한도 초과 사용자</div>
          <div class="stat-value" id="exceededUsers">0</div>
          <div class="stat-change">주의 필요</div>
        </div>
      </div>

      <!-- 사용량 차트 -->
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">토큰 사용량 추이</h3>
          <div class="filter-buttons">
            <button class="filter-btn active" onclick="changeChartPeriod('7d')">7일</button>
            <button class="filter-btn" onclick="changeChartPeriod('30d')">30일</button>
            <button class="filter-btn" onclick="changeChartPeriod('90d')">90일</button>
          </div>
        </div>
        <canvas id="usageChart" height="80"></canvas>
      </div>

      <!-- 사용자별 토큰 현황 테이블 -->
      <div class="users-table-container">
        <div class="table-header">
          <h3 class="chart-title">사용자별 토큰 현황</h3>
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="userSearch" placeholder="이메일 또는 이름 검색..." onkeyup="searchUsers()">
          </div>
        </div>
        
        <table class="users-table">
          <thead>
            <tr>
              <th>사용자</th>
              <th>플랜</th>
              <th>사용량</th>
              <th>사용률</th>
              <th>남은 토큰</th>
              <th>갱신일</th>
              <th>작업</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="7" class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <div>데이터 로딩 중...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 스크립트 -->
  <script src="../assets/admin-sidebar.js"></script>
  <script src="../assets/admin-common.js"></script>
  <script>
    // 전역 변수
    let supabase;
    let usageChart;
    let currentPeriod = '7d';
    let allUsersData = [];

    // 초기화
    async function init() {
      try {
        // Supabase 초기화
        const SUPABASE_URL = window.NEXT_PUBLIC_SUPABASE_URL;
        const SUPABASE_KEY = window.SUPABASE_SERVICE_ROLE_KEY;

        if (!SUPABASE_URL || !SUPABASE_KEY) {
          throw new Error('Supabase 설정이 필요합니다.');
        }

        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 차트 초기화
        initChart();
        
        // 대시보드 로드
        await loadDashboard();
        
        // 30초마다 자동 새로고침
        setInterval(loadDashboard, 30000);

      } catch (error) {
        console.error('초기화 실패:', error);
        showAlert('시스템 초기화에 실패했습니다: ' + error.message, 'error');
      }
    }

    // 차트 초기화
    function initChart() {
      const ctx = document.getElementById('usageChart').getContext('2d');
      usageChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: '토큰 사용량',
            data: [],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' 토큰';
                }
              }
            }
          }
        }
      });
    }

    // 대시보드 데이터 로드
    async function loadDashboard() {
      try {
        // 1. 활성 사용자 수
        const { data: activeUsers, error: activeError } = await supabase
          .from('subscription_cycle')
          .select('user_id')
          .eq('status', 'active');

        if (!activeError && activeUsers) {
          document.getElementById('totalActiveUsers').textContent = activeUsers.length;
        }

        // 2. 오늘 사용된 토큰
        const today = new Date().toISOString().split('T')[0];
        const { data: todayUsage, error: todayError } = await supabase
          .from('token_usage')
          .select('tokens_used')
          .gte('used_at', today + 'T00:00:00')
          .lte('used_at', today + 'T23:59:59');

        if (!todayError && todayUsage) {
          const totalTokens = todayUsage.reduce((sum, item) => sum + item.tokens_used, 0);
          document.getElementById('todayTokens').textContent = totalTokens.toLocaleString();
        }

        // 3. 평균 사용률
        const { data: cycles, error: cycleError } = await supabase
          .from('subscription_cycle')
          .select('tokens_used, monthly_token_limit')
          .eq('status', 'active');

        if (!cycleError && cycles && cycles.length > 0) {
          const avgUsage = cycles.reduce((sum, c) => {
            const rate = c.monthly_token_limit > 0 ? (c.tokens_used / c.monthly_token_limit) * 100 : 0;
            return sum + rate;
          }, 0) / cycles.length;

          document.getElementById('avgUsageRate').textContent = Math.round(avgUsage) + '%';
        }

        // 4. 한도 초과 사용자
        const { data: exceededUsers, error: exceededError } = await supabase
          .from('subscription_cycle')
          .select('user_id')
          .eq('is_exceeded', true)
          .eq('status', 'active');

        if (!exceededError && exceededUsers) {
          const count = exceededUsers.length;
          document.getElementById('exceededUsers').textContent = count;
          
          if (count > 0) {
            showAlert(`${count}명의 사용자가 토큰 한도를 초과했습니다.`, 'warning');
          }
        }

        // 5. 차트 데이터 로드
        await loadChartData();

        // 6. 사용자 테이블 로드
        await loadUsersTable();

      } catch (error) {
        console.error('대시보드 로드 실패:', error);
        showAlert('데이터 로드 중 오류가 발생했습니다.', 'error');
      }
    }

    // 차트 데이터 로드
    async function loadChartData() {
      try {
        const days = currentPeriod === '7d' ? 7 : currentPeriod === '30d' ? 30 : 90;
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);

        const { data: usageData, error } = await supabase
          .from('token_usage')
          .select('used_at, tokens_used')
          .gte('used_at', startDate.toISOString());

        if (error) throw error;

        // 날짜별로 그룹화
        const groupedData = {};
        const labels = [];
        
        for (let i = 0; i < days; i++) {
          const date = new Date();
          date.setDate(date.getDate() - (days - i - 1));
          const dateStr = date.toISOString().split('T')[0];
          labels.push(dateStr);
          groupedData[dateStr] = 0;
        }

        usageData.forEach(item => {
          const dateStr = item.used_at.split('T')[0];
          if (groupedData.hasOwnProperty(dateStr)) {
            groupedData[dateStr] += item.tokens_used;
          }
        });

        const data = labels.map(label => groupedData[label]);

        // 차트 업데이트
        usageChart.data.labels = labels.map(l => {
          const date = new Date(l);
          return `${date.getMonth() + 1}/${date.getDate()}`;
        });
        usageChart.data.datasets[0].data = data;
        usageChart.update();

      } catch (error) {
        console.error('차트 데이터 로드 실패:', error);
      }
    }

    // 사용자 테이블 로드
    async function loadUsersTable() {
      try {
        // 사용자 정보와 구독 정보 조인
        const { data: userData, error } = await supabase
          .from('profiles')
          .select(`
            id,
            email,
            name,
            membership_level,
            subscription_cycle!inner(
              tokens_used,
              monthly_token_limit,
              tokens_remaining,
              cycle_end_date,
              status
            )
          `)
          .eq('subscription_cycle.status', 'active')
          .order('subscription_cycle.tokens_used', { ascending: false })
          .limit(50);

        if (error) throw error;

        allUsersData = userData || [];
        renderUsersTable(allUsersData);

      } catch (error) {
        console.error('사용자 테이블 로드 실패:', error);
        document.getElementById('usersTableBody').innerHTML = `
          <tr>
            <td colspan="7" class="loading">
              <i class="fas fa-exclamation-triangle"></i>
              <div>데이터 로드 실패</div>
            </td>
          </tr>
        `;
      }
    }

    // 사용자 테이블 렌더링
    function renderUsersTable(users) {
      const tbody = document.getElementById('usersTableBody');
      
      if (!users || users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: #9ca3af;">
              활성 사용자가 없습니다.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = users.map(user => {
        const cycle = user.subscription_cycle[0];
        const usageRate = cycle.monthly_token_limit > 0 
          ? Math.round((cycle.tokens_used / cycle.monthly_token_limit) * 100)
          : 0;
        
        const usageClass = usageRate >= 90 ? 'usage-high' : 
                          usageRate >= 70 ? 'usage-medium' : 'usage-low';
        
        const planClass = `plan-${user.membership_level || 'seed'}`;
        
        const daysLeft = Math.ceil((new Date(cycle.cycle_end_date) - new Date()) / (1000 * 60 * 60 * 24));

        return `
          <tr>
            <td>
              <div style="font-weight: 600;">${user.name || '이름 없음'}</div>
              <div style="font-size: 12px; color: #9ca3af;">${user.email}</div>
            </td>
            <td>
              <span class="plan-badge ${planClass}">
                ${user.membership_level?.toUpperCase() || 'SEED'}
              </span>
            </td>
            <td>${cycle.tokens_used} / ${cycle.monthly_token_limit}</td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div class="usage-bar">
                  <div class="usage-fill ${usageClass}" style="width: ${Math.min(usageRate, 100)}%"></div>
                </div>
                <span style="font-size: 12px; color: #666;">${usageRate}%</span>
              </div>
            </td>
            <td>${cycle.tokens_remaining}</td>
            <td>${daysLeft}일 후</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn" onclick="viewUserDetail('${user.id}')">
                  <i class="fas fa-eye"></i> 상세
                </button>
                <button class="action-btn" onclick="addTokens('${user.id}')">
                  <i class="fas fa-plus"></i> 토큰
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // 사용자 검색
    function searchUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      
      if (!searchTerm) {
        renderUsersTable(allUsersData);
        return;
      }

      const filtered = allUsersData.filter(user => 
        user.email.toLowerCase().includes(searchTerm) ||
        (user.name && user.name.toLowerCase().includes(searchTerm))
      );

      renderUsersTable(filtered);
    }

    // 차트 기간 변경
    function changeChartPeriod(period) {
      currentPeriod = period;
      
      // 버튼 상태 업데이트
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // 차트 재로드
      loadChartData();
    }

    // 사용자 상세 보기
    function viewUserDetail(userId) {
      window.location.href = `/admin/member-management.html?userId=${userId}`;
    }

    // 토큰 추가
    async function addTokens(userId) {
      const tokens = prompt('추가할 토큰 수를 입력하세요:');
      if (!tokens || isNaN(tokens)) return;

      try {
        // 현재 사이클 조회
        const { data: cycle, error: fetchError } = await supabase
          .from('subscription_cycle')
          .select('*')
          .eq('user_id', userId)
          .eq('status', 'active')
          .single();

        if (fetchError) throw fetchError;

        // 토큰 추가
        const newRemaining = cycle.tokens_remaining + parseInt(tokens);
        const newLimit = cycle.monthly_token_limit + parseInt(tokens);

        const { error: updateError } = await supabase
          .from('subscription_cycle')
          .update({
            tokens_remaining: newRemaining,
            monthly_token_limit: newLimit
          })
          .eq('id', cycle.id);

        if (updateError) throw updateError;

        showAlert(`${tokens} 토큰이 추가되었습니다.`, 'success');
        await loadUsersTable();

      } catch (error) {
        console.error('토큰 추가 실패:', error);
        showAlert('토큰 추가에 실패했습니다.', 'error');
      }
    }

    // 대시보드 새로고침
    async function refreshDashboard() {
      showAlert('데이터를 새로고침하는 중...', 'info');
      await loadDashboard();
      setTimeout(() => {
        document.getElementById('alertBox').style.display = 'none';
      }, 2000);
    }

    // 알림 표시
    function showAlert(message, type = 'warning') {
      const alertBox = document.getElementById('alertBox');
      const alertMessage = document.getElementById('alertMessage');
      
      alertBox.className = `alert-box ${type}`;
      alertMessage.textContent = message;
      alertBox.style.display = 'block';
      
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          alertBox.style.display = 'none';
        }, 5000);
      }
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
