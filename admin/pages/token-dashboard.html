<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í† í° ëŒ€ì‹œë³´ë“œ - ì–´ë“œë¯¼</title>
  <link rel="stylesheet" href="../assets/admin-common.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 15px;
    }

    .stat-title {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .stat-change {
      font-size: 13px;
      color: #666;
    }

    .stat-change.positive {
      color: #22c55e;
    }

    .stat-change.negative {
      color: #ef4444;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .filter-buttons {
      display: flex;
      gap: 10px;
    }

    .filter-btn {
      padding: 6px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: white;
      color: #666;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .filter-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .users-table-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .search-box {
      position: relative;
      width: 300px;
    }

    .search-box input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }

    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table th {
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid #f3f4f6;
      color: #6b7280;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .users-table td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #333;
      font-size: 14px;
    }

    .users-table tr:hover {
      background: #f9fafb;
    }

    .plan-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .plan-seed {
      background: #e5e7eb;
      color: #6b7280;
    }

    .plan-power {
      background: #dbeafe;
      color: #2563eb;
    }

    .plan-bigpower {
      background: #fce7f3;
      color: #ec4899;
    }

    .plan-premium {
      background: #f3e8ff;
      color: #9333ea;
    }

    .usage-bar {
      width: 100px;
      height: 8px;
      background: #f3f4f6;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .usage-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }

    .usage-low {
      background: #22c55e;
    }

    .usage-medium {
      background: #f59e0b;
    }

    .usage-high {
      background: #ef4444;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 4px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      background: white;
      color: #666;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      border-color: #667eea;
      color: #667eea;
      background: #f0f4ff;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }

    .loading i {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .alert-box {
      background: #fef2f2;
      border: 1px solid #fee2e2;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      color: #dc2626;
      display: none;
    }

    .alert-box.warning {
      background: #fef3c7;
      border-color: #fde68a;
      color: #d97706;
    }

    .alert-box.info {
      background: #dbeafe;
      border-color: #bfdbfe;
      color: #1e40af;
    }
  </style>
</head>
<body class="admin-body">
  <!-- ì‚¬ì´ë“œë°” -->
  <div id="admin-sidebar"></div>
  
  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <div class="admin-main">
    <!-- í—¤ë” -->
    <header class="admin-header">
      <h1>ğŸ“Š í† í° ëŒ€ì‹œë³´ë“œ</h1>
      <button class="btn btn-primary" onclick="refreshDashboard()">
        <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
      </button>
    </header>
    
    <!-- ì»¨í…ì¸  -->
    <div class="admin-content">
      <!-- ì•Œë¦¼ ë°•ìŠ¤ -->
      <div class="alert-box warning" id="alertBox" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="alertMessage"></span>
      </div>

      <!-- í†µê³„ ì¹´ë“œ -->
      <div class="dashboard-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background: #e0f2fe;">
            <i class="fas fa-users" style="color: #0284c7;"></i>
          </div>
          <div class="stat-title">ì „ì²´ í™œì„± ì‚¬ìš©ì</div>
          <div class="stat-value" id="totalActiveUsers">0</div>
          <div class="stat-change" id="userChange">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: #dcfce7;">
            <i class="fas fa-coins" style="color: #16a34a;"></i>
          </div>
          <div class="stat-title">ì˜¤ëŠ˜ ì‚¬ìš©ëœ í† í°</div>
          <div class="stat-value" id="todayTokens">0</div>
          <div class="stat-change" id="tokenChange">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: #fef3c7;">
            <i class="fas fa-chart-line" style="color: #d97706;"></i>
          </div>
          <div class="stat-title">í‰ê·  ì‚¬ìš©ë¥ </div>
          <div class="stat-value" id="avgUsageRate">0%</div>
          <div class="stat-change" id="usageChange">-</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: #fee2e2;">
            <i class="fas fa-exclamation-circle" style="color: #dc2626;"></i>
          </div>
          <div class="stat-title">í•œë„ ì´ˆê³¼ ì‚¬ìš©ì</div>
          <div class="stat-value" id="exceededUsers">0</div>
          <div class="stat-change">ì£¼ì˜ í•„ìš”</div>
        </div>
      </div>

      <!-- ì‚¬ìš©ëŸ‰ ì°¨íŠ¸ -->
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">í† í° ì‚¬ìš©ëŸ‰ ì¶”ì´</h3>
          <div class="filter-buttons">
            <button class="filter-btn active" onclick="changeChartPeriod('7d')">7ì¼</button>
            <button class="filter-btn" onclick="changeChartPeriod('30d')">30ì¼</button>
            <button class="filter-btn" onclick="changeChartPeriod('90d')">90ì¼</button>
          </div>
        </div>
        <canvas id="usageChart" height="80"></canvas>
      </div>

      <!-- ì‚¬ìš©ìë³„ í† í° í˜„í™© í…Œì´ë¸” -->
      <div class="users-table-container">
        <div class="table-header">
          <h3 class="chart-title">ì‚¬ìš©ìë³„ í† í° í˜„í™©</h3>
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="userSearch" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰..." onkeyup="searchUsers()">
          </div>
        </div>
        
        <table class="users-table">
          <thead>
            <tr>
              <th>ì‚¬ìš©ì</th>
              <th>í”Œëœ</th>
              <th>ì‚¬ìš©ëŸ‰</th>
              <th>ì‚¬ìš©ë¥ </th>
              <th>ë‚¨ì€ í† í°</th>
              <th>ê°±ì‹ ì¼</th>
              <th>ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="7" class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="../assets/admin-sidebar.js"></script>
  <script src="../assets/admin-common.js"></script>
  <script>
    // ì „ì—­ ë³€ìˆ˜
    let supabase;
    let usageChart;
    let currentPeriod = '7d';
    let allUsersData = [];

    // ì´ˆê¸°í™”
    async function init() {
      try {
        // Supabase ì´ˆê¸°í™”
        const SUPABASE_URL = window.NEXT_PUBLIC_SUPABASE_URL;
        const SUPABASE_KEY = window.SUPABASE_SERVICE_ROLE_KEY;

        if (!SUPABASE_URL || !SUPABASE_KEY) {
          throw new Error('Supabase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }

        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        initChart();
        
        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        await loadDashboard();
        
        // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(loadDashboard, 30000);

      } catch (error) {
        console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showAlert('ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
      }
    }

    // ì°¨íŠ¸ ì´ˆê¸°í™”
    function initChart() {
      const ctx = document.getElementById('usageChart').getContext('2d');
      usageChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'í† í° ì‚¬ìš©ëŸ‰',
            data: [],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' í† í°';
                }
              }
            }
          }
        }
      });
    }

    // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
    async function loadDashboard() {
      try {
        // 1. í™œì„± ì‚¬ìš©ì ìˆ˜
        const { data: activeUsers, error: activeError } = await supabase
          .from('subscription_cycle')
          .select('user_id')
          .eq('status', 'active');

        if (!activeError && activeUsers) {
          document.getElementById('totalActiveUsers').textContent = activeUsers.length;
        }

        // 2. ì˜¤ëŠ˜ ì‚¬ìš©ëœ í† í°
        const today = new Date().toISOString().split('T')[0];
        const { data: todayUsage, error: todayError } = await supabase
          .from('token_usage')
          .select('tokens_used')
          .gte('used_at', today + 'T00:00:00')
          .lte('used_at', today + 'T23:59:59');

        if (!todayError && todayUsage) {
          const totalTokens = todayUsage.reduce((sum, item) => sum + item.tokens_used, 0);
          document.getElementById('todayTokens').textContent = totalTokens.toLocaleString();
        }

        // 3. í‰ê·  ì‚¬ìš©ë¥ 
        const { data: cycles, error: cycleError } = await supabase
          .from('subscription_cycle')
          .select('tokens_used, monthly_token_limit')
          .eq('status', 'active');

        if (!cycleError && cycles && cycles.length > 0) {
          const avgUsage = cycles.reduce((sum, c) => {
            const rate = c.monthly_token_limit > 0 ? (c.tokens_used / c.monthly_token_limit) * 100 : 0;
            return sum + rate;
          }, 0) / cycles.length;

          document.getElementById('avgUsageRate').textContent = Math.round(avgUsage) + '%';
        }

        // 4. í•œë„ ì´ˆê³¼ ì‚¬ìš©ì
        const { data: exceededUsers, error: exceededError } = await supabase
          .from('subscription_cycle')
          .select('user_id')
          .eq('is_exceeded', true)
          .eq('status', 'active');

        if (!exceededError && exceededUsers) {
          const count = exceededUsers.length;
          document.getElementById('exceededUsers').textContent = count;
          
          if (count > 0) {
            showAlert(`${count}ëª…ì˜ ì‚¬ìš©ìê°€ í† í° í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.`, 'warning');
          }
        }

        // 5. ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
        await loadChartData();

        // 6. ì‚¬ìš©ì í…Œì´ë¸” ë¡œë“œ
        await loadUsersTable();

      } catch (error) {
        console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
    async function loadChartData() {
      try {
        const days = currentPeriod === '7d' ? 7 : currentPeriod === '30d' ? 30 : 90;
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);

        const { data: usageData, error } = await supabase
          .from('token_usage')
          .select('used_at, tokens_used')
          .gte('used_at', startDate.toISOString());

        if (error) throw error;

        // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
        const groupedData = {};
        const labels = [];
        
        for (let i = 0; i < days; i++) {
          const date = new Date();
          date.setDate(date.getDate() - (days - i - 1));
          const dateStr = date.toISOString().split('T')[0];
          labels.push(dateStr);
          groupedData[dateStr] = 0;
        }

        usageData.forEach(item => {
          const dateStr = item.used_at.split('T')[0];
          if (groupedData.hasOwnProperty(dateStr)) {
            groupedData[dateStr] += item.tokens_used;
          }
        });

        const data = labels.map(label => groupedData[label]);

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        usageChart.data.labels = labels.map(l => {
          const date = new Date(l);
          return `${date.getMonth() + 1}/${date.getDate()}`;
        });
        usageChart.data.datasets[0].data = data;
        usageChart.update();

      } catch (error) {
        console.error('ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ì‚¬ìš©ì í…Œì´ë¸” ë¡œë“œ
    async function loadUsersTable() {
      try {
        // ì‚¬ìš©ì ì •ë³´ì™€ êµ¬ë… ì •ë³´ ì¡°ì¸
        const { data: userData, error } = await supabase
          .from('profiles')
          .select(`
            id,
            email,
            name,
            membership_level,
            subscription_cycle!inner(
              tokens_used,
              monthly_token_limit,
              tokens_remaining,
              cycle_end_date,
              status
            )
          `)
          .eq('subscription_cycle.status', 'active')
          .order('subscription_cycle.tokens_used', { ascending: false })
          .limit(50);

        if (error) throw error;

        allUsersData = userData || [];
        renderUsersTable(allUsersData);

      } catch (error) {
        console.error('ì‚¬ìš©ì í…Œì´ë¸” ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('usersTableBody').innerHTML = `
          <tr>
            <td colspan="7" class="loading">
              <i class="fas fa-exclamation-triangle"></i>
              <div>ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>
            </td>
          </tr>
        `;
      }
    }

    // ì‚¬ìš©ì í…Œì´ë¸” ë Œë”ë§
    function renderUsersTable(users) {
      const tbody = document.getElementById('usersTableBody');
      
      if (!users || users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: #9ca3af;">
              í™œì„± ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = users.map(user => {
        const cycle = user.subscription_cycle[0];
        const usageRate = cycle.monthly_token_limit > 0 
          ? Math.round((cycle.tokens_used / cycle.monthly_token_limit) * 100)
          : 0;
        
        const usageClass = usageRate >= 90 ? 'usage-high' : 
                          usageRate >= 70 ? 'usage-medium' : 'usage-low';
        
        const planClass = `plan-${user.membership_level || 'seed'}`;
        
        const daysLeft = Math.ceil((new Date(cycle.cycle_end_date) - new Date()) / (1000 * 60 * 60 * 24));

        return `
          <tr>
            <td>
              <div style="font-weight: 600;">${user.name || 'ì´ë¦„ ì—†ìŒ'}</div>
              <div style="font-size: 12px; color: #9ca3af;">${user.email}</div>
            </td>
            <td>
              <span class="plan-badge ${planClass}">
                ${user.membership_level?.toUpperCase() || 'SEED'}
              </span>
            </td>
            <td>${cycle.tokens_used} / ${cycle.monthly_token_limit}</td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div class="usage-bar">
                  <div class="usage-fill ${usageClass}" style="width: ${Math.min(usageRate, 100)}%"></div>
                </div>
                <span style="font-size: 12px; color: #666;">${usageRate}%</span>
              </div>
            </td>
            <td>${cycle.tokens_remaining}</td>
            <td>${daysLeft}ì¼ í›„</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn" onclick="viewUserDetail('${user.id}')">
                  <i class="fas fa-eye"></i> ìƒì„¸
                </button>
                <button class="action-btn" onclick="addTokens('${user.id}')">
                  <i class="fas fa-plus"></i> í† í°
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ì‚¬ìš©ì ê²€ìƒ‰
    function searchUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      
      if (!searchTerm) {
        renderUsersTable(allUsersData);
        return;
      }

      const filtered = allUsersData.filter(user => 
        user.email.toLowerCase().includes(searchTerm) ||
        (user.name && user.name.toLowerCase().includes(searchTerm))
      );

      renderUsersTable(filtered);
    }

    // ì°¨íŠ¸ ê¸°ê°„ ë³€ê²½
    function changeChartPeriod(period) {
      currentPeriod = period;
      
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // ì°¨íŠ¸ ì¬ë¡œë“œ
      loadChartData();
    }

    // ì‚¬ìš©ì ìƒì„¸ ë³´ê¸°
    function viewUserDetail(userId) {
      window.location.href = `/admin/member-management.html?userId=${userId}`;
    }

    // í† í° ì¶”ê°€
    async function addTokens(userId) {
      const tokens = prompt('ì¶”ê°€í•  í† í° ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!tokens || isNaN(tokens)) return;

      try {
        // í˜„ì¬ ì‚¬ì´í´ ì¡°íšŒ
        const { data: cycle, error: fetchError } = await supabase
          .from('subscription_cycle')
          .select('*')
          .eq('user_id', userId)
          .eq('status', 'active')
          .single();

        if (fetchError) throw fetchError;

        // í† í° ì¶”ê°€
        const newRemaining = cycle.tokens_remaining + parseInt(tokens);
        const newLimit = cycle.monthly_token_limit + parseInt(tokens);

        const { error: updateError } = await supabase
          .from('subscription_cycle')
          .update({
            tokens_remaining: newRemaining,
            monthly_token_limit: newLimit
          })
          .eq('id', cycle.id);

        if (updateError) throw updateError;

        showAlert(`${tokens} í† í°ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        await loadUsersTable();

      } catch (error) {
        console.error('í† í° ì¶”ê°€ ì‹¤íŒ¨:', error);
        showAlert('í† í° ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
    async function refreshDashboard() {
      showAlert('ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” ì¤‘...', 'info');
      await loadDashboard();
      setTimeout(() => {
        document.getElementById('alertBox').style.display = 'none';
      }, 2000);
    }

    // ì•Œë¦¼ í‘œì‹œ
    function showAlert(message, type = 'warning') {
      const alertBox = document.getElementById('alertBox');
      const alertMessage = document.getElementById('alertMessage');
      
      alertBox.className = `alert-box ${type}`;
      alertMessage.textContent = message;
      alertBox.style.display = 'block';
      
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          alertBox.style.display = 'none';
        }, 5000);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
