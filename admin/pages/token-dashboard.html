<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>토큰 대시보드 - 사장픽 관리자</title>
    
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    
    <!-- 공통 스타일 -->
    <link rel="stylesheet" href="/admin/assets/admin-common.css" />
    
    <style>
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }

      .subtitle {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 24px;
      }

      /* 통계 카드 */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 24px;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .stat-card.green {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      }

      .stat-card.orange {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .stat-card.blue {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      .stat-card .icon {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 48px;
        opacity: 0.3;
      }

      .stat-card .label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 8px;
      }

      .stat-card .value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .stat-card .change {
        font-size: 12px;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* 차트 카드 */
      .chart-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .chart-title {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
      }

      /* 테이블 */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      .data-table thead {
        background: #f9fafb;
        border-bottom: 2px solid var(--border);
      }

      .data-table th {
        padding: 12px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .data-table td {
        padding: 12px;
        font-size: 14px;
        color: #374151;
        border-bottom: 1px solid #f3f4f6;
      }

      .data-table tbody tr:hover {
        background: #fafafa;
      }

      /* 프로그레스 바 */
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--accent);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .progress-fill.warning {
        background: #f59e0b;
      }

      .progress-fill.danger {
        background: #ef4444;
      }

      /* 태그 */
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge.success {
        background: #dcfce7;
        color: #16a34a;
      }

      .badge.warning {
        background: #fef3c7;
        color: #d97706;
      }

      .badge.danger {
        background: #fee2e2;
        color: #dc2626;
      }

      .badge.info {
        background: #dbeafe;
        color: #2563eb;
      }

      /* 필터 */
      .filter-bar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .filter-label {
        font-size: 12px;
        color: #6b7280;
        font-weight: 600;
      }

      .filter-select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        background: white;
      }

      .btn {
        padding: 8px 16px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .btn.secondary {
        background: white;
        color: #374151;
        border: 1px solid var(--border);
      }

      /* 리프레시 인디케이터 */
      .refresh-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 4px 8px;
        background: #f3f4f6;
        border-radius: 4px;
        font-size: 12px;
        color: #6b7280;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
      }

      .empty-state {
        text-align: center;
        padding: 60px;
        color: #9ca3af;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
    </style>
  </head>
  <body class="admin-body">
    <!-- 사이드바 -->
    <div id="admin-sidebar"></div>

    <!-- 헤더 -->
    <div id="header"></div>

    <!-- 메인 콘텐츠 -->
    <main class="main-content">
      <div class="container">
        <!-- 페이지 타이틀 -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
          <h1 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 28px; color: #111827;">
            <i class="fas fa-coins" style="color: var(--accent);"></i>
            토큰 대시보드
          </h1>
          <div class="refresh-indicator">
            <i class="fas fa-sync-alt"></i>
            <span id="lastUpdate">마지막 업데이트: -</span>
          </div>
        </div>
        <div class="subtitle">실시간 토큰 사용 현황 및 통계</div>

        <!-- 통계 카드 -->
        <div class="stats-grid">
          <div class="stat-card">
            <i class="fas fa-users icon"></i>
            <div class="label">전체 활성 사용자</div>
            <div class="value" id="activeUsers">-</div>
            <div class="change">
              <i class="fas fa-arrow-up"></i>
              <span id="userChange">+0% 전월 대비</span>
            </div>
          </div>

          <div class="stat-card green">
            <i class="fas fa-coins icon"></i>
            <div class="label">오늘 사용 토큰</div>
            <div class="value" id="todayTokens">-</div>
            <div class="change">
              <i class="fas fa-arrow-up"></i>
              <span id="tokenChange">+0% 어제 대비</span>
            </div>
          </div>

          <div class="stat-card orange">
            <i class="fas fa-chart-line icon"></i>
            <div class="label">월간 총 사용량</div>
            <div class="value" id="monthlyTokens">-</div>
            <div class="change">
              <span id="monthlyRate">0% 사용률</span>
            </div>
          </div>

          <div class="stat-card blue">
            <i class="fas fa-won-sign icon"></i>
            <div class="label">예상 월 매출</div>
            <div class="value" id="monthlyRevenue">-</div>
            <div class="change">
              <i class="fas fa-arrow-up"></i>
              <span id="revenueChange">+0% 전월 대비</span>
            </div>
          </div>
        </div>

        <!-- 필터 -->
        <div class="filter-bar">
          <div class="filter-item">
            <label class="filter-label">기간</label>
            <select class="filter-select" id="periodFilter" onchange="loadDashboardData()">
              <option value="today">오늘</option>
              <option value="week" selected>이번 주</option>
              <option value="month">이번 달</option>
              <option value="all">전체</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label">회원 유형</label>
            <select class="filter-select" id="userTypeFilter" onchange="loadDashboardData()">
              <option value="all">전체</option>
              <option value="owner">식당 대표</option>
              <option value="agency">대행사</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label">멤버십</label>
            <select class="filter-select" id="membershipFilter" onchange="loadDashboardData()">
              <option value="all">전체</option>
              <option value="seed">씨앗</option>
              <option value="power">파워</option>
              <option value="bigpower">빅파워</option>
              <option value="premium">프리미엄</option>
            </select>
          </div>
          <div class="filter-item" style="margin-left: auto;">
            <label class="filter-label">&nbsp;</label>
            <button class="btn" onclick="loadDashboardData()">
              <i class="fas fa-sync-alt"></i> 새로고침
            </button>
          </div>
        </div>

        <!-- 사용량 차트 -->
        <div class="chart-card">
          <div class="chart-header">
            <h2 class="chart-title">
              <i class="fas fa-chart-area" style="color: var(--accent); margin-right: 8px;"></i>
              토큰 사용 추이
            </h2>
            <div>
              <button class="btn secondary" onclick="exportData()">
                <i class="fas fa-download"></i> 데이터 내보내기
              </button>
            </div>
          </div>
          <div id="usageChart" style="height: 300px;">
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i> 차트 로딩 중...
            </div>
          </div>
        </div>

        <!-- 상위 사용자 테이블 -->
        <div class="chart-card">
          <div class="chart-header">
            <h2 class="chart-title">
              <i class="fas fa-trophy" style="color: #f59e0b; margin-right: 8px;"></i>
              상위 토큰 사용자
            </h2>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>순위</th>
                <th>사용자</th>
                <th>멤버십</th>
                <th>사용량</th>
                <th>한도</th>
                <th>사용률</th>
                <th>상태</th>
              </tr>
            </thead>
            <tbody id="topUsersTable">
              <tr>
                <td colspan="7" class="loading">
                  <i class="fas fa-spinner fa-spin"></i> 데이터 로딩 중...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 한도 초과 사용자 -->
        <div class="chart-card">
          <div class="chart-header">
            <h2 class="chart-title">
              <i class="fas fa-exclamation-triangle" style="color: #ef4444; margin-right: 8px;"></i>
              한도 초과 사용자
            </h2>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>사용자</th>
                <th>멤버십</th>
                <th>사용량</th>
                <th>한도</th>
                <th>초과량</th>
                <th>초과 시간</th>
                <th>액션</th>
              </tr>
            </thead>
            <tbody id="exceededUsersTable">
              <tr>
                <td colspan="7" class="empty-state">
                  <i class="fas fa-check-circle"></i>
                  <div>한도 초과 사용자가 없습니다</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="/admin/assets/admin-bootstrap.js" defer></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // ==================== 설정 ====================
      
      let supabase;
      let chartInstance = null;

      // ==================== 초기화 ====================

      window.addEventListener('load', async function() {
        supabase = await AdminBootstrap.getSupabaseClient();
        await AdminBootstrap.initializeHeader();
        await AdminBootstrap.initializeSidebar();
        await loadDashboardData();
        
        // 30초마다 자동 새로고침
        setInterval(loadDashboardData, 30000);
      });

      // ==================== 대시보드 데이터 로드 ====================

      async function loadDashboardData() {
        try {
          const period = document.getElementById('periodFilter').value;
          const userType = document.getElementById('userTypeFilter').value;
          const membership = document.getElementById('membershipFilter').value;

          // 1. 통계 데이터 로드
          await loadStatistics(period, userType, membership);
          
          // 2. 차트 데이터 로드
          await loadChartData(period);
          
          // 3. 상위 사용자 로드
          await loadTopUsers();
          
          // 4. 한도 초과 사용자 로드
          await loadExceededUsers();
          
          // 마지막 업데이트 시간
          document.getElementById('lastUpdate').textContent = 
            `마지막 업데이트: ${new Date().toLocaleTimeString('ko-KR')}`;
        } catch (error) {
          console.error('❌ 대시보드 로드 실패:', error);
        }
      }

      // ==================== 통계 로드 ====================

      async function loadStatistics(period, userType, membership) {
        try {
          // 활성 사용자 수
          let query = supabase
            .from('subscription_cycle')
            .select('*', { count: 'exact' })
            .eq('status', 'active');
          
          if (userType !== 'all') {
            query = query.eq('user_type', userType);
          }
          
          const { count: activeCount } = await query;
          document.getElementById('activeUsers').textContent = activeCount || 0;

          // 오늘 사용 토큰
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          const { data: todayUsage } = await supabase
            .from('token_usage')
            .select('tokens_used')
            .gte('used_at', today.toISOString());
          
          const todayTotal = todayUsage?.reduce((sum, u) => sum + u.tokens_used, 0) || 0;
          document.getElementById('todayTokens').textContent = todayTotal.toLocaleString('ko-KR');

          // 월간 총 사용량
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          const { data: monthlyUsage } = await supabase
            .from('token_usage')
            .select('tokens_used')
            .gte('used_at', monthStart.toISOString());
          
          const monthlyTotal = monthlyUsage?.reduce((sum, u) => sum + u.tokens_used, 0) || 0;
          document.getElementById('monthlyTokens').textContent = monthlyTotal.toLocaleString('ko-KR');

          // 예상 월 매출
          const { data: subscriptions } = await supabase
            .from('subscription_cycle')
            .select('billing_amount')
            .eq('status', 'active');
          
          const revenue = subscriptions?.reduce((sum, s) => sum + s.billing_amount, 0) || 0;
          document.getElementById('monthlyRevenue').textContent = 
            `₩${revenue.toLocaleString('ko-KR')}`;
        } catch (error) {
          console.error('❌ 통계 로드 실패:', error);
        }
      }

      // ==================== 차트 로드 ====================

      async function loadChartData(period) {
        try {
          const ctx = document.getElementById('usageChart');
          
          // 기간별 데이터 조회
          let startDate = new Date();
          if (period === 'today') {
            startDate.setHours(0, 0, 0, 0);
          } else if (period === 'week') {
            startDate.setDate(startDate.getDate() - 7);
          } else if (period === 'month') {
            startDate.setMonth(startDate.getMonth() - 1);
          } else {
            startDate = new Date('2025-01-01');
          }

          const { data: usageData } = await supabase
            .from('token_usage')
            .select('tokens_used, used_at')
            .gte('used_at', startDate.toISOString())
            .order('used_at');

          // 날짜별로 그룹핑
          const grouped = {};
          usageData?.forEach(item => {
            const date = new Date(item.used_at).toLocaleDateString('ko-KR');
            grouped[date] = (grouped[date] || 0) + item.tokens_used;
          });

          // 차트 데이터 준비
          const labels = Object.keys(grouped);
          const data = Object.values(grouped);

          // 차트 업데이트 또는 생성
          if (chartInstance) {
            chartInstance.destroy();
          }

          ctx.innerHTML = '<canvas id="tokenChart"></canvas>';
          const canvas = document.getElementById('tokenChart');
          
          chartInstance = new Chart(canvas, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: '토큰 사용량',
                data: data,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString('ko-KR');
                    }
                  }
                }
              }
            }
          });
        } catch (error) {
          console.error('❌ 차트 로드 실패:', error);
          document.getElementById('usageChart').innerHTML = 
            '<div class="empty-state">차트를 로드할 수 없습니다</div>';
        }
      }

      // ==================== 상위 사용자 로드 ====================

      async function loadTopUsers() {
        try {
          // 구독 사이클과 프로필 조인
          const { data: cycles } = await supabase
            .from('subscription_cycle')
            .select(`
              *,
              profiles:user_id (email)
            `)
            .eq('status', 'active')
            .order('tokens_used', { ascending: false })
            .limit(10);

          const tbody = document.getElementById('topUsersTable');
          
          if (!cycles || cycles.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="7" class="empty-state">
                  <i class="fas fa-users"></i>
                  <div>활성 사용자가 없습니다</div>
                </td>
              </tr>
            `;
            return;
          }

          tbody.innerHTML = cycles.map((cycle, index) => {
            const usageRate = (cycle.tokens_used / cycle.monthly_token_limit * 100).toFixed(1);
            const statusClass = usageRate >= 90 ? 'danger' : usageRate >= 70 ? 'warning' : 'success';
            
            return `
              <tr>
                <td><strong>${index + 1}</strong></td>
                <td>${cycle.profiles?.email || 'Unknown'}</td>
                <td><span class="badge info">${getMembershipName(cycle.user_type)}</span></td>
                <td>${cycle.tokens_used.toLocaleString('ko-KR')}</td>
                <td>${cycle.monthly_token_limit.toLocaleString('ko-KR')}</td>
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="progress-bar" style="width: 100px;">
                      <div class="progress-fill ${statusClass}" style="width: ${Math.min(usageRate, 100)}%"></div>
                    </div>
                    <span>${usageRate}%</span>
                  </div>
                </td>
                <td><span class="badge ${statusClass}">${getStatusLabel(statusClass)}</span></td>
              </tr>
            `;
          }).join('');
        } catch (error) {
          console.error('❌ 상위 사용자 로드 실패:', error);
        }
      }

      // ==================== 한도 초과 사용자 로드 ====================

      async function loadExceededUsers() {
        try {
          const { data: exceeded } = await supabase
            .from('subscription_cycle')
            .select(`
              *,
              profiles:user_id (email)
            `)
            .eq('is_exceeded', true)
            .order('exceeded_at', { ascending: false });

          const tbody = document.getElementById('exceededUsersTable');
          
          if (!exceeded || exceeded.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="7" class="empty-state">
                  <i class="fas fa-check-circle"></i>
                  <div>한도 초과 사용자가 없습니다</div>
                </td>
              </tr>
            `;
            return;
          }

          tbody.innerHTML = exceeded.map(user => {
            const exceeded = user.tokens_used - user.monthly_token_limit;
            const exceededTime = user.exceeded_at ? 
              new Date(user.exceeded_at).toLocaleString('ko-KR') : '-';
            
            return `
              <tr>
                <td>${user.profiles?.email || 'Unknown'}</td>
                <td><span class="badge info">${getMembershipName(user.user_type)}</span></td>
                <td>${user.tokens_used.toLocaleString('ko-KR')}</td>
                <td>${user.monthly_token_limit.toLocaleString('ko-KR')}</td>
                <td style="color: #dc2626; font-weight: 600;">
                  +${exceeded.toLocaleString('ko-KR')}
                </td>
                <td>${exceededTime}</td>
                <td>
                  <button class="btn secondary" onclick="resetUserTokens('${user.user_id}')">
                    토큰 리셋
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        } catch (error) {
          console.error('❌ 한도 초과 사용자 로드 실패:', error);
        }
      }

      // ==================== 유틸리티 함수 ====================

      function getMembershipName(type) {
        const names = {
          'seed': '씨앗',
          'power': '파워',
          'bigpower': '빅파워',
          'premium': '프리미엄',
          'elite': '엘리트',
          'expert': '전문가',
          'master': '마스터'
        };
        return names[type] || type;
      }

      function getStatusLabel(status) {
        const labels = {
          'success': '정상',
          'warning': '주의',
          'danger': '초과'
        };
        return labels[status] || '정상';
      }

      async function resetUserTokens(userId) {
        if (!confirm('정말로 이 사용자의 토큰을 리셋하시겠습니까?')) return;

        try {
          const { error } = await supabase
            .from('subscription_cycle')
            .update({
              tokens_used: 0,
              tokens_remaining: 0,
              is_exceeded: false,
              exceeded_at: null
            })
            .eq('user_id', userId);

          if (error) throw error;

          alert('토큰이 리셋되었습니다.');
          await loadDashboardData();
        } catch (error) {
          console.error('❌ 토큰 리셋 실패:', error);
          alert('토큰 리셋에 실패했습니다.');
        }
      }

      function exportData() {
        alert('데이터 내보내기 기능은 준비 중입니다.');
      }
    </script>
    
    <!-- Admin 공통 스크립트 -->
    <script src="../assets/admin-sidebar.js"></script>
    <script src="../assets/admin-header.js"></script>
    <script src="../assets/admin-common.js"></script>
  </body>
</html>