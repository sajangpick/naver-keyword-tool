<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>구독 관리 - 사장픽</title>
    
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    
    <!-- 공통 스타일 -->
    <link rel="stylesheet" href="/assets/common.css" />
    
    <style>
      :root {
        --accent: #3490dc;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;
        --muted: #6b7280;
        --border: #e5e7eb;
        --panel: #ffffff;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        background: #f9fafb;
        color: #111827;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }

      .header {
        margin-bottom: 32px;
      }

      .header h1 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .header-subtitle {
        color: var(--muted);
        font-size: 14px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
      }

      .plan-card {
        background: var(--panel);
        border: 2px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        position: relative;
        transition: all 0.3s;
      }

      .plan-card:hover {
        border-color: var(--accent);
        box-shadow: 0 10px 30px rgba(52, 144, 220, 0.1);
      }

      .plan-card.current {
        border-color: var(--accent);
        background: linear-gradient(135deg, rgba(52, 144, 220, 0.05) 0%, rgba(52, 144, 220, 0.02) 100%);
      }

      .plan-card.current::before {
        content: '현재 구독';
        position: absolute;
        top: -12px;
        left: 20px;
        background: var(--accent);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .plan-name {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .plan-description {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 16px;
      }

      .plan-price {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .plan-price-unit {
        font-size: 14px;
        color: var(--muted);
      }

      .plan-features {
        list-style: none;
        margin: 20px 0;
        padding: 20px 0;
        border-top: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
      }

      .plan-features li {
        padding: 8px 0;
        font-size: 14px;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .plan-features li::before {
        content: '✓';
        color: var(--success);
        font-weight: 700;
        width: 20px;
      }

      .plan-actions {
        display: flex;
        gap: 8px;
        margin-top: 20px;
      }

      .btn {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
        color: #374151;
      }

      .btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
      }

      .btn.primary:hover {
        opacity: 0.9;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .section {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }

      .section-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
        background: #fafafa;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .section-header h2 {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-body {
        padding: 24px;
      }

      .billing-history {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th {
        background: #f9fafb;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: var(--muted);
        border-bottom: 1px solid var(--border);
      }

      td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
      }

      tr:hover {
        background: #f9fafb;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-badge.completed {
        background: #d1fae5;
        color: #065f46;
      }

      .status-badge.pending {
        background: #fef3c7;
        color: #92400e;
      }

      .status-badge.failed {
        background: #fee2e2;
        color: #7f1d1d;
      }

      .info-box {
        padding: 16px;
        background: #f0f9ff;
        border-left: 4px solid var(--accent);
        border-radius: 8px;
        margin-bottom: 16px;
      }

      .info-box strong {
        color: var(--accent);
      }

      .upgrade-request-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
      }

      .upgrade-request-card.pending {
        background: #fffbeb;
        border-color: var(--warning);
      }

      .upgrade-request-card.approved {
        background: #f0fdf4;
        border-color: var(--success);
      }

      .loading {
        text-align: center;
        padding: 60px 24px;
        color: var(--muted);
      }

      @media (max-width: 768px) {
        .container {
          padding: 16px;
        }

        .header h1 {
          font-size: 22px;
        }

        .grid {
          grid-template-columns: 1fr;
        }

        .plan-actions {
          flex-direction: column;
        }

        .plan-features {
          margin: 16px 0;
          padding: 16px 0;
        }

        table {
          font-size: 12px;
        }

        th, td {
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <!-- 헤더 -->
    <div id="header"></div>

    <!-- 메인 콘텐츠 -->
    <main class="container">
      <!-- 페이지 타이틀 -->
      <div class="header">
        <h1>
          <i class="fas fa-credit-card" style="color: var(--accent);"></i>
          구독 관리
        </h1>
        <div class="header-subtitle">구독 계획을 선택하고 관리하세요</div>
      </div>

      <!-- 로딩 상태 -->
      <div id="loadingState" class="loading" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> 로딩 중...
      </div>

      <!-- 메인 콘텐츠 (로드 후 표시) -->
      <div id="mainContent" style="display: none;">
        
        <!-- 현재 구독 정보 -->
        <div class="info-box">
          <i class="fas fa-info-circle"></i>
          <strong id="currentPlanInfo">-</strong>
        </div>

        <!-- 구독 플랜 -->
        <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">
          <i class="fas fa-layer-group" style="color: var(--accent);"></i>
          이용 가능한 플랜
        </h2>

        <div class="grid" id="plansContainer">
          <!-- 플랜 카드가 여기에 렌더링됨 -->
        </div>

        <!-- 업그레이드 요청 섹션 -->
        <div class="section" id="upgradeSection" style="display: none;">
          <div class="section-header">
            <h2>
              <i class="fas fa-arrow-up-right" style="color: var(--warning);"></i>
              업그레이드 요청
            </h2>
          </div>
          <div class="section-body">
            <div class="upgrade-request-card pending">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                  <strong style="font-size: 16px;">토큰 한도 초과</strong>
                  <div style="font-size: 13px; color: var(--muted); margin-top: 4px;">
                    현재 사용량이 한도를 초과했습니다
                  </div>
                </div>
                <span class="status-badge pending">검토 중</span>
              </div>
              <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(0, 0, 0, 0.1);">
                <button class="btn primary" onclick="requestUpgrade()">
                  <i class="fas fa-paper-plane"></i> 업그레이드 요청하기
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 청구 내역 섹션 -->
        <div class="section">
          <div class="section-header">
            <h2>
              <i class="fas fa-receipt" style="color: var(--accent);"></i>
              청구 내역
            </h2>
          </div>
          <div class="section-body">
            <div class="billing-history">
              <table>
                <thead>
                  <tr>
                    <th>청구일</th>
                    <th>구독 등급</th>
                    <th>금액</th>
                    <th>토큰 사용량</th>
                    <th>상태</th>
                  </tr>
                </thead>
                <tbody id="billingTable">
                  <tr>
                    <td colspan="5" style="text-align: center; color: var(--muted);">
                      청구 내역이 없습니다
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- FAQ 섹션 -->
        <div class="section">
          <div class="section-header">
            <h2>
              <i class="fas fa-question-circle" style="color: var(--accent);"></i>
              자주 묻는 질문
            </h2>
          </div>
          <div class="section-body">
            <div style="display: grid; gap: 16px;">
              <div>
                <strong>Q: 구독을 취소할 수 있나요?</strong>
                <p style="margin-top: 8px; color: var(--muted); font-size: 14px;">
                  네, 언제든지 구독을 취소할 수 있습니다. 다만, 이미 지불한 월간 요금은 환불되지 않습니다.
                </p>
              </div>
              <div>
                <strong>Q: 토큰이 초과되면 어떻게 되나요?</strong>
                <p style="margin-top: 8px; color: var(--muted); font-size: 14px;">
                  토큰이 한도를 초과하면 즉시 사용이 중지됩니다. 상위 플랜으로 업그레이드하거나 다음 월간 갱신 때까지 기다렸다가 요청할 수 있습니다.
                </p>
              </div>
              <div>
                <strong>Q: 언제 자동으로 청구되나요?</strong>
                <p style="margin-top: 8px; color: var(--muted); font-size: 14px;">
                  매월 구독 시작일을 기준으로 자동 청구됩니다. 예를 들어, 5월 15일에 구독을 시작했다면 매월 15일에 청구됩니다.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="/assets/common-header.js" defer></script>

    <script>
      let supabase;
      let currentUser;
      let currentProfile;

      window.addEventListener('load', async function() {
        try {
          const SUPABASE_URL = window.NEXT_PUBLIC_SUPABASE_URL;
          const SUPABASE_ANON_KEY = window.NEXT_PUBLIC_SUPABASE_ANON_KEY;
          
          if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            console.error('Supabase 환경변수 미설정');
            return;
          }

          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

          const { data: { user } } = await supabase.auth.getUser();
          if (!user) {
            window.location.href = '/login.html';
            return;
          }

          currentUser = user;
          await loadSubscriptionData();
        } catch (error) {
          console.error('❌ 구독 페이지 로드 실패:', error);
        }
      });

      async function loadSubscriptionData() {
        try {
          document.getElementById('loadingState').style.display = 'block';

          // 서버 API를 통해 대시보드 데이터 조회
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            window.location.href = '/login.html';
            return;
          }

          const response = await fetch('/api/subscription/user-dashboard?action=dashboard', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json'
            }
          });

          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.error);
          }

          const { profile, cycle, plans, recentUsage, stats } = result.data;
          currentProfile = profile;

          // 현재 플랜 정보
          const levelText = {
            'seed': '씨앗',
            'power': '파워',
            'big_power': '빅파워',
            'premium': '프리미엄',
            'elite': '엘리트',
            'expert': '전문가',
            'master': '마스터'
          };

          document.getElementById('currentPlanInfo').textContent = 
            `현재 구독: ${levelText[profile.membership_level] || profile.membership_level} (월 ${cycle?.monthly_price || 0}원)`;

          // 플랜 카드 렌더링
          const plansHtml = plans.map(plan => `
            <div class="plan-card ${profile.membership_level === plan.id ? 'current' : ''}">
              <div class="plan-name">${plan.name}</div>
              <div class="plan-description">${plan.description}</div>
              <div class="plan-price">
                ${plan.price > 0 ? plan.price.toLocaleString() : '무료'}
                <span class="plan-price-unit">${plan.price > 0 ? '/월' : ''}</span>
              </div>
              <ul class="plan-features">
                <li>월 ${plan.tokens.toLocaleString()} 토큰</li>
                <li>24/7 고객 지원</li>
                <li>우선 처리</li>
              </ul>
              <div class="plan-actions">
                ${profile.membership_level === plan.id 
                  ? '<button class="btn" disabled>현재 플랜</button>' 
                  : `<button class="btn primary" onclick="upgradeToPlan('${plan.id}')">업그레이드</button>`}
              </div>
            </div>
          `).join('');

          document.getElementById('plansContainer').innerHTML = plansHtml;

          // 청구 내역 조회
          const billingResponse = await fetch('/api/subscription/user-dashboard?action=billing', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json'
            }
          });
          
          const billingResult = await billingResponse.json();
          const billing = billingResult.success ? billingResult.data : [];

          if (billing && billing.length > 0) {
            const billingHtml = billing.map(b => `
              <tr>
                <td>${new Date(b.created_at).toLocaleDateString('ko-KR')}</td>
                <td>${levelText[b.membership_level] || b.membership_level}</td>
                <td>${b.monthly_price ? b.monthly_price.toLocaleString() + '원' : '-'}</td>
                <td>${b.token_used ? b.token_used.toLocaleString() : '-'}</td>
                <td>
                  <span class="status-badge ${b.payment_status === 'completed' ? 'completed' : 'pending'}">
                    ${b.payment_status === 'completed' ? '완료' : '대기 중'}
                  </span>
                </td>
              </tr>
            `).join('');
            document.getElementById('billingTable').innerHTML = billingHtml;
          }

          // 토큰 초과 상태 확인 (서버에서 이미 계산됨)
          if (cycle && cycle.is_exceeded) {
            document.getElementById('upgradeSection').style.display = 'block';
          }

          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
        } catch (error) {
          console.error('❌ 데이터 로드 실패:', error);
          document.getElementById('loadingState').innerHTML = `<div style="color: var(--danger);">❌ 오류 발생: ${error.message}</div>`;
        }
      }

      async function upgradeToPlan(planId) {
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            alert('로그인이 필요합니다.');
            return;
          }

          const response = await fetch('/api/subscription/user-dashboard', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              action: 'upgrade',
              target_level: planId,
              reason: '플랜 업그레이드 요청'
            })
          });

          const result = await response.json();
          
          if (result.success) {
            alert(result.message || '업그레이드 요청이 접수되었습니다.');
            // 페이지 새로고침
            window.location.reload();
          } else {
            alert(result.error || '업그레이드 요청 실패');
          }
        } catch (error) {
          console.error('업그레이드 요청 오류:', error);
          alert('업그레이드 요청 중 오류가 발생했습니다.');
        }
      }

      async function requestUpgrade() {
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            alert('로그인이 필요합니다.');
            return;
          }

          const response = await fetch('/api/subscription/user-dashboard', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              action: 'upgrade',
              target_level: 'power', // 기본값으로 파워 등급
              reason: '토큰 한도 초과로 인한 업그레이드 요청'
            })
          });

          const result = await response.json();
          
          if (result.success) {
            alert(result.message || '업그레이드 요청이 접수되었습니다. 관리자가 검토한 후 알려드리겠습니다.');
          } else {
            alert(result.error || '업그레이드 요청 실패');
          }
        } catch (error) {
          console.error('업그레이드 요청 오류:', error);
          alert('업그레이드 요청 중 오류가 발생했습니다.');
        }
      }
    </script>
  </body>
</html>
