<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://*.supabase.co http://localhost:* http://127.0.0.1:*; img-src 'self' data: https:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com data:; frame-ancestors 'self'; base-uri 'self'; form-action 'self'" />
    <meta name="referrer" content="no-referrer" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <title>AI 리뷰 관리 - 사장픽</title>
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2303c75a'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' font-family='Arial' fill='white'%3ESP%3C/text%3E%3C/svg%3E"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link href="https://cdn.jsdelivr.net/gh/webfontworld/score/SCoreDream.css" rel="stylesheet">
    <script src="/assets/common-header.js?v=20251022" defer></script>
    <style>
      :root {
        --primary-green: #03C75A;
        --primary-white: #FFFFFF;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'SCoreDream', -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Noto Sans KR", Arial, sans-serif;
        background: #FFFFFF;
        min-height: 100vh;
        color: #03C75A;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        -webkit-tap-highlight-color: transparent;
      }

      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        background: var(--primary-white);
        box-shadow: 0 2px 10px rgba(3, 199, 90, 0.1);
        transition: transform 0.3s ease;
      }

      .header-inner {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 20px 40px;
        max-width: 1400px;
        margin: 0 auto;
        gap: 20px;
      }
      @media (max-width: 768px) {
        .header-inner {
          display: flex;
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          gap: 8px;
        }
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        text-decoration: none;
      }
      .logo-icon {
        font-size: 48px;
        color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .logo-text {
        font-weight: 800;
        font-size: 20px;
        color: #000;
        letter-spacing: -0.5px;
      }
      .header-slogan {
        text-align: center;
        font-size: 24px;
        font-weight: 700;
        color: #000;
        white-space: nowrap;
      }
      @media (max-width: 768px) {
        .logo-container {
          gap: 6px;
        }
        .logo-icon {
          font-size: 24px;
        }
        .logo-text {
          font-size: 14px;
        }
        .header-slogan {
          display: none;
        }
      }

      .header-auth {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
      }
      .home-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 50px;
        padding: 0 32px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 16px;
        gap: 8px;
        border: none;
        background: var(--primary-green);
        color: var(--primary-white);
        text-decoration: none;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .home-btn:hover {
        background: #02a84a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(3, 199, 90, 0.3);
      }

      .auth-buttons {
        display: flex;
        align-items: center;
        gap: 0;
      }
      .auth-user {
        display: none;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        border-radius: 8px;
        background: var(--primary-green);
        color: var(--primary-white);
      }
      .auth-user__avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary-white);
        color: var(--primary-green);
        font-weight: 800;
        display: flex;
        align-items: center;
        justify-content: center;
        letter-spacing: -0.02em;
        text-transform: uppercase;
      }
      .auth-user__meta {
        display: flex;
        flex-direction: column;
        line-height: 1.3;
      }
      .auth-user__label {
        font-size: 11px;
        font-weight: 600;
        color: var(--primary-white);
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }
      .auth-user__email {
        font-size: 14px;
        font-weight: 600;
        color: var(--primary-white);
      }
      .auth-user__logout {
        height: 36px;
        padding: 0 16px;
        border-radius: 6px;
        border: 1px solid rgba(255,255,255,0.3);
        background: transparent;
        color: var(--primary-white);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .auth-user__logout:hover {
        background: rgba(255,255,255,0.1);
      }
      .auth-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 50px;
        padding: 0 32px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 16px;
        gap: 8px;
        border: none;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .auth-btn--primary {
        background: var(--primary-green);
        color: var(--primary-white);
      }
      .auth-btn--primary:hover {
        background: #02a84a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(3, 199, 90, 0.3);
      }
      .auth-btn--ghost {
        display: none;
      }
      @media (max-width: 768px) {
        .auth-user {
          padding: 4px 8px;
          gap: 6px;
        }
        .auth-user__avatar {
          width: 24px;
          height: 24px;
          font-size: 10px;
        }
        .auth-user__label {
          font-size: 8px;
          white-space: nowrap;
        }
        .auth-user__email {
          font-size: 9px;
          white-space: nowrap;
        }
        .auth-user__logout {
          height: 24px;
          padding: 0 8px;
          font-size: 9px;
        }
        .auth-btn {
          height: 28px;
          padding: 0 12px;
          font-size: 11px;
        }
        .home-btn {
          height: 28px;
          padding: 0 12px;
          font-size: 11px;
        }
      }

      /* Hide old nav elements */
      .nav-container, .nav-menu, .top-nav, .user-actions {
        display: none !important;
      }

      .old-nav-container {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px 20px;
        gap: 20px;
      }

      .top-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        position: relative;
      }

      .logo {
        font-size: 32px;
        font-weight: 800;
        color: #111827;
        cursor: pointer;
        transition: all 0.3s ease;
        letter-spacing: -1px;
      }

      .logo:hover {
        transform: scale(1.05);
        color: var(--naver-green);
      }

      .nav-menu {
        display: flex;
        list-style: none;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
        position: relative;
      }

      .nav-menu li {
        position: relative;
      }

      .nav-menu a {
        text-decoration: none;
        color: #333;
        font-weight: 600;
        font-size: 15px;
        transition: all 0.3s ease;
        padding: 12px 18px;
        display: block;
        border-radius: 8px;
        position: relative;
      }

      .nav-menu a:hover {
        color: var(--naver-green);
        background: var(--naver-green-50);
        transform: translateY(-1px);
      }

      .nav-menu a.active {
        color: white;
        background: var(--naver-green);
        font-weight: 700;
        box-shadow: 0 3px 10px rgba(3, 199, 90, 0.25);
      }

      .user-actions {
        display: flex;
        gap: 15px;
        align-items: center;
        position: absolute;
        right: 0;
      }

      .login-btn,
      .signup-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .login-btn {
        background: var(--naver-green);
        color: white;
        box-shadow: 0 3px 10px rgba(3, 199, 90, 0.25);
      }

      .signup-btn {
        background: transparent;
        color: var(--naver-green);
        border: 2px solid var(--naver-green);
      }

      .login-btn:hover,
      .signup-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(3, 199, 90, 0.35);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 50px 20px;
      }
      @media (max-width: 768px) {
        body {
          padding-top: 60px;
        }
      }

      .page-header {
        text-align: center;
        margin-bottom: 50px;
        color: #2c3e50;
      }

      .page-header h1 {
        font-size: 2.8rem;
        margin-bottom: 15px;
        font-weight: 700;
        letter-spacing: -1px;
      }

      .page-header p {
        font-size: 1.1rem;
        color: #7f8c8d;
        font-weight: 400;
      }

      .review-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .review-header {
        display: none;
      }

      .review-content {
        padding: 40px;
      }

      .form-group {
        margin-bottom: 30px;
      }

      .form-group label {
        display: block;
        margin-bottom: 12px;
        color: #374151;
        font-weight: 600;
        font-size: 16px;
      }

      .form-group label i {
        margin-right: 8px;
        color: var(--naver-green);
      }

      .input-field,
      .form-group input[type="text"] {
        width: 100%;
        padding: 15px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 15px;
        transition: all 0.3s ease;
        font-family: inherit;
        -webkit-appearance: none;
        appearance: none;
      }

      .textarea-field,
      .form-group textarea {
        width: 100%;
        padding: 15px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 15px;
        transition: all 0.3s ease;
        font-family: inherit;
        resize: vertical;
        min-height: 180px;
        line-height: 1.6;
        -webkit-appearance: none;
        appearance: none;
      }

      .textarea-field.owner-tips {
        min-height: 90px;
      }

      .input-field:focus,
      .textarea-field:focus,
      .form-group input[type="text"]:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--naver-green);
        box-shadow: 0 0 0 3px rgba(3, 199, 90, 0.15);
      }

      .button-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 30px;
      }

      .btn {
        padding: 15px 30px;
        border: 2px solid var(--primary-green);
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 15px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        white-space: nowrap;
        background: var(--primary-white);
        color: var(--primary-green);
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(3, 199, 90, 0.2);
        background: var(--primary-green);
        color: var(--primary-white);
      }

      .btn:active {
        transform: translateY(0);
        box-shadow: 0 3px 10px rgba(3, 199, 90, 0.2);
      }

      .btn.primary {
        background: var(--primary-green);
        color: var(--primary-white);
        border-color: var(--primary-green);
      }

      .btn.primary:hover {
        box-shadow: 0 6px 20px rgba(3, 199, 90, 0.35);
        background: var(--primary-white);
        color: var(--primary-green);
      }

      .btn.primary:active {
        box-shadow: 0 3px 10px rgba(3, 199, 90, 0.25);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .result-section {
        background: #f8fafc;
        padding: 30px;
        border-radius: 15px;
        border: 1px solid #e2e8f0;
        min-height: 200px;
      }

      .result-section h3 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .result-content {
        background: white;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        white-space: pre-wrap;
        line-height: 1.8;
        color: #374151;
        font-size: 15px;
      }

      .result-content:empty::before {
        content: "생성된 답글이 여기에 표시됩니다...";
        color: #9ca3af;
        font-style: italic;
      }

      .result-content.error {
        background: #fff1f2;
        border-color: #fecaca;
        color: #991b1b;
      }

      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid var(--naver-green);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }

      /* 홍보 포인트 태그 스타일 */
      .promo-tag {
        display: inline-block;
        padding: 8px 16px;
        background: white;
        border: 2px solid #ddd;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
      }

      .promo-tag:hover {
        border-color: #2196F3;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
      }

      .promo-tag.selected {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        color: white;
        border-color: #2196F3;
        font-weight: 600;
      }

      .place-info-status {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        border: 2px solid #81c784;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: #2e7d32;
        font-weight: 600;
        font-size: 15px;
        animation: fadeIn 0.3s ease-in-out;
      }

      .place-info-status i {
        font-size: 20px;
        color: #43a047;
      }

      .place-info-status.loading {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        border-color: #ffb74d;
        color: #e65100;
      }

      .place-info-status.loading i {
        color: #fb8c00;
        animation: spin 1s linear infinite;
      }

      .place-info-status.loading #placeInfoText::after {
        content: '';
        animation: dots 1.5s steps(4, end) infinite;
      }

      @keyframes dots {
        0%, 20% { content: ''; }
        40% { content: '.'; }
        60% { content: '..'; }
        80%, 100% { content: '...'; }
      }

      .place-info-status.warning {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        border-color: #ff9800;
        color: #e65100;
      }

      .place-info-status.warning i {
        color: #f57c00;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .info-box {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
      }

      .info-box h4 {
        color: #1976d2;
        margin-bottom: 12px;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .info-box ul {
        color: #1565c0;
        font-size: 14px;
        line-height: 1.8;
        margin-left: 20px;
      }

      @media (max-width: 768px) {
        .top-nav {
          flex-direction: column;
          gap: 10px;
        }
        .user-actions {
          position: static;
          right: auto;
          width: 100%;
          display: flex;
          justify-content: center;
          gap: 8px;
          flex-wrap: wrap;
        }
        .nav-menu {
          justify-content: flex-start;
          overflow-x: auto;
          white-space: nowrap;
          padding: 5px 0;
          scrollbar-width: none;
          -ms-overflow-style: none;
        }

        .nav-menu::-webkit-scrollbar {
          display: none;
        }

        .nav-menu li {
          flex-shrink: 0;
        }

        .nav-menu a {
          font-size: 12px;
          padding: 8px 12px;
          white-space: nowrap;
        }

        .page-header h1 {
          font-size: 1.5rem;
          margin-bottom: 6px;
        }
        .page-header p {
          font-size: 0.9rem;
        }
        .page-header {
          margin-bottom: 16px;
          margin-top: 5px;
        }
        .container[style*="margin-top"] {
          margin-top: 20px !important;
        }
        input[type="text"], textarea {
          font-size: 0.77rem !important;
          padding: 10px !important;
        }
        button {
          font-size: 11px;
          padding: 9px 14px;
        }
        label {
          font-size: 0.9rem;
        }
        p, small, .form-group label {
          font-size: 0.88rem;
        }

        .review-header h2 {
          font-size: 1.44rem;
        }

        .review-header p {
          font-size: 0.9rem;
        }

        .review-container h3 {
          font-size: 0.95rem;
        }

        .place-info-status {
          font-size: 0.8rem;
        }

        .result-section h3 {
          font-size: 0.95rem;
        }

        .review-content {
          padding: 20px 15px;
        }

        .form-group {
          margin-bottom: 25px;
        }

        .form-group label {
          font-size: 16px;
          margin-bottom: 10px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .form-group label i {
          font-size: 18px;
        }

        .input-field,
        .textarea-field,
        .form-group input[type="text"],
        .form-group textarea {
          font-size: 16px !important; /* iOS 줌 방지 */
          padding: 14px 16px;
          border-width: 2px;
          border-radius: 10px;
        }

        .textarea-field,
        .form-group textarea {
          min-height: 140px;
        }

        .textarea-field.owner-tips {
          min-height: 110px;
        }

        .form-group small {
          font-size: 13px;
          line-height: 1.5;
          margin-top: 10px;
        }

        .button-group {
          flex-direction: column;
          gap: 12px;
        }

        .btn {
          width: 100%;
          justify-content: center;
          padding: 10px 16px;
          font-size: 11px;
          min-height: 40px;
          border-radius: 10px;
          gap: 4px;
        }

        .btn i {
          font-size: 13px;
        }

        .place-info-status {
          font-size: 14px;
          padding: 14px 16px;
          flex-wrap: wrap;
        }

        .place-info-status i {
          font-size: 18px;
        }

        .result-section h3 {
          font-size: 1.2rem;
          margin-bottom: 15px;
        }

        .result-content {
          font-size: 15px;
          padding: 20px 16px;
          line-height: 1.7;
        }

        .info-box {
          padding: 16px;
          margin-top: 25px;
        }

        .info-box h4 {
          font-size: 1rem;
          margin-bottom: 10px;
        }

        .info-box ul {
          font-size: 13px;
          line-height: 1.7;
        }

        .info-box li {
          margin-bottom: 10px;
        }

        .container {
          padding: 30px 15px;
        }

        .review-container {
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
      }

      /* 추가: 아주 작은 화면 (360px 이하) */
      @media (max-width: 360px) {
        .page-header h1 {
          font-size: 1.8rem;
        }

        .review-header h2 {
          font-size: 1.4rem;
        }

        .form-group label {
          font-size: 15px;
        }

        .btn {
          padding: 9px 16px;
          font-size: 10px;
          min-height: 38px;
        }

        .container {
          padding: 20px 10px;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-inner">
        <a href="/" class="logo-container">
          <div class="logo-icon">
            <i class="fa-solid fa-thumbtack"></i>
          </div>
          <span class="logo-text">sajang pick</span>
        </a>
        
        <h1 class="header-slogan">센스있는 사장님들의 선택</h1>
        
        <div class="header-auth">
          <a href="/" class="home-btn">
            <i class="fa-solid fa-home"></i>
            <span>홈</span>
          </a>
          <div class="auth-buttons" id="authButtons">
            <div class="auth-user" id="authUser" style="display: none;">
              <div class="auth-user__avatar" id="userAvatar">U</div>
              <div class="auth-user__meta">
                <a href="/mypage.html" class="auth-user__label" style="cursor: pointer; text-decoration: none;">나의 페이지</a>
                <a href="/mypage.html" class="auth-user__email" id="userEmail" style="cursor: pointer; text-decoration: none;"></a>
              </div>
              <button class="auth-user__logout" id="logoutBtn" type="button">
                <i class="fa-solid fa-right-from-bracket"></i>
                로그아웃
              </button>
            </div>
            <a href="/login.html" class="auth-btn auth-btn--primary" id="loginBtn">
              <i class="fa-solid fa-arrow-right-to-bracket"></i>
              <span>로그인</span>
            </a>
            <a href="/join.html" class="auth-btn auth-btn--ghost" id="signupBtn">
              <i class="fa-solid fa-user-plus"></i>
              <span>회원가입</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <div class="container" style="margin-top: 80px;">
      <div class="page-header">
        <h1>AI 리뷰 관리</h1>
        <p>고객 리뷰를 분석하고 전문적인 답글을 자동으로 생성합니다</p>
      </div>

      <div class="review-container">
        <div class="review-header">
          <h2>🎯 리뷰 분석 & 답글 생성</h2>
          <p>고객의 리뷰를 입력하면 AI가 자동으로 분석하고 답글을 작성해드립니다</p>
        </div>

        <div class="review-content">
          <!-- 가게 정보 저장/불러오기 안내 -->
          <div style="background: var(--primary-white); border: 2px solid var(--primary-green); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <p style="margin: 0; color: var(--primary-green); font-size: 14px; margin-bottom: 10px;">
              💡 <strong>알림:</strong> 가게 정보를 한 번 저장하면 다음부터 자동으로 불러와집니다!
            </p>
            <div style="display: flex; gap: 10px;">
              <button type="button" id="loadStoreInfoBtn" class="btn" style="flex: 1; background: var(--primary-green); color: var(--primary-white); border: 2px solid var(--primary-green);">
                📥 저장된 정보 불러오기
              </button>
              <button type="button" id="saveStoreInfoBtn" class="btn" style="flex: 1; background: var(--primary-white); color: var(--primary-green); border: 2px solid var(--primary-green);">
                📌 가게 정보 저장하기
              </button>
            </div>
          </div>

          <!-- 네이버 플레이스 URL 입력 -->
          <div class="form-group">
            <label for="placeUrl">
              <i class="fa-solid fa-map-location-dot"></i>
              네이버 플레이스 URL (선택사항)
            </label>
            <input
              type="text"
              id="placeUrl"
              class="input-field"
              placeholder="네이버 플레이스 URL 또는 place_id 입력 (예: https://m.place.naver.com/restaurant/1390003666)"
            />
            <small style="color: #6b7280; display: block; margin-top: 8px;">
              <i class="fa-solid fa-info-circle"></i>
              플레이스 URL을 입력하면 식당 정보를 자동으로 분석하여 더욱 정확한 답글을 생성합니다.
            </small>
          </div>

          <!-- 사장님 추천 정보 입력 -->
          <div class="form-group">
            <label for="ownerTips">
              <i class="fa-solid fa-lightbulb"></i>
              사장님 추천 포인트 (선택사항)
            </label>
            <textarea
              id="ownerTips"
              class="textarea-field owner-tips"
              placeholder="강조하고 싶은 메뉴, 분위기, 특징 등을 자유롭게 작성해주세요.&#10;&#10;예시:&#10;- 시그니처 메뉴: 냉면, 갈비탕&#10;- 분위기: 가족 모임에 좋은 넓은 홀&#10;- 특징: 직접 만든 육수, 주차 가능&#10;- 추천: 고기와 냉면의 조합이 일품"
            ></textarea>
            <button type="button" id="aiPromoBtn" class="btn" style="margin-top: 10px; background: var(--primary-green); color: var(--primary-white); border: 2px solid var(--primary-green);">
              <i class="fa-solid fa-magic"></i>
              🤖 AI 홍보 포인트 자동 추천
            </button>
            <small style="color: #6b7280; display: block; margin-top: 8px;">
              <i class="fa-solid fa-star" style="color: #fbbf24;"></i>
              <strong>💡 Tip:</strong> AI가 리뷰를 분석해서 답글에 추가하면 좋을 홍보 포인트를 추천해드립니다!
            </small>

            <!-- AI 추천 홍보 포인트 영역 -->
            <div id="aiPromoArea" style="display: none; margin-top: 15px;">
              <div style="background: var(--primary-white); border: 2px solid var(--primary-green); border-radius: 10px; padding: 15px;">
                <p style="margin: 0 0 10px 0; color: var(--primary-green); font-weight: 600;">
                  🎯 AI 추천 홍보 포인트 (클릭해서 선택/해제)
                </p>
                <div id="aiPromoTags" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
              </div>
            </div>
          </div>

          <!-- 리뷰 원문 입력 -->
          <div class="form-group">
            <label for="reviewText">
              <i class="fa-solid fa-message"></i>
              고객 리뷰 원문
            </label>
            <textarea
              id="reviewText"
              placeholder="고객이 작성한 리뷰 내용을 입력하세요...&#10;&#10;예시:&#10;음식이 정말 맛있었어요! 특히 불고기가 일품이었습니다. 다만 대기 시간이 좀 길었던 게 아쉬워요. 직원분들은 친절하셨습니다."
            ></textarea>
          </div>

          <!-- 답글 스타일 선택 안내 -->
          <div style="background: var(--primary-white); border: 2px solid var(--primary-green); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <p style="margin: 0 0 10px 0; color: var(--primary-green); font-weight: 600;">
              <i class="fa-solid fa-palette"></i> 답글 스타일을 선택하세요 (잠재 고객에게 보이는 홍보 효과를 고려)
            </p>
            <p style="margin: 0; color: var(--primary-green); font-size: 14px; opacity: 0.8;">
              💡 리뷰 답글은 처음 방문을 고려하는 다른 사람들이 읽습니다!
            </p>
          </div>

          <div class="button-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <button class="btn" id="replyPromoBtn" style="background: var(--primary-green); color: var(--primary-white); border: 2px solid var(--primary-green);">
              <i class="fa-solid fa-bullhorn"></i>
              📢 홍보형 (추천!)
            </button>
            <button class="btn" id="replyProfessionalBtn" style="background: var(--primary-white); color: var(--primary-green); border: 2px solid var(--primary-green);">
              <i class="fa-solid fa-award"></i>
              💼 전문가형
            </button>
            <button class="btn" id="replyFriendlyBtn" style="background: var(--primary-white); color: var(--primary-green); border: 2px solid var(--primary-green);">
              <i class="fa-solid fa-heart"></i>
              💚 친근형
            </button>
          </div>

          <div style="background: var(--primary-white); border: 2px solid var(--primary-green); border-radius: 8px; padding: 12px; margin-top: 15px;">
            <p style="margin: 0; color: var(--primary-green); font-size: 13px; line-height: 1.6;">
              <strong>📢 홍보형:</strong> 다른 메뉴, 주차, 예약 등 추가 정보를 적극 언급 (방문 유도 최대화)<br>
              <strong>💼 전문가형:</strong> 재료, 조리법 설명으로 전문성과 신뢰감 강조<br>
              <strong>💚 친근형:</strong> 따뜻하고 부드러운 톤으로 단골 고객 만들기
            </p>
          </div>

          <!-- 식당 정보 상태 표시 영역 -->
          <div id="placeInfoStatus" class="place-info-status hidden">
            <i class="fa-solid fa-check-circle"></i>
            <span id="placeInfoText">식당 정보를 분석하고 있습니다...</span>
          </div>

          <div class="result-section">
            <h3>
              <i class="fa-solid fa-comment-dots"></i>
              생성된 답글
            </h3>
            <div id="reviewOutput" class="result-content"></div>
          </div>

          <div class="info-box">
            <h4>
              <i class="fa-solid fa-info-circle"></i>
              기능 안내
            </h4>
            <ul>
              <li>
                <strong>네이버 플레이스 URL (선택):</strong> 식당의 플레이스 URL을 입력하면, 
                식당 이름, 업종, 위치, 메뉴 등을 자동으로 파악하여 더욱 맞춤화된 답글을 생성합니다.
              </li>
              <li>
                <strong>🌟 사장님 추천 포인트 (선택):</strong> 강조하고 싶은 메뉴, 분위기, 특징을 직접 입력하면
                AI가 이를 우선 반영하여 답글을 작성합니다. 크롤링 정보보다 사장님의 의견이 우선됩니다!
              </li>
              <li>
                <strong>✨ 답글 생성하기:</strong> 식당 정보와 사장님 추천 정보를 반영하여 전문적이고
                공손한 답글을 자동으로 작성합니다. 새로운 고객들이 보는 답글이므로 자연스러운 홍보 효과도 있습니다!
              </li>
              <li>
                💡 <strong>Tip:</strong> 리뷰에서 고객이 궁금해하는 다른 메뉴가 있다면, 
                AI가 식당 정보를 바탕으로 자동으로 추천해드립니다.
              </li>
              <li>생성된 답글은 자유롭게 수정하여 사용하실 수 있습니다.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" integrity="sha384-GFr3yTh5lJznCbZfpTtXnwboFsxqtTQoeTZCRHhE0579KrRmlCzen5AA8ohaB5ug" crossorigin="anonymous"></script>
    <script src="/assets/auth-state.js?v=202410" defer></script>
    <script>
      // 백엔드 서버 설정: 상대 경로(`/api`) 사용
      console.log("Using backend URL:", "/api");

      // DOM 요소
      const placeUrl = document.getElementById("placeUrl");
      const ownerTips = document.getElementById("ownerTips");
      const reviewText = document.getElementById("reviewText");
      const replyPromoBtn = document.getElementById("replyPromoBtn");
      const replyProfessionalBtn = document.getElementById("replyProfessionalBtn");
      const replyFriendlyBtn = document.getElementById("replyFriendlyBtn");
      const reviewOutput = document.getElementById("reviewOutput");
      const placeInfoStatus = document.getElementById("placeInfoStatus");
      const placeInfoText = document.getElementById("placeInfoText");
      const loadStoreInfoBtn = document.getElementById("loadStoreInfoBtn");
      const saveStoreInfoBtn = document.getElementById("saveStoreInfoBtn");
      const aiPromoBtn = document.getElementById("aiPromoBtn");
      const aiPromoArea = document.getElementById("aiPromoArea");
      const aiPromoTags = document.getElementById("aiPromoTags");

      // 크롤링된 식당 정보를 저장할 변수
      let placeInfo = null;
      
      // 선택된 홍보 포인트를 저장할 변수
      let selectedPromoPoints = [];

      // 프로모션 데이터 전역 변수
      let globalPromotionData = null;
      let globalHasPromotion = false;

      // 공통 유틸리티 함수
      function setLoading(el, isLoading, textWhenLoading = "처리 중...") {
        if (!el) return;
        el.dataset._originalText = el.dataset._originalText || el.textContent;
        el.disabled = !!isLoading;
        if (isLoading) {
          el.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${textWhenLoading}`;
        } else {
          el.textContent = el.dataset._originalText;
        }
      }

      // 식당 정보 상태 표시 함수
      function showPlaceInfoStatus(message, status = "success") {
        // status: "loading", "success", "warning"
        placeInfoStatus.classList.remove("hidden", "loading", "warning");
        placeInfoText.textContent = message;
        
        const icon = placeInfoStatus.querySelector("i");
        
        if (status === "loading") {
          placeInfoStatus.classList.add("loading");
          icon.className = "fa-solid fa-spinner fa-spin";
        } else if (status === "warning") {
          placeInfoStatus.classList.add("warning");
          icon.className = "fa-solid fa-exclamation-triangle";
        } else {
          icon.className = "fa-solid fa-check-circle";
        }
      }

      function hidePlaceInfoStatus() {
        placeInfoStatus.classList.add("hidden");
      }

      // URL에서 place_id 추출 함수
      function extractPlaceId(url) {
        // URL 형식: https://m.place.naver.com/restaurant/1390003666
        //          https://pcmap.place.naver.com/restaurant/1390003666
        //          https://place.map.naver.com/restaurant/1390003666
        const match = url.match(/\/restaurant\/(\d+)/);
        if (match && match[1]) {
          return match[1];
        }
        
        // 숫자만 입력한 경우
        if (/^\d+$/.test(url.trim())) {
          return url.trim();
        }
        
        return null;
      }

      // 플레이스 URL 크롤링 함수
      async function crawlPlaceUrl(url) {
        try {
          // URL에서 place_id 추출
          const placeId = extractPlaceId(url);
          
          if (!placeId) {
            throw new Error("올바른 네이버 플레이스 URL이 아닙니다. URL을 확인해주세요.");
          }

          // 타임아웃 설정 (15초)
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);

          try {
            const res = await fetch(`/api/place-detail-crawl`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ place_id: placeId }),
              signal: controller.signal
            });

            clearTimeout(timeoutId);

            const data = await readJsonSafely(res);

            if (!res.ok || data.success === false) {
              throw new Error(data.error || "크롤링 실패");
            }

            return data.data || data;
          } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name === 'AbortError') {
              throw new Error("크롤링 시간이 초과되었습니다. URL 없이 진행합니다.");
            }
            throw fetchError;
          }
        } catch (e) {
          console.error("크롤링 오류:", e);
          throw e;
        }
      }

      async function readJsonSafely(res) {
        const contentType = res.headers.get("content-type") || "";
        if (contentType.includes("application/json")) {
          try {
            return await res.json();
          } catch (_) {
            return { error: "JSON 파싱 실패", status: res.status };
          }
        }
        try {
          const text = await res.text();
          return text
            ? { error: text, status: res.status }
            : { status: res.status };
        } catch (_) {
          return { error: "응답 본문을 읽을 수 없습니다.", status: res.status };
        }
      }

      function showOutput(data) {
        reviewOutput.classList.remove("error");
        try {
          if (typeof data === "string") {
            reviewOutput.textContent = data.trim();
          } else {
            reviewOutput.textContent = JSON.stringify(data, null, 2);
          }
        } catch (e) {
          reviewOutput.textContent = String(data);
        }
      }

      function showError(err) {
        reviewOutput.classList.add("error");
        
        // 에러 상세 정보를 콘솔에 출력
        console.error("상세 에러 정보:", err);
        
        let errorMessage = "오류가 발생했습니다.";
        
        // 다양한 에러 형식에서 메시지 추출
        if (err?.error) {
          errorMessage = err.error;
        } else if (err?.message) {
          errorMessage = err.message;
        } else if (err?.raw) {
          errorMessage = err.raw;
        } else if (err?.errorText) {
          errorMessage = err.errorText;
        } else if (typeof err === 'string') {
          errorMessage = err;
        }
        
        // TypeError: Failed to fetch 등의 네트워크 에러 처리
        if (errorMessage.includes("Failed to fetch") || errorMessage.includes("NetworkError")) {
          errorMessage = "서버에 연결할 수 없습니다. 서버가 실행 중인지 확인해주세요.";
        }
        
        reviewOutput.textContent = errorMessage;
      }

      // 가게 정보 저장 기능
      async function saveStoreInfo() {
        try {
          const userData = JSON.parse(localStorage.getItem('userData') || '{}');
          if (!userData.id) {
            alert('로그인이 필요합니다.');
            return;
          }

          const storeInfo = {
            placeUrl: placeUrl.value.trim(),
            companyName: '', // review.html에는 업체명 필드가 없으므로 빈 값
            companyAddress: '',
            businessHours: '',
            phoneNumber: '',
            mainMenu: '',
            landmarks: '',
            keywords: ownerTips.value.trim() // 사장님 추천 포인트를 keywords로 저장
          };

          const response = await fetch('/api/store-info', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: userData.id, storeInfo })
          });

          if (!response.ok) {
            throw new Error('저장 실패');
          }

          const result = await response.json();
          if (result.success) {
            alert('✅ 가게 정보가 저장되었습니다!');
          } else {
            throw new Error(result.error || '저장 실패');
          }
        } catch (error) {
          console.error('가게 정보 저장 오류:', error);
          alert('❌ 가게 정보 저장에 실패했습니다.\n' + error.message);
        }
      }

      // 가게 정보 불러오기 기능
      async function loadStoreInfo() {
        try {
          const userData = JSON.parse(localStorage.getItem('userData') || '{}');
          if (!userData.id) {
            alert('로그인이 필요합니다.');
            return;
          }

          // 통합 정보 API 호출
          const response = await fetch(`/api/store-info-all?userId=${userData.id}`);
          if (!response.ok) {
            throw new Error('조회 실패');
          }

          const result = await response.json();
          if (!result.success || !result.data) {
            alert('저장된 가게 정보가 없습니다.');
            return;
          }

          const data = result.data.basic; // 기본 정보
          if (data.store_place_url) placeUrl.value = data.store_place_url;
          if (data.store_keywords) ownerTips.value = data.store_keywords;

          // 프로모션 정보 저장
          globalPromotionData = result.data.promotion;
          globalHasPromotion = result.hasPromotion;

          // 프로모션 알림
          let message = '✅ 저장된 가게 정보를 불러왔습니다!';
          if (globalHasPromotion && globalPromotionData) {
            message += `\n\n🎉 내 가게 알리기 정보도 자동 적용됩니다!\n작성 항목: ${result.filledCount} / ${result.totalCount}`;
          }

          alert(message);
        } catch (error) {
          console.error('가게 정보 불러오기 오류:', error);
          alert('❌ 가게 정보 불러오기에 실패했습니다.\n' + error.message);
        }
      }

      // 가게 정보 저장 버튼
      saveStoreInfoBtn.addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = '저장 중...';
        try {
          await saveStoreInfo();
        } finally {
          this.disabled = false;
          this.textContent = '📌 가게 정보 저장하기';
        }
      });

      // 가게 정보 불러오기 버튼
      loadStoreInfoBtn.addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = '불러오는 중...';
        try {
          await loadStoreInfo();
        } finally {
          this.disabled = false;
          this.textContent = '📥 저장된 정보 불러오기';
        }
      });

      // AI 홍보 포인트 추천 버튼
      aiPromoBtn.addEventListener('click', async function() {
        const review = reviewText.value.trim();
        if (!review) {
          alert('리뷰 원문을 먼저 입력해주세요.');
          return;
        }

        this.disabled = true;
        this.textContent = '🤖 AI 분석 중...';

        try {
          // 플레이스 정보가 없으면 먼저 크롤링 시도
          const url = placeUrl.value.trim();
          if (url && !placeInfo) {
            try {
              placeInfo = await crawlPlaceUrl(url);
            } catch (e) {
              console.warn('크롤링 실패, 계속 진행:', e);
            }
          }

          const response = await fetch('/api/generate-reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              reviewText: review,
              placeInfo: placeInfo,
              ownerTips: ownerTips.value.trim(),
              action: 'recommend-promo-points'
            })
          });

          if (!response.ok) {
            throw new Error('홍보 포인트 추천 실패');
          }

          const result = await response.json();
          const promoPoints = result.data?.promoPoints || [];

          if (promoPoints.length === 0) {
            throw new Error('추천된 홍보 포인트가 없습니다');
          }

          // 홍보 포인트 태그 생성
          aiPromoTags.innerHTML = '';
          promoPoints.forEach(point => {
            const tag = document.createElement('span');
            tag.className = 'promo-tag';
            tag.textContent = point;
            tag.dataset.point = point;
            
            tag.addEventListener('click', function() {
              this.classList.toggle('selected');
              updateSelectedPromoPoints();
            });

            aiPromoTags.appendChild(tag);
          });

          aiPromoArea.style.display = 'block';
          alert('✅ AI가 홍보 포인트를 추천했습니다! 원하는 항목을 선택하세요.');

        } catch (error) {
          console.error('홍보 포인트 추천 오류:', error);
          alert('❌ 홍보 포인트 추천에 실패했습니다.\n' + error.message);
        } finally {
          this.disabled = false;
          this.textContent = '🤖 AI 홍보 포인트 자동 추천';
        }
      });

      // 선택된 홍보 포인트 업데이트
      function updateSelectedPromoPoints() {
        const selectedTags = aiPromoTags.querySelectorAll('.promo-tag.selected');
        selectedPromoPoints = Array.from(selectedTags).map(tag => tag.dataset.point);
        console.log('선택된 홍보 포인트:', selectedPromoPoints);
      }

      // 답글 생성 공통 함수 (스타일별)
      async function generateReply(style, buttonElement) {
        const text = reviewText.value.trim();
        const url = placeUrl.value.trim();
        const tips = ownerTips.value.trim();

        if (!text) {
          showError({ message: "리뷰 원문을 입력하세요." });
          return;
        }

        setLoading(buttonElement, true, "생성 중...");
        reviewOutput.textContent = "";
        hidePlaceInfoStatus();

        try {
          // 1단계: URL이 있고 아직 크롤링 안했으면 먼저 크롤링
          if (url && !placeInfo) {
            showPlaceInfoStatus("🔍 식당 정보 수집 중 (약 10~15초 소요)", "loading");
            try {
              placeInfo = await crawlPlaceUrl(url);
              showPlaceInfoStatus("✅ 식당 정보 수집 완료! 답글 생성 중", "success");
            } catch (crawlError) {
              console.error("크롤링 실패:", crawlError);
              if (crawlError.message.includes("시간이 초과")) {
                showPlaceInfoStatus("⏱️ 시간 초과! 입력하신 정보로 답글 생성 중", "warning");
              } else {
                showPlaceInfoStatus("⚠️ 식당 정보를 가져올 수 없습니다. 입력하신 정보로 답글 생성 중", "warning");
              }
              placeInfo = null;
            }
          } else if (!url && !placeInfo) {
            showPlaceInfoStatus("💭 답글 생성 중", "loading");
          }

          // 2단계: 답글 생성 (스타일 포함)
          const requestBody = {
            reviewText: text,
            replyStyle: style // 'promo', 'professional', 'friendly'
          };

          if (placeInfo) {
            requestBody.placeInfo = placeInfo;
          }

          if (tips) {
            requestBody.ownerTips = tips;
          }

          // 선택된 홍보 포인트가 있으면 함께 전달
          if (selectedPromoPoints.length > 0) {
            requestBody.selectedPromoPoints = selectedPromoPoints;
          }

          // 프로모션 정보 추가
          if (globalHasPromotion && globalPromotionData) {
            requestBody.promotionData = globalPromotionData;
            requestBody.hasPromotion = true;
          }

          const replyController = new AbortController();
          const replyTimeoutId = setTimeout(() => replyController.abort(), 15000);
          
          let res;
          try {
            res = await fetch(`/api/generate-reply`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(requestBody),
              signal: replyController.signal
            });
            clearTimeout(replyTimeoutId);
          } catch (fetchError) {
            clearTimeout(replyTimeoutId);
            
            if (fetchError.name === 'AbortError') {
              throw new Error("답글 생성 시간이 초과되었습니다. 잠시 후 다시 시도해주세요.");
            }
            
            throw new Error("서버에 연결할 수 없습니다. 서버가 실행 중인지 확인해주세요.");
          }

          const data = await readJsonSafely(res);

          if (!res.ok || data.success === false) {
            if (res.status === 405) {
              throw new Error("서버가 실행되지 않았습니다.");
            } else if (res.status === 500) {
              throw new Error(data.error || "서버 내부 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
            } else if (res.status === 400) {
              throw new Error(data.error || "입력 데이터가 올바르지 않습니다.");
            } else {
              throw new Error(data.error || data.message || `서버 오류 (${res.status})`);
            }
          }

          showOutput(data.data?.reply || data.reply || data);
          
          // 성공 메시지 표시
          const styleNames = {
            'promo': '홍보형',
            'professional': '전문가형',
            'friendly': '친근형'
          };
          const styleName = styleNames[style] || style;
          
          let successMessage = `✅ ${styleName} 답글이 생성되었습니다!`;
          if (selectedPromoPoints.length > 0) {
            successMessage += ` (홍보 포인트 ${selectedPromoPoints.length}개 반영)`;
          }
          
          showPlaceInfoStatus(successMessage, "success");
          setTimeout(() => hidePlaceInfoStatus(), 5000);
          
        } catch (e) {
          console.error("답글 생성 오류:", e);
          showError(e);
          hidePlaceInfoStatus();
        } finally {
          setLoading(buttonElement, false);
        }
      }

      // 3개의 답글 스타일 버튼 이벤트
      replyPromoBtn.addEventListener("click", async () => {
        await generateReply('promo', replyPromoBtn);
      });

      replyProfessionalBtn.addEventListener("click", async () => {
        await generateReply('professional', replyProfessionalBtn);
      });

      replyFriendlyBtn.addEventListener("click", async () => {
        await generateReply('friendly', replyFriendlyBtn);
      });

      // 페이지 로드 시 초기화
      window.addEventListener("load", function () {
        reviewText.focus();
        ensureAuthenticated();
      });


      function buildRedirectUrl() {
        const current =
          window.location.pathname +
          window.location.search +
          window.location.hash;
        return `login.html?redirect=${encodeURIComponent(current)}`;
      }

      function redirectToLogin() {
        window.location.replace(buildRedirectUrl());
      }

      async function ensureAuthenticated() {
        // Supabase 세션 확인
        if (window.authState?.supabase) {
          try {
            const { data: { session } } = await window.authState.supabase.auth.getSession();
            if (session) {
              updateAuthUI();
              return;
            }
          } catch (error) {
            console.warn("세션 확인 실패:", error);
          }
        }
        redirectToLogin();
      }

      window.addEventListener("auth:state-changed", async () => {
        await updateAuthUI();
        const session = await (window.authState?.supabase?.auth.getSession());
        if (!session?.data?.session) {
          redirectToLogin();
        }
      });
    </script>

    <!-- 추적 및 모니터링 스크립트 -->
    <script src="/assets/analytics.js"></script>
    <script src="/assets/error-logger.js"></script>
    <script src="/assets/performance-tracker.js"></script>

    <script>
      // 로그인 상태 UI 업데이트 (Supabase 세션 기반)
      async function updateAuthUI() {
        const authUser = document.getElementById("authUser");
        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const userAvatar = document.getElementById("userAvatar");
        const userEmailSpan = document.getElementById("userEmail");
        const logoutBtn = document.getElementById("logoutBtn");

        // Supabase 세션 확인
        let session = null;
        if (window.authState?.supabase) {
          try {
            const { data } = await window.authState.supabase.auth.getSession();
            session = data?.session;
          } catch (error) {
            console.error("세션 확인 오류:", error);
          }
        }

        if (session?.user) {
          const user = session.user;

          // 로그인 버튼 숨기기
          if (loginBtn) loginBtn.style.display = "none";
          if (signupBtn) signupBtn.style.display = "none";

          // 사용자 정보 표시
          if (authUser) authUser.style.display = "flex";
          if (userEmailSpan) {
            const email = user.email || "마이페이지";
            userEmailSpan.textContent = email;
            userEmailSpan.title = `${email} (마이페이지로 이동)`;
          }
          if (userAvatar) {
            const base = user.user_metadata?.full_name || user.email || "U";
            userAvatar.textContent = (base.trim()[0] || "U").toUpperCase();
          }
          if (logoutBtn) {
            logoutBtn.style.display = "inline-flex";
            logoutBtn.onclick = async function () {
              if (!confirm("로그아웃 하시겠습니까?")) return;
              try {
                if (window.authState?.signOut) {
                  await window.authState.signOut();
                }
              } finally {
                localStorage.removeItem("isLoggedIn");
                localStorage.removeItem("userData");
                location.href = "/login.html";
              }
            };
          }
        } else {
          // 로그인하지 않은 상태
          if (authUser) authUser.style.display = "none";
          if (loginBtn) loginBtn.style.display = "inline-flex";
          if (signupBtn) signupBtn.style.display = "inline-flex";
          if (logoutBtn) logoutBtn.style.display = "none";
        }
      }

      // 페이지 로드 시 실행
      (async function() {
        while (!window.authState?.supabase) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        await updateAuthUI();
        window.addEventListener("auth:state-changed", updateAuthUI);
        if (window.authState?.syncSession) {
          window.authState.syncSession();
        }
      })();
    </script>

  </body>
</html>
