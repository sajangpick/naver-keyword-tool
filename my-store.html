<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://*.supabase.co https://naver-keyword-tool.onrender.com https://connect.facebook.net https://www.facebook.com wss://*.supabase.co http://localhost:* http://127.0.0.1:*; img-src 'self' data: https://www.facebook.com https:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://connect.facebook.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; font-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net data:; base-uri 'self'; form-action 'self'" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <title>내가게 - 사장픽</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23ff7b54'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' font-family='Arial' fill='white'%3ESP%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" integrity="sha384-GFr3yTh5lJznCbZfpTtXnwboFsxqtTQoeTZCRHhE0579KrRmlCzen5AA8ohaB5ug" crossorigin="anonymous"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
  <script src="./assets/common-header.js?v=20251029" defer></script>
  <style>
    :root {
      --accent-color: #ff7b54;
      --accent-dark: #e56548;
      --bg-color: #fff7f0;
      --text-primary: #201a17;
      --text-secondary: #7a6a60;
      --secondary: #ffe8d9;
      --white: #ffffff;
      --border: rgba(0, 0, 0, 0.08);
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", Arial, sans-serif;
      background: var(--bg-color);
      min-height: 100vh;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
      padding-left: 100px;
      flex: 1;
    }

    .page-title {
      font-size: 36px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 8px;
      text-align: center;
      letter-spacing: -0.5px;
    }

    .page-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 40px;
      text-align: center;
      font-weight: 500;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .card {
      background: var(--white);
      border-radius: 24px;
      padding: 32px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent-color);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .card-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    .card-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--accent-color);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .stat-change {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--error);
    }

    .info-grid {
      display: grid;
      gap: 16px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: var(--bg-color);
      border-radius: 12px;
    }

    .info-label {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .info-value {
      font-size: 16px;
      color: var(--text-primary);
      font-weight: 600;
      text-align: right;
      word-break: break-word;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state i {
      font-size: 64px;
      color: var(--text-secondary);
      opacity: 0.3;
      margin-bottom: 20px;
    }

    .empty-state p {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .empty-state .empty-subtitle {
      font-size: 14px;
      opacity: 0.7;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .loading i {
      font-size: 48px;
      color: var(--accent-color);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 16px;
      }

      .page-title {
        font-size: 28px;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .card {
        padding: 24px;
      }

      .stat-value {
        font-size: 28px;
      }
    }

    /* 헤더 스타일 (index.html과 동일) */
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--bg-color);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      box-shadow: none;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .header-inner {
      max-width: 100%;
      margin: 0;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      position: relative;
      box-sizing: border-box;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      font-size: 12px;
      color: var(--text-primary);
      cursor: pointer;
      flex: 0 0 auto;
      text-decoration: none;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      border-radius: 12px;
      background: var(--accent-color);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .logo-text {
      letter-spacing: -0.03em;
      text-transform: lowercase;
      font-size: 12px;
    }

    .header-slogan {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-secondary);
      margin: 0;
      white-space: nowrap;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
    }

    .header-auth {
      display: flex;
      align-items: center;
      flex: 0 0 auto;
      margin-left: auto;
    }

    .auth-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .auth-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 44px;
      padding: 0 22px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      background: #fff;
      color: var(--text-primary);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease;
      text-decoration: none;
    }

    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
    }

    .auth-btn--primary {
      background: transparent;
      color: var(--accent-color);
      border: 1px solid var(--accent-color);
    }

    .auth-btn--primary:hover {
      background: var(--accent-color);
      color: #fff;
      box-shadow: 0 8px 18px rgba(255, 126, 70, 0.3);
      transform: translateY(-1px);
    }

    .auth-btn--ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .auth-btn--ghost:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .auth-user {
      display: none;
      align-items: center;
      gap: 14px;
      padding: 10px 16px;
      border-radius: 16px;
      background: rgba(255, 123, 84, 0.12);
      color: var(--text-primary);
    }

    .auth-user__avatar {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--accent-color);
      color: #fff;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }

    .auth-user__meta {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .auth-user__label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      text-decoration: none;
    }

    .auth-user__email {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: color 0.2s ease;
      text-decoration: none;
    }

    .auth-user__email:hover {
      color: var(--accent-color);
    }

    .auth-user__logout {
      height: 36px;
      padding: 0 16px;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: #fff;
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .auth-user__logout:hover {
      background: rgba(255, 126, 70, 0.12);
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .header-inner {
        padding: 12px 16px;
        flex-wrap: wrap;
      }

      .header-slogan {
        font-size: 12px;
        position: static;
        transform: none;
        order: 3;
        width: 100%;
        text-align: center;
        margin-top: 8px;
      }

      .logo-container {
        order: 1;
        gap: 8px;
      }

      .header-auth {
        order: 2;
      }

      .auth-btn {
        height: 36px;
        padding: 0 14px;
        font-size: 12px;
      }
    }

    /* 사이드바 스타일 (index.html과 동일) */
    .side-nav {
      background: #ffe8d9;
      border-radius: 18px;
      padding: 18px 11px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: center;
      position: fixed;
      left: 20px;
      top: 120px;
      width: 66px;
      height: auto;
      max-height: calc(100vh - 160px);
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 40;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .side-nav::-webkit-scrollbar {
      display: none;
    }

    .side-nav .menu-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      padding: 9px 6px;
      color: #5a5a5a;
      text-decoration: none;
      font-weight: 500;
      font-size: 9px;
      border-radius: 11px;
      transition: all 0.3s ease;
      width: 43px;
      position: relative;
      background: transparent;
    }

    .side-nav .menu-item:hover {
      background: #ffffff;
      color: #ff7e46;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 126, 70, 0.3);
    }

    .side-nav .menu-item:hover .ico {
      color: #ff7e46;
      background: #ffffff;
    }

    .side-nav .menu-item.active {
      background: #ffffff;
      color: #ff7e46;
    }

    .side-nav .menu-item.active .ico {
      color: #ff7e46;
      background: rgba(255, 126, 70, 0.1);
    }

    .side-nav .ico {
      width: 29px;
      height: 29px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #5a5a5a;
      transition: all 0.3s ease;
    }

    /* 컨테이너 레이아웃 조정 (사이드바 공간 확보) */
    .container {
      padding-left: 100px;
    }

    @media (max-width: 992px) {
      .side-nav {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        top: auto;
        flex-direction: row;
        width: calc(100vw - 40px);
        max-width: calc(100vw - 40px);
        padding: 12px 16px;
        overflow-x: auto;
        overflow-y: hidden;
        gap: 12px;
        border-radius: 24px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        z-index: 100;
        justify-content: flex-start;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-x;
        scrollbar-width: none;
        -ms-overflow-style: none;
        scroll-snap-type: x mandatory;
        background: #ffe8d9;
      }

      .side-nav::-webkit-scrollbar {
        display: none;
      }

      .side-nav .menu-item {
        flex-direction: column;
        min-width: 60px;
        padding: 10px 8px;
        font-size: 10px;
        flex: 0 0 60px;
        flex-shrink: 0;
        scroll-snap-align: start;
      }

      .side-nav .menu-item .ico {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }

      .container {
        padding-left: 20px;
        padding-bottom: 90px;
      }
    }

    @media (max-width: 360px) {
      .side-nav {
        bottom: 12px;
        width: calc(100vw - 16px);
        max-width: calc(100vw - 16px);
        padding: 8px 12px;
        gap: 10px;
        border-radius: 18px;
        background: #ffe8d9;
      }

      .side-nav .menu-item {
        min-width: 55px;
        padding: 8px 6px;
        font-size: 9px;
        flex: 0 0 55px;
        gap: 4px;
      }

      .side-nav .menu-item .ico {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }

      .container {
        padding-bottom: 70px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="./index.html" class="logo-container">
        <div class="logo-icon">
          <i class="fa-solid fa-thumbtack"></i>
        </div>
        <span class="logo-text">sajang pick</span>
      </a>

      <h1 class="header-slogan">센스있는 사장님들의 선택</h1>

      <div class="header-auth">
        <div class="auth-buttons" id="authButtons">
          <div class="auth-user" id="authUser" style="display: none">
            <div class="auth-user__avatar" id="userAvatar">U</div>
            <div class="auth-user__meta">
              <div style="display: flex; align-items: center; gap: 8px;">
                <a
                  href="./mypage.html"
                  class="auth-user__label"
                  style="cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 6px;"
                  ><i class="fa-solid fa-door-open" style="font-size: 14px;"></i>나의 페이지</a
                >
              </div>
              <a
                href="./mypage.html"
                class="auth-user__email"
                id="userEmail"
                style="cursor: pointer; text-decoration: none"
              ></a>
            </div>
            <button class="auth-user__logout" id="logoutBtn" type="button">
              로그아웃
            </button>
          </div>
          <a
            href="./login.html"
            class="auth-btn auth-btn--primary"
            id="loginBtn"
          >
            <i class="fa-solid fa-sign-in-alt" style="margin-right: 8px"></i>
            <span>로그인</span>
          </a>
          <a
            href="./join.html"
            class="auth-btn auth-btn--ghost"
            id="signupBtn"
          >
            <i class="fa-solid fa-user-plus" style="margin-right: 8px"></i>
            <span>회원가입</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <aside class="side-nav" aria-label="사이드 네비게이션">
    <a class="menu-item" href="./index.html">
      <span class="ico"><i class="fa-solid fa-house"></i></span>
      <span>홈</span>
    </a>
    <a class="menu-item active" href="./my-store.html">
      <span class="ico"><i class="fa-solid fa-store"></i></span>
      <span>내가게</span>
    </a>
    <a class="menu-item" href="./naver_search.html">
      <span class="ico"><i class="fa-solid fa-key"></i></span>
      <span>키워드</span>
    </a>
    <a class="menu-item" href="./Blog-Editor.html">
      <span class="ico"><i class="fa-solid fa-blog"></i></span>
      <span>블로그</span>
    </a>
    <a class="menu-item" href="./policy-support.html">
      <span class="ico"><i class="fa-solid fa-coins"></i></span>
      <span>정책</span>
    </a>
    <a class="menu-item" href="./AI-Review.html">
      <span class="ico"><i class="fa-solid fa-pen-nib"></i></span>
      <span>리뷰</span>
    </a>
    <a class="menu-item" href="./ai-review-automation.html">
      <span class="ico"><i class="fab fa-neos"></i></span>
      <span>리뷰 자동</span>
    </a>
    <a class="menu-item" href="./shorts-editor.html">
      <span class="ico"><i class="fa-solid fa-film"></i></span>
      <span>영상</span>
    </a>
    <a class="menu-item" href="./sajangpick-book.html">
      <span class="ico"><i class="fa-solid fa-book-open"></i></span>
      <span>전자책</span>
    </a>
    <a class="menu-item" href="./recipe-manager.html">
      <span class="ico"><i class="fa-solid fa-utensils"></i></span>
      <span>레시피</span>
    </a>
    <a class="menu-item" href="./news-board.html">
      <span class="ico"><i class="fa-solid fa-newspaper"></i></span>
      <span>뉴스</span>
    </a>
  </aside>

  <div class="container">
    <h1 class="page-title">
      <i class="fa-solid fa-store"></i> 내가게
    </h1>
    <p class="page-subtitle">가게 정보와 매출 현황을 한눈에 확인하세요</p>

    <div id="loadingState" class="loading">
      <i class="fa-solid fa-spinner"></i>
      <p style="margin-top: 16px;">데이터를 불러오는 중...</p>
    </div>

    <div id="contentArea" style="display: none;">
      <!-- 매출 통계 카드 -->
      <div class="dashboard-grid">
        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fa-solid fa-won-sign"></i>
            </div>
            <div class="card-title">오늘 매출</div>
          </div>
          <div class="stat-value" id="todaySales">0원</div>
          <div class="stat-label">오늘의 총 매출액</div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fa-solid fa-calendar-week"></i>
            </div>
            <div class="card-title">이번 주 매출</div>
          </div>
          <div class="stat-value" id="weekSales">0원</div>
          <div class="stat-label">이번 주 총 매출액</div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fa-solid fa-calendar-alt"></i>
            </div>
            <div class="card-title">이번 달 매출</div>
          </div>
          <div class="stat-value" id="monthSales">0원</div>
          <div class="stat-label">이번 달 총 매출액</div>
        </div>
      </div>

      <!-- 가게 정보 카드 -->
      <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
          <div class="card-icon">
            <i class="fa-solid fa-store"></i>
          </div>
          <div class="card-title">가게 정보</div>
        </div>
        <div class="info-grid" id="storeInfo">
          <div class="info-item">
            <span class="info-label">가게 이름</span>
            <span class="info-value" id="storeName">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">주소</span>
            <span class="info-value" id="storeAddress">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">전화번호</span>
            <span class="info-value" id="storePhone">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">영업시간</span>
            <span class="info-value" id="storeHours">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">대표메뉴</span>
            <span class="info-value" id="storeMenu">-</span>
          </div>
        </div>
      </div>

      <!-- 매출 건수 분석 카드 -->
      <div class="card" id="salesCountCard" style="margin-bottom: 30px; display: none;">
        <div class="card-header">
          <div class="card-icon">
            <i class="fa-solid fa-chart-pie"></i>
          </div>
          <div class="card-title">매출 건수 분석</div>
        </div>
        <div style="text-align: center; padding: 20px;">
          <div style="position: relative; width: 200px; height: 200px; margin: 0 auto 30px;">
            <svg width="200" height="200" style="transform: rotate(-90deg);">
              <circle cx="100" cy="100" r="80" fill="none" stroke="#e0e0e0" stroke-width="20"></circle>
              <circle id="salesCountCircle" cx="100" cy="100" r="80" fill="none" stroke="#0066CC" stroke-width="20" 
                stroke-dasharray="0 502" stroke-linecap="round" style="transition: stroke-dasharray 1s ease;"></circle>
            </svg>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
              <div style="font-size: 36px; font-weight: 800; color: var(--text-primary);" id="totalOrders">0</div>
              <div style="font-size: 14px; color: var(--text-secondary);">총 주문</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
            <div>
              <div style="font-size: 24px; font-weight: 700; color: var(--accent-color);" id="dailyAverage">0건</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">일 평균</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="dailyMax">0건</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;" id="dailyMaxDate">일 최고</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: 700; color: var(--error);" id="dailyMin">0건</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;" id="dailyMinDate">일 최저</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 월별 매출 현황 캘린더 -->
      <div class="card" id="monthlySalesCard" style="margin-bottom: 30px; display: none;">
        <div class="card-header">
          <div class="card-icon">
            <i class="fa-solid fa-calendar-days"></i>
          </div>
          <div class="card-title" id="monthlySalesTitle">12월 매출 현황</div>
        </div>
        <div style="padding: 20px;">
          <!-- 월 누적 총 매출 -->
          <div style="background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 82, 163, 0.1)); border-radius: 12px; padding: 20px; margin-bottom: 24px; text-align: center;">
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;" id="monthlyTotalLabel">12월 누적 총 매출은</div>
            <div style="font-size: 32px; font-weight: 800; color: var(--success);" id="monthlyTotalAmount">0원</div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-top: 4px;">입니다.</div>
          </div>
          
          <div id="salesCalendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 20px;">
            <!-- 캘린더는 JavaScript로 동적 생성 -->
          </div>
          <div id="weeklyTotals" style="display: flex; flex-direction: column; gap: 12px;">
            <!-- 주별 합계는 JavaScript로 동적 생성 -->
          </div>
        </div>
      </div>

      <!-- 홈택스 연동 카드 -->
      <div class="card" style="margin-bottom: 30px;">
        <div class="card-header">
          <div class="card-icon" style="background: linear-gradient(135deg, #0066CC, #0052A3);">
            <i class="fa-solid fa-receipt"></i>
          </div>
          <div class="card-title">홈택스 매입매출조회</div>
        </div>
        <div id="hometaxStatus" style="padding: 20px;">
          <div id="hometaxNotConnected" style="text-align: center; padding: 40px 20px;">
            <i class="fa-solid fa-receipt" style="font-size: 64px; color: var(--text-secondary); opacity: 0.3; margin-bottom: 20px;"></i>
            <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 8px;">홈택스 연동이 필요합니다</p>
            <p style="font-size: 14px; color: var(--text-secondary); opacity: 0.7; margin-bottom: 24px;">
              바로빌 홈택스 API를 연동하면<br>매일 자동으로 매입매출 내역을 수집합니다
            </p>
            <button onclick="window.location.href='./mypage.html#platformConnectionSection'" 
              style="
                padding: 14px 28px;
                background: linear-gradient(135deg, #0066CC, #0052A3);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
              "
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0, 102, 204, 0.3)';"
              onmouseout="this.style.transform=''; this.style.boxShadow='';">
              <i class="fa-solid fa-plug" style="margin-right: 8px;"></i>
              홈택스 연동하기
            </button>
          </div>
          <div id="hometaxConnected" style="display: none;">
            <div style="background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 82, 163, 0.1)); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                <i class="fa-solid fa-check-circle" style="font-size: 24px; color: var(--success);"></i>
                <span style="font-size: 18px; font-weight: 700; color: var(--text-primary);">홈택스 연동 완료</span>
              </div>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">사업자번호</span>
                  <span class="info-value" id="hometaxCorpNum">-</span>
                </div>
                <div class="info-item">
                  <span class="info-label">연동 상태</span>
                  <span class="info-value" style="color: var(--success);">
                    <i class="fa-solid fa-check-circle" style="margin-right: 4px;"></i>
                    정상 작동 중
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">마지막 수집일</span>
                  <span class="info-value" id="hometaxLastSync">-</span>
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 12px;">
              <button onclick="window.location.href='./mypage.html#platformConnectionSection'" 
                style="
                  flex: 1;
                  padding: 12px;
                  background: white;
                  border: 1px solid var(--border);
                  border-radius: 8px;
                  color: var(--text-primary);
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.borderColor='#0066CC'; this.style.color='#0066CC';"
                onmouseout="this.style.borderColor=''; this.style.color='';">
                <i class="fa-solid fa-cog" style="margin-right: 6px;"></i>
                설정 변경
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 매출 데이터가 없을 때 -->
      <div id="emptyState" class="empty-state" style="display: none;">
        <i class="fa-solid fa-chart-line"></i>
        <p>아직 매출 데이터가 없습니다</p>
        <p class="empty-subtitle">매출 데이터를 입력하면 여기에 표시됩니다</p>
        <button onclick="showAddSalesModal()" style="
          margin-top: 20px;
          padding: 12px 24px;
          background: var(--accent-color);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 15px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
        ">
          <i class="fa-solid fa-plus" style="margin-right: 8px;"></i>
          매출 입력하기
        </button>
      </div>
    </div>
  </div>

  <!-- 매출 입력 모달 -->
  <div id="addSalesModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  ">
    <div style="
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    ">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h3 style="font-size: 24px; font-weight: 800; color: var(--text-primary); margin: 0;">
          매출 입력
        </h3>
        <button onclick="closeAddSalesModal()" style="
          background: none;
          border: none;
          font-size: 24px;
          color: var(--text-secondary);
          cursor: pointer;
          padding: 0;
          width: 32px;
          height: 32px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 8px;
          transition: all 0.2s ease;
        " onmouseover="this.style.background='var(--bg-color)';" onmouseout="this.style.background='none';">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>

      <form id="addSalesForm" style="display: flex; flex-direction: column; gap: 20px;">
        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
            날짜 <span style="color: var(--error);">*</span>
          </label>
          <input type="date" id="saleDate" required style="
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
          ">
        </div>

        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
            매출액 <span style="color: var(--error);">*</span>
          </label>
          <input type="number" id="saleAmount" placeholder="예: 50000" required min="0" step="100" style="
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
          ">
          <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            숫자만 입력하세요 (예: 50000)
          </p>
        </div>

        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
            결제 수단
          </label>
          <select id="paymentMethod" style="
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
          ">
            <option value="cash">현금</option>
            <option value="card">카드</option>
            <option value="transfer">계좌이체</option>
            <option value="other">기타</option>
          </select>
        </div>

        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
            메모 (선택사항)
          </label>
          <textarea id="saleMemo" placeholder="매출에 대한 메모를 입력하세요" rows="3" style="
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            resize: vertical;
            font-family: inherit;
          "></textarea>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 8px;">
          <button type="button" onclick="closeAddSalesModal()" style="
            flex: 1;
            padding: 14px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
          " onmouseover="this.style.borderColor='var(--accent-color)';" onmouseout="this.style.borderColor='var(--border)';">
            취소
          </button>
          <button type="submit" style="
            flex: 1;
            padding: 14px;
            background: var(--accent-color);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(255, 123, 84, 0.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
            저장
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="./assets/auth-state.js?v=202410"></script>
  <script>
    let supabase = null;

    // Supabase 초기화
    async function initSupabase() {
      try {
        while (!window.authState?.supabase) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        supabase = window.authState.supabase;
        window.supabaseClient = supabase;
        console.log('✅ Supabase 초기화 완료');
      } catch (error) {
        console.error('❌ Supabase 초기화 실패:', error);
      }
    }

    // 숫자 포맷팅 (천 단위 구분)
    function formatNumber(num) {
      return new Intl.NumberFormat('ko-KR').format(num);
    }

    // 매출 데이터 조회
    async function loadSalesData() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          showError('로그인이 필요합니다.');
          return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay()); // 이번 주 월요일
        
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

        // 오늘 매출
        const { data: todayData } = await supabase
          .from('sales_data')
          .select('sale_amount')
          .eq('user_id', user.id)
          .gte('sale_date', today.toISOString().split('T')[0])
          .lt('sale_date', new Date(today.getTime() + 86400000).toISOString().split('T')[0]);

        // 이번 주 매출
        const { data: weekData } = await supabase
          .from('sales_data')
          .select('sale_amount')
          .eq('user_id', user.id)
          .gte('sale_date', weekStart.toISOString().split('T')[0]);

        // 이번 달 매출
        const { data: monthData } = await supabase
          .from('sales_data')
          .select('sale_amount')
          .eq('user_id', user.id)
          .gte('sale_date', monthStart.toISOString().split('T')[0]);

        const todayTotal = todayData?.reduce((sum, item) => sum + parseFloat(item.sale_amount || 0), 0) || 0;
        const weekTotal = weekData?.reduce((sum, item) => sum + parseFloat(item.sale_amount || 0), 0) || 0;
        const monthTotal = monthData?.reduce((sum, item) => sum + parseFloat(item.sale_amount || 0), 0) || 0;

        document.getElementById('todaySales').textContent = formatNumber(todayTotal) + '원';
        document.getElementById('weekSales').textContent = formatNumber(weekTotal) + '원';
        document.getElementById('monthSales').textContent = formatNumber(monthTotal) + '원';

        // 매출 데이터가 없으면 empty state 표시
        if (todayTotal === 0 && weekTotal === 0 && monthTotal === 0) {
          document.getElementById('emptyState').style.display = 'block';
        }
      } catch (error) {
        console.error('매출 데이터 조회 실패:', error);
        // 에러가 나도 계속 진행 (매출 데이터가 없을 수 있음)
      }
    }

    // 가게 정보 조회
    async function loadStoreInfo() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          showError('로그인이 필요합니다.');
          return;
        }

        const { data, error } = await supabase
          .from('profiles')
          .select('store_name, store_address, store_phone_number, store_business_hours, store_main_menu')
          .eq('id', user.id)
          .single();

        if (error) {
          console.error('가게 정보 조회 실패:', error);
          return;
        }

        if (data) {
          document.getElementById('storeName').textContent = data.store_name || '-';
          document.getElementById('storeAddress').textContent = data.store_address || '-';
          document.getElementById('storePhone').textContent = data.store_phone_number || '-';
          document.getElementById('storeHours').textContent = data.store_business_hours || '-';
          document.getElementById('storeMenu').textContent = data.store_main_menu || '-';
        }
      } catch (error) {
        console.error('가게 정보 조회 실패:', error);
      }
    }

    // 홈택스 연동 상태 조회 및 매출 데이터 로드
    async function loadHometaxStatus() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          return;
        }

        // 홈택스 연동 정보 조회 (platform_connections 테이블에서 hometax 플랫폼 확인)
        const { data: connections, error } = await supabase
          .from('platform_connections')
          .select('*')
          .eq('user_id', user.id)
          .eq('platform', 'hometax')
          .eq('is_active', true);

        if (error && error.code !== 'PGRST116') {
          console.error('홈택스 연동 상태 조회 실패:', error);
          return;
        }

        if (connections && connections.length > 0) {
          // 세금계산서와 현금영수증을 구분하여 표시
          const taxInvoiceConn = connections.find(c => c.store_id?.endsWith('_taxinvoice'));
          const cashBillConn = connections.find(c => c.store_id?.endsWith('_cashbill'));
          
          document.getElementById('hometaxNotConnected').style.display = 'none';
          document.getElementById('hometaxConnected').style.display = 'block';
          
          // 사업자번호 표시 (store_id에서 추출)
          const corpNum = taxInvoiceConn?.store_id?.replace('_taxinvoice', '') || 
                         cashBillConn?.store_id?.replace('_cashbill', '') || 
                         connections[0].store_id?.split('_')[0] || '-';
          document.getElementById('hometaxCorpNum').textContent = corpNum;
          
          // 마지막 수집일 표시 (가장 최근 것)
          const latestSync = connections
            .map(c => c.last_sync_at ? new Date(c.last_sync_at) : null)
            .filter(d => d !== null)
            .sort((a, b) => b - a)[0];
          
          if (latestSync) {
            document.getElementById('hometaxLastSync').textContent = 
              latestSync.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
          } else {
            document.getElementById('hometaxLastSync').textContent = '아직 수집되지 않음';
          }

          // 홈택스 연동이 되어 있으면 매출 데이터 로드
          await loadHometaxSalesData(user.id, true);
          // 매출 카드 표시
          document.getElementById('salesCountCard').style.display = 'block';
          document.getElementById('monthlySalesCard').style.display = 'block';
        } else {
          document.getElementById('hometaxNotConnected').style.display = 'block';
          document.getElementById('hometaxConnected').style.display = 'none';
          // 연동이 안 되어 있으면 매출 카드 숨기기
          document.getElementById('salesCountCard').style.display = 'none';
          document.getElementById('monthlySalesCard').style.display = 'none';
        }
      } catch (error) {
        console.error('홈택스 연동 상태 조회 실패:', error);
      }
    }

    // 홈택스 매출 데이터 로드
    async function loadHometaxSalesData(userId, isConnected) {
      try {
        const now = new Date();
        const currentMonth = now.getMonth() + 1;
        const currentYear = now.getFullYear();

        // 연동이 되어 있으면 실제 데이터 조회 시도
        if (isConnected) {
          const { data: { session } } = await supabase.auth.getSession();
          if (session) {
            const response = await fetch(`/api/hometax/sales-list?userId=${userId}&serviceType=taxinvoice&dateType=monthly&date=${currentYear}-${String(currentMonth).padStart(2, '0')}`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${session.access_token}`
              }
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success && result.data) {
                // 매출 데이터가 있으면 표시
                displaySalesData(result.data, currentYear, currentMonth, true);
                return;
              }
            }
          }
        }

        // 연동이 안 되어 있거나 데이터가 없으면 예시 데이터 표시
        displayExampleData(currentYear, currentMonth, isConnected);
      } catch (error) {
        console.error('홈택스 매출 데이터 로드 실패:', error);
        // 에러 발생 시 예시 데이터 표시
        const now = new Date();
        displayExampleData(now.getFullYear(), now.getMonth() + 1, isConnected);
      }
    }

    // 매출 데이터 표시
    function displaySalesData(data, year, month, isConnected) {
      try {
        const salesList = data.salesList || [];
        
        // 일별 매출 데이터 정리
        const dailySales = {};
        let totalSales = 0;
        let totalOrders = 0;
        const dailyCounts = {};
        
        salesList.forEach(item => {
          const dateStr = item.date; // YYYYMMDD
          const date = new Date(
            parseInt(dateStr.substring(0, 4)),
            parseInt(dateStr.substring(4, 6)) - 1,
            parseInt(dateStr.substring(6, 8))
          );
          
          // 해당 월의 데이터만 처리
          if (date.getFullYear() === year && date.getMonth() + 1 === month) {
            const day = date.getDate();
            const amount = item.total || item.supplyCost || 0;
            
            if (!dailySales[day]) {
              dailySales[day] = 0;
              dailyCounts[day] = 0;
            }
            
            dailySales[day] += amount;
            dailyCounts[day] += 1;
            totalSales += amount;
            totalOrders += 1;
          }
        });

        // 매출 건수 분석 업데이트
        const daysWithData = Object.keys(dailyCounts).length;
        const dailyAverage = daysWithData > 0 ? Math.round(totalOrders / daysWithData) : 0;
        
        const dailyValues = Object.values(dailyCounts);
        const dailyMax = dailyValues.length > 0 ? Math.max(...dailyValues) : 0;
        const dailyMin = dailyValues.length > 0 ? Math.min(...dailyValues.filter(v => v > 0)) : 0;
        
        const maxDay = Object.keys(dailyCounts).find(day => dailyCounts[day] === dailyMax);
        const minDay = Object.keys(dailyCounts).find(day => dailyCounts[day] === dailyMin);
        
        document.getElementById('totalOrders').textContent = formatNumber(totalOrders);
        document.getElementById('dailyAverage').textContent = `${dailyAverage}건`;
        document.getElementById('dailyMax').textContent = `${dailyMax}건`;
        document.getElementById('dailyMaxDate').textContent = maxDay ? `${month}/${maxDay} 일 최고` : '일 최고';
        document.getElementById('dailyMin').textContent = `${dailyMin}건`;
        document.getElementById('dailyMinDate').textContent = minDay ? `${month}/${minDay} 일 최저` : '일 최저';

        // 원형 그래프 업데이트
        const circumference = 2 * Math.PI * 80;
        const maxExpected = 2000; // 예상 최대 주문 수
        const percentage = Math.min(100, (totalOrders / maxExpected) * 100);
        const offset = circumference - (percentage / 100) * circumference;
        document.getElementById('salesCountCircle').style.strokeDasharray = `${circumference} ${circumference}`;
        document.getElementById('salesCountCircle').style.strokeDashoffset = offset;

        // 월 누적 총 매출 표시
        document.getElementById('monthlyTotalLabel').textContent = `${month}월 누적 총 매출은`;
        document.getElementById('monthlyTotalAmount').textContent = formatNumber(totalSales) + '원';

        // 캘린더 생성 (실제 데이터 포함)
        generateSalesCalendar(year, month, isConnected, dailySales, totalSales);

        // 카드 표시
        document.getElementById('salesCountCard').style.display = 'block';
        document.getElementById('monthlySalesCard').style.display = 'block';
      } catch (error) {
        console.error('매출 데이터 표시 오류:', error);
        // 에러 발생 시 예시 데이터 표시
        displayExampleData(year, month, isConnected);
      }
    }

    // 예시 데이터 표시 (연동 전 또는 데이터 없을 때)
    function displayExampleData(year, month, isConnected = false) {
      const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
      document.getElementById('monthlySalesTitle').textContent = `${month}월 매출 현황`;
      
      // 예시 월 누적 총 매출
      const exampleTotal = 6365000;
      document.getElementById('monthlyTotalLabel').textContent = `${month}월 누적 총 매출은`;
      document.getElementById('monthlyTotalAmount').textContent = formatNumber(exampleTotal) + '원';
      
      // 매출 건수 분석 표시
      const totalOrders = 1463;
      const dailyAverage = 47;
      const dailyMax = 69;
      const dailyMaxDate = '12/15';
      const dailyMin = 23;
      const dailyMinDate = '12/13';

      document.getElementById('totalOrders').textContent = formatNumber(totalOrders);
      document.getElementById('dailyAverage').textContent = `${dailyAverage}건`;
      document.getElementById('dailyMax').textContent = `${dailyMax}건`;
      document.getElementById('dailyMaxDate').textContent = `${dailyMaxDate} 일 최고`;
      document.getElementById('dailyMin').textContent = `${dailyMin}건`;
      document.getElementById('dailyMinDate').textContent = `${dailyMinDate} 일 최저`;

      // 원형 그래프 업데이트
      const circumference = 2 * Math.PI * 80;
      const percentage = 100; // 예시 데이터는 100%
      const offset = circumference - (percentage / 100) * circumference;
      document.getElementById('salesCountCircle').style.strokeDasharray = `${circumference} ${circumference}`;
      document.getElementById('salesCountCircle').style.strokeDashoffset = offset;

      // 캘린더 생성
      generateSalesCalendar(year, month, isConnected);

      // 카드 표시
      document.getElementById('salesCountCard').style.display = 'block';
      document.getElementById('monthlySalesCard').style.display = 'block';
    }

    // 매출 캘린더 생성
    function generateSalesCalendar(year, month, isConnected = false, dailySales = {}, totalSales = 0) {
      const calendar = document.getElementById('salesCalendar');
      calendar.innerHTML = '';

      // 요일 헤더
      const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
      weekdays.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.style.cssText = 'text-align: center; font-weight: 600; color: var(--text-secondary); padding: 8px; font-size: 12px;';
        dayHeader.textContent = day;
        calendar.appendChild(dayHeader);
      });

      // 첫 날짜와 마지막 날짜
      const firstDay = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - startDate.getDay()); // 주의 시작일 (일요일)

      // 빈 칸 채우기
      for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyCell = document.createElement('div');
        emptyCell.style.cssText = 'padding: 8px; min-height: 60px;';
        calendar.appendChild(emptyCell);
      }

      // 날짜 셀 생성
      for (let date = 1; date <= lastDay.getDate(); date++) {
        const cell = document.createElement('div');
        const currentDate = new Date(year, month - 1, date);
        const dayOfWeek = currentDate.getDay();
        
        cell.style.cssText = `
          padding: 8px;
          min-height: 60px;
          border: 1px solid var(--border);
          border-radius: 8px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: ${dayOfWeek === 0 ? 'rgba(255, 0, 0, 0.05)' : dayOfWeek === 6 ? 'rgba(0, 0, 255, 0.05)' : 'white'};
        `;

        const dateText = document.createElement('div');
        dateText.style.cssText = `
          font-size: 12px;
          font-weight: 600;
          color: ${dayOfWeek === 0 ? '#ff0000' : dayOfWeek === 6 ? '#0066ff' : 'var(--text-primary)'};
          margin-bottom: 4px;
        `;
        dateText.textContent = date;
        cell.appendChild(dateText);

        const amountText = document.createElement('div');
        amountText.style.cssText = 'font-size: 11px; color: var(--text-secondary);';
        
        if (dailySales[date]) {
          // 실제 매출 데이터가 있으면 표시
          const amount = dailySales[date];
          if (amount >= 10000) {
            amountText.textContent = `${Math.round(amount / 10000)}만원`;
          } else {
            amountText.textContent = `${formatNumber(amount)}원`;
          }
          amountText.style.color = 'var(--accent-color)';
          amountText.style.fontWeight = '600';
        } else {
          // 데이터가 없으면
          amountText.textContent = isConnected ? '0원' : '?만원';
        }
        cell.appendChild(amountText);

        calendar.appendChild(cell);
      }

      // 주별 합계 생성
      generateWeeklyTotals(year, month, dailySales);
    }

    // 주별 합계 생성
    function generateWeeklyTotals(year, month, dailySales = {}) {
      const weeklyTotals = document.getElementById('weeklyTotals');
      weeklyTotals.innerHTML = '';

      const firstDay = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0);
      let weekNum = 1;
      let currentDate = new Date(firstDay);

      while (currentDate <= lastDay) {
        const weekStart = new Date(currentDate);
        const weekEnd = new Date(currentDate);
        weekEnd.setDate(weekEnd.getDate() + 6);

        if (weekEnd > lastDay) {
          weekEnd.setTime(lastDay.getTime());
        }

        const weekItem = document.createElement('div');
        weekItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-color); border-radius: 8px;';

        const weekLabel = document.createElement('div');
        weekLabel.style.cssText = 'font-weight: 600; color: var(--text-primary);';
        weekLabel.textContent = `${weekNum}주차`;
        weekItem.appendChild(weekLabel);

        const weekAmount = document.createElement('div');
        weekAmount.style.cssText = 'font-weight: 700; color: var(--accent-color);';
        
        // 주별 합계 계산
        let weekTotal = 0;
        for (let d = weekStart.getDate(); d <= weekEnd.getDate(); d++) {
          if (dailySales[d]) {
            weekTotal += dailySales[d];
          }
        }
        
        if (weekTotal > 0) {
          if (weekTotal >= 10000) {
            weekAmount.textContent = `${Math.round(weekTotal / 10000)}만원`;
          } else {
            weekAmount.textContent = `${formatNumber(weekTotal)}원`;
          }
        } else {
          weekAmount.textContent = isConnected ? '0원' : '?만원';
        }
        weekItem.appendChild(weekAmount);

        weeklyTotals.appendChild(weekItem);

        currentDate.setDate(currentDate.getDate() + 7);
        weekNum++;
      }
    }

    // 에러 표시
    function showError(message) {
      alert(message);
    }

    // 인증 UI 업데이트 함수
    async function updateAuthUI() {
      const authUser = document.getElementById('authUser');
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      const userEmail = document.getElementById('userEmail');
      const userAvatar = document.getElementById('userAvatar');
      const logoutBtn = document.getElementById('logoutBtn');
      
      let user = null;
      
      // 1. 먼저 localStorage/sessionStorage 확인 (빠른 초기 렌더링)
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true';
      if (isLoggedIn) {
        try {
          const loginType = localStorage.getItem('loginType') || 'auto';
          const useSessionStorage = loginType === 'manual';
          const storage = useSessionStorage ? sessionStorage : localStorage;
          const raw = storage.getItem('userData');
          if (raw) {
            user = JSON.parse(raw);
            console.log('[my-store] localStorage에서 사용자 정보 확인:', user?.email);
          }
        } catch (error) {
          console.warn('[my-store] 사용자 정보 파싱 실패:', error);
        }
      }
      
      // 2. Supabase 세션 확인 (auth-state.js가 로드된 경우)
      if (window.authState?.supabase) {
        try {
          const { data: { session } } = await window.authState.supabase.auth.getSession();
          if (session?.user) {
            user = {
              id: session.user.id,
              email: session.user.email,
              displayName: session.user.user_metadata?.full_name || session.user.user_metadata?.name || session.user.email
            };
            console.log('[my-store] Supabase 세션에서 사용자 정보 확인:', user.email);
          }
        } catch (error) {
          console.warn('[my-store] Supabase 세션 확인 실패:', error);
        }
      }
      
      // 3. UI 업데이트
      if (user && user.email) {
        if (authUser) authUser.style.display = 'flex';
        if (loginBtn) loginBtn.style.display = 'none';
        if (signupBtn) signupBtn.style.display = 'none';
        if (userEmail) {
          userEmail.textContent = user.email;
          userEmail.href = './mypage.html';
        }
        if (userAvatar) {
          const initial = (user.email[0] || 'U').toUpperCase();
          userAvatar.textContent = initial;
        }
        if (logoutBtn) {
          logoutBtn.onclick = async function() {
            if (!confirm('로그아웃 하시겠습니까?')) return;
            
            // auth-state.js의 signOut 사용
            if (window.authState?.signOut) {
              await window.authState.signOut();
            } else {
              // fallback
              localStorage.removeItem('isLoggedIn');
              localStorage.removeItem('userData');
              sessionStorage.removeItem('isLoggedIn');
              sessionStorage.removeItem('userData');
            }
            
            location.href = './login.html';
          };
        }
      } else {
        if (authUser) authUser.style.display = 'none';
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (signupBtn) signupBtn.style.display = 'inline-flex';
      }
    }

    // 페이지 초기화
    async function initPage() {
      await initSupabase();
      
      if (!supabase) {
        showError('데이터베이스 연결에 실패했습니다.');
        return;
      }

      // 로그인 확인
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = './login.html';
        return;
      }

      // auth-state.js가 로드될 때까지 대기
      let waitCount = 0;
      const maxWait = 50; // 5초 대기
      while (!window.authState && waitCount < maxWait) {
        await new Promise(resolve => setTimeout(resolve, 100));
        waitCount++;
      }
      
      // 인증 UI 업데이트
      await updateAuthUI();
      
      // auth-state.js의 인증 상태 변경 이벤트 구독
      if (window.authState) {
        window.addEventListener('auth:state-changed', async () => {
          await updateAuthUI();
        });
      }
      
      // 페이지 로드 후에도 한 번 더 확인
      setTimeout(async () => {
        await updateAuthUI();
      }, 1000);

      // 데이터 로드
      await Promise.all([
        loadSalesData(),
        loadStoreInfo(),
        loadHometaxStatus()
      ]);

      // 로딩 숨기고 콘텐츠 표시
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('contentArea').style.display = 'block';
    }

    // 페이지 로드 시 초기화
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPage);
    } else {
      initPage();
    }
  </script>
</body>
</html>

