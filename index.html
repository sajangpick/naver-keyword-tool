<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>사장픽(sajang pick) - 메인 허브</title>
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2303c75a'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' font-family='Arial' fill='white'%3ESP%3C/text%3E%3C/svg%3E"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .is-hidden {
        display: none !important;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Noto Sans KR", Arial, sans-serif;
        background: var(--bg);
        color: #111827;
      }
      a {
        color: inherit;
        text-decoration: none;
      }

      :root {
        --naver-green: #03c75a;
        --naver-green-dark: #02b14f;
        --naver-green-50: #e6f9f0;
        --bg: #f7f9fb;
        --chatgpt-green: #10a37f;
        /* unified vertical rhythm */
        --section-gap: 12px;
        --section-pad: 14px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }
      /* Reduce only main content's top padding to tighten area 2 */
      main.container {
        padding-top: calc(var(--section-gap) / 2);
      }
      /* Normalize hero container: only horizontal padding, no extra vertical spacing */
      .hero .container {
        padding: 0 24px;
      }
      .header {
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid #e5e7eb;
      }
      .header-inner {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        padding: 14px 24px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .logo {
        font-weight: 800;
        font-size: 24px;
        color: #111827;
        cursor: pointer;
      }
      /* Header on light background: plain text logo */
      .header .logo {
        background: none;
        -webkit-text-fill-color: inherit;
        color: #111827;
      }

      .nav {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .nav a {
        font-size: 14px;
        padding: 8px 12px;
        border-radius: 8px;
        color: #374151;
      }
      .nav a:hover {
        background: var(--naver-green-50);
        color: var(--naver-green);
      }

      .hero {
        background: transparent;
        padding: 0; /* remove extra vertical space, grid margin governs gap */
      }
      .hero .title {
        color: #ffffff;
        font-size: 34px;
        font-weight: 800;
        line-height: 1.2;
        margin-bottom: var(--section-gap);
      }
      .hero .subtitle {
        color: rgba(255, 255, 255, 0.92);
        font-size: 16px;
      }
      .hero-box {
        background: linear-gradient(
          135deg,
          var(--naver-green),
          var(--naver-green-dark)
        );
        border-radius: 16px;
        padding: var(--section-pad);
        max-width: none; /* restore original width */
        margin: 0 auto;
      }

      .grid {
        display: flex;
        flex-direction: column;
        gap: var(--section-gap);
        margin-top: calc(var(--section-gap) / 2); /* slightly tighter area 2 */
      }
      .card {
        width: 100%;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      @media (min-width: 1024px) {
        .card.half {
          grid-column: span 6;
        }
      }
      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 18px;
        border-bottom: 1px solid #f3f4f6;
        background: #fafafa;
      }
      .card-header .title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        font-weight: 700;
        color: #111827;
      }
      .card-body {
        padding: 18px;
        display: grid;
        gap: 14px;
      }

      .row {
        display: grid;
        gap: 10px;
      }
      .row.cols-2 {
        grid-template-columns: 1fr;
      }
      @media (min-width: 768px) {
        .row.cols-2 {
          grid-template-columns: 1fr 1fr;
        }
      }

      label {
        font-size: 13px;
        color: #374151;
        font-weight: 600;
      }
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        outline: none;
        font-size: 14px;
      }
      textarea {
        min-height: 120px;
        resize: vertical;
      }

      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #111827;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
      }
      .btn.primary {
        background: var(--naver-green);
        color: #fff;
        border-color: var(--naver-green);
      }
      .btn.primary:hover {
        background: var(--naver-green-dark);
        border-color: var(--naver-green-dark);
      }
      .btn.ghost {
        background: #fff;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .muted {
        color: #6b7280;
        font-size: 13px;
      }
      .output {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: var(--section-pad);
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 13px;
        color: #111827;
      }
      .output.error {
        border-color: #fecaca;
        background: #fff1f2;
        color: #991b1b;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }
      .table th,
      .table td {
        border-bottom: 1px solid #f3f4f6;
        padding: 10px;
        font-size: 13px;
        text-align: left;
      }
      .table th {
        background: #fafafa;
        font-weight: 700;
        color: #374151;
      }

      .small {
        font-size: 12px;
        color: #6b7280;
      }
      /* Naver-style ChatGPT search bar */
      .naver-search {
        display: grid;
        gap: 10px;
      }
      .ns-box {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border: 2px solid var(--naver-green);
        border-radius: 999px;
        background: #fff;
        box-shadow: 0 8px 20px rgba(3, 199, 90, 0.08);
      }
      .ns-logo {
        height: 32px;
        border-radius: 6px;
        background: transparent; /* remove background for better visibility */
        color: inherit;
        font-weight: 900;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 0 2px;
      }
      .openai-icon {
        width: 24px;
        height: 24px;
        filter: none; /* natural logo color on transparent background */
        display: block;
      }
      .ns-logo-text {
        font-size: 20px;
        font-weight: 800;
        color: #111827;
        letter-spacing: -0.3px;
      }
      .ns-input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 16px;
        padding: 6px 4px;
        background: transparent;
      }
      .ns-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .ns-btn {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 999px;
        background: var(--naver-green);
        color: #fff;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .ns-btn:hover {
        background: var(--naver-green-dark);
      }
      .ns-shortcuts {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .ns-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 9px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #fff;
        font-size: 12px;
        color: #374151;
      }
      /* top search placement and slightly larger scale */
      .top-search {
        background: #fff;
        border-bottom: 1px solid #e5e7eb;
      }
      .top-search .container {
        padding-top: calc(var(--section-gap) / 2);
        padding-bottom: var(
          --section-gap
        ); /* restore visible space above hero (area 1) */
      }
      .top-search .ns-box {
        padding: calc(var(--section-pad) - 8px) 16px;
        max-width: 820px;
        margin: 0 auto;
      }
      .top-search .ns-logo {
        height: 32px;
        font-size: 20px;
        flex-direction: row; /* restore side-by-side */
        gap: 6px;
      }
      .top-search .ns-logo-text {
        font-size: 18px;
      }
      .top-search .ns-input {
        font-size: 18px;
      }
      .top-search .ns-btn {
        width: 40px;
        height: 40px;
      }
      .top-actions-row {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center; /* center icons block */
        gap: 12px;
        flex-wrap: wrap;
      }
      .top-actions {
        margin-top: var(--section-gap);
      }
      .auth-buttons {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        margin: auto 0; /* vertically center without translate issues */
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
        justify-content: center; /* true vertical centering */
      }
      @media (max-width: 768px) {
        .top-actions-row {
          flex-direction: column;
          align-items: center;
        }
        .auth-buttons {
          position: static;
          width: 100%;
          align-items: center;
        }
      }
      .login-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 200px;
        height: 48px;
        padding: 0 16px;
        border-radius: 6px;
        background: var(--naver-green);
        color: #fff;
        font-weight: 800;
        font-size: 15px;
        border: none;
        text-decoration: none;
        transition: background-color 0.2s ease;
      }
      .login-link .emph {
        color: #ffffff;
        font-weight: 900;
      }
      .login-link .sub {
        color: rgba(255, 255, 255, 0.85);
        font-weight: 700;
        margin-left: 4px;
      }
      .login-link .owner {
        display: none;
      }
      .login-link:hover {
        background: var(--naver-green-dark);
      }
      .kakao-signup {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 200px;
        height: 48px; /* match login height */
        background: transparent; /* remove yellow background */
        color: #6b7280; /* lighter text */
        font-weight: 800;
        font-size: 15px; /* match login font size */
        border-radius: 6px;
        text-decoration: underline; /* subtle underline */
        text-underline-offset: 3px;
        text-decoration-thickness: 1.5px;
        transition: color 0.2s ease, text-decoration-thickness 0.2s ease;
      }
      .kakao-signup:hover {
        background: transparent;
        color: #374151; /* slightly darker on hover for readability */
        text-decoration-thickness: 2px;
      }
      @media (max-width: 768px) {
        .login-link {
          position: static;
          transform: none;
          margin-top: 10px;
        }
      }
      .top-apps {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
        padding: 12px 4px 6px 4px;
      }
      .top-apps a.app {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        min-width: 64px;
        text-decoration: none;
        color: #374151;
      }
      .app-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: #fff;
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
        color: var(--naver-green);
        font-size: 18px;
      }
      .app-label {
        font-size: 15px;
        color: #374151;
      }
      .top-apps a.app:hover .app-icon {
        border-color: var(--naver-green);
        transform: translateY(-2px);
        transition: all 0.2s ease;
      }

      /* Mobile-only layout tweaks */
      @media (max-width: 768px) {
        /* 1) 기능 아이콘: 5개 고정 노출(스크롤 없음, 2줄로 자동 줄바꿈) */
        .top-actions-row .top-apps {
          display: grid !important;
          grid-template-columns: repeat(5, 1fr);
          gap: 12px;
          padding: 8px 12px 10px 12px;
          overflow: hidden;
        }
        .top-actions-row .top-apps a.app {
          min-width: 0 !important; /* 5등분을 막는 최소폭 제약 제거 */
          width: 100% !important;
        }
        /* 2) 스마트 비즈니스 툴 허브 배너는 모바일에서 숨김 */
        .hero {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-inner">
        <div class="logo" onclick="location.href='/'">사장픽</div>
      </div>
      <!-- Top Naver-style ChatGPT search (moved under header) -->
      <section class="top-search">
        <div class="container top-row">
          <form id="topNaverChatForm" class="ns-box">
            <div class="ns-logo" aria-label="GPT-5">
              <i
                class="fa-solid fa-comments"
                style="font-size: 22px; color: var(--chatgpt-green)"
              ></i>
              <span class="ns-logo-text">GPT-5</span>
            </div>
            <input
              id="topNaverChatInput"
              class="ns-input"
              type="text"
              placeholder="무엇이든 물어보세요. 예) 손님 불만 리뷰에 공손한 답변 작성"
              autocomplete="off"
            />
            <div class="ns-actions">
              <button
                type="submit"
                id="topNaverChatSubmit"
                class="ns-btn"
                aria-label="검색"
              >
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
            </div>
          </form>

          <!-- 상단 추천 단축 버튼(추천메뉴/응대/주제) 제거 -->
          <div class="top-actions-row top-actions">
            <div class="top-apps">
              <a class="app" href="/ChatGPT.html">
                <div class="app-icon">
                  <i
                    class="fa-solid fa-comments"
                    style="font-size: 20px; color: var(--chatgpt-green)"
                  ></i>
                </div>
                <div class="app-label" style="font-size: 14px">채팅</div>
              </a>
              <a class="app" href="/#review">
                <div class="app-icon">
                  <i class="fa-solid fa-pen-nib" style="font-size: 20px"></i>
                </div>
                <div class="app-label" style="font-size: 14px">리뷰작성</div>
              </a>
              <a class="app" href="/Blog-Editor.html">
                <div class="app-icon">
                  <i class="fa-solid fa-blog" style="font-size: 20px"></i>
                </div>
                <div class="app-label" style="font-size: 14px">블로그</div>
              </a>
              <a class="app" href="/naver_search.html">
                <div class="app-icon">
                  <i class="fa-solid fa-key" style="font-size: 20px"></i>
                </div>
                <div class="app-label" style="font-size: 14px">키워드</div>
              </a>
              
            </div>
            <div class="auth-buttons" id="authButtons">
              <a href="/login.html" class="login-link" id="loginBtn"
                ><span class="emph">사장님픽</span
                ><span class="sub"> 로그인</span></a
              >
              <a href="/join.html" class="kakao-signup" id="signupBtn"
                >카카오톡 아이디로 회원가입</a
              >
              <button
                class="kakao-signup"
                id="logoutBtn"
                style="display: none; border: none; cursor: pointer"
              >
                로그아웃
              </button>
              <span
                id="userEmail"
                style="display: none; margin-right: 10px; font-size: 14px"
              ></span>
            </div>
          </div>
          <div
            id="topChatSearchOutput"
            class="output"
            style="display: none"
          ></div>
        </div>
      </section>
    </header>

    <section class="hero">
      <div class="container">
        <div class="hero-box">
          <h1 class="title">스마트 비즈니스 툴 허브</h1>
          <p class="subtitle">
            하단의 4가지 기능을 바로 사용할 수 있습니다. 동일 도메인에서
            백엔드가 실행 중이라면 별도 CORS 설정 없이 동작합니다.
          </p>
        </div>
      </div>
    </section>

    <main class="container">
      <div class="grid">
        <!-- 1) ChatGPT 채팅 -->
        <section id="chat" class="card half">
          <div class="card-header">
            <div class="title">
              <i class="fa-solid fa-comments"></i> ChatGPT 채팅
            </div>
            <span class="small muted">POST /api/chat</span>
          </div>
          <div class="card-body">
            <!-- Naver-style quick ChatGPT search -->
            <div class="naver-search">
              <form id="naverChatForm" class="ns-box">
                <div class="ns-logo" aria-label="ChatGPT">
                  <i class="fa-solid fa-comments"></i>
                </div>
                <input
                  id="naverChatInput"
                  class="ns-input"
                  type="text"
                  placeholder="무엇이 궁금하신가요? 예) 오늘 매출을 늘릴 방법 정리해줘"
                  autocomplete="off"
                />
                <div class="ns-actions">
                  <button
                    type="submit"
                    id="naverChatSubmit"
                    class="ns-btn"
                    aria-label="검색"
                  >
                    <i class="fa-solid fa-magnifying-glass"></i>
                  </button>
                </div>
              </form>
              <div class="ns-shortcuts">
                <button
                  type="button"
                  class="ns-chip"
                  data-q="오늘 핫한 마케팅 아이디어 3가지"
                >
                  <i class="fa-regular fa-lightbulb"></i> 아이디어
                </button>
                <button
                  type="button"
                  class="ns-chip"
                  data-q="리뷰에 공손하게 답장 작성해줘"
                >
                  <i class="fa-regular fa-message"></i> 리뷰답글
                </button>
                <button
                  type="button"
                  class="ns-chip"
                  data-q="점심 특선 홍보 문구 1문장"
                >
                  <i class="fa-solid fa-bullhorn"></i> 홍보문구
                </button>
              </div>
              <div
                id="chatSearchOutput"
                class="output"
                style="display: none"
              ></div>
            </div>
            <div class="row">
              <label for="chatMessage">메시지</label>
              <textarea
                id="chatMessage"
                placeholder="질문을 입력하세요..."
              ></textarea>
            </div>
            <div class="actions">
              <button class="btn primary" id="chatSend">전송</button>
              <button class="btn ghost" id="chatClear">지우기</button>
            </div>
            <div id="chatOutput" class="output" style="min-height: 80px"></div>
          </div>
        </section>

        <!-- 2) AI 리뷰작성 -->
        <section id="review" class="card half">
          <div class="card-header">
            <div class="title">
              <i class="fa-solid fa-pen-nib"></i> AI 리뷰작성
            </div>
            <span class="small muted"
              >POST /api/analyze-review, POST /api/generate-reply</span
            >
          </div>
          <div class="card-body">
            <div class="row">
              <label for="reviewText">리뷰 원문</label>
              <textarea
                id="reviewText"
                placeholder="고객 리뷰 내용을 입력하세요..."
              ></textarea>
            </div>
            <div class="actions">
              <button class="btn" id="analyzeBtn">
                <i class="fa-solid fa-magnifying-glass-chart"></i> 리뷰 분석
              </button>
              <button class="btn primary" id="replyBtn">
                <i class="fa-solid fa-reply"></i> 답글 생성
              </button>
            </div>
            <div
              id="reviewOutput"
              class="output"
              style="min-height: 80px"
            ></div>
          </div>
        </section>

        <!-- 3) AI 블로그 작성 -->
        <section id="blog" class="card">
          <div class="card-header">
            <div class="title">
              <i class="fa-solid fa-blog"></i> AI 블로그 작성
            </div>
            <span class="small muted">POST /api/generate-blog</span>
          </div>
          <div class="card-body">
            <div class="row cols-2">
              <div>
                <label for="storeName">가게명</label>
                <input
                  type="text"
                  id="storeName"
                  placeholder="예) 사장픽카페"
                />
              </div>
              <div>
                <label for="category">업종</label>
                <input
                  type="text"
                  id="category"
                  placeholder="예) 카페/디저트"
                />
              </div>
            </div>
            <div class="row cols-2">
              <div>
                <label for="blogStyle">블로그 스타일</label>
                <select id="blogStyle">
                  <option value="일상후기">일상후기</option>
                  <option value="상세리뷰">상세리뷰</option>
                  <option value="사진중심">사진중심</option>
                  <option value="분위기중심">분위기중심</option>
                </select>
              </div>
              <div>
                <label for="wordCount">목표 글자수</label>
                <input
                  type="number"
                  id="wordCount"
                  value="800"
                  min="300"
                  max="4000"
                />
              </div>
            </div>
            <div class="actions">
              <button class="btn primary" id="blogGenerate">
                <i class="fa-solid fa-wand-magic-sparkles"></i> 생성
              </button>
              <button class="btn ghost" id="blogClear">지우기</button>
            </div>
            <div id="blogOutput" class="output" style="min-height: 120px"></div>
          </div>
        </section>

        <!-- 4) 키워드 검색 -->
        <section id="keyword" class="card">
          <div class="card-header">
            <div class="title"><i class="fa-solid fa-key"></i> 키워드 검색</div>
            <span class="small muted">POST /api/keywords</span>
          </div>
          <div class="card-body">
            <div class="row cols-2">
              <div>
                <label for="keywordInput">검색 키워드</label>
                <input type="text" id="keywordInput" placeholder="예) 치킨" />
              </div>
              <div class="actions" style="align-items: end">
                <button class="btn primary" id="keywordSearch">
                  <i class="fa-solid fa-search"></i> 검색
                </button>
                <button class="btn ghost" id="keywordClear">지우기</button>
              </div>
            </div>
            <div id="keywordInfo" class="small muted"></div>
            <div id="keywordOutput" class="output" style="display: none"></div>
            <div style="overflow: auto">
              <table class="table" id="keywordTable" style="display: none">
                <thead>
                  <tr>
                    <th>키워드</th>
                    <th>월간 PC</th>
                    <th>월간 모바일</th>
                    <th>경쟁도</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </main>

    <script>
      // 백엔드 베이스 URL 제거: 현재 도메인의 /api 상대경로 사용

      // 공통 유틸
      function setLoading(el, isLoading, textWhenLoading = "처리 중...") {
        if (!el) return;
        el.dataset._originalText = el.dataset._originalText || el.textContent;
        el.disabled = !!isLoading;
        el.textContent = isLoading ? textWhenLoading : el.dataset._originalText;
      }
      async function readJsonSafely(res) {
        // 안전하게 JSON 파싱 (빈 응답/HTML 응답 대비)
        const contentType = res.headers.get("content-type") || "";
        if (contentType.includes("application/json")) {
          try {
            return await res.json();
          } catch (_) {
            return { error: "JSON 파싱 실패", status: res.status };
          }
        }
        try {
          const text = await res.text();
          return text
            ? { error: text, status: res.status }
            : { status: res.status };
        } catch (_) {
          return { error: "응답 본문을 읽을 수 없습니다.", status: res.status };
        }
      }
      function showOutput(el, data) {
        if (!el) return;
        el.classList.remove("error");
        el.style.display = "block";
        try {
          if (typeof data === "string") {
            el.textContent = data.trim();
          } else {
            el.textContent = JSON.stringify(data, null, 2);
          }
        } catch (e) {
          el.textContent = String(data);
        }
      }
      function showError(el, err) {
        if (!el) return;
        el.classList.add("error");
        el.style.display = "block";
        el.textContent = (
          err?.error ||
          err?.message ||
          err?.raw ||
          err?.errorText ||
          "오류가 발생했습니다."
        ).toString();
      }

      // 1) ChatGPT 채팅
      const chatSendBtn = document.getElementById("chatSend");
      const chatClearBtn = document.getElementById("chatClear");
      chatSendBtn?.addEventListener("click", async () => {
        const message = (
          document.getElementById("chatMessage")?.value || ""
        ).trim();
        const out = document.getElementById("chatOutput");
        if (!message) {
          showError(out, { message: "메시지를 입력하세요." });
          return;
        }
        setLoading(chatSendBtn, true, "전송 중...");
        showOutput(out, "");
        try {
          const res = await fetch(`/api/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message }),
          });
          const data = await readJsonSafely(res);
          if (!res.ok || data.success === false) throw data;
          showOutput(out, data.reply || data);
        } catch (e) {
          showError(out, e);
        } finally {
          setLoading(chatSendBtn, false);
        }
      });
      chatClearBtn?.addEventListener("click", () => {
        const out = document.getElementById("chatOutput");
        const ta = document.getElementById("chatMessage");
        if (ta) ta.value = "";
        showOutput(out, "");
      });

      // 2) AI 리뷰작성
      const analyzeBtn = document.getElementById("analyzeBtn");
      const replyBtn = document.getElementById("replyBtn");
      analyzeBtn?.addEventListener("click", async () => {
        const reviewText = (
          document.getElementById("reviewText")?.value || ""
        ).trim();
        const out = document.getElementById("reviewOutput");
        if (!reviewText) {
          showError(out, { message: "리뷰 원문을 입력하세요." });
          return;
        }
        setLoading(analyzeBtn, true, "분석 중...");
        showOutput(out, "");
        try {
          const res = await fetch(`/api/analyze-review`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              reviewText,
              analysisType: "comprehensive",
              options: [],
            }),
          });
          const data = await readJsonSafely(res);
          if (!res.ok || data.success === false) throw data;
          showOutput(out, data.data || data);
        } catch (e) {
          showError(out, e);
        } finally {
          setLoading(analyzeBtn, false);
        }
      });
      replyBtn?.addEventListener("click", async () => {
        const reviewText = (
          document.getElementById("reviewText")?.value || ""
        ).trim();
        const out = document.getElementById("reviewOutput");
        if (!reviewText) {
          showError(out, { message: "리뷰 원문을 입력하세요." });
          return;
        }
        setLoading(replyBtn, true, "생성 중...");
        showOutput(out, "");
        try {
          const res = await fetch(`/api/generate-reply`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reviewText }),
          });
          const data = await readJsonSafely(res);
          if (!res.ok || data.success === false) throw data;
          showOutput(out, data.data?.reply || data.reply || data);
        } catch (e) {
          showError(out, e);
        } finally {
          setLoading(replyBtn, false);
        }
      });

      // 3) AI 블로그 작성
      const blogBtn = document.getElementById("blogGenerate");
      const blogClear = document.getElementById("blogClear");
      blogBtn?.addEventListener("click", async () => {
        const storeName = (
          document.getElementById("storeName")?.value || ""
        ).trim();
        const category = (
          document.getElementById("category")?.value || ""
        ).trim();
        const blogStyle = (
          document.getElementById("blogStyle")?.value || ""
        ).trim();
        const wordCount = Number(
          document.getElementById("wordCount")?.value || 800
        );
        const out = document.getElementById("blogOutput");
        if (!storeName || !category || !blogStyle) {
          showError(out, { message: "가게명/업종/스타일을 입력하세요." });
          return;
        }
        setLoading(blogBtn, true, "생성 중...");
        showOutput(out, "");
        try {
          const res = await fetch(`/api/generate-blog`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ storeName, category, blogStyle, wordCount }),
          });
          const data = await readJsonSafely(res);
          if (!res.ok || data.success === false) throw data;
          const steps = data.data || data;
          const finalText =
            steps.finalBlog ||
            steps.step3_claude ||
            steps.step2_gemini ||
            steps.step1_chatgpt ||
            steps;
          const composed = [
            steps.step1_chatgpt
              ? "Step1(ChatGPT)\n\n" + steps.step1_chatgpt
              : null,
            steps.step2_gemini
              ? "\n\nStep2(Gemini)\n\n" + steps.step2_gemini
              : null,
            steps.step3_claude
              ? "\n\nStep3(Claude)\n\n" + steps.step3_claude
              : null,
            finalText ? "\n\n최종본\n\n" + finalText : null,
          ]
            .filter(Boolean)
            .join("");
          showOutput(out, composed || steps);
        } catch (e) {
          showError(out, e);
        } finally {
          setLoading(blogBtn, false);
        }
      });
      blogClear?.addEventListener("click", () => {
        ["storeName", "category"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.value = "";
        });
        const out = document.getElementById("blogOutput");
        showOutput(out, "");
      });

      // 4) 키워드 검색
      const kwBtn = document.getElementById("keywordSearch");
      const kwClear = document.getElementById("keywordClear");
      kwBtn?.addEventListener("click", async () => {
        const DataQ = (
          document.getElementById("keywordInput")?.value || ""
        ).trim();
        const info = document.getElementById("keywordInfo");
        const out = document.getElementById("keywordOutput");
        const table = document.getElementById("keywordTable");
        const tbody = table?.querySelector("tbody");
        if (!DataQ) {
          showError(out, { message: "검색 키워드를 입력하세요." });
          table.style.display = "none";
          return;
        }
        setLoading(kwBtn, true, "검색 중...");
        out.style.display = "none";
        info.textContent = "";
        table.style.display = "none";
        if (tbody) tbody.innerHTML = "";
        try {
          const res = await fetch(`/api/keywords`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ DataQ }),
          });
          const data = await readJsonSafely(res);
          if (!res.ok) throw data;
          const list = data.keywordList || data.results || [];
          info.textContent = `검색어: ${DataQ} | 총 ${list.length || 0}개 결과`;
          if (list.length > 0 && tbody) {
            list.slice(0, 50).forEach((item) => {
              const tr = document.createElement("tr");
              const name = item.relKeyword || item.keyword || "-";
              const pc = item.monthlyPcQcCnt ?? "-";
              const mobile = item.monthlyMobileQcCnt ?? "-";
              const comp = item.compIdx ?? item.competition ?? "-";
              tr.innerHTML = `<td>${name}</td><td>${pc}</td><td>${mobile}</td><td>${comp}</td>`;
              tbody.appendChild(tr);
            });
            table.style.display = "table";
          } else {
            showOutput(out, data);
          }
        } catch (e) {
          showError(out, e);
        } finally {
          setLoading(kwBtn, false);
        }
      });
      kwClear?.addEventListener("click", () => {
        const info = document.getElementById("keywordInfo");
        const out = document.getElementById("keywordOutput");
        const table = document.getElementById("keywordTable");
        const tbody = table?.querySelector("tbody");
        document.getElementById("keywordInput").value = "";
        info.textContent = "";
        showOutput(out, "");
        if (tbody) tbody.innerHTML = "";
        table.style.display = "none";
      });

      // Unify ChatGPT quick search handlers (top + card)
      function bindChatForm({ formId, inputId, submitId, outId, chipScope }) {
        const form = document.getElementById(formId);
        const input = document.getElementById(inputId);
        const submit = document.getElementById(submitId);
        const out = document.getElementById(outId);
        form?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const message = (input?.value || "").trim();
          if (!message) {
            showError(out, { message: "검색어를 입력하세요." });
            return;
          }
          setLoading(submit, true, "검색 중...");
          out.style.display = "block";
          showOutput(out, "");
          try {
            const res = await fetch(`/api/chat`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message }),
            });
            const data = await readJsonSafely(res);
            if (!res.ok || data.success === false) throw data;
            showOutput(out, data.reply || data);
          } catch (e) {
            showError(out, e);
          } finally {
            setLoading(submit, false);
          }
        });
        if (chipScope) {
          document
            .querySelectorAll(`${chipScope} .ns-chip`)
            ?.forEach((chip) => {
              chip.addEventListener("click", () => {
                const q = chip.getAttribute("data-q") || "";
                if (input) input.value = q;
                form?.dispatchEvent(new Event("submit"));
              });
            });
        }
      }

      bindChatForm({
        formId: "naverChatForm",
        inputId: "naverChatInput",
        submitId: "naverChatSubmit",
        outId: "chatSearchOutput",
        chipScope: ".naver-search",
      });

      bindChatForm({
        formId: "topNaverChatForm",
        inputId: "topNaverChatInput",
        submitId: "topNaverChatSubmit",
        outId: "topChatSearchOutput",
        chipScope: ".top-search",
      });

      // 강제 적용: 일부 기기에서 캐시/브라우저 이슈로 CSS가 즉시 반영되지 않는 문제 보완
      (function enforceMobileLayout() {
        const isMobile = window.matchMedia("(max-width: 768px)").matches;
        if (!isMobile) return;
        // 1) 히어로 배너 숨김
        const hero = document.querySelector(".hero");
        if (hero) hero.classList.add("is-hidden");
        // 2) 기능 아이콘 5등분 그리드 강제(일부 브라우저 캐시 이슈 대응)
        const topApps = document.querySelector(".top-actions-row .top-apps");
        if (topApps) {
          topApps.style.display = "grid";
          topApps.style.gridTemplateColumns = "repeat(5, 1fr)";
          topApps.style.gap = "12px";
          topApps.style.overflow = "hidden";
        }
      })();

      // 로그인 상태 확인 및 UI 업데이트 (즉시 실행)
      (function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        const userData = localStorage.getItem("userData");

        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const userEmailSpan = document.getElementById("userEmail");
        const logoutBtn = document.getElementById("logoutBtn");

        if (isLoggedIn === "true" && userData) {
          try {
            const user = JSON.parse(userData);

            // 로그인 버튼 숨기기
            if (loginBtn) loginBtn.style.display = "none";
            if (signupBtn) signupBtn.style.display = "none";

            // 사용자 정보 및 로그아웃 버튼 표시
            if (userEmailSpan) {
              userEmailSpan.textContent = user.email || user.name || "사용자";
              userEmailSpan.style.display = "inline";
            }
            if (logoutBtn) {
              logoutBtn.style.display = "inline-block";

              // 로그아웃 버튼 클릭 이벤트
              logoutBtn.addEventListener("click", function () {
                if (confirm("로그아웃 하시겠습니까?")) {
                  localStorage.removeItem("isLoggedIn");
                  localStorage.removeItem("userData");
                  location.href = "index.html";
                }
              });
            }
          } catch (e) {
            console.error("로그인 정보 파싱 오류:", e);
            // 오류 발생 시 로그인 정보 초기화
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("userData");
          }
        } else {
          // 로그인하지 않은 상태 - 로그인/회원가입 버튼 표시
          if (loginBtn) loginBtn.style.display = "inline-block";
          if (signupBtn) signupBtn.style.display = "inline-block";
          if (userEmailSpan) userEmailSpan.style.display = "none";
          if (logoutBtn) logoutBtn.style.display = "none";
        }
      })();
    </script>
  </body>
</html>
