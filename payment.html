<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://*.supabase.co https://naver-keyword-tool.onrender.com wss://*.supabase.co; img-src 'self' data: https:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; font-src 'self' data:; frame-ancestors 'self'; base-uri 'self'; form-action 'self'" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <title>ê²°ì œí•˜ê¸° - ì‚¬ì¥í”½</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2303c75a'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' font-family='Arial' fill='white'%3ESP%3C/text%3E%3C/svg%3E" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .payment-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
      color: #333;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .plan-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .plan-name {
      font-size: 20px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 10px;
    }
    .plan-details {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      color: #555;
    }
    .price {
      font-size: 32px;
      font-weight: 700;
      color: #333;
      margin: 20px 0;
    }
    .payment-methods {
      margin-bottom: 30px;
    }
    .payment-method {
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .payment-method:hover {
      border-color: #667eea;
    }
    .payment-method.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .payment-method input[type="radio"] {
      width: 20px;
      height: 20px;
    }
    .btn-payment {
      width: 100%;
      padding: 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-payment:hover {
      background: #5a67d8;
    }
    .btn-payment:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .terms {
      font-size: 12px;
      color: #999;
      text-align: center;
      margin-top: 20px;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .payment-container {
        padding: 30px 20px;
        border-radius: 16px;
      }

      h1 {
        font-size: 24px;
      }

      .subtitle {
        font-size: 14px;
      }

      .plan-info {
        padding: 16px;
      }

      .plan-name {
        font-size: 18px;
      }

      .price {
        font-size: 28px;
      }

      .btn-payment {
        padding: 14px;
        font-size: 16px;
      }
    }

    @media (max-width: 360px) {
      body {
        padding: 5px;
      }

      .payment-container {
        padding: 20px 15px;
        border-radius: 12px;
      }

      h1 {
        font-size: 20px;
      }

      .subtitle {
        font-size: 12px;
      }

      .plan-info {
        padding: 12px;
      }

      .plan-name {
        font-size: 16px;
      }

      .price {
        font-size: 24px;
      }

      .btn-payment {
        padding: 12px;
        font-size: 14px;
      }

      .payment-method {
        padding: 12px;
      }
    }

    /* í”Œëœ ì„ íƒ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .plan-card {
      transition: all 0.3s ease;
    }

    .plan-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }

    .plan-card:active {
      transform: translateY(-4px);
    }
  </style>
  <!-- Meta Pixel Code -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '823098897158597');
    fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=823098897158597&ev=PageView&noscript=1"
  /></noscript>
  <!-- End Meta Pixel Code -->
</head>
<body>
  <!-- í”Œëœ ì„ íƒ í™”ë©´ -->
  <div class="payment-container" id="planSelectionContainer" style="display: none; max-width: 900px;">
    <h1>í”Œëœ ì„ íƒ</h1>
    <p class="subtitle">ì›í•˜ëŠ” í”Œëœì„ ì„ íƒí•˜ê³  ê²°ì œí•˜ì„¸ìš”</p>
    
    <div id="planSelectionGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
      <!-- í”Œëœ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
      <div class="loading" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
        <div class="spinner"></div>
        <p style="margin-top: 15px;">í”Œëœ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </div>
  </div>

  <!-- ê²°ì œ í™”ë©´ -->
  <div class="payment-container" id="paymentContainer">
    <h1>êµ¬ë… í”Œëœ ê²°ì œ</h1>
    <p class="subtitle">ë” ë§ì€ AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”</p>
    
    <div class="plan-info">
      <div class="plan-name" id="planName">íŒŒì›Œ í”Œëœ</div>
      <div class="plan-details">
        <span>ì›”ê°„ í† í°</span>
        <strong id="tokenAmount">500 í† í°</strong>
      </div>
      <div class="plan-details">
        <span>ë¸”ë¡œê·¸ ì‘ì„± ê°€ëŠ¥ íšŸìˆ˜</span>
        <strong>ì•½ 15-20íšŒ</strong>
      </div>
      <div class="plan-details">
        <span>ë¦¬ë·° ë‹µê¸€</span>
        <strong>ì•½ 50-100íšŒ</strong>
      </div>
    </div>

    <div class="price">
      <span id="priceAmount">30,000</span>ì›
    </div>

    <div class="payment-methods">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0; font-size: 16px;">ê²°ì œ ë°©ë²• ì„ íƒ</h3>
        <button id="registerCardBtn" class="btn-register-card" onclick="openCardRegisterModal()" style="padding: 8px 16px; background: #f0f4ff; color: #667eea; border: 1px solid #667eea; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
          <i class="fas fa-plus"></i> ë‚´ ì¹´ë“œ ë“±ë¡í•˜ê¸°
        </button>
      </div>
      
      <!-- ë“±ë¡ëœ ì¹´ë“œ ëª©ë¡ -->
      <div id="registeredCards" style="margin-bottom: 15px;">
        <!-- ì¹´ë“œ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
      </div>
      
      <!-- ì¼ë°˜ ê²°ì œ ë°©ë²• -->
      <div id="generalPaymentMethods">
        <label class="payment-method selected">
          <input type="radio" name="method" value="card" checked>
          <span>ğŸ’³ ì‹ ìš©/ì²´í¬ì¹´ë“œ (ì¼íšŒì„±)</span>
        </label>
        
        <label class="payment-method">
          <input type="radio" name="method" value="transfer">
          <span>ğŸ¦ ê³„ì¢Œì´ì²´</span>
        </label>
        
        <label class="payment-method">
          <input type="radio" name="method" value="phone">
          <span>ğŸ“± íœ´ëŒ€í° ê²°ì œ</span>
        </label>
      </div>
    </div>

    <!-- ì¹´ë“œ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="cardRegisterModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; font-size: 22px; color: #333;">ì¹´ë“œ ë“±ë¡í•˜ê¸°</h2>
          <button onclick="closeCardRegisterModal()" style="background: none; border: none; font-size: 24px; color: #999; cursor: pointer;">&times;</button>
        </div>
        
        <form id="cardRegisterForm" onsubmit="registerCard(event)">
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ì¹´ë“œ ë³„ì¹­</label>
            <input type="text" id="cardAlias" placeholder="ì˜ˆ: ì£¼ ì¹´ë“œ, íšŒì‚¬ ì¹´ë“œ" 
                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" required>
            <small style="color: #999; font-size: 12px;">ë‚˜ì¤‘ì— ì‰½ê²Œ êµ¬ë¶„í•  ìˆ˜ ìˆë„ë¡ ë³„ì¹­ì„ ì…ë ¥í•˜ì„¸ìš”</small>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ì¹´ë“œë²ˆí˜¸</label>
            <input type="text" id="cardNumber" placeholder="1234-5678-9012-3456" 
                   maxlength="19" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" required>
            <small style="color: #999; font-size: 12px;">í•˜ì´í”ˆ(-) ì—†ì´ ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš”</small>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ìœ íš¨ê¸°ê°„</label>
              <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5"
                     style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" required>
            </div>
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">CVC</label>
              <input type="text" id="cardCvc" placeholder="123" maxlength="4"
                     style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" required>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ì¹´ë“œ ë¹„ë°€ë²ˆí˜¸ ì• 2ìë¦¬</label>
            <input type="password" id="cardPassword" placeholder="**" maxlength="2"
                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" required>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="setAsDefault" style="width: 18px; height: 18px;">
              <span style="font-size: 14px; color: #333;">ê¸°ë³¸ ì¹´ë“œë¡œ ì„¤ì •</span>
            </label>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button type="button" onclick="closeCardRegisterModal()" 
                    style="flex: 1; padding: 14px; background: #f5f5f5; color: #333; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
              ì·¨ì†Œ
            </button>
            <button type="submit" 
                    style="flex: 1; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
              ë“±ë¡í•˜ê¸°
            </button>
          </div>
        </form>
      </div>
    </div>

    <button class="btn-payment" onclick="processPayment()">
      ê²°ì œí•˜ê¸°
    </button>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p style="margin-top: 15px;">ê²°ì œ ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <p class="terms">
      ê²°ì œí•˜ê¸°ë¥¼ í´ë¦­í•˜ë©´ <a href="/terms">ì´ìš©ì•½ê´€</a> ë° 
      <a href="/privacy">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.
    </p>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" integrity="sha384-GFr3yTh5lJznCbZfpTtXnwboFsxqtTQoeTZCRHhE0579KrRmlCzen5AA8ohaB5ug" crossorigin="anonymous"></script>
  <script src="/assets/auth-state.js?v=202410" defer></script>
  
  <script>
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ í”Œëœ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    let plan = urlParams.get('plan');
    
    let pricingData = null;
    let tokenData = null;
    
    // í˜ì´ì§€ ì´ˆê¸°í™”
    window.addEventListener('load', async function() {
      // ê°€ê²© ë° í† í° ì„¤ì • ë¡œë“œ
      await loadPlanSettings();
      
      // plan íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ê²°ì œ í™”ë©´, ì—†ìœ¼ë©´ í”Œëœ ì„ íƒ í™”ë©´
      if (plan) {
        showPaymentScreen(plan);
      } else {
        showPlanSelectionScreen();
      }
      
      // ë“±ë¡ëœ ì¹´ë“œ ëª©ë¡ ë¡œë“œ
      await loadRegisteredCards();
    });

    // í”Œëœ ì„¤ì • ë¡œë“œ (ê°€ê²© ë° í† í°)
    async function loadPlanSettings() {
      try {
        const [pricingRes, tokenRes] = await Promise.all([
          fetch('/api/subscription/pricing-config'),
          fetch('/api/subscription/token-config')
        ]);

        const pricingResult = await pricingRes.json();
        const tokenResult = await tokenRes.json();

        if (pricingResult.success) {
          pricingData = pricingResult.pricing;
        }
        if (tokenResult.success) {
          tokenData = tokenResult.tokens;
        }
      } catch (error) {
        console.error('í”Œëœ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // í”Œëœ ì„ íƒ í™”ë©´ í‘œì‹œ
    function showPlanSelectionScreen() {
      document.getElementById('planSelectionContainer').style.display = 'block';
      document.getElementById('paymentContainer').style.display = 'none';
      
      renderPlanSelection();
    }

    // ê²°ì œ í™”ë©´ í‘œì‹œ
    function showPaymentScreen(selectedPlan) {
      document.getElementById('planSelectionContainer').style.display = 'none';
      document.getElementById('paymentContainer').style.display = 'block';
      
      // í”Œëœ ì •ë³´ í‘œì‹œ
      const planInfo = getPlanInfo(selectedPlan);
      if (planInfo) {
        document.getElementById('planName').textContent = planInfo.name;
        document.getElementById('priceAmount').textContent = planInfo.price === 0 ? 'ë¬´ë£Œ' : planInfo.price.toLocaleString();
        document.getElementById('tokenAmount').textContent = planInfo.tokens.toLocaleString() + ' í† í°';
      }
    }

    // í”Œëœ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    function getPlanInfo(planKey) {
      if (!pricingData || !tokenData) {
        // ê¸°ë³¸ê°’
        const defaults = {
          seed: { name: 'ì”¨ì•— í”Œëœ', price: 0, tokens: 100 },
          power: { name: 'íŒŒì›Œ í”Œëœ', price: 30000, tokens: 500 },
          bigpower: { name: 'ë¹…íŒŒì›Œ í”Œëœ', price: 50000, tokens: 833 },
          premium: { name: 'í”„ë¦¬ë¯¸ì—„ í”Œëœ', price: 70000, tokens: 1166 }
        };
        return defaults[planKey] || null;
      }

      const priceKey = `owner_${planKey}_price`;
      const tokenKey = `owner_${planKey}_limit`;
      
      const planNames = {
        seed: 'ì”¨ì•— í”Œëœ',
        power: 'íŒŒì›Œ í”Œëœ',
        bigpower: 'ë¹…íŒŒì›Œ í”Œëœ',
        premium: 'í”„ë¦¬ë¯¸ì—„ í”Œëœ'
      };

      return {
        name: planNames[planKey] || planKey,
        price: pricingData[priceKey] || 0,
        tokens: tokenData[tokenKey] || 100
      };
    }

    // í”Œëœ ì„ íƒ ì¹´ë“œ ë Œë”ë§
    function renderPlanSelection() {
      const container = document.getElementById('planSelectionGrid');
      if (!container) return;

      const ownerPlans = [
        { key: 'seed', name: 'ì”¨ì•—', icon: 'ğŸŒ±', color: '#16a34a' },
        { key: 'power', name: 'íŒŒì›Œ', icon: 'âš¡', color: '#f59e0b' },
        { key: 'bigpower', name: 'ë¹…íŒŒì›Œ', icon: 'ğŸ’ª', color: '#f97316' },
        { key: 'premium', name: 'í”„ë¦¬ë¯¸ì—„', icon: 'â­', color: '#ec4899' }
      ];

      container.innerHTML = ownerPlans.map(plan => {
        const planInfo = getPlanInfo(plan.key);
        const priceText = planInfo.price === 0 ? 'ë¬´ë£Œ' : `${planInfo.price.toLocaleString()}ì›`;
        
        return `
          <div class="plan-card" onclick="selectPlan('${plan.key}')" 
               style="background: linear-gradient(135deg, ${plan.color}15, ${plan.color}25); 
                      border: 2px solid ${plan.color}; 
                      border-radius: 16px; 
                      padding: 24px; 
                      cursor: pointer; 
                      transition: all 0.3s;
                      text-align: center;">
            <div style="font-size: 48px; margin-bottom: 12px;">${plan.icon}</div>
            <h3 style="font-size: 24px; font-weight: 700; color: #333; margin-bottom: 8px;">${plan.name}</h3>
            <div style="font-size: 28px; font-weight: 700; color: ${plan.color}; margin-bottom: 12px;">
              ${priceText}
            </div>
            <div style="font-size: 14px; color: #666; margin-bottom: 20px;">
              ì›” ${planInfo.tokens.toLocaleString()} í† í°
            </div>
            <button style="width: 100%; padding: 12px; background: ${plan.color}; color: white; 
                          border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
              ì„ íƒí•˜ê¸°
            </button>
          </div>
        `;
      }).join('');
    }

    // í”Œëœ ì„ íƒ
    function selectPlan(planKey) {
      window.location.href = `/payment.html?plan=${planKey}`;
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë“±ë¡ëœ ì¹´ë“œ ëª©ë¡ ë¡œë“œ
    let registeredCards = [];
    let currentUserId = null;

    window.addEventListener('load', async function() {
      await loadRegisteredCards();
    });

    // ë“±ë¡ëœ ì¹´ë“œ ëª©ë¡ ë¡œë“œ
    async function loadRegisteredCards() {
      try {
        // Supabase ì´ˆê¸°í™” ëŒ€ê¸°
        while (!window.authState?.supabase) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        const supabase = window.authState.supabase;
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session) {
          return;
        }

        currentUserId = session.user.id;

        const response = await fetch('/api/payment/cards', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            registeredCards = result.cards || [];
            renderRegisteredCards();
          }
        }
      } catch (error) {
        console.error('ì¹´ë“œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ë“±ë¡ëœ ì¹´ë“œ ë Œë”ë§
    function renderRegisteredCards() {
      const container = document.getElementById('registeredCards');
      if (!container) return;

      if (registeredCards.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = registeredCards.map((card, index) => `
        <label class="payment-method ${card.is_default ? 'selected' : ''}" style="position: relative;">
          <input type="radio" name="method" value="saved_card_${card.id}" ${card.is_default ? 'checked' : ''}>
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div>
              <span>ğŸ’³ ${card.card_alias || 'ë“±ë¡ëœ ì¹´ë“œ'}</span>
              <div style="font-size: 12px; color: #999; margin-top: 4px;">
                ${card.card_number || '****-****-****-****'} ${card.card_company ? 'Â· ' + card.card_company : ''}
                ${card.is_default ? '<span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">ê¸°ë³¸</span>' : ''}
              </div>
            </div>
            <button onclick="deleteCard('${card.id}', event)" 
                    style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px 8px; font-size: 12px;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </label>
      `).join('');

      // ê²°ì œ ë°©ë²• ì„ íƒ ì´ë²¤íŠ¸ ë‹¤ì‹œ ë°”ì¸ë”©
      document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', function() {
          document.querySelectorAll('.payment-method').forEach(m => {
            m.classList.remove('selected');
          });
          this.classList.add('selected');
          const input = this.querySelector('input');
          if (input) input.checked = true;
        });
      });
    }

    // ì¹´ë“œ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
    function openCardRegisterModal() {
      document.getElementById('cardRegisterModal').style.display = 'flex';
    }

    // ì¹´ë“œ ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸°
    function closeCardRegisterModal() {
      document.getElementById('cardRegisterModal').style.display = 'none';
      document.getElementById('cardRegisterForm').reset();
    }

    // ì¹´ë“œ ë“±ë¡
    async function registerCard(event) {
      event.preventDefault();

      try {
        // Supabase ì´ˆê¸°í™” ëŒ€ê¸°
        while (!window.authState?.supabase) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        const supabase = window.authState.supabase;
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }

        const cardData = {
          card_alias: document.getElementById('cardAlias').value.trim(),
          card_number: document.getElementById('cardNumber').value.replace(/-/g, ''),
          card_expiry: document.getElementById('cardExpiry').value,
          card_cvc: document.getElementById('cardCvc').value,
          card_password: document.getElementById('cardPassword').value,
          is_default: document.getElementById('setAsDefault').checked
        };

        // ì¹´ë“œë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬ (ê°„ë‹¨í•œ ì²´í¬)
        if (cardData.card_number.length < 13 || cardData.card_number.length > 19) {
          alert('ì˜¬ë°”ë¥¸ ì¹´ë“œë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        const response = await fetch('/api/payment/cards', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify(cardData)
        });

        const result = await response.json();

        if (result.success) {
          alert('ì¹´ë“œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
          closeCardRegisterModal();
          await loadRegisteredCards();
        } else {
          throw new Error(result.error || 'ì¹´ë“œ ë“±ë¡ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('ì¹´ë“œ ë“±ë¡ ì˜¤ë¥˜:', error);
        alert('ì¹´ë“œ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // ì¹´ë“œ ì‚­ì œ
    async function deleteCard(cardId, event) {
      event.stopPropagation();
      
      if (!confirm('ë“±ë¡ëœ ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        // Supabase ì´ˆê¸°í™” ëŒ€ê¸°
        while (!window.authState?.supabase) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        const supabase = window.authState.supabase;
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }

        const response = await fetch(`/api/payment/cards/${cardId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          }
        });

        const result = await response.json();

        if (result.success) {
          alert('ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          await loadRegisteredCards();
        } else {
          throw new Error(result.error || 'ì¹´ë“œ ì‚­ì œ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('ì¹´ë“œ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ì¹´ë“œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // ì¹´ë“œë²ˆí˜¸ ìë™ í¬ë§·íŒ…
    document.addEventListener('DOMContentLoaded', function() {
      const cardNumberInput = document.getElementById('cardNumber');
      if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          let formatted = value.match(/.{1,4}/g)?.join('-') || value;
          if (formatted.length > 19) formatted = formatted.substring(0, 19);
          e.target.value = formatted;
        });
      }

      // ìœ íš¨ê¸°ê°„ ìë™ í¬ë§·íŒ…
      const cardExpiryInput = document.getElementById('cardExpiry');
      if (cardExpiryInput) {
        cardExpiryInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
          }
          e.target.value = value;
        });
      }

      // CVC ìˆ«ìë§Œ ì…ë ¥
      const cardCvcInput = document.getElementById('cardCvc');
      if (cardCvcInput) {
        cardCvcInput.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/\D/g, '');
        });
      }

      // ì¹´ë“œ ë¹„ë°€ë²ˆí˜¸ ìˆ«ìë§Œ ì…ë ¥
      const cardPasswordInput = document.getElementById('cardPassword');
      if (cardPasswordInput) {
        cardPasswordInput.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/\D/g, '');
        });
      }
    });

    // ê²°ì œ ë°©ë²• ì„ íƒ
    document.querySelectorAll('.payment-method').forEach(method => {
      method.addEventListener('click', function() {
        document.querySelectorAll('.payment-method').forEach(m => {
          m.classList.remove('selected');
        });
        this.classList.add('selected');
        this.querySelector('input').checked = true;
      });
    });
    
    // ê²°ì œ ì²˜ë¦¬
    async function processPayment() {
      if (!plan) {
        alert('í”Œëœì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const methodInput = document.querySelector('input[name="method"]:checked');
      if (!methodInput) {
        alert('ê²°ì œ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const method = methodInput.value;
      const selectedCardId = method.startsWith('saved_card_') ? method.replace('saved_card_', '') : null;
      
      // ë¡œë”© í‘œì‹œ
      document.getElementById('loading').style.display = 'block';
      document.querySelector('.btn-payment').disabled = true;
      
      try {
        // Supabase ì´ˆê¸°í™” ëŒ€ê¸° (auth-state.jsì—ì„œ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”)
        while (!window.authState?.supabase) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        const supabase = window.authState.supabase;
        
        // ì‚¬ìš©ì ì„¸ì…˜ í™•ì¸
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session) {
          window.location.href = '/login.html?redirect=/payment.html?plan=' + plan;
          return;
        }
        
        const user = session.user;
        
        // ê²°ì œ ìš”ì²­ ìƒì„±
        // ì¤‘ìš”: ì„œë²„ì—ì„œ í”Œëœ ì •ë³´ì™€ ê°€ê²©ì„ ë‹¤ì‹œ ê²€ì¦í•¨
        // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚¸ ì •ë³´ëŠ” ì‹ ë¢°í•˜ì§€ ì•ŠìŒ
        const response = await fetch('/api/payment/payment-handler', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            action: 'create-payment',
            userId: user.id,
            planType: plan,  // ì„œë²„ì—ì„œ ê²€ì¦ë¨
            paymentMethod: selectedCardId ? 'saved_card' : method,
            cardId: selectedCardId || null
          })
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'ê²°ì œ ìš”ì²­ ì‹¤íŒ¨');
        }
        
        // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™ (ë˜ëŠ” í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
        if (result.paymentUrl.includes('test-success')) {
          // í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ìë™ ì™„ë£Œ
          alert('í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ê²°ì œê°€ ìë™ìœ¼ë¡œ ì™„ë£Œë©ë‹ˆë‹¤');
          window.location.href = `/payment-success.html?orderId=${result.orderId}`;
        } else {
          // ì‹¤ì œ PGì‚¬ ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
          window.location.href = result.paymentUrl;
        }
        
      } catch (error) {
        console.error('ê²°ì œ ì˜¤ë¥˜:', error);
        alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        
        // ë¡œë”© ìˆ¨ê¸°ê¸°
        document.getElementById('loading').style.display = 'none';
        document.querySelector('.btn-payment').disabled = false;
      }
    }
  </script>
</body>
</html>
