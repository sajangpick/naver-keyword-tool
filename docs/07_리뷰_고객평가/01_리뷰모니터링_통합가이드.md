# 🔍 리뷰 모니터링 시스템 통합 문서

> **최종 업데이트**: 2025-11-01  
> **버전**: 2.0 (통합판)  
> **상태**: ✅ 구현 완료  

---

## 📋 목차

### Part 1: 사용자 가이드
1. [개요](#개요)
2. [회원 사용법](#회원-사용법)
3. [관리자 사용법](#관리자-사용법)
4. [알림 설정](#알림-설정)

### Part 2: 개발 문서
5. [시스템 아키텍처](#시스템-아키텍처)
6. [API 레퍼런스](#api-레퍼런스)
7. [데이터베이스 스키마](#데이터베이스-스키마)

### Part 3: 개발 현황
8. [구현 완료 내역](#구현-완료-내역)
9. [테스트 가이드](#테스트-가이드)
10. [문제 해결](#문제-해결)

---

# Part 1: 사용자 가이드

## 개요

### 🎯 시스템 목적
식당 사장님을 위한 네이버 플레이스 리뷰 자동 수집 및 알림 시스템

### ⚡ 주요 기능

#### 1. **자동 리뷰 수집**
- 네이버 플레이스 리뷰 자동 크롤링
- 매일 3회 실행 (오전 9시, 오후 2시, 저녁 8시)
- 4종류 수집: 방문자 리뷰, 영수증 리뷰, 블로그 리뷰, 새소식

#### 2. **즉시 알림**
- 🚨 1-2점 저평점 → 긴급 알림
- ⭐ 5점 고평점 → 칭찬 알림
- 🔑 특정 키워드 → 키워드 알림
- 📊 일일 요약 → 매일 저녁 9시

#### 3. **AI 답변 생성**
- 리뷰별 맞춤 답변 자동 생성
- 감정 분석 기반 톤 조절
- 즉시 복사 가능

---

## 회원 사용법

### 1️⃣ 플레이스 URL 등록

1. 마이페이지 접속
2. "리뷰 모니터링" 섹션
3. 네이버 플레이스 URL 입력
   ```
   예시: https://place.naver.com/restaurant/1234567890
   ```
4. "모니터링 시작" 클릭

### 2️⃣ 알림 설정

#### 카카오톡 알림
1. 전화번호 등록 (010-XXXX-XXXX)
2. 알림 종류 선택
   - ✅ 긴급 알림 (1-2점)
   - ✅ 칭찬 알림 (5점)
   - ✅ 일일 요약

#### 알림 시간
- 실시간: 긴급/칭찬 알림
- 매일 저녁 9시: 일일 요약

### 3️⃣ 리뷰 확인

#### 리뷰 목록
- 최신순 정렬
- 평점별 필터
- 답변 여부 표시

#### AI 답변 사용
1. 리뷰 클릭
2. "AI 답변 생성" 버튼
3. 생성된 답변 확인
4. "복사" 버튼 → 네이버에 붙여넣기

---

## 관리자 사용법

### 1️⃣ 모니터링 대시보드

**접속 경로**: `/admin/review-monitoring.html`

#### 주요 지표
- 총 모니터링 회원 수
- 오늘 수집된 리뷰
- 긴급 대응 필요 리뷰
- 평균 응답 시간

### 2️⃣ 회원별 설정

#### 발송 제한 설정
```
일일 발송 제한:
- 0회: 알림 OFF
- 1회: 중요 알림만
- 2회: 모든 알림
```

#### 키워드 설정
- 회원별 맞춤 키워드
- 긍정/부정 키워드 구분
- 알림 우선순위 설정

### 3️⃣ 시스템 관리

#### 크론 작업 모니터링
- 다음 실행 시간
- 마지막 실행 결과
- 오류 로그 확인

#### 수동 실행
```javascript
// 긴급 시 수동 크롤링
POST /api/review-monitoring?action=manual&userId={userId}
```

---

## 알림 설정

### 📱 카카오톡 알림톡

#### 필수 설정
1. 카카오 비즈니스 채널 개설
2. 알림톡 템플릿 등록
3. API 키 설정

#### 템플릿 예시

**긴급 리뷰 알림**
```
[사장픽] 긴급 리뷰 알림 🚨

#{place_name}에 새 리뷰가 등록되었습니다.

평점: #{rating}점
내용: #{review_content}

▶ 지금 확인하기
```

**일일 요약**
```
[사장픽] 오늘의 리뷰 요약 📊

총 #{total_count}개의 리뷰
평균 평점: #{avg_rating}점

✅ 자세히 보기
```

---

# Part 2: 개발 문서

## 시스템 아키텍처

### 🏗️ 전체 구조

```
┌─────────────────┐
│   프론트엔드    │
│  (사용자/관리자) │
└────────┬────────┘
         │
┌────────▼────────┐
│    API 서버     │
│  (Node.js)      │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌──────┐  ┌──────┐
│Crawler│  │  DB  │
│(Puppr)│  │(Supa)│
└──────┘  └──────┘
```

### 📂 파일 구조

```
/api/
├── review-monitoring.js     # 메인 API
├── cron/
│   └── review-monitoring.js # 정기 실행
└── generate-reply.js        # AI 답변

/database/
└── schemas/
    └── features/
        └── review/          # 리뷰 스키마

/admin/
└── review-monitoring.html   # 관리자 페이지
```

---

## API 레퍼런스

### 1. 리뷰 크롤링 API

```javascript
POST /api/review-monitoring
```

#### Parameters
| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| action | string | ✅ | crawl, get, update |
| userId | string | ✅ | 사용자 ID |
| placeId | string | ❓ | 네이버 플레이스 ID |

#### Response
```json
{
  "success": true,
  "data": {
    "visitor": 15,
    "blog": 8,
    "receipt": 3,
    "news": 2,
    "total": 28,
    "new": 5,
    "alerts": 2
  }
}
```

### 2. AI 답변 생성 API

```javascript
POST /api/generate-reply
```

#### Parameters
```json
{
  "reviewContent": "리뷰 내용",
  "rating": 5,
  "storeName": "우리 가게"
}
```

#### Response
```json
{
  "success": true,
  "reply": "생성된 답변...",
  "tone": "grateful",
  "keywords": ["맛", "서비스"]
}
```

### 3. 알림 발송 API

```javascript
POST /api/kakao-alimtalk
```

#### Parameters
```json
{
  "type": "urgent_review",
  "userId": "user-id",
  "data": {
    "review": {...}
  }
}
```

---

## 데이터베이스 스키마

### 📊 테이블 구조

#### 1. review_monitoring_settings
```sql
CREATE TABLE review_monitoring_settings (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users,
  place_id VARCHAR(20),
  place_url TEXT,
  place_name VARCHAR(100),
  
  -- 알림 설정
  alert_enabled BOOLEAN DEFAULT true,
  daily_alert_limit INTEGER DEFAULT 2,
  alert_count_today INTEGER DEFAULT 0,
  last_alert_date DATE,
  
  -- 크롤링 정보
  last_crawled_at TIMESTAMP,
  total_reviews INTEGER DEFAULT 0,
  
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 2. review_monitoring_data
```sql
CREATE TABLE review_monitoring_data (
  id UUID PRIMARY KEY,
  monitoring_id UUID REFERENCES review_monitoring_settings,
  
  -- 리뷰 정보
  review_type VARCHAR(20), -- visitor, blog, receipt, news
  review_id VARCHAR(50) UNIQUE,
  rating INTEGER,
  content TEXT,
  reviewer_name VARCHAR(50),
  reviewed_at TIMESTAMP,
  
  -- 알림 정보
  alert_sent BOOLEAN DEFAULT false,
  alert_sent_at TIMESTAMP,
  
  -- AI 답변
  ai_reply TEXT,
  reply_posted BOOLEAN DEFAULT false,
  
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 3. review_alerts
```sql
CREATE TABLE review_alerts (
  id UUID PRIMARY KEY,
  monitoring_id UUID,
  review_id UUID,
  
  alert_type VARCHAR(20), -- urgent, praise, keyword
  priority INTEGER,
  
  -- 발송 정보
  kakao_sent BOOLEAN DEFAULT false,
  email_sent BOOLEAN DEFAULT false,
  
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

# Part 3: 개발 현황

## 구현 완료 내역

### ✅ 완료된 기능 (100%)

#### Phase 1: 크롤링 ✅
- [x] 방문자 리뷰 크롤링
- [x] 블로그 리뷰 크롤링  
- [x] 영수증 리뷰 크롤링
- [x] 새소식 크롤링

#### Phase 2: 저장 ✅
- [x] DB 스키마 설계
- [x] 중복 체크 로직
- [x] 신규 리뷰만 저장
- [x] 히스토리 관리

#### Phase 3: 알림 ✅
- [x] 조건별 알림 분류
- [x] 발송 제한 체크
- [x] 카카오톡 연동
- [x] 일일 요약

#### Phase 4: AI ✅
- [x] ChatGPT 연동
- [x] 톤 분석
- [x] 맞춤 답변
- [x] 키워드 추출

#### Phase 5: 관리자 ✅
- [x] 대시보드
- [x] 회원 관리
- [x] 통계
- [x] 수동 실행

---

## 테스트 가이드

### 1️⃣ 단위 테스트

```bash
# 크롤링 테스트
curl -X POST http://localhost:5000/api/review-monitoring \
  -H "Content-Type: application/json" \
  -d '{"action":"crawl","userId":"test-user","placeId":"1234567890"}'
```

### 2️⃣ 통합 테스트

#### 시나리오 A: 신규 회원
```
1. URL 등록
2. 초기 크롤링
3. 데이터 확인
4. 알림 OFF 확인
```

#### 시나리오 B: 긴급 알림
```
1. 1점 리뷰 생성
2. 크롤링 실행
3. 알림 발송 확인
4. 제한 체크
```

### 3️⃣ 부하 테스트

```javascript
// 동시 크롤링 테스트
const promises = [];
for (let i = 0; i < 10; i++) {
  promises.push(crawlReviews(userId[i]));
}
await Promise.all(promises);
```

---

## 문제 해결

### ❌ 자주 발생하는 오류

#### 1. 크롤링 실패
```
Error: Timeout exceeded
```
**해결**: timeout 값 증가 (30초 → 60초)

#### 2. 중복 알림
```
Error: Duplicate alert sent
```
**해결**: alert_sent 플래그 확인

#### 3. API 한도 초과
```
Error: ChatGPT rate limit
```
**해결**: 재시도 로직 구현

### 🔧 디버깅 팁

#### 로그 확인
```sql
-- 최근 크롤링 로그
SELECT * FROM review_monitoring_logs
ORDER BY created_at DESC
LIMIT 100;
```

#### 수동 리셋
```sql
-- 일일 카운트 리셋
UPDATE review_monitoring_settings
SET alert_count_today = 0,
    last_alert_date = CURRENT_DATE - 1
WHERE user_id = 'xxx';
```

---

## 📈 성능 최적화

### 크롤링 최적화
- 병렬 처리: 4종 동시 크롤링
- 캐싱: 24시간 캐시
- 증분 크롤링: 신규만 수집

### DB 최적화
- 인덱스: review_id, user_id
- 파티셔닝: 월별 분할
- 정리: 3개월 이상 자동 삭제

### API 최적화
- Rate Limiting: 분당 60회
- 큐 시스템: Bull Queue
- 재시도: 3회, 지수 백오프

---

## 🚀 향후 계획

### v2.1 (2025 Q1)
- [ ] 인스타그램 연동
- [ ] 배민 리뷰 연동
- [ ] 실시간 알림

### v2.2 (2025 Q2)
- [ ] 감성 분석 고도화
- [ ] 리뷰 트렌드 분석
- [ ] 경쟁사 비교

---

## 📞 지원

### 문의처
- 기술 문의: dev@sajangpick.co.kr
- 버그 리포트: GitHub Issues
- 긴급 지원: 카카오톡 채널

---

*이 문서는 리뷰_모니터링_가이드.md, 리뷰_모니터링_완료.md, 리뷰모니터링_개발가이드.md를 통합한 버전입니다.*
