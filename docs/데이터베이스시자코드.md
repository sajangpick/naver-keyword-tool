-- 확장 기능 활성화 (UUID 생성을 위함)
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 1. 사용자 프로필 및 회원 등급 관리 테이블 (auth.users와 연결)
-- Supabase Auth를 사용하면 'users' 테이블은 자동 생성되므로, 추가 정보는 'profiles'에 저장합니다.
CREATE TABLE public.profiles (
  id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name text,
  business_name text,
  kakao_id text UNIQUE,
  membership_level text NOT NULL DEFAULT 'free', -- 회원 등급: free, standard, premium 등
  monthly_blog_limit integer NOT NULL DEFAULT 0, -- 월간 블로그 작성 가능 횟수
  monthly_review_limit integer NOT NULL DEFAULT 0, -- 월간 리뷰 답글 작성 가능 횟수
  last_payment_date timestamp with time zone,
  created_at timestamp with time zone DEFAULT now() NOT NULL,

  PRIMARY KEY (id)
);

-- RLS (Row Level Security) 설정 (필수 권장)
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public profiles are viewable by everyone." ON public.profiles FOR SELECT USING (TRUE);
CREATE POLICY "Users can insert their own profile." ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Users can update their own profile." ON public.profiles FOR UPDATE USING (auth.uid() = id);


-- 2. 영수증 리뷰 작성 관리 테이블 (가장 먼저 구축)
CREATE TABLE public.review_responses (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, -- 사용자 ID
  naver_place_url text NOT NULL, -- 네이버 플레이스 URL 주소
  owner_keywords text[], -- 사장님 추천 키워드 (PostgreSQL 배열 타입)
  customer_review text NOT NULL, -- 고객이 작성한 실제 리뷰 내용
  ai_response text NOT NULL, -- AI가 작성한 답글 내용
  is_completed boolean NOT NULL DEFAULT TRUE, -- 답글 생성 완료 여부
  created_at timestamp with time zone DEFAULT now() NOT NULL
);

-- RLS (Row Level Security) 설정
ALTER TABLE public.review_responses ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage their own review responses." ON public.review_responses
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);


-- 3. 블로그 작업 관리 테이블 (향후 확장)
CREATE TABLE public.blog_posts (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  target_platform text,
  keywords text[],
  blog_title text,
  blog_content text,
  status text NOT NULL DEFAULT 'draft', -- draft, pending, published
  created_at timestamp with time zone DEFAULT now() NOT NULL
);

-- RLS (Row Level Security) 설정
ALTER TABLE public.blog_posts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage their own blog posts." ON public.blog_posts
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);


-- 4. 네이버 파워클릭 키워드 관리 테이블 (향후 확장)
CREATE TABLE public.ad_keywords (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  keyword text NOT NULL UNIQUE,
  monthly_search_volume integer,
  competition_level text, -- low, medium, high
  last_analysis_date date,
  created_at timestamp with time zone DEFAULT now() NOT NULL
);

-- RLS (Row Level Security) 설정
ALTER TABLE public.ad_keywords ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage their own ad keywords." ON public.ad_keywords
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);