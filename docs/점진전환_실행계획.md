# 점진 전환 실행 계획 (실서비스 61% 트래픽 기준)

본 문서는 현재 Express + 정적 HTML 구조를 Next.js(App Router) 기반 단일 스택으로 단계적으로 전환하기 위한 실제 실행용 체크리스트다. 각 단계는 독립 수행과 즉시 롤백이 가능하도록 설계했다. 이 문서는 작업 순서·검증 기준·롤백 방법을 포함하며, 변경 작업은 이 문서의 하위 체크리스트를 기준으로만 수행한다.

---

## 실행 대시보드

| 지표        | 값                                           |
| ----------- | -------------------------------------------- |
| 현재 사용량 | 33%                                          |
| 중단 기준   | 95% 도달 전 즉시 중지 및 보고                |
| 현재 단계   | Phase 0 진행중                               |
| 최근 변경   | 실행 대시보드/세이프가드/변경 로그 섹션 추가 |

### 결정 사항(Phase 0 기준)

- CORS/웹 도메인: https://www.sajangpick.co.kr, https://sajangpick.co.kr
- 알림 이메일: ohdaejun@naver.com (발신 방식 추후 확정)
- CSP 화이트리스트(초안): gstatic, fonts.googleapis.com, fonts.gstatic.com, kauth.kakao.com, kapi.kakao.com

## 세이프가드

- 사용량이 90% 이상: 경고 알림 및 작업 속도 조절
- 사용량이 95% 도달 직전: 즉시 작업 중지, 진행 상황 보고
- 오류율/타임아웃 급증: 중지 후 롤백 수행(Phase/라우트 단위)
- 롤백 절차: 기능 토글 OFF → 기존 Express 경로 100% 복귀

---

## 승급 게이트(SLO/조건)

- SLO 목표(기본): 오류율 < 1%, P95 응답시간 < 800ms, 타임아웃율 < 1%
- 인증 품질: 로그인 성공률 기존 대비 ±1%p 이내 유지
- 승급/롤백 기준:
  - 승급: 1시간 관측치가 SLO 충족, 이슈 미발생, 스모크 테스트 통과
  - 롤백: 오류율 +0.5%p 초과 또는 P95 +20%p 초과 또는 사용자 불만 급증 시 즉시 토글 OFF

---

## 공통 원칙

- 작은 배포, 빠른 관측, 즉시 롤백(Feature Flag/Route Switch)
- 모든 신규 라우트는 기존 경로(`/api/*`) 유지, 응답 포맷 표준화(JSON)
- 관측 필수: 오류율(4xx/5xx), P95 응답시간, 로그인 성공률, 전환율, 사용자 피드백
- 롤백 단위: 단계별 1분 내 트래픽 스위치로 원복

환경 변수 표준(.env/.env.local)

- 서버 전용: OPENAI*API_KEY, GEMINI_API_KEY, CLAUDE_API_KEY, NAVER*\_, SUPABASE\_\_, UPSTASH\_\* (클라이언트 노출 금지)
- 예시 파일: `docs/env.example.md`

### 보안 (현재 상태 및 체크리스트)

현황(적용됨)

- Kakao OAuth: state를 HttpOnly+SameSite=Lax(프로덕션은 Secure) 쿠키로 발급/검증, 콜백 후 즉시 삭제; 토큰은 클라이언트에 저장하지 않음
- CORS: Origin을 `CORS_ORIGIN` 환경변수로 제어(미설정 시 \*)
- trust proxy 활성화, 요청 바디 10MB 제한, 전역/404 에러 핸들러, 레이트리밋(`/api`, `/auth` 적용)
- helmet 기본 보안 헤더 적용 + CSP Report-Only 도입(`/csp-report` 수집), ENV 기반 Enforce 토글(`CSP_ENFORCE`)
- JWT 세션 쿠키 발급: Kakao 콜백에서 HS256 JWT 발급(httponly+secure in prod, SameSite=Lax), `/auth/me`, `/auth/logout` 제공
- 입력 정화/검증 강화 및 로그 PII 최소화, 프로덕션 와일드카드 CORS 경고
- HSTS(프로덕션), CSP Report rate-limit, 프로덕션에서 404 엔드포인트 노출 축소

다음 작업(권장)

- [ ] 배포 도메인 확정 후 CORS Origin 고정(스테이징/프로덕 별도)
- [ ] helmet CSP 정책 강화(Report-Only → Enforce, 스크립트 nonce 도입)
  - 롤아웃 계획:
    1. 1차: `CSP_ENFORCE=false` 상태에서 nonce 적용 코드 배포(무중단)
    2. 2차: 외부 도메인 화이트리스트 정리(script/img/style/connect)
    3. 3차: 일부 경로만 Enforce(캔어리 10%) → 50% → 100%
    4. 4차: Report 노이즈 1주 모니터링 후 디폴트 Enforce 전환
    5. 실패 시 즉시 `CSP_ENFORCE=false`로 롤백
  - 구현 체크리스트: 인라인 이벤트 핸들러 제거, 스크립트/스타일 외부화, SRI 검토
- [ ] 입력 스키마 검증 고도화(스키마 레벨, 주요 POST/GET 파라미터)
- [ ] 로그 민감정보 마스킹 및 보존 정책 수립
- [ ] 키 관리/회전 전략 문서화(권한 최소화)
  - [ ] Client Secret 재발급(회전) 및 노출 키 폐기 기록
  - [ ] 쿠키 정책 확정: Domain/SameSite/`__Host-` 프리픽스 적용 가능성 검토
  - [ ] Referrer-Policy(strict-origin-when-cross-origin) 적용
  - [ ] Permissions-Policy 최소 허용(카메라/마이크 등 비활성)
  - [ ] /csp-report 샘플링/허용목록 운영 메모 추가

담당/기한

| Task                         | Owner     | Due |
| ---------------------------- | --------- | --- |
| CORS Origin 고정             | 오대준    | D+1 |
| CSP Enforce/Nonce 도입       | Assistant | D+3 |
| 입력 스키마 검증 고도화      | Assistant | D+3 |
| 로그 민감정보/보존 정책 수립 | 오대준    | D+3 |
| 키 관리/회전 전략 문서화     | 오대준    | D+5 |

### 추가 운영/보안 계획(보강)

- 관측/알림: Sentry 등 에러 추적, 구조적 로그(요청 ID), 대시보드 링크 및 알림 채널 명시, 에러 버짓(P95/P99, 오류율) 목표 설정
- 런북/롤백: 95% 임계 도달 시 단계별 조치, 기능 토글/배포 롤백 스크립트와 스모크 테스트 절차 문서화
- 시크릿/권한: 환경별 시크릿 저장소 사용 및 접근 권한/감사 로깅, 키 회전 주기/절차 수립
- 테스트: 핵심 플로우 E2E(로그인/회원가입/콜백) 자동화, 합격 기준, 스테이징-프로덕 패리티 체크리스트
- CSRF 범위 확대: 상태 변경 POST 전반에 Origin/Referer 검사 + CSRF 토큰 적용 범위 명시
- OAuth 고도화: PKCE 도입 검토, state/nonce 강화를 위한 암호화, 실패/재시도/차단 로깅 표준화
- 보안 헤더: Referrer-Policy, Permissions-Policy 최소 권한 원칙으로 설정
- 계정 보호: 로그인 시도 레이트리밋(계정/IP) 및 CAPTCHA 트리거 조건 정의
- 데이터 보호: 로그 보존 기간, PII 마스킹 표준, 데이터 지역/백업 복구 전략 명시
- 취약점 스캔: Dependabot/npm audit 등 주기 설정 및 대응 프로세스

담당/기한

| Task                         | Owner     | Due |
| ---------------------------- | --------- | --- |
| 관측/알림 체계               | 오대준    | D+2 |
| 런북/롤백 절차               | 오대준    | D+3 |
| 시크릿/권한/감사             | 오대준    | D+3 |
| 핵심 E2E 테스트              | Assistant | D+3 |
| CSRF 범위 확대               | Assistant | D+2 |
| OAuth PKCE 등 고도화         | Assistant | D+5 |
| Referrer/Permissions-Policy  | Assistant | D+2 |
| 계정보호(레이트리밋/CAPTCHA) | Assistant | D+4 |
| 데이터 보호/백업 복구        | 오대준    | D+7 |
| 취약점 스캔 주기/프로세스    | 오대준    | D+2 |

---

## Phase 0. 준비/관측 설정 (2–4일)

- [ ] 배포/런타임 확정: Vercel(Node 런타임) + 현재 Express 병행 운영
- [ ] 로깅/모니터링: 응답시간·오류율·카운터 대시보드(예: Vercel Analytics, Logtail 등)
- [ ] Feature Flag/Route Switch 설계: 경로 기반(예: /api/chat) + 비율 기반(캔어리 5/20/50/100)
- [ ] ENV 분리: 로컬/스테이징/프로덕션
- 산출물: 관측 대시보드 링크, 스위치 토글 문서

롤백

- 플래그 OFF → 즉시 기존 Express 경로로 100% 복귀

### Phase 0 상세 체크리스트

| Task                                       | Owner     | Due | Status      | Notes                                      |
| ------------------------------------------ | --------- | --- | ----------- | ------------------------------------------ |
| 배포/런타임 전략 확정(Vercel+Express 병행) | 오대준    | D+1 | Todo        | 병행기간/스위치 기준 확정                  |
| 관측 대시보드 개설(오류율/P95/사용량)      | 오대준    | D+1 | In Progress | 알림 임계치 90/95% 설정, CSP 리포트 모니터 |
| 기능 플래그 설계/적용(경로/비율)           | Assistant | D+2 | Todo        | /api 단위/캔어리 전환 플로우               |
| ENV 분리/비밀키 검증                       | Assistant | D+2 | Todo        | 서버 전용 키 노출 점검                     |
| 롤백 스크립트/리허설                       | 오대준    | D+3 | Todo        | 1분 내 복귀 시나리오                       |

승급 조건(Phase 1로 이동 전):

- CORS Origin 고정(프로덕/스테이징)
- 대시보드/알림(90/95%) 활성, 에러 추적 도구 연결
- 스모크 테스트 전 항목 통과, 롤백 스크립트 리허설 완료
- CSP는 Report-Only 유지(Nonce 적용 준비 완료)

---

## Phase 1. 인증 라우팅 분리(카카오 중심) (2–5일)

목표: 로그인/회원가입만 Next(OAuth)로 이동, 나머지는 현행 유지

작업

- [ ] NextAuth(+Kakao) 또는 Supabase Auth(Kakao) 중 선택 및 설정
- [ ] `/login`, `/join` 페이지를 Next로 생성(현재 UI 이식) — 버튼 클릭 시 OAuth 시작
- [ ] 성공 후 기존 도메인으로 리다이렉트(세션/JWT 쿠키 정책 합의)
- [ ] 실패/취소 플로우 UX 반영

검증 기준

- 로그인 성공률 기존 대비 ±1%p 이내
- 오류율 +0.3%p 이내, CS 증가 없음

롤백

- 라우팅 스위치로 `/login`, `/join`을 기존 HTML로 즉시 복귀

### Phase 1 상세 체크리스트

| Task                            | Owner     | Due | Status | Notes                                                                        |
| ------------------------------- | --------- | --- | ------ | ---------------------------------------------------------------------------- |
| Kakao OAuth 환경변수 수집/설정  | 오대준    | D+1 | Todo   | KAKAO_REST_API_KEY, REDIRECT_URI, SECRET                                     |
| 서버 OAuth 엔드포인트 추가      | Assistant | D+1 | Done   | GET /auth/kakao/login, /auth/kakao/callback, GET /auth/me, POST /auth/logout |
| 로그인/회원가입 버튼 링크 연결  | Assistant | D+2 | Todo   | login.html/join.html → 서버 OAuth 시작 URL                                   |
| 콜백 처리 후 리다이렉트 UX/로깅 | Assistant | D+2 | Todo   | 성공/실패/취소 UI, 에러 메시지 표준화, 재시도/지원 동선, 로깅 코릴레이션 ID  |

쿠키/도메인 정책:

- 서브도메인 운영 시 쿠키 domain/path 및 SameSite 전략 합의 필요

---

## Phase 2. 읽기 API 이관(저위험) (2–3일)

대상: `/api/keywords`, `/api/search/local`, `/api/health`

작업

- [ ] 각 API를 Next Route Handlers(앱 라우터 `app/api/*/route.ts`)로 이전
- [ ] 응답 포맷/에러 표준화(코드·메시지·timestamp)
- [ ] ENV 주입 방식 전환 및 비밀키 서버 보호 확인
- [ ] 읽기 API 캐시 전략 수립(ISR/서버 캐시), 무효화 조건 정의
  - 예시: TTL 5~15분, 키: path+쿼리, 무효화: 데이터 갱신/배포 시

검증 기준

- P95 응답시간 기존 대비 +10% 이내, 오류율 유지
- 5% → 20% → 50% → 100% 단계 전환

롤백

- API 라우팅 토글 OFF → Express 경로로 전체 트래픽 복귀

---

## Phase 3. 쓰기/연산 API 이관(중위험) (5–10일)

대상: `/api/chat`, `/api/generate-blog`, `/api/analyze-review`, `/api/generate-reply`

작업

- [ ] 서버리스 타임아웃(10–30초) 고려: 우선 단계 축소 또는 스트리밍 도입
- [ ] 장시간 파이프라인(블로그 3단계)은 임시로 1–2단계로 축소하거나 결과를 짧게
- [ ] 에러·타임아웃 재시도/메시지 일관화
- [ ] 외부 API 타임아웃/재시도(백오프) 표준 수립 및 적용

검증 기준

- 타임아웃율 < 1%, P95 +15% 이내
- 사용자 체감 품질(응답 길이·정확도) 점검

롤백

- API 단위 토글로 즉시 Express 버전으로 복귀

---

## Phase 4. 페이지 전환(SEO/UX) (1–2주)

대상: `ChatGPT.html`, `AI-Review.html`, `Blog-Editor.html`, `naver_search.html`, `place-check.html`, `index.html`

작업

- [ ] 공통 레이아웃/헤더/푸터 컴포넌트화, NAVER 그린 테마 변수 유지
- [ ] 페이지별 `page.tsx` 전환, 정적 리소스는 `public/`로 이동
- [ ] Chart.js/FontAwesome 동작 확인
- [ ] 정적 자원 캐시/압축(immutable, gzip/br) 및 SRI 검토

검증 기준

- LCP/CLS 성능 유지 또는 개선, 주요 전환율 유지

롤백

- 라우팅 토글로 구 HTML 경로로 복귀(필요 시 서브경로 분리 운영)

---

## Phase 5. 데이터/스토리지(있을 경우)

대상: SQLite → Supabase(PostgreSQL)

작업

- [ ] 스키마 정의·마이그레이션 계획 수립(읽기→듀얼라이트→컷오버)
- [ ] Prisma 또는 Supabase Client 도입

검증/롤백

- 읽기만 신DB, 쓰기는 구DB → 검증 후 컷오버
- 오류 시 쓰기차단 후 즉시 구DB로 회귀

---

## 운영 체크리스트(각 단계 공통)

- [ ] 배포 전 유닛테스트/간단 E2E(핵심 플로우) 통과
- [ ] 장애 알림(오류율·지연·타임아웃) 임계치 설정
- [ ] 롤백 스크립트/절차 리허설
- [ ] WAF/DDoS 보호 또는 프록시 레벨 방어 설정 검토/적용
- [ ] CI 파이프라인에 취약점 스캔/린트 게이팅(Dependabot/npm audit/ESLint-Sec)

배포 전 체크리스트(추가)

- [ ] .env 스냅샷(프로덕/스테이징) 저장, 불필요 변수 제거
- [ ] Kakao Redirect URI(콘솔/서버) 완전 일치 재확인
- [ ] smartplace_data.db 백업 및 보관 기간 명시(예: 90일)
- [ ] 약관/개인정보처리방침 실제 URL로 교체 확인(join.html)
- [ ] 기능 플래그 기본 OFF 상태 확인(승급 전)
- [ ] 요청 ID(x-request-id) 로그/알림에 전파 확인

스모크 테스트 합격 기준(수치 명시)

- [ ] /auth/kakao/login → 302(카카오)
- [ ] /auth/me → 200, authenticated=true
- [ ] 핵심 읽기 API → 200, P95 < 800ms(5분 샘플)
- [ ] /csp-report → 204, 과도한 노이즈 없음

롤백 성공 기준

- [ ] 플래그 OFF 후 1분 내 정상 응답(200/302), 오류율 원복

스모크 테스트(승급 전 필수):

- [ ] GET /auth/kakao/login → 302 리다이렉트(Kakao) 확인, kstate/csrf 쿠키 세팅
- [ ] Kakao 콜백 후 /auth/me → authenticated=true, 세션 쿠키 유효
- [ ] POST /auth/logout → 200, 세션/CSRF 쿠키 제거, CSRF/Origin 검증 동작
- [ ] 핵심 읽기 API(예: /api/keywords, /api/search/local) 200 응답, P95<800ms
- [ ] /csp-report → 204, 레이트리밋 정상 동작

---

## 작업 분담 예시(역할)

- FE(Next): 페이지/컴포넌트/Route Handlers 이관, 스타일·접근성 유지
- BE(API): 타임아웃/에러 표준화, 키 관리, 추후 큐/스트리밍 설계
- OPS: 플래그/라우팅/관측/알림, 롤백 운영

---

## 산출물(완료 정의)

- `/docs/점진전환_실행계획.md` 최신화(본 문서)
- 라우팅 스위치/플래그 목록 및 사용 방법
- 모니터링 대시보드 링크
- 전환 전후 성능/품질 비교 리포트

---

## 변경 로그

- 2025-10-11: 실행 대시보드/세이프가드/변경 로그 섹션 추가 (진행률/사용량 모니터링 문맥화)
- 2025-10-11: Phase 0 상세 체크리스트 표 추가
- 2025-10-11: `.env` 예시 파일 추가(`docs/env.example.md`), 서버 feature flag 노출(`/`, `/health`)
- 2025-10-11: Kakao OAuth 엔드포인트 추가(`/auth/kakao/login`, `/auth/kakao/callback`), Phase 1 상세 체크리스트 추가
- 2025-10-11: 대시보드 현재 사용량을 33%로 갱신
- 2025-10-11: 보안 섹션 및 체크리스트 추가(helmet, state 쿠키, CORS 등)
- 2025-10-11: CSP Report-Only, JWT 세션(/auth/me,/auth/logout), /auth 레이트리밋, 입력 검증/로그 최소화 반영
- 2025-10-11: ENV `CSP_ENFORCE` 도입, 레이트리밋 주기 청소 추가
- 2025-10-11: 프로덕션 도메인 확정: https://www.sajangpick.co.kr (CORS/Kakao Redirect 반영)

---

## 부록: 토글 예시(개발 메모)

- `FEATURE_AUTH_NEXT=true` → `/login`, `/join` Next 라우팅
- `FEATURE_API_CHAT_NEXT=true` → `/api/chat` Next 라우팅
- `FEATURE_API_READ_NEXT=true` → 읽기 API 일괄 전환

> 주의: 실제 구현 시 런타임 변수/프록시 라우터 또는 에지 미들웨어로 적용.

---

## 기능 플래그/라우팅 토글(운영)

- AUTH: `FEATURE_AUTH_NEXT` (login/join 라우팅 전환)
- API_CHAT: `FEATURE_API_CHAT_NEXT` (/api/chat 전환)
- API_READ: `FEATURE_API_READ_NEXT` (읽기 API 일괄 전환)

운영 규칙

- 승급: 10% → 50% → 100% 순으로 단계 전환, 단계 간 최소 관측 1시간
- 롤백: 오류율/P95 임계 초과 즉시 OFF, 1분 내 복귀

---

## CSP 화이트리스트(초안) 및 Nonce 준비

- defaultSrc: 'self'
- scriptSrc: 'self' https://www.gstatic.com (Firebase)
- styleSrc: 'self' 'unsafe-inline' (Nonce 도입 후 제거) https://fonts.googleapis.com (옵션)
- fontSrc: 'self' https://fonts.gstatic.com (옵션)
- imgSrc: 'self' data: https:
- connectSrc: 'self' https://kauth.kakao.com https://kapi.kakao.com

Nonce 준비 체크리스트

- [ ] 인라인 스크립트/이벤트 핸들러 제거(파일 외부화)
- [ ] 서버에서 요청별 nonce 생성 및 메타 주입
- [ ] script/style 태그에 nonce 적용
- [ ] Report-Only에서 에러 수집 후 Enforce로 전환

---

## 롤백 체크리스트(요약)

사전

- [ ] 기능 플래그 목록과 기본 OFF 상태 확인
- [ ] 스모크 테스트 스크립트 준비

실행

- [ ] 플래그 OFF → 기존 경로 복귀
- [ ] 헬스/핵심 API 스모크(내부) 확인
- [ ] 에러 로그 정상화 확인

사후

- [ ] 원인 기록/대응 계획 수립
- [ ] 재발 방지 항목을 체크리스트에 반영
