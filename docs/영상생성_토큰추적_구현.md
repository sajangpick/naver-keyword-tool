# 🎬 영상 생성 토큰 추적 시스템 구현

## 📋 개요

영상 생성 기능에 토큰 추적 시스템을 추가하여 사용자의 토큰 한도에서 차감되도록 구현했습니다.

## ✅ 구현 내용

### 1. 토큰 추적 모듈 import
- `api/middleware/token-tracker` 모듈을 server.js에 추가
- `trackTokenUsage`, `checkTokenLimit` 함수 사용

### 2. Gemini 1.5 Pro 이미지 분석 토큰 추적
- **위치**: `generateVideoPromptWithGemini()` 함수
- **토큰 사용량**: API 응답의 `usageMetadata`에서 추출
  - `promptTokenCount`: 입력 토큰
  - `candidatesTokenCount`: 출력 토큰
  - `totalTokenCount`: 총 토큰
- **추적 시점**: 이미지 분석 및 프롬프트 생성 완료 후
- **API 타입**: `gemini-image-analysis`

### 3. Gemini Veo 영상 생성 비용 추적
- **위치**: `generateVideoWithGeminiVeo()` 함수
- **비용 환산**:
  - Veo 3 Fast: 초당 $0.15
  - 8초 영상: $1.20
  - 토큰 환산: $1 ≈ 833 토큰
  - **최종**: 8초 영상 = 약 **1,000 토큰**
- **추적 시점**: 영상 생성 완료 후
- **API 타입**: `gemini-veo-video`

### 4. 토큰 한도 사전 체크
- **위치**: `/api/shorts/generate` API 엔드포인트
- **예상 토큰**: 1,500 토큰
  - Gemini 이미지 분석: 약 500 토큰
  - Veo 영상 생성 환산: 약 1,000 토큰
- **체크 시점**: 영상 생성 시작 전
- **한도 초과 시**: 403 에러 반환 및 영상 생성 중단

## 📊 토큰 사용량 요약

| 단계 | 기능 | 예상 토큰 | 추적 상태 |
|------|------|----------|----------|
| 1단계 | Gemini 1.5 Pro 이미지 분석 | 약 500 토큰 | ✅ 추적됨 |
| 2단계 | Gemini Veo 영상 생성 | 약 1,000 토큰 | ✅ 추적됨 |
| **총계** | **영상 1개 생성** | **약 1,500 토큰** | ✅ **추적됨** |

## 🔍 코드 변경 사항

### 1. server.js 상단에 모듈 import 추가
```javascript
const { trackTokenUsage, checkTokenLimit } = require("./api/middleware/token-tracker");
```

### 2. generateVideoPromptWithGemini 함수 수정
- `userId` 파라미터 추가
- API 응답에서 토큰 사용량 추출
- `trackTokenUsage()` 호출 추가

### 3. generateVideoWithGeminiVeo 함수 수정
- `userId` 파라미터 추가
- Veo 비용을 토큰으로 환산
- `trackTokenUsage()` 호출 추가

### 4. 영상 생성 API에 한도 체크 추가
- 영상 생성 전 예상 토큰 체크
- 한도 초과 시 403 에러 반환

## 📝 로그 예시

```
✅ [토큰 체크] 예상 토큰 1500 확인 완료 (남은 토큰: 8500)
✅ [토큰 추적] Gemini 이미지 분석: 487 토큰 사용 (남은 토큰: 8013)
💰 [Veo 비용] 8초 영상 생성: $1.20 (토큰 환산: 1000 토큰)
✅ [토큰 추적] Gemini Veo 영상 생성: 1000 토큰 사용 (남은 토큰: 7013)
```

## ⚠️ 주의사항

1. **토큰 환산률**: Veo 비용을 토큰으로 환산할 때 $1 ≈ 833 토큰으로 계산합니다. 이는 OpenAI 기준이며, 실제 비용 구조에 따라 조정 가능합니다.

2. **토큰 추적 실패 처리**: 토큰 추적에 실패해도 영상 생성은 계속 진행됩니다. 서비스 중단을 방지하기 위한 안전장치입니다.

3. **한도 체크**: 영상 생성 전 예상 토큰을 체크하므로, 한도를 초과한 사용자는 영상 생성을 시작할 수 없습니다.

## 🔄 다음 단계

1. **실제 사용량 모니터링**: 실제 사용량을 모니터링하여 환산률 조정
2. **사용자 알림**: 토큰 사용량이 높을 때 사용자에게 알림
3. **비용 최적화**: Veo 모델 선택 옵션 추가 (Veo 3 vs Veo 3 Fast)

---

**작성일**: 2025-01-20
**버전**: 1.0.0

