# 🎭 관리자/매니저 역할 시스템 통합 가이드

> **최종 업데이트**: 2025-11-01  
> **상태**: ✅ 구현 완료  

---

## 📋 목차

1. [시스템 개요](#시스템-개요)
2. [회원 등급 체계](#회원-등급-체계)
3. [권한 상세](#권한-상세)
4. [설정 방법](#설정-방법)
5. [사용 가이드](#사용-가이드)
6. [테스트 방법](#테스트-방법)

---

## 시스템 개요

사장픽 프로젝트의 4단계 회원등급 시스템입니다.

### 🎯 변경 내역
```
이전 (3단계):              →    현재 (4단계):
├─ 식당 대표                    ├─ 식당 대표 (user)
├─ 대행사/블로그                ├─ 대행사/블로그 (agency)
└─ 관리자                       ├─ 매니저 (manager) ⭐ NEW
                                └─ 관리자 (admin)
```

---

## 회원 등급 체계

### 1. 🍽️ **식당 대표** (user)
- 일반 회원
- AI 도구 사용
- 마이페이지 접근

### 2. 🏢 **대행사/블로그** (agency)
- 여러 매장 관리
- 대량 크롤링
- 리포트 생성

### 3. 👔 **매니저** (manager) 
- **고객 지원 업무**
  - 회원 정보 조회/수정
  - 토큰 충전/조정
  - 구독 관리
  - 카카오톡 발송
- **제한 사항**
  - 시스템 설정 불가
  - 매니저 임명 불가
  - 삭제 권한 제한

### 4. 👑 **관리자** (admin)
- **모든 권한**
  - 매니저 임명/해제
  - 시스템 설정
  - 데이터 삭제
  - 모든 매니저 권한 포함

---

## 권한 상세

### 권한 테이블

| 기능 | 식당대표 | 대행사 | 매니저 | 관리자 |
|------|----------|---------|---------|---------|
| **회원 관리** |
| 회원 목록 조회 | ❌ | ❌ | ✅ | ✅ |
| 회원 정보 수정 | ❌ | ❌ | ✅ | ✅ |
| 회원 삭제 | ❌ | ❌ | ❌ | ✅ |
| **구독/토큰** |
| 토큰 충전/조정 | ❌ | ❌ | ✅ | ✅ |
| 구독 설정 | ❌ | ❌ | ✅ | ✅ |
| **시스템** |
| 매니저 임명 | ❌ | ❌ | ❌ | ✅ |
| 시스템 설정 | ❌ | ❌ | ❌ | ✅ |
| DB 직접 접근 | ❌ | ❌ | ❌ | ✅ |

---

## 설정 방법

### 1. 데이터베이스 설정

```sql
-- Supabase SQL Editor에서 실행
ALTER TABLE profiles 
ADD COLUMN IF NOT EXISTS role VARCHAR(20) DEFAULT 'user';

-- role 값: 'user', 'agency', 'manager', 'admin'
```

### 2. 매니저 임명 (관리자만)

1. `/admin/member-management.html` 접속
2. 회원 목록에서 대상 선택
3. "매니저 임명" 버튼 클릭
4. 즉시 적용

### 3. 관리자 설정

```sql
-- 최초 관리자는 수동으로 설정
UPDATE profiles 
SET role = 'admin' 
WHERE email = 'admin@sajangpick.co.kr';
```

---

## 사용 가이드

### 매니저 업무 프로세스

#### 1️⃣ 회원 지원
```
회원 문의 → 매니저 대시보드 → 회원 검색 → 정보 확인/수정 → 처리 완료
```

#### 2️⃣ 토큰 충전
```
충전 요청 → 회원 찾기 → 토큰 조정 → 히스토리 기록 → 알림 발송
```

#### 3️⃣ 구독 관리
```
구독 변경 → 플랜 선택 → 적용 → 자동 갱신 설정 → 확인
```

### 페이지별 접근 권한

| 페이지 | URL | 매니저 | 관리자 |
|--------|-----|---------|---------|
| 회원 관리 | `/admin/member-management.html` | ✅ | ✅ |
| 토큰 대시보드 | `/admin/pages/token-dashboard.html` | ✅ | ✅ |
| 구독 설정 | `/admin/pages/subscription-settings.html` | ✅ | ✅ |
| 권한 관리 | `/admin/pages/admin-permissions.html` | ❌ | ✅ |
| DB 뷰어 | `/admin/db-view.html` | ❌ | ✅ |
| 성능 모니터링 | `/admin/performance.html` | ✅ | ✅ |
| 오류 로그 | `/admin/errors.html` | ✅ | ✅ |

---

## 테스트 방법

### 1. 권한 테스트

```javascript
// 콘솔에서 실행
const response = await fetch('/api/auth/me');
const user = await response.json();
console.log('현재 권한:', user.role);
```

### 2. 매니저 권한 확인

1. 매니저 계정 로그인
2. `/admin` 접속
3. 허용된 메뉴만 표시되는지 확인
4. 제한된 페이지 접근 시 차단 확인

### 3. 시나리오 테스트

#### 시나리오 A: 토큰 충전
```
1. 매니저 로그인
2. 회원 관리 페이지
3. 회원 선택
4. 토큰 10,000개 충전
5. 성공 메시지 확인
```

#### 시나리오 B: 권한 차단
```
1. 매니저 로그인
2. /admin/pages/admin-permissions.html 접근 시도
3. "권한이 없습니다" 메시지 확인
4. 홈으로 리다이렉트 확인
```

---

## 🔧 문제 해결

### Q: 매니저가 페이지에 접근할 수 없음
- profiles 테이블의 role 확인
- 로그아웃 후 재로그인
- 브라우저 캐시 삭제

### Q: 권한 변경이 적용되지 않음
- 세션 새로고침 필요
- F5 또는 재로그인

### Q: 관리자 권한을 잃어버림
```sql
-- Supabase에서 직접 복구
UPDATE profiles 
SET role = 'admin' 
WHERE id = 'your-user-id';
```

---

## 📌 중요 사항

1. **보안**
   - 매니저는 삭제 권한 없음
   - 시스템 설정 접근 차단
   - 모든 작업 로그 기록

2. **운영**
   - 매니저는 2-3명 적정
   - 정기적인 권한 검토
   - 이상 활동 모니터링

3. **백업**
   - 권한 변경 전 백업
   - 관리자는 최소 2명 유지
   - 비상 복구 절차 준비

---

## 📞 지원

문제 발생 시:
1. 이 문서 확인
2. 시스템 로그 확인
3. 관리자 문의

---

*이 문서는 관리자_권한_설정.md와 관리자_권한_요약.md를 통합한 버전입니다.*
