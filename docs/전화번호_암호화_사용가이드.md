# μ „ν™”λ²νΈ μ•”νΈν™” μ‚¬μ© κ°€μ΄λ“

## π“‹ κ°μ”

κ³ κ° κ°μΈμ •λ³΄ λ³΄νΈλ¥Ό μ„ν•΄ μ „ν™”λ²νΈλ¥Ό AES-256 μ•κ³ λ¦¬μ¦(Fernet)μΌλ΅ μ•”νΈν™”ν•μ—¬ μ €μ¥ν•©λ‹λ‹¤.

## π—οΈ μ‹μ¤ν… κµ¬μ΅°

```
μ‚¬μ©μ μ…λ ¥ (010-6664-3744)
    β†“
[Node.js API] β†’ encryptPhoneNumber()
    β†“
[Python CipherService] β†’ Fernet.encrypt()
    β†“
μ•”νΈν™”λ λ¬Έμμ—΄ (gAAAAABk...) β†’ DB μ €μ¥
```

μ΅°ν μ‹μ—λ” μ—­μμΌλ΅ λ³µνΈν™”ν•©λ‹λ‹¤.

## π“¦ μ„¤μΉ λ° μ„¤μ •

### 1. Python ν¨ν‚¤μ§€ μ„¤μΉ

```bash
cd scraping
pip install -r requirements.txt
```

λλ”

```bash
pip install cryptography python-dotenv
```

### 2. SECRET_KEY μ„¤μ •

`.env` νμΌμ— `SECRET_KEY`λ¥Ό μ¶”κ°€ν•μ„Έμ”. μμ„Έν• λ‚΄μ©μ€ [SECRET_KEY_μ„¤μ •_κ°€μ΄λ“.md](./SECRET_KEY_μ„¤μ •_κ°€μ΄λ“.md)λ¥Ό μ°Έκ³ ν•μ„Έμ”.

```env
SECRET_KEY=μ—¬κΈ°μ—_μƒμ„±ν•_ν‚¤_μ…λ ¥
```

### 3. λ°μ΄ν„°λ² μ΄μ¤ ν…μ΄λΈ” μƒμ„±

Supabase SQL Editorμ—μ„ λ‹¤μ νμΌμ„ μ‹¤ν–‰ν•μ„Έμ”:

```
database/schemas/features/analytics/sales-data-schema.sql
```

## π’» μ‚¬μ© λ°©λ²•

### κΈ°λ³Έ μ‚¬μ©λ²•

#### Node.jsμ—μ„ μ‚¬μ©

```javascript
const { encryptPhoneNumber, decryptPhoneNumber } = require('./api/utils/cipher');

// μ•”νΈν™”
const encrypted = await encryptPhoneNumber('010-6664-3744');
console.log(encrypted); // gAAAAABk...

// λ³µνΈν™”
const decrypted = await decryptPhoneNumber(encrypted);
console.log(decrypted); // 010-6664-3744
```

#### Pythonμ—μ„ μ§μ ‘ μ‚¬μ©

```python
from api.utils.cipher_service import CipherService

# μ„λΉ„μ¤ μ΄κΈ°ν™”
cipher = CipherService()

# μ•”νΈν™”
encrypted = cipher.encrypt("010-6664-3744")
print(encrypted)  # gAAAAABk...

# λ³µνΈν™”
decrypted = cipher.decrypt(encrypted)
print(decrypted)  # 010-6664-3744
```

#### CLIμ—μ„ μ‚¬μ©

```bash
# μ•”νΈν™”
python api/utils/cipher_service.py encrypt "010-6664-3744"

# λ³µνΈν™”
python api/utils/cipher_service.py decrypt "gAAAAABk..."
```

### λ§¤μ¶ λ°μ΄ν„° API μ‚¬μ© μμ‹

`api/sales-data.js`λ¥Ό μ‚¬μ©ν•μ—¬ λ§¤μ¶ λ°μ΄ν„°λ¥Ό μ €μ¥/μ΅°νν•  μ μμµλ‹λ‹¤.

```javascript
const { saveSalesData, getSalesData } = require('./api/sales-data');

// λ§¤μ¶ λ°μ΄ν„° μ €μ¥ (μ „ν™”λ²νΈ μλ™ μ•”νΈν™”)
await saveSalesData(userId, {
  saleDate: '2024-01-15',
  saleAmount: 50000,
  paymentMethod: 'card',
  customerPhone: '010-6664-3744', // μλ™μΌλ΅ μ•”νΈν™”λ¨
  customerName: 'ν™κΈΈλ™',
  menuItems: [{ name: 'μ§μ¥λ©΄', price: 5000 }]
});

// λ§¤μ¶ λ°μ΄ν„° μ΅°ν (μ „ν™”λ²νΈ μλ™ λ³µνΈν™”)
const result = await getSalesData(userId, {
  startDate: '2024-01-01',
  endDate: '2024-01-31',
  limit: 100
});
// result.data[0].customerPhone -> λ³µνΈν™”λ μ „ν™”λ²νΈ
```

### Express API μ—”λ“ν¬μΈνΈ μμ‹

```javascript
// server.jsμ— μ¶”κ°€
const { saveSalesData, getSalesData } = require('./api/sales-data');

// λ§¤μ¶ λ°μ΄ν„° μ €μ¥
app.post('/api/sales-data', async (req, res) => {
  try {
    const userId = req.user.id; // μΈμ¦λ μ‚¬μ©μ ID
    const result = await saveSalesData(userId, req.body);
    res.json(result);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// λ§¤μ¶ λ°μ΄ν„° μ΅°ν
app.get('/api/sales-data', async (req, res) => {
  try {
    const userId = req.user.id;
    const result = await getSalesData(userId, req.query);
    res.json(result);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

## π”’ λ³΄μ• μ£Όμμ‚¬ν•­

1. **SECRET_KEY λ³΄νΈ**
   - `.env` νμΌμ€ μ λ€ Gitμ— μ»¤λ°‹ν•μ§€ λ§μ„Έμ”
   - μ΄μ ν™κ²½μ—μ„λ” ν™κ²½λ³€μλ΅ κ΄€λ¦¬ν•μ„Έμ”
   - ν‚¤κ°€ λ…Έμ¶λλ©΄ λ¨λ“  μ•”νΈν™”λ λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•  μ μμµλ‹λ‹¤

2. **λ΅κ·Έμ— λ³µνΈν™”λ μ „ν™”λ²νΈ μ¶λ ¥ κΈμ§€**
   ```javascript
   // β λ‚μ μ
   console.log('μ „ν™”λ²νΈ:', decryptedPhone);
   
   // β… μΆ‹μ€ μ
   console.log('μ „ν™”λ²νΈ μ €μ¥ μ™„λ£');
   ```

3. **API μ‘λ‹µμ— μ£Όμ**
   - μ „ν™”λ²νΈλ” ν•„μ”ν• κ²½μ°μ—λ§ λ³µνΈν™”ν•μ—¬ λ°ν™
   - λ¶ν•„μ”ν• κ²½μ° μ•”νΈν™”λ μƒνƒλ΅ λ°ν™ν•λ” κ²ƒμ„ κ³ λ ¤

4. **λ°μ΄ν„°λ² μ΄μ¤ μ ‘κ·Ό μ μ–΄**
   - RLS(Row Level Security) μ •μ±…μ΄ μ μ©λμ–΄ μμµλ‹λ‹¤
   - μ‚¬μ©μλ” μμ‹ μ λ°μ΄ν„°λ§ μ΅°ν/μμ •ν•  μ μμµλ‹λ‹¤

## π§ ν…μ¤νΈ

### 1. μ•”νΈν™”/λ³µνΈν™” ν…μ¤νΈ

```bash
# μ•”νΈν™” ν…μ¤νΈ
python api/utils/cipher_service.py encrypt "010-6664-3744"

# κ²°κ³Όλ¥Ό λ³µμ‚¬ν•μ—¬ λ³µνΈν™” ν…μ¤νΈ
python api/utils/cipher_service.py decrypt "gAAAAABk..."
```

### 2. Node.js ν†µν•© ν…μ¤νΈ

```javascript
// test-cipher.js
const { encryptPhoneNumber, decryptPhoneNumber } = require('./api/utils/cipher');

async function test() {
  const original = '010-6664-3744';
  console.log('μ›λ³Έ:', original);
  
  const encrypted = await encryptPhoneNumber(original);
  console.log('μ•”νΈν™”:', encrypted);
  
  const decrypted = await decryptPhoneNumber(encrypted);
  console.log('λ³µνΈν™”:', decrypted);
  
  console.log('ν…μ¤νΈ κ²°κ³Ό:', original === decrypted ? 'β… μ„±κ³µ' : 'β μ‹¤ν¨');
}

test();
```

## π”„ λ§μ΄κ·Έλ μ΄μ… (κΈ°μ΅΄ λ°μ΄ν„° μ•”νΈν™”)

κΈ°μ΅΄μ— ν‰λ¬ΈμΌλ΅ μ €μ¥λ μ „ν™”λ²νΈκ°€ μλ” κ²½μ°:

```sql
-- 1. κΈ°μ΅΄ λ°μ΄ν„° ν™•μΈ
SELECT id, customer_phone FROM sales_data WHERE customer_phone IS NOT NULL;

-- 2. Python μ¤ν¬λ¦½νΈλ΅ μΌκ΄„ μ•”νΈν™” ν›„ μ—…λ°μ΄νΈ
-- (λ³„λ„ λ§μ΄κ·Έλ μ΄μ… μ¤ν¬λ¦½νΈ μ‘μ„± ν•„μ”)
```

## π“ κ΄€λ ¨ νμΌ

- μ•”νΈν™” μ„λΉ„μ¤ (Python): `api/utils/cipher_service.py`
- Node.js μ ν‹Έλ¦¬ν‹°: `api/utils/cipher.js`
- λ§¤μ¶ λ°μ΄ν„° API: `api/sales-data.js`
- λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§: `database/schemas/features/analytics/sales-data-schema.sql`
- SECRET_KEY μ„¤μ • κ°€μ΄λ“: `docs/SECRET_KEY_μ„¤μ •_κ°€μ΄λ“.md`

## β“ λ¬Έμ  ν•΄κ²°

### Q: "SECRET_KEYκ°€ μ„¤μ •λμ§€ μ•μ•μµλ‹λ‹¤" μ¤λ¥

A: `.env` νμΌμ— `SECRET_KEY`λ¥Ό μ¶”κ°€ν•μ„Έμ”. [SECRET_KEY_μ„¤μ •_κ°€μ΄λ“.md](./SECRET_KEY_μ„¤μ •_κ°€μ΄λ“.md)λ¥Ό μ°Έκ³ ν•μ„Έμ”.

### Q: "Python μ¤ν¬λ¦½νΈ μ‹¤ν–‰ μ‹¤ν¨" μ¤λ¥

A: 
1. Pythonμ΄ μ„¤μΉλμ–΄ μλ”μ§€ ν™•μΈ: `python --version`
2. cryptography ν¨ν‚¤μ§€ μ„¤μΉ: `pip install cryptography`
3. Python μ¤ν¬λ¦½νΈ κ²½λ΅ ν™•μΈ

### Q: λ³µνΈν™” μ‹¤ν¨

A: 
1. SECRET_KEYκ°€ μ•”νΈν™” μ‹μ™€ λ™μΌν•μ§€ ν™•μΈ
2. μ•”νΈν™”λ λ¬Έμμ—΄μ΄ μ†μƒλμ§€ μ•μ•λ”μ§€ ν™•μΈ
3. λ°μ΄ν„°λ² μ΄μ¤μ—μ„ μ •ν™•ν λ³µμ‚¬ν–λ”μ§€ ν™•μΈ (κ³µλ°±, μ¤„λ°”κΏ λ“±)

## π“ μ§€μ›

λ¬Έμ κ°€ λ°μƒν•λ©΄ λ‹¤μμ„ ν™•μΈν•μ„Έμ”:
1. `.env` νμΌμ `SECRET_KEY` μ„¤μ •
2. Python ν¨ν‚¤μ§€ μ„¤μΉ μ—¬λ¶€
3. λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° μƒνƒ
4. λ΅κ·Έ νμΌμ μ¤λ¥ λ©”μ‹μ§€

