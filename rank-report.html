<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìˆœìœ„ ì¡°íšŒ - ì‚¬ì¥í”½</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --naver-green: #03c75a;
        --naver-green-dark: #02b14f;
        --bg: #f7f9fb;
        --panel: #ffffff;
        --muted: #6b7280;
        --text: #111827;
        --accent: var(--naver-green);
        --border: #e5e7eb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto,
          Noto Sans KR, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }
      h1 {
        font-size: 28px;
        margin: 16px 0;
        color: var(--text);
      }
      .card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        margin-bottom: 20px;
      }
      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid #f3f4f6;
        background: linear-gradient(135deg, #03c75a 0%, #02b14f 100%);
      }
      .card-header .title {
        font-size: 18px;
        font-weight: 700;
        color: #ffffff;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .card-body {
        padding: 24px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 16px;
      }
      label {
        font-size: 13px;
        color: var(--muted);
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
      }
      input[type="text"] {
        width: 100%;
        padding: 12px 14px;
        background: #fff;
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 10px;
        font-size: 14px;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(3, 199, 90, 0.1);
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        flex-wrap: wrap;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: #111827;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s;
      }
      .btn:hover {
        background: #f9fafb;
      }
      .btn.primary {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }
      .btn.primary:hover {
        background: var(--naver-green-dark);
      }
      .hint {
        color: var(--muted);
        font-size: 12px;
        margin-top: 8px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }
      th,
      td {
        padding: 12px 10px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 13px;
        text-align: left;
      }
      th {
        color: #374151;
        font-weight: 700;
        background: #fafafa;
        position: sticky;
        top: 0;
      }
      td {
        color: var(--text);
      }
      .table-container {
        max-height: 600px;
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: 12px;
      }
      .sticky-note {
        border-left: 4px solid var(--accent);
        padding: 16px;
        background: #f0fdf4;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .sticky-note .hint {
        margin: 0;
        font-size: 14px;
        color: #065f46;
      }
      @media (max-width: 768px) {
        .row {
          flex-direction: column;
          align-items: stretch;
        }
        .btn {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="/assets/common-header.js" defer></script>
  </head>
  <body>
    <main class="container" id="app">
      <h1>ğŸ” ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìˆœìœ„ ì¡°íšŒ</h1>

      <div class="sticky-note">
        <div class="hint">
          <i class="fas fa-info-circle"></i> í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê³  <strong>ì‹¤ì‹œê°„ ìƒì„¸ ìˆ˜ì§‘</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ 
          ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ì˜ ì‹¤ì‹œê°„ ìˆœìœ„ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>

      <section class="card">
        <div class="card-header">
          <div class="title">
            <i class="fas fa-search"></i> í‚¤ì›Œë“œ ê²€ìƒ‰
          </div>
        </div>
        <div class="card-body">
          <div class="panel">
            <div class="row">
              <div style="flex: 1;">
                <label>ê²€ìƒ‰í•  í‚¤ì›Œë“œ</label>
                <input
                  id="keyword"
                  type="text"
                  placeholder="ì˜ˆ: ë¶€ì‚°ê³ ê¸°ë§›ì§‘"
                />
                <div class="hint">ë„¤ì´ë²„ì—ì„œ ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
              </div>
              <div style="width: auto;">
                <button
                  class="btn primary"
                  id="crawlFetch"
                  title="ë„¤ì´ë²„ì—ì„œ ìƒì„¸ ì •ë³´ê¹Œì§€ ìˆ˜ì§‘ (í‰ì , ë¦¬ë·°, ì „í™”ë²ˆí˜¸ ë“±)"
                >
                  <i class="fas fa-spider"></i> ì‹¤ì‹œê°„ ìƒì„¸ ìˆ˜ì§‘
                </button>
                <button
                  class="btn"
                  id="crawlCsv"
                  title="ìˆ˜ì§‘ ê²°ê³¼ CSVë¡œ ì €ì¥"
                >
                  <i class="fas fa-download"></i> CSV ë‹¤ìš´ë¡œë“œ
                </button>
              </div>
            </div>
          </div>

          <div class="panel" id="crawlPanel" style="display: none;">
            <div class="hint" style="margin-bottom: 12px;">
              <i class="fas fa-check-circle" style="color: #03c75a;"></i> 
              ë„¤ì´ë²„ ì‹¤ì‹œê°„ í¬ë¡¤ë§ ê²°ê³¼ (ìƒì„¸ ì •ë³´ í¬í•¨)
            </div>
            <div class="table-container">
              <table id="crawlTable">
                <thead>
                  <tr>
                    <th>ìˆœìœ„</th>
                    <th>ì—…ì²´ëª…</th>
                    <th>ì¹´í…Œê³ ë¦¬</th>
                    <th>í‰ì </th>
                    <th>ë°©ë¬¸ìë¦¬ë·°</th>
                    <th>ë¸”ë¡œê·¸ë¦¬ë·°</th>
                    <th>ì£¼ì†Œ</th>
                    <th>ì „í™”ë²ˆí˜¸</th>
                    <th>ì˜ì—…ì‹œê°„</th>
                    <th>í¸ì˜ì‹œì„¤</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      const el = (id) => document.getElementById(id);
      const state = {
        crawl: [],
      };

      // í¬ë¡¤ë§ ì‹¤í–‰
      el("crawlFetch").addEventListener("click", async () => {
        const keyword = el("keyword").value.trim();
        if (!keyword) {
          alert("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }

        const btn = el("crawlFetch");
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìˆ˜ì§‘ ì¤‘...';

        try {
          const res = await fetch("/api/place-detail-crawl", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ keyword, max_scrolls: 6 }),
          });

          const data = await res.json();
          if (!data.success || !data.list) {
            throw new Error(data.error || "ìˆ˜ì§‘ ì‹¤íŒ¨");
          }

          state.crawl = data.list;
          renderCrawlTable();

          el("crawlPanel").style.display = "block";
          alert(`âœ… ${state.crawl.length}ê°œ ì—…ì²´ ì •ë³´ ìˆ˜ì§‘ ì™„ë£Œ!`);
        } catch (err) {
          console.error("í¬ë¡¤ë§ ì˜¤ë¥˜:", err);
          alert("í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n" + err.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-spider"></i> ì‹¤ì‹œê°„ ìƒì„¸ ìˆ˜ì§‘';
        }
      });

      // í¬ë¡¤ë§ ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
      function renderCrawlTable() {
        const tbody = document.querySelector("#crawlTable tbody");
        tbody.innerHTML = "";

        state.crawl.forEach((item, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="text-align: center; font-weight: 700;">${idx + 1}</td>
            <td><strong>${item.place_name || "-"}</strong></td>
            <td>${item.category || "-"}</td>
            <td style="text-align: center;">${item.rating || "-"}</td>
            <td style="text-align: center;">${item.visitor_reviews || "-"}</td>
            <td style="text-align: center;">${item.blog_reviews || "-"}</td>
            <td>${item.address || "-"}</td>
            <td>${item.phone || "-"}</td>
            <td>${item.hours || "-"}</td>
            <td>${item.amenities || "-"}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      // CSV ë‹¤ìš´ë¡œë“œ
      el("crawlCsv").addEventListener("click", () => {
        if (state.crawl.length === 0) {
          alert("ë¨¼ì € í¬ë¡¤ë§ì„ ì‹¤í–‰í•˜ì„¸ìš”.");
          return;
        }

        const keyword = el("keyword").value.trim() || "í‚¤ì›Œë“œ";
        const headers = [
          "ìˆœìœ„",
          "ì—…ì²´ëª…",
          "ì¹´í…Œê³ ë¦¬",
          "í‰ì ",
          "ë°©ë¬¸ìë¦¬ë·°",
          "ë¸”ë¡œê·¸ë¦¬ë·°",
          "ì£¼ì†Œ",
          "ì „í™”ë²ˆí˜¸",
          "ì˜ì—…ì‹œê°„",
          "í¸ì˜ì‹œì„¤",
        ];
        const rows = state.crawl.map((item, idx) => [
          idx + 1,
          item.place_name || "",
          item.category || "",
          item.rating || "",
          item.visitor_reviews || "",
          item.blog_reviews || "",
          item.address || "",
          item.phone || "",
          item.hours || "",
          item.amenities || "",
        ]);

        const csv = Papa.unparse({
          fields: headers,
          data: rows,
        });

        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `ì‚¬ì¥í”½_${keyword}_${new Date().toISOString().split("T")[0]}.csv`;
        link.click();
      });
    </script>
  </body>
</html>

