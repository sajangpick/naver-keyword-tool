<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://*.supabase.co https://naver-keyword-tool.onrender.com https://connect.facebook.net https://www.facebook.com wss://*.supabase.co http://localhost:* http://127.0.0.1:*; img-src 'self' data: https://www.facebook.com https:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://connect.facebook.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; font-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net data:; base-uri 'self'; form-action 'self'" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <title>ë§ˆì´í˜ì´ì§€ - ì‚¬ì¥í”½</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23ff7b54'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' font-family='Arial' fill='white'%3ESP%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" integrity="sha384-GFr3yTh5lJznCbZfpTtXnwboFsxqtTQoeTZCRHhE0579KrRmlCzen5AA8ohaB5ug" crossorigin="anonymous"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
  <style>
    /* ì‚¬ì¥í”½ ë¸Œëœë“œ ìƒ‰ìƒ ë³€ìˆ˜ */
    :root {
      --accent-color: #ff7b54;
      --accent-dark: #e56548;
      --bg-color: #fff7f0;
      --text-primary: #201a17;
      --text-secondary: #7a6a60;
      --secondary: #ffe8d9;
      --white: #ffffff;
      --border: rgba(0, 0, 0, 0.08);
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", Arial, sans-serif;
      background: var(--bg-color);
      min-height: 100vh;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
      flex: 1;
    }

    .page-title {
      font-size: 36px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 8px;
      text-align: center;
      letter-spacing: -0.5px;
    }

    .page-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 40px;
      text-align: center;
      font-weight: 500;
    }

    .profile-section {
      background: var(--white);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 1px solid var(--border);
    }

    .profile-avatar-large {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 36px;
      font-weight: bold;
      box-shadow: 0 8px 24px rgba(255, 123, 84, 0.3);
    }

    .profile-info {
      flex: 1;
    }

    .profile-name {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .profile-email {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 15px;
    }

    .profile-badges {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .badge.owner {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge.agency {
      background: #fef3c7;
      color: #92400e;
    }

    .badge.admin {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge.seed, .badge.power, .badge.big_power, .badge.premium {
      background: #dcfce7;
      color: #166534;
    }

    .badge.elite, .badge.expert, .badge.master, .badge.platinum {
      background: #fce7f3;
      color: #9f1239;
    }

    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
    }

    .section {
      background: var(--white);
      border-radius: 20px;
      padding: 28px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .section:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: var(--accent-color);
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-title i {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
      color: white;
      padding: 24px 20px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(255, 123, 84, 0.2);
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }

    .activity-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .activity-item {
      padding: 16px;
      border-radius: 12px;
      background: var(--secondary);
      margin-bottom: 12px;
      border-left: 4px solid var(--accent-color);
      transition: all 0.3s ease;
    }

    .activity-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-sm);
      background: #ffe0cc;
    }

    .activity-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .activity-content {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .activity-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: #999;
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: var(--white);
      color: var(--text-primary);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-color);
      background: var(--white);
      box-shadow: 0 0 0 3px rgba(255, 123, 84, 0.1);
    }

    .form-input select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 35px;
      cursor: pointer;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255, 123, 84, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(45deg, #6b7280, #4b5563);
      color: white;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(107, 114, 128, 0.4);
    }

    .btn-danger {
      background: linear-gradient(45deg, #ef4444, #dc2626);
      color: white;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--secondary);
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee2e2;
      color: #dc2626;
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid #fecaca;
    }

    .usage-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .usage-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--accent-dark));
      border-radius: 4px;
      transition: width 0.3s;
    }

    .usage-bar-fill.warning {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .usage-bar-fill.danger {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }

    .empty-state i {
      font-size: 48px;
      opacity: 0.3;
      display: block;
      margin-bottom: 12px;
    }

    /* í† í° ì •ë³´ ìŠ¤íƒ€ì¼ */
    .token-status-card {
      background: linear-gradient(135deg, var(--secondary) 0%, #ffe0cc 100%);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 123, 84, 0.1);
    }

    .token-plan {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .plan-name {
      font-size: 24px;
      font-weight: bold;
      color: var(--text-primary);
    }

    .plan-badge {
      background: var(--accent-color);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(255, 123, 84, 0.2);
    }

    .token-meter {
      margin-bottom: 20px;
    }

    .meter-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .meter-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .meter-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .meter-bar {
      width: 100%;
      height: 20px;
      background: var(--secondary);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .meter-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--accent-dark));
      border-radius: 10px;
      transition: width 0.5s ease;
      box-shadow: 0 2px 10px rgba(255, 123, 84, 0.3);
    }

    .meter-percent {
      text-align: right;
      margin-top: 5px;
      font-size: 14px;
      color: var(--accent-color);
      font-weight: 600;
    }

    .token-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    .token-stat {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border-radius: 10px;
    }

    .token-stat i {
      font-size: 20px;
      color: var(--accent-color);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      display: block;
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--text-primary);
    }

    .token-usage-history {
      margin-top: 25px;
    }

    .usage-list {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      max-height: 200px;
      overflow-y: auto;
    }

    .usage-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .usage-item:last-child {
      border-bottom: none;
    }

    .usage-api {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .usage-tokens {
      font-weight: 600;
      color: var(--accent-color);
    }

    .usage-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .btn-upgrade {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
      transition: all 0.3s ease;
    }

    .btn-upgrade:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255, 123, 84, 0.3);
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 12px;
      }

      .page-title {
        font-size: 24px;
      }

      .page-subtitle {
        font-size: 14px;
        margin-bottom: 30px;
      }

      .content-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .profile-section {
        padding: 24px 16px;
        border-radius: 20px;
      }

      .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 20px;
        padding-bottom: 20px;
      }

      .profile-header > div:last-child {
        flex-direction: column;
        width: 100%;
        gap: 10px;
      }

      .profile-header > div:last-child button {
        width: 100%;
      }

      .profile-avatar-large {
        width: 80px;
        height: 80px;
        font-size: 28px;
      }

      .profile-name {
        font-size: 22px;
      }

      .profile-email {
        font-size: 14px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .stat-card {
        padding: 16px 12px;
      }

      .stat-number {
        font-size: 20px;
      }

      .section {
        padding: 20px 16px;
        border-radius: 16px;
      }

      .section-title {
        font-size: 16px;
        margin-bottom: 16px;
      }

      .section-title i {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      .form-input {
        padding: 10px 12px;
        font-size: 14px;
      }

      .btn {
        padding: 10px 20px;
        font-size: 13px;
      }

      .token-status-card {
        padding: 20px 16px;
      }

      .plan-name {
        font-size: 20px;
      }

      .token-stats {
        grid-template-columns: 1fr;
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 16px 10px;
      }

      .page-title {
        font-size: 20px;
      }

      .profile-section {
        padding: 20px 12px;
      }

      .profile-avatar-large {
        width: 60px;
        height: 60px;
        font-size: 24px;
      }

      .profile-name {
        font-size: 18px;
      }

      .section {
        padding: 16px 12px;
      }

      .form-input {
        padding: 10px;
        font-size: 13px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 12px;
      }
    }

    /* í¬ë ˆë”§ í™•ì¸ íŒì—… ìŠ¤íƒ€ì¼ */
    .credit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .credit-modal.active {
      display: flex;
    }

    .credit-modal-content {
      background: white;
      border-radius: 24px;
      padding: 40px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
      max-height: 90vh;
      overflow-y: auto;
      box-sizing: border-box;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .credit-modal-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .credit-modal-icon {
      width: 64px;
      height: 64px;
      background: rgba(255, 123, 84, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 32px;
      color: var(--accent-color);
    }

    .credit-modal-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .credit-modal-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
    }

    .credit-info-box {
      background: #f8fafc;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .credit-info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .credit-info-item:last-child {
      border-bottom: none;
    }

    .credit-info-label {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .credit-info-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .credit-info-value.warning {
      color: #ef4444;
    }

    .credit-info-value.success {
      color: #22c55e;
    }

    .credit-modal-actions {
      display: flex;
      gap: 12px;
    }

    .credit-modal-actions .btn {
      flex: 1;
      min-width: 0;
    }

    .credit-warning-box {
      background: linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(255, 123, 84, 0.1) 100%);
      border: 2px solid #f59e0b;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
    }

    .credit-warning-box.hidden {
      display: none;
    }

    .credit-warning-icon {
      width: 48px;
      height: 48px;
      background: #f59e0b;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 24px;
      color: white;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .credit-warning-title {
      font-size: 18px;
      font-weight: 700;
      color: #f59e0b;
      margin-bottom: 8px;
    }

    .credit-warning-message {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .credit-modal-icon.warning {
      background: rgba(255, 152, 0, 0.15);
      color: #f59e0b;
    }

    @media (max-width: 768px) {
      .credit-modal {
        padding: 16px;
        align-items: flex-end;
      }

      .credit-modal-content {
        width: 100%;
        max-width: 100%;
        border-radius: 24px 24px 0 0;
        padding: 24px 20px;
        max-height: 85vh;
        margin-bottom: 0;
      }

      .credit-modal-header {
        margin-bottom: 24px;
      }

      .credit-modal-icon {
        width: 56px;
        height: 56px;
        font-size: 28px;
        margin-bottom: 16px;
      }

      .credit-modal-title {
        font-size: 20px;
      }

      .credit-modal-subtitle {
        font-size: 14px;
      }

      .credit-info-box {
        padding: 20px;
        margin-bottom: 24px;
      }

      .credit-info-item {
        padding: 10px 0;
      }

      .credit-info-label {
        font-size: 14px;
      }

      .credit-info-value {
        font-size: 16px;
      }

      .credit-modal-actions {
        gap: 8px;
      }

      .credit-modal-actions .btn {
        min-width: 0;
        padding: 0 16px;
        font-size: 14px;
      }
    }

    /* í™˜ë¶ˆì•½ê´€ ë§í¬ ìŠ¤íƒ€ì¼ */
    .refund-policy-link {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      transition: color 0.3s ease;
    }

    .refund-policy-link:hover {
      color: var(--accent-color);
      text-decoration: underline;
    }

    /* í‘¸í„° ìŠ¤íƒ€ì¼ */
    .site-footer {
      background: rgba(255, 255, 255, 0.95);
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      padding: 40px 20px;
      margin-top: auto;
      color: var(--text-secondary);
      width: 100%;
    }

    .footer-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      gap: 24px;
      font-size: 14px;
      line-height: 1.8;
      align-items: center;
    }

    .footer-item {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
    }

    .footer-label {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 13px;
      margin-bottom: 4px;
    }

    .footer-value {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .footer-value a {
      color: var(--accent-color);
      text-decoration: none;
      transition: opacity 0.2s ease;
    }

    .footer-value a:hover {
      opacity: 0.8;
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .site-footer {
        padding: 10px 8px;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 30;
        margin-top: 0;
      }

      .footer-content {
        gap: 5px;
        font-size: 8px;
        flex-direction: row;
        flex-wrap: wrap;
        line-height: 1.4;
      }

      .footer-item {
        flex-direction: row;
        align-items: center;
        gap: 3px;
      }

      .footer-label {
        font-size: 8px;
      }

      .footer-value {
        font-size: 8px;
      }
    }
  </style>
  <!-- Meta Pixel Code -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '823098897158597');
    fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=823098897158597&ev=PageView&noscript=1"
  /></noscript>
  <!-- End Meta Pixel Code -->
</head>
<body>
  <div class="container">
    <h1 class="page-title">ë§ˆì´í˜ì´ì§€</h1>
    <p class="page-subtitle">ë‚´ ì •ë³´ ë° ì„œë¹„ìŠ¤ ì´ìš© í˜„í™©</p>

    <!-- ë¡œë”© ìƒíƒœ -->
    <div id="loadingContainer" class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 16px">ë¡œë”© ì¤‘...</p>
    </div>

    <!-- ì—ëŸ¬ ìƒíƒœ -->
    <div id="errorContainer" style="display: none;"></div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div id="mainContent" style="display: none;">
      <!-- í”„ë¡œí•„ í—¤ë” -->
      <section class="profile-section">
        <div class="profile-header">
          <div class="profile-avatar-large" id="profileAvatar">-</div>
          <div class="profile-info">
            <h2 class="profile-name" id="profileName">-</h2>
            <p class="profile-email" id="profileEmail">-</p>
            <div class="profile-badges">
              <span class="badge" id="userTypeBadge">-</span>
              <span class="badge" id="levelBadge">-</span>
            </div>
          </div>
          <div style="display: flex; gap: 12px; align-self: center;">
            <button class="btn btn-secondary" onclick="location.href='/'" style="height: fit-content;">
              <i class="fas fa-home"></i> í™ˆìœ¼ë¡œ
            </button>
            <button class="btn btn-danger" id="logoutBtn" style="height: fit-content;">
              <i class="fas fa-right-from-bracket"></i> ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>

        <!-- ê²°ì œ ë° í”Œëœ ì •ë³´ -->
        <div class="stats-grid">
          <div class="stat-card" style="cursor: pointer;" onclick="goToPaymentPage()">
            <div class="stat-number" id="currentPlanName">ë¼ì´íŠ¸</div>
            <div class="stat-label">í˜„ì¬ í”Œëœ</div>
            <div style="margin-top: 8px; font-size: 12px; opacity: 0.9;">
              <i class="fas fa-arrow-right"></i> í”Œëœ ë³€ê²½í•˜ê¸°
            </div>
          </div>
          <div class="stat-card" style="cursor: pointer;" onclick="window.location.href='/payment-cards.html'">
            <div class="stat-number">
              <i class="fas fa-credit-card"></i>
            </div>
            <div class="stat-label">ê²°ì œ ê´€ë¦¬</div>
            <div style="margin-top: 8px; font-size: 12px; opacity: 0.9;">
              <i class="fas fa-arrow-right"></i> ì¹´ë“œ ë“±ë¡í•˜ê¸°
            </div>
          </div>
        </div>
      </section>

      <!-- ì»¨í…ì¸  ê·¸ë¦¬ë“œ -->
      <div class="content-grid">
        <!-- 0. ì‘ì—… í¬ë ˆë”§ ì‚¬ìš© í˜„í™© -->
        <section class="section" id="tokenSection" style="cursor: pointer;" onclick="showCreditModal()">
          <h3 class="section-title">
            <i class="fas fa-coins"></i>
            ë‚´ ì‘ì—… í¬ë ˆë”§ ì‚¬ìš© í˜„í™©
          </h3>
          
          <!-- ì‘ì—… í¬ë ˆë”§ í˜„í™© ì¹´ë“œ -->
          <div class="token-status-card" onclick="event.stopPropagation();">
            <div class="token-plan">
              <span class="plan-name" id="currentPlan">ìŠ¤íƒ ë‹¤ë“œ</span>
              <span class="plan-badge" id="planBadge">ë“±ê¸‰</span>
            </div>
            
            <div class="token-meter">
              <div class="meter-info">
                <span class="meter-label">ì´ë²ˆ ë‹¬ ì‚¬ìš© í¬ë ˆë”§</span>
                <span class="meter-value">
                  <span id="tokensUsed">0</span> / <span id="tokensLimit">0</span> í¬ë ˆë”§
                </span>
              </div>
              <div class="meter-bar">
                <div class="meter-fill" id="tokenMeterFill" style="width: 0%"></div>
              </div>
              <div class="meter-percent" id="usagePercent">0%</div>
            </div>
            
            <div class="token-stats">
              <div class="token-stat">
                <i class="fas fa-battery-three-quarters"></i>
                <div>
                  <span class="stat-label">í¬í•¨ëœ ê¸°ë³¸ í¬ë ˆë”§</span>
                  <span class="stat-value" id="tokensRemaining">0</span>
                </div>
              </div>
              <div class="token-stat">
                <i class="fas fa-calendar-alt"></i>
                <div>
                  <span class="stat-label">ë‹¤ìŒ ê²°ì œ ì˜ˆì •ì¼</span>
                  <span class="stat-value" id="daysLeft">-</span>
                </div>
              </div>
            </div>
            
            <!-- ì˜ˆìƒ ì²­êµ¬ ê¸ˆì•¡ -->
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 16px; margin-top: 16px; border: 1px solid rgba(251, 191, 36, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="color: #92400e; font-size: 14px; font-weight: 600;">
                  <i class="fas fa-info-circle"></i> ì´ë²ˆ ë‹¬ ì˜ˆìƒ ì²­êµ¬ ê¸ˆì•¡
                </span>
                <span style="color: #92400e; font-size: 20px; font-weight: 700;" id="estimatedBillingAmount">0ì›</span>
              </div>
              <div style="font-size: 12px; color: #78350f; margin-top: 8px; line-height: 1.5;">
                <div style="margin-bottom: 4px;">â€¢ ì›” ìµœì†Œ ì´ìš©ë£Œ: <span id="minimumFee">0</span>ì›</div>
                <div style="margin-bottom: 4px;">â€¢ ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ì²­êµ¬ ê¸ˆì•¡: <span id="usageBasedAmount">0</span>ì›</div>
                <div style="font-weight: 600;">ìµœì¢… ì²­êµ¬ ê¸ˆì•¡ = max(ì›” ìµœì†Œ ì´ìš©ë£Œ, ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ê¸ˆì•¡)</div>
              </div>
            </div>
          </div>
          
          <!-- ìµœê·¼ ì‚¬ìš© ë‚´ì—­ -->
          <div class="token-usage-history" style="margin-bottom: 20px;" onclick="event.stopPropagation();">
            <h4 style="margin-bottom: 10px; color: var(--text-primary); font-size: 16px; font-weight: 600;">
              <i class="fas fa-history"></i> ìµœê·¼ ì‚¬ìš© ë‚´ì—­
            </h4>
            <div id="recentUsageList" class="usage-list">
              <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...
              </div>
            </div>
          </div>
          
          <!-- ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ -->
          <div id="upgradeSection" style="display: none;" onclick="event.stopPropagation();">
            <button class="btn btn-upgrade" onclick="goToUpgrade()">
              <i class="fas fa-rocket"></i> ë” ë§ì€ í¬ë ˆë”§ì´ í•„ìš”í•˜ì‹ ê°€ìš”? ì—…ê·¸ë ˆì´ë“œ í•˜ê¸°
            </button>
          </div>
        </section>

        <!-- ê²°ì œ ë° êµ¬ë… ê´€ë¦¬ (ì‹ë‹¹ ëŒ€í‘œë§Œ í‘œì‹œ) -->
        <section class="section" id="paymentSection">
          <h3 class="section-title">
            <i class="fas fa-credit-card"></i>
            ê²°ì œ ë° êµ¬ë… ê´€ë¦¬
          </h3>
          <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
            í”Œëœì„ ë³€ê²½í•˜ê±°ë‚˜ ê²°ì œ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”
          </p>

          <!-- í˜„ì¬ í”Œëœ ì •ë³´ -->
          <div style="background: linear-gradient(135deg, var(--secondary) 0%, #ffe0cc 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255, 123, 84, 0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div>
                <h4 style="margin: 0 0 5px 0; color: #201a17; font-size: 22px; font-weight: 800; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                  <span id="paymentPlanName">ë¼ì´íŠ¸ í”Œëœ</span>
                </h4>
                <p style="margin: 0; color: #7a6a60; font-size: 15px; font-weight: 600;">
                  <span id="paymentPlanBadge">ë¬´ë£Œ</span>
                </p>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 24px; font-weight: 700; color: var(--accent-color);">
                  <span id="paymentPlanPrice">ë¬´ë£Œ</span>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">ì›”ê°„</div>
              </div>
            </div>
            <div style="background: rgba(255,255,255,0.6); border-radius: 8px; padding: 12px; margin-top: 10px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: var(--text-secondary); font-size: 13px;">ì›”ê°„ í¬ë ˆë”§</span>
                <strong style="color: var(--text-primary); font-size: 14px;" id="paymentPlanTokens">0 í¬ë ˆë”§</strong>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary); font-size: 13px;">ê°±ì‹ ì¼ê¹Œì§€</span>
                <strong style="color: var(--text-primary); font-size: 14px;" id="paymentPlanDays">30ì¼</strong>
              </div>
            </div>
          </div>

          <!-- í”Œëœ ë³€ê²½ ë²„íŠ¼ë“¤ (ì‹ë‹¹ ëŒ€í‘œ ë“±ê¸‰ë§Œ) -->
          <div id="planButtons" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
            <div class="loading" style="grid-column: 1 / -1; text-align: center; padding: 20px;">
              <i class="fas fa-spinner fa-spin"></i> í”Œëœ ì •ë³´ ë¡œë”© ì¤‘...
            </div>
          </div>

          <!-- ê²°ì œ ë‚´ì—­ (ê°„ë‹¨ ë²„ì „) -->
          <div style="background: #f9f9f9; border-radius: 12px; padding: 16px; margin-top: 20px;">
            <h4 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 15px; font-weight: 600;">
              <i class="fas fa-receipt"></i> ê²°ì œ ë‚´ì—­
            </h4>
            <div id="paymentHistory" style="color: var(--text-secondary); font-size: 14px;">
              <p style="margin: 0; text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...
              </p>
            </div>
            <button class="btn btn-secondary" onclick="goToPaymentPage()" style="width: 100%; margin-top: 12px; font-size: 13px;">
              <i class="fas fa-external-link-alt"></i> ì „ì²´ ê²°ì œ ë‚´ì—­ ë³´ê¸°
            </button>
          </div>
        </section>

        <!-- 1. ë‚´ ê°€ê²Œ ì •ë³´ -->
        <section class="section">
          <h3 class="section-title">
            <i class="fas fa-store"></i>
            ë‚´ ê°€ê²Œ ì •ë³´
          </h3>
          <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            ë¸”ë¡œê·¸ ì‘ì„± ì‹œ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤
          </p>

          <div class="form-group">
            <label class="form-label">í”Œë ˆì´ìŠ¤ URL</label>
            <input type="text" class="form-input" id="editStoreUrl" placeholder="https://map.naver.com/...">
          </div>

          <div class="form-group">
            <label class="form-label">ê°€ê²Œ ì´ë¦„</label>
            <input type="text" class="form-input" id="editStoreName" placeholder="ì˜ˆ: ë™í¥ì•ˆê°€">
          </div>

          <div class="form-group">
            <label class="form-label">ê°€ê²Œ ì£¼ì†Œ</label>
            <input type="text" class="form-input" id="editStoreAddress" placeholder="ì˜ˆ: ë¶€ì‚°ê´‘ì—­ì‹œ í•´ìš´ëŒ€êµ¬ ìš°ë™ 1394-84">
          </div>

          <div class="form-group">
            <label class="form-label">ì˜ì—…ì‹œê°„</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-items: end;">
              <div>
                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">ì˜¤í”ˆ ì‹œê°„</label>
                <select class="form-input" id="editStoreOpenHour" style="margin-bottom: 0;">
                  <option value="">ì‹œ ì„ íƒ</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">ë§ˆê° ì‹œê°„</label>
                <select class="form-input" id="editStoreCloseHour" style="margin-bottom: 0;">
                  <option value="">ì‹œ ì„ íƒ</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">ìš”ì¼</label>
                <select class="form-input" id="editStoreDays" style="margin-bottom: 0;">
                  <option value="ë§¤ì¼">ë§¤ì¼</option>
                  <option value="ì›”~ê¸ˆ">ì›”~ê¸ˆ</option>
                  <option value="í† ì¼">í† ì¼</option>
                  <option value="ì›”~í† ">ì›”~í† </option>
                  <option value="ì¼ìš”ì¼ íœ´ë¬´">ì¼ìš”ì¼ íœ´ë¬´</option>
                  <option value="ì›”ìš”ì¼ íœ´ë¬´">ì›”ìš”ì¼ íœ´ë¬´</option>
                  <option value="í™”ìš”ì¼ íœ´ë¬´">í™”ìš”ì¼ íœ´ë¬´</option>
                  <option value="ìˆ˜ìš”ì¼ íœ´ë¬´">ìˆ˜ìš”ì¼ íœ´ë¬´</option>
                  <option value="ëª©ìš”ì¼ íœ´ë¬´">ëª©ìš”ì¼ íœ´ë¬´</option>
                  <option value="ê¸ˆìš”ì¼ íœ´ë¬´">ê¸ˆìš”ì¼ íœ´ë¬´</option>
                  <option value="í† ìš”ì¼ íœ´ë¬´">í† ìš”ì¼ íœ´ë¬´</option>
                </select>
              </div>
            </div>
            <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">ì˜¤í”ˆ ì‹œê°„ê³¼ ë§ˆê° ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</small>
          </div>

          <div class="form-group">
            <label class="form-label">ê°€ê²Œ ì „í™”ë²ˆí˜¸</label>
            <input type="tel" class="form-input" id="editStorePhone" placeholder="ì˜ˆ: 010-1234-5678 ë˜ëŠ” 051-123-4567">
          </div>

          <div class="form-group">
            <label class="form-label">ëŒ€í‘œë©”ë‰´</label>
            <textarea class="form-input" id="editStoreMenu" placeholder="ì˜ˆ: ì‚¼ê²¹ì‚´, ëª©ì‚´, ê°ˆë¹„" rows="2"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">ì£¼ë³€ ëœë“œë§ˆí¬</label>
            <input type="text" class="form-input" id="editStoreLandmarks" placeholder="ì˜ˆ: í•´ìš´ëŒ€í•´ìˆ˜ìš•ì¥, ì„¼í…€ì‹œí‹°">
          </div>

          <div class="form-group">
            <label class="form-label">í‚¤ì›Œë“œ</label>
            <input type="text" class="form-input" id="editStoreKeywords" placeholder="ì˜ˆ: 30ë…„ì „í†µ, ì‹ ì„ í•œê³ ê¸°">
          </div>

          <button class="btn btn-primary" onclick="saveStoreInfo()">
            <i class="fas fa-save"></i> ê°€ê²Œ ì •ë³´ ì €ì¥
          </button>
        </section>

        <!-- 2. ë‚´ ê°€ê²Œ ì•Œë¦¬ê¸° -->
        <section class="section">
          <h3 class="section-title">
            <i class="fas fa-bullhorn"></i>
            ë‚´ ê°€ê²Œ ì•Œë¦¬ê¸°
          </h3>
          <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            ê°€ê²Œë¥¼ ì‹¬ë„ ìˆê²Œ ì„¤ëª…í•˜ëŠ” ê³µê°„ì…ë‹ˆë‹¤. ìì„¸íˆ ì“¸ìˆ˜ë¡ AIê°€ í™œìš©í•  ì •ë³´ê°€ ë§ì•„ì ¸ì„œ ë” í’ë¶€í•œ ë¸”ë¡œê·¸/ë‹µê¸€ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
          </p>

          <!-- ì‘ì„± í˜„í™© -->
          <div id="promotionStatus" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196F3; border-radius: 15px; padding: 20px; margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h4 style="margin: 0; color: #1976D2; font-size: 16px;">ì‘ì„± í˜„í™©</h4>
              <span id="promotionCount" style="font-size: 18px; font-weight: 700; color: #1565C0;">0 / 7 í•­ëª©</span>
            </div>
            <div style="background: rgba(255,255,255,0.6); border-radius: 10px; height: 12px; overflow: hidden;">
              <div id="promotionBar" style="background: linear-gradient(90deg, #2196F3, #1976D2); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
            </div>
          </div>

          <!-- ì•ˆë‚´ -->
          <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <p style="margin: 0; color: #856404; font-size: 13px; line-height: 1.6;">
              ğŸ’¡ <strong>ì°¨ì´ì :</strong><br>
              â€¢ <strong>ê¸°ë³¸ ì •ë³´:</strong> íŒ©íŠ¸ (ì´ë¦„, ì£¼ì†Œ, ë©”ë‰´)<br>
              â€¢ <strong>ë‚´ ê°€ê²Œ ì•Œë¦¬ê¸°:</strong> ìŠ¤í† ë¦¬, ì² í•™, ìë‘ê±°ë¦¬ (ì‹¬ë„ ìˆê²Œ)<br><br>
              ì˜ˆ) ê¸°ë³¸ ë©”ë‰´: "ê°ˆë¹„" â†’ ì‹¬ë„ ìˆê²Œ: "30ë…„ ì „í†µ ë¹„ë²• ì–‘ë…ì¥ìœ¼ë¡œ 72ì‹œê°„ ìˆ™ì„±í•œ LAê°ˆë¹„..."
            </p>
          </div>

          <!-- 1. ì‹œê·¸ë‹ˆì²˜ ë©”ë‰´ -->
          <div class="form-group">
            <label class="form-label">
              <span>1ï¸âƒ£ ì‹œê·¸ë‹ˆì²˜ ë©”ë‰´</span>
              <span id="sigStatus" style="margin-left: 10px; font-size: 12px; color: #999;">âœ…</span>
            </label>
            <textarea class="form-input" id="signatureMenu" placeholder="ì˜ˆ: 30ë…„ ì „í†µ ë¹„ë²• ì–‘ë…ì¥ìœ¼ë¡œ 72ì‹œê°„ ìˆ™ì„±í•œ LAê°ˆë¹„. í• ë¨¸ë‹ˆê°€ ë§¤ì¼ ìƒˆë²½ 5ì‹œì— ì§ì ‘ ë§Œë“œì‹œëŠ” ì–‘ë…ì…ë‹ˆë‹¤..." rows="3"></textarea>
            <small style="color: #999; font-size: 12px;">ê¸°ë³¸ ë©”ë‰´ì™€ ë‹¤ë¥´ê²Œ ìŠ¤í† ë¦¬ë¥¼ ë‹´ì•„ ì‘ì„±í•´ì£¼ì„¸ìš”</small>
          </div>

          <!-- 2. ì¬ë£Œ/ì¡°ë¦¬ë²• -->
          <div class="form-group">
            <label class="form-label">
              <span>2ï¸âƒ£ ì¬ë£Œ/ì¡°ë¦¬ë²•ì˜ íŠ¹ë³„í•¨</span>
              <span id="ingStatus" style="margin-left: 10px; font-size: 12px; color: #999;">â–¡</span>
            </label>
            <textarea class="form-input" id="specialIngredients" placeholder="ì˜ˆ: êµ­ë‚´ì‚° 1ë“±ê¸‰ í•œìš°ë§Œ ì‚¬ìš©. ë§¤ì¼ ìƒˆë²½ ì§ì ‘ ë§Œë“œëŠ” ì‚¬ê³¨ ìœ¡ìˆ˜. í™”í•™ ì¡°ë¯¸ë£Œ ì¼ì ˆ ì‚¬ìš© ì•ˆ í•¨. 20ë…„ ê²½ë ¥ ì¡°ë¦¬ì‚¬ê°€ ì§ì ‘ ì¡°ë¦¬..." rows="3"></textarea>
          </div>

          <!-- 3. ë¶„ìœ„ê¸°/í¸ì˜ì‹œì„¤ -->
          <div class="form-group">
            <label class="form-label">
              <span>3ï¸âƒ£ ë¶„ìœ„ê¸°/í¸ì˜ì‹œì„¤</span>
              <span id="atmStatus" style="margin-left: 10px; font-size: 12px; color: #999;">â–¡</span>
            </label>
            <textarea class="form-input" id="atmosphereFacilities" placeholder="ì˜ˆ: 2ì¸µ ë…ë¦½ ë£¸ 4ê°œ (ê° 10-20ëª… ìˆ˜ìš©), ê±´ë¬¼ ì§€í•˜ ì£¼ì°¨ì¥ 50ëŒ€ ê°€ëŠ¥, ì•„ì´ ë†€ì´ë°© ë³„ë„ ìš´ì˜, í•œì˜¥ ì •ì›ì´ ë³´ì´ëŠ” í†µìœ ë¦¬ ì°½ê°€ì„..." rows="3"></textarea>
          </div>

          <!-- 4. ì‚¬ì¥ë‹˜ ì´ì•¼ê¸° -->
          <div class="form-group">
            <label class="form-label">
              <span>4ï¸âƒ£ ì‚¬ì¥ë‹˜/ì…°í”„ ì´ì•¼ê¸°</span>
              <span id="storyStatus" style="margin-left: 10px; font-size: 12px; color: #999;">â–¡</span>
            </label>
            <textarea class="form-input" id="ownerStory" placeholder="ì˜ˆ: í•œì‹ ì¡°ë¦¬ ê¸°ëŠ¥ì¥ ì¶œì‹ . 20ë…„ê°„ ì„œìš¸ ìœ ëª… í˜¸í…”ì—ì„œ ê·¼ë¬´í•˜ë‹¤ê°€ ê³ í–¥ì— ë‚´ë ¤ì™€ ì•„ë²„ì§€ì˜ ê°€ì—…ì„ ì‡ê³  ìˆìŠµë‹ˆë‹¤..." rows="3"></textarea>
          </div>

          <!-- 5. ì¶”ì²œ ìƒí™© -->
          <div class="form-group">
            <label class="form-label">
              <span>5ï¸âƒ£ ì¶”ì²œ ìƒí™©/ê³ ê°ì¸µ</span>
              <span id="situStatus" style="margin-left: 10px; font-size: 12px; color: #999;">â–¡</span>
            </label>
            <textarea class="form-input" id="recommendedSituations" placeholder="ì˜ˆ: ê°€ì¡± ëª¨ì„ (ë£¸ ìˆìŒ), íšŒì‹ (ë‹¨ì²´ 20ëª…ê¹Œì§€), ëŒì”ì¹˜ (ë³„ë„ ê³µê°„ ì œê³µ), ë°ì´íŠ¸ (ë¶„ìœ„ê¸° ì¢‹ì€ ì°½ê°€ì„), ì ì‹¬ íŠ¹ì„  ë©”ë‰´ ìˆìŒ (ì§ì¥ì¸ ì¶”ì²œ)..." rows="2"></textarea>
          </div>

          <!-- 6. SNS í¬ì¸íŠ¸ -->
          <div class="form-group">
            <label class="form-label">
              <span>6ï¸âƒ£ SNS/ì¸ìŠ¤íƒ€ í¬ì¸íŠ¸</span>
              <span id="snsStatus" style="margin-left: 10px; font-size: 12px; color: #999;">â–¡</span>
            </label>
            <textarea class="form-input" id="snsPhotoPoints" placeholder="ì˜ˆ: í•œì˜¥ ì •ì›ì´ ë³´ì´ëŠ” í†µìœ ë¦¬ ì°½ê°€ì„, ì˜ˆìœ ë„ìê¸° ê·¸ë¦‡, ê³„ì ˆë§ˆë‹¤ ë°”ë€ŒëŠ” ê½ƒ ì¥ì‹, ì¸ìƒìƒ· ëª…ì†Œë¡œ ìœ ëª…..." rows="2"></textarea>
          </div>

          <!-- 7. ì´ë²¤íŠ¸/íŠ¹ë³„ ì„œë¹„ìŠ¤ -->
          <div class="form-group">
            <label class="form-label">
              <span>7ï¸âƒ£ ì´ë²¤íŠ¸/íŠ¹ë³„ ì„œë¹„ìŠ¤</span>
              <span id="eventStatus" style="margin-left: 10px; font-size: 12px; color: #999;">â–¡</span>
            </label>
            <textarea class="form-input" id="specialEvents" placeholder="ì˜ˆ: ìƒì¼ ì¶•í•˜ ì¼€ì´í¬ ë¬´ë£Œ ì œê³µ, ì˜ˆì•½ ê³ ê° ë””ì €íŠ¸ ì„œë¹„ìŠ¤, ë‹¨ê³¨ ê³ ê° ì ë¦½ ì‹œìŠ¤í…œ..." rows="2"></textarea>
          </div>

          <button class="btn btn-primary" onclick="savePromotion()">
            <i class="fas fa-save"></i> ë‚´ ê°€ê²Œ ì•Œë¦¬ê¸° ì €ì¥
          </button>
        </section>

        <!-- 3. ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ ì„¤ì • -->
        <section class="section">
          <h3 class="section-title">
            <i class="fas fa-palette"></i>
            ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ ì„¤ì •
          </h3>
          <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            AIê°€ ë‚˜ë§Œì˜ ìŠ¤íƒ€ì¼ë¡œ ë¸”ë¡œê·¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤
          </p>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
              <label for="blogTone">ë§íˆ¬</label>
              <select id="blogTone" class="form-control">
                <option value="friendly">ì¹œê·¼í•œ</option>
                <option value="formal">ê²©ì‹ ìˆëŠ”</option>
                <option value="casual">ìºì£¼ì–¼í•œ</option>
              </select>
            </div>

            <div class="form-group">
              <label for="blogFormality">ê²©ì‹</label>
              <select id="blogFormality" class="form-control">
                <option value="polite">ì¡´ëŒ“ë§</option>
                <option value="semi-formal">ì¡´ëŒ“ë§/ë°˜ë§ í˜¼ìš©</option>
                <option value="informal">ë°˜ë§</option>
              </select>
            </div>

            <div class="form-group">
              <label for="blogEmojiUsage">ì´ëª¨í‹°ì½˜ ì‚¬ìš©</label>
              <select id="blogEmojiUsage" class="form-control">
                <option value="none">ì‚¬ìš© ì•ˆ í•¨</option>
                <option value="minimal">ìµœì†Œí•œ</option>
                <option value="moderate">ì ë‹¹íˆ</option>
                <option value="frequent">ìì£¼ ì‚¬ìš©</option>
              </select>
            </div>

            <div class="form-group">
              <label for="blogPersonality">ì„±ê²©</label>
              <select id="blogPersonality" class="form-control">
                <option value="warm">ë”°ëœ»í•œ</option>
                <option value="professional">í”„ë¡œí˜ì…”ë„í•œ</option>
                <option value="humorous">ìœ ë¨¸ëŸ¬ìŠ¤í•œ</option>
                <option value="enthusiastic">ì—´ì •ì ì¸</option>
              </select>
            </div>

            <div class="form-group">
              <label for="blogExpertiseLevel">ì „ë¬¸ì„±</label>
              <select id="blogExpertiseLevel" class="form-control">
                <option value="beginner">ì´ˆë³´ì ê´€ì </option>
                <option value="intermediate">ì¤‘ê¸‰ì ê´€ì </option>
                <option value="expert">ì „ë¬¸ê°€ ê´€ì </option>
              </select>
            </div>

            <div class="form-group">
              <label for="blogContentLength">ê¸€ ê¸¸ì´</label>
              <select id="blogContentLength" class="form-control">
                <option value="brief">ê°„ê²°í•˜ê²Œ</option>
                <option value="moderate">ì ë‹¹í•˜ê²Œ</option>
                <option value="detailed">ìƒì„¸í•˜ê²Œ</option>
              </select>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <label for="blogWritingStyle">ê¸€ì“°ê¸° ìŠ¤íƒ€ì¼</label>
              <select id="blogWritingStyle" class="form-control">
                <option value="storytelling">ìŠ¤í† ë¦¬í…”ë§ ì¤‘ì‹¬</option>
                <option value="informative">ì •ë³´ ì „ë‹¬ ì¤‘ì‹¬</option>
                <option value="conversational">ëŒ€í™”ì²´ ì¤‘ì‹¬</option>
                <option value="analytical">ë¶„ì„ì  ì¤‘ì‹¬</option>
              </select>
            </div>
          </div>

          <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 15px; margin: 15px 0;">
            <p style="margin: 0; color: #856404; font-size: 14px;">
              ğŸ’¡ <strong>íŒ:</strong> ì´ ì„¤ì •ì€ ë¸”ë¡œê·¸ ì‘ì„± ì‹œ ê¸°ë³¸ í†¤ì•¤ë§¤ë„ˆë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. ë§¤ë²ˆ ëœë¤í•˜ê²Œ ë‹¤ë¥¸ ê´€ì (ë‹¨ê³¨ ê³ ê°, ì²« ë°©ë¬¸, ë¯¸ì‹ê°€ ë“±)ì´ ì ìš©ë˜ì–´ ë‹¤ì–‘í•œ ë¸”ë¡œê·¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            </p>
          </div>

          <button class="btn btn-primary" onclick="saveBlogStyle()">
            <i class="fas fa-save"></i> ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ ì €ì¥
          </button>
        </section>

        <!-- 3-1. ë‚´ ì‡¼ì¸  ì˜ìƒ -->
        <section class="section" id="shortsSection">
          <h3 class="section-title">
            <i class="fas fa-video"></i>
            ë‚´ ì‡¼ì¸  ì˜ìƒ
          </h3>
          <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            AIë¡œ ìƒì„±í•œ ì‡¼ì¸  ì˜ìƒì„ í™•ì¸í•˜ì„¸ìš”
          </p>
          <div id="shortsVideos" class="activity-list">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </section>

        <!-- 4. íšŒì›ì •ë³´ ìˆ˜ì • -->
        <section class="section">
          <h3 class="section-title">
            <i class="fas fa-user-edit"></i>
            íšŒì›ì •ë³´ ìˆ˜ì •
          </h3>

          <div class="form-group">
            <label class="form-label">ì´ë¦„</label>
            <input type="text" class="form-input" id="editName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
          </div>

          <div class="form-group">
            <label class="form-label">ë¹„ì¦ˆë‹ˆìŠ¤ëª… (ìƒí˜¸ëª…)</label>
            <input type="text" class="form-input" id="editBusinessName" placeholder="ìƒí˜¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
          </div>

          <div class="form-group">
            <label class="form-label">ì „í™”ë²ˆí˜¸</label>
            <input type="tel" class="form-input" id="editPhone" placeholder="010-0000-0000">
          </div>

          <button class="btn btn-primary" onclick="saveProfile()">
            <i class="fas fa-save"></i> ì •ë³´ ì €ì¥
          </button>
        </section>

        <!-- 5. ì—°ë™í•˜ê¸° -->
        <section class="section" id="platformConnectionSection">
          <h3 class="section-title" style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-plug"></i>
            ì—°ë™í•˜ê¸°
            <span style="
              background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
              color: white;
              padding: 4px 12px;
              border-radius: 12px;
              font-size: 11px;
              font-weight: 700;
              letter-spacing: 0.5px;
              text-transform: uppercase;
              box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
            ">ê°œë°œì¤‘</span>
          </h3>
          <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
            ì™¸ë¶€ í”Œë«í¼ì„ ì—°ë™í•˜ë©´ ë¦¬ë·°ë¥¼ ìë™ìœ¼ë¡œ ê°€ì ¸ì™€ì„œ AI ë‹µê¸€ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>

          <!-- ì—°ë™ëœ í”Œë«í¼ ëª©ë¡ -->
          <div id="connectedPlatforms" style="margin-bottom: 30px;">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>

          <!-- í”Œë«í¼ ë¡œê·¸ì¸ ë²„íŠ¼ë“¤ -->
          <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
            <!-- ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸í”Œë ˆì´ìŠ¤ -->
            <button class="btn btn-primary" onclick="connectPlatform('naver')" data-platform="naver" id="platform-btn-naver" style="
              background: linear-gradient(135deg, #03C75A, #02A148);
              color: white;
              padding: 16px;
              font-size: 15px;
              font-weight: 600;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              width: 100%;
            ">
              <i class="fab fa-neos" style="font-size: 20px;"></i>
              <span>ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸í”Œë ˆì´ìŠ¤</span>
            </button>

            <!-- ë°°ë‹¬ì˜ë¯¼ì¡± -->
            <button class="btn btn-primary" onclick="connectPlatform('baemin')" data-platform="baemin" id="platform-btn-baemin" style="
              background: linear-gradient(135deg, #2AC1BC, #1FA8A3);
              color: white;
              padding: 16px;
              font-size: 15px;
              font-weight: 600;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              width: 100%;
            ">
              <i class="fas fa-utensils" style="font-size: 20px;"></i>
              <span>ë°°ë‹¬ì˜ë¯¼ì¡±</span>
            </button>

            <!-- ìš”ê¸°ìš” -->
            <button class="btn btn-primary" onclick="connectPlatform('yogiyo')" data-platform="yogiyo" id="platform-btn-yogiyo" style="
              background: linear-gradient(135deg, #FF2F00, #E02800);
              color: white;
              padding: 16px;
              font-size: 15px;
              font-weight: 600;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              width: 100%;
            ">
              <i class="fas fa-motorcycle" style="font-size: 20px;"></i>
              <span>ìš”ê¸°ìš”</span>
            </button>

            <!-- ì¿ íŒ¡ì´ì¸  -->
            <button class="btn btn-primary" onclick="connectPlatform('coupangeats')" data-platform="coupangeats" id="platform-btn-coupangeats" style="
              background: linear-gradient(135deg, #FFA500, #E69400);
              color: white;
              padding: 16px;
              font-size: 15px;
              font-weight: 600;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              width: 100%;
            ">
              <i class="fas fa-shopping-bag" style="font-size: 20px;"></i>
              <span>ì¿ íŒ¡ì´ì¸ </span>
            </button>

            <!-- í™ˆíƒìŠ¤ -->
            <button class="btn btn-primary" onclick="connectHometax()" data-platform="hometax" id="platform-btn-hometax" style="
              background: linear-gradient(135deg, #0066CC, #0052A3);
              color: white;
              padding: 16px;
              font-size: 15px;
              font-weight: 600;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              width: 100%;
            ">
              <i class="fas fa-receipt" style="font-size: 20px;"></i>
              <span>í™ˆíƒìŠ¤ ë§¤ì…ë§¤ì¶œì¡°íšŒ</span>
            </button>
          </div>
        </section>
      </div>
    </div>

    <!-- í™˜ë¶ˆì•½ê´€ ë§í¬ (í•˜ë‹¨) -->
    <div style="text-align: center; margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--border);">
      <a href="/refund-policy.html" class="refund-policy-link" style="color: var(--text-secondary); text-decoration: none; font-size: 14px;">
        í™˜ë¶ˆì•½ê´€
      </a>
    </div>
  </div>

  <!-- í¬ë ˆë”§ í™•ì¸ íŒì—… -->
  <div class="credit-modal" id="creditModal">
    <div class="credit-modal-content">
      <div class="credit-modal-header">
        <div class="credit-modal-icon" id="creditModalIcon">
          <i class="fas fa-coins"></i>
        </div>
        <h2 class="credit-modal-title">í¬ë ˆë”§ ì‚¬ìš© í™•ì¸</h2>
        <p class="credit-modal-subtitle">ì‘ì—… í¬ë ˆë”§ ì‚¬ìš© í˜„í™©ì„ í™•ì¸í•´ì£¼ì„¸ìš”</p>
      </div>
      <!-- í¬ë ˆë”§ ë¶€ì¡± ê²½ê³  ë©”ì‹œì§€ (í¬ë ˆë”§ ë¶€ì¡± ì‹œì—ë§Œ í‘œì‹œ) -->
      <div class="credit-warning-box hidden" id="creditWarningBox">
        <div class="credit-warning-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="credit-warning-title">í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤</div>
        <div class="credit-warning-message">
          ì‘ì—… í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.<br>
          í¬ë ˆë”§ì„ ì¶©ì „í•˜ê±°ë‚˜ êµ¬ë…ì„ ì—…ê·¸ë ˆì´ë“œí•´ì£¼ì„¸ìš”.
        </div>
      </div>
      <div class="credit-info-box">
        <div class="credit-info-item">
          <span class="credit-info-label">ì´ë²ˆ ë‹¬ ì‚¬ìš© í¬ë ˆë”§</span>
          <span class="credit-info-value" id="modalTokensUsed">0 í¬ë ˆë”§</span>
        </div>
        <div class="credit-info-item">
          <span class="credit-info-label">í¬í•¨ëœ ê¸°ë³¸ í¬ë ˆë”§</span>
          <span class="credit-info-value" id="modalTokensLimit">0 í¬ë ˆë”§</span>
        </div>
        <div class="credit-info-item">
          <span class="credit-info-label">í˜„ì¬ ë‚¨ì€ í¬ë ˆë”§</span>
          <span class="credit-info-value" id="modalTokensRemaining">0 í¬ë ˆë”§</span>
        </div>
        <div class="credit-info-item">
          <span class="credit-info-label">ì‚¬ìš©ë¥ </span>
          <span class="credit-info-value" id="modalUsagePercent">0%</span>
        </div>
        <div class="credit-info-item">
          <span class="credit-info-label">ì´ë²ˆ ë‹¬ ì˜ˆìƒ ì²­êµ¬ ê¸ˆì•¡</span>
          <span class="credit-info-value" id="modalEstimatedBilling">0ì›</span>
        </div>
      </div>
      <div class="credit-modal-actions">
        <button class="btn btn-secondary" onclick="closeCreditModal()">
          ë‹«ê¸°
        </button>
        <button class="btn btn-primary" onclick="goToPaymentPage()">
          <i class="fas fa-arrow-right"></i>
          í”Œëœ ë³€ê²½í•˜ê¸°
        </button>
      </div>
    </div>
  </div>

  <!-- ê³µí†µ ì¸ì¦ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="/assets/demo-mode.js?v=20241125"></script>
  <script src="/assets/auth-state.js?v=202410" defer></script>
  <script src="/assets/back-button.js"></script>

  <script>
    // Supabase í´ë¼ì´ì–¸íŠ¸
    let supabase;
    let currentUser = null;
    let cachedStorePlaceUrl = '';

    // ë“±ê¸‰ í•œê¸€ëª… (ê´€ë¦¬ì í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ)
    const LEVEL_NAMES = {
      free: 'ë¼ì´íŠ¸',      // FREE ë“±ê¸‰ë„ ë¼ì´íŠ¸ë¡œ í‘œì‹œ
      seed: 'ë¼ì´íŠ¸',
      power: 'ìŠ¤íƒ ë‹¤ë“œ',
      big_power: 'í”„ë¡œ',
      bigpower: 'í”„ë¡œ',
      premium: 'í”„ë¦¬ë¯¸ì—„',
      elite: 'ìŠ¤íƒ€í„°',
      expert: 'í”„ë¡œ',
      master: 'ì—”í„°í”„ë¼ì´ì¦ˆ',
      platinum: 'í”Œë˜í‹°ë„˜',
      admin: 'ê´€ë¦¬ì'
    };

    // ë“±ê¸‰ ì •ê·œí™” í•¨ìˆ˜ (ê´€ë¦¬ì í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ)
    function normalizeMembershipLevel(level) {
      if (!level) {
        return 'seed';
      }
      const normalized = level.toLowerCase();
      // FREE ë˜ëŠ” freeë¥¼ seedë¡œ ë³€í™˜
      if (normalized === 'free') {
        return 'seed';
      }
      // big_powerë¥¼ bigpowerë¡œ ë³€í™˜
      if (normalized === 'big_power') {
        return 'bigpower';
      }
      return normalized;
    }

    // ì‚¬ìš©ëŸ‰ ì œí•œ
    const LIMITS = {
      owner: {
        seed: { review: 10, blog: 2 },
        power: { review: 50, blog: 10 },
        big_power: { review: 200, blog: 30 },
        premium: { review: null, blog: 100 }
      },
      agency: {
        elite: { review: 100, blog: 50 },
        expert: { review: 500, blog: 200 },
        master: { review: 2000, blog: 500 },
        platinum: { review: null, blog: null }
      },
      admin: {
        admin: { review: null, blog: null }
      }
    };

    // Supabase ì´ˆê¸°í™” (auth-state.jsì—ì„œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜´)
    async function initSupabase() {
      try {
        // auth-state.jsê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        while (!window.authState?.supabase) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        supabase = window.authState.supabase;
        
        // âœ… ì „ì—­ ë³€ìˆ˜ë¡œë„ ì €ì¥ (ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        window.supabaseClient = supabase;
        
        console.log('âœ… Supabase ì´ˆê¸°í™” ì™„ë£Œ');
      } catch (error) {
        console.error('âŒ Supabase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showError('Supabase ì´ˆê¸°í™” ì‹¤íŒ¨. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
      }
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    async function initPage() {
      try {
        // ë°ëª¨ ëª¨ë“œ í™•ì¸
        const isDemoMode = window.isDemoMode && window.isDemoMode();
        
        // ë°ëª¨ ëª¨ë“œì¼ ë•ŒëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ì²˜ë¦¬
        if (isDemoMode) {
          console.log('ğŸ” [ë°ëª¨ ëª¨ë“œ] ê¸°ë³¸ í”„ë¡œí•„ë¡œ ì´ˆê¸°í™”');
          
          // ê¸°ë³¸ í”„ë¡œí•„ ë°ì´í„° ì„¤ì • (ìŠ¤íƒ ë‹¤ë“œ í”Œëœìœ¼ë¡œ ì„¤ì •)
          currentUser = {
            id: 'demo_user_12345',
            email: 'demo@sajangpick.co.kr',
            name: 'ë°ëª¨ ì‚¬ìš©ì',
            user_type: 'owner',
            membership_level: 'power', // ìŠ¤íƒ ë‹¤ë“œ í”Œëœ
            business_name: '',
            phone: ''
          };
          
          // UI ì—…ë°ì´íŠ¸
          document.getElementById('profileAvatar').textContent = 'ë°';
          document.getElementById('profileName').textContent = 'ë°ëª¨ ì‚¬ìš©ì';
          document.getElementById('profileEmail').textContent = 'demo@sajangpick.co.kr';
          
          const userTypeBadge = document.getElementById('userTypeBadge');
          if (userTypeBadge) {
            userTypeBadge.textContent = 'ì‹ë‹¹ ëŒ€í‘œ';
            userTypeBadge.className = 'badge owner';
          }
          
          const levelBadge = document.getElementById('levelBadge');
          if (levelBadge) {
            levelBadge.textContent = 'ìŠ¤íƒ ë‹¤ë“œ';
            levelBadge.className = 'badge power';
          }
          
          // ì‚¬ìš©ëŸ‰ í‘œì‹œ
          updateUsageStats(currentUser);
          
          // í¼ í•„ë“œ ì´ˆê¸°í™”
          const editNameEl = document.getElementById('editName');
          if (editNameEl) editNameEl.value = 'ë°ëª¨ ì‚¬ìš©ì';
          const editBusinessNameEl = document.getElementById('editBusinessName');
          if (editBusinessNameEl) editBusinessNameEl.value = '';
          const editPhoneEl = document.getElementById('editPhone');
          if (editPhoneEl) editPhoneEl.value = '';
          
          // ë©”ì¸ ì»¨í…ì¸  í‘œì‹œ
          const loadingContainer = document.getElementById('loadingContainer');
          const mainContent = document.getElementById('mainContent');
          if (loadingContainer) loadingContainer.style.display = 'none';
          if (mainContent) mainContent.style.display = 'block';
          
          // í”Œëœ ë²„íŠ¼ ë Œë”ë§ (ê¸°ë³¸ê°’ìœ¼ë¡œ)
          renderPlanButtons(null);
          
          // ê²°ì œ ì •ë³´ UI ì—…ë°ì´íŠ¸ (ê¸°ë³¸ê°’)
          updatePaymentUI(null);
          
          // ë°ëª¨ ëª¨ë“œ: ìŠ¤íƒ ë‹¤ë“œ í”Œëœ ìƒ˜í”Œ í¬ë ˆë”§ ì •ë³´ í‘œì‹œ
          loadDemoCreditInfo();
          
          return; // ë°ëª¨ ëª¨ë“œì—ì„œëŠ” ì—¬ê¸°ì„œ ì¢…ë£Œ
        }
        
        await initSupabase();
        
        // ë¡œê·¸ì¸ í™•ì¸ (Supabase ì„¸ì…˜ ê¸°ë°˜)
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          showError('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 2000);
          return;
        }

        const user = session.user;
        
        // UUID í˜•ì‹ ê²€ì¦ (ì •ê·œì‹: 8-4-4-4-12)
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        
        if (!user || !user.id || !uuidRegex.test(user.id)) {
          console.error('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì‚¬ìš©ì ID:', user?.id);
          showError('ë¡œê·¸ì¸ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          
          // ì„¸ì…˜ ì •ë¦¬
          await supabase.auth.signOut();
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('userData');
          
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 2000);
          return;
        }

        // âš¡ ëª¨ë“  ë°ì´í„°ë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œ (ë¹ ë¦„!)
        await Promise.all([
          loadUserProfile(user.id),
          loadTokenInfo(user.id),  // í† í° ì •ë³´ ì¶”ê°€
          loadShortsVideos(user.id),  // ì‡¼ì¸  ì˜ìƒ ëª©ë¡ ì¶”ê°€
          loadPaymentInfo(user.id)  // ê²°ì œ ì •ë³´ ì¶”ê°€
        ]);

        // ì¶”ê°€ ë°ì´í„° ë¡œë“œ (ë¸”ë¡œê·¸ ê´€ë ¨)
        await Promise.all([
          loadStoreInfo(),
          loadPromotion(),
          loadBlogStyle(),
          loadPlatformConnections(user.id)  // ì™¸ë¶€ í”Œë«í¼ ì—°ë™ ì •ë³´
        ]);

        // ì‹¤ì‹œê°„ ì‘ì„± í˜„í™© ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setupPromotionListeners();
        
        // í† í° ì •ë³´ ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì •
        setupTokenAutoRefresh(user.id);

      } catch (error) {
        console.error('âŒ í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showError('í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // í† í° ì •ë³´ ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì •
    let tokenRefreshInterval = null;
    let lastTokenRefreshTime = null;
    
    function setupTokenAutoRefresh(userId) {
      // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
      if (tokenRefreshInterval) {
        clearInterval(tokenRefreshInterval);
      }
      
      // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ í† í° ì •ë³´ ìƒˆë¡œê³ ì¹¨
      window.addEventListener('focus', () => {
        console.log('ğŸ“Š í˜ì´ì§€ í¬ì»¤ìŠ¤ - í† í° ì •ë³´ ìƒˆë¡œê³ ì¹¨');
        refreshTokenInfo();
      });
      
      // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ í† í° ì •ë³´ ìƒˆë¡œê³ ì¹¨
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          console.log('ğŸ“Š í˜ì´ì§€ í‘œì‹œ - í† í° ì •ë³´ ìƒˆë¡œê³ ì¹¨');
          refreshTokenInfo();
        }
      });
      
      // 30ì´ˆë§ˆë‹¤ í† í° ì •ë³´ ìë™ ìƒˆë¡œê³ ì¹¨
      tokenRefreshInterval = setInterval(() => {
        // ë§ˆì§€ë§‰ ìƒˆë¡œê³ ì¹¨ í›„ 30ì´ˆê°€ ì§€ë‚¬ëŠ”ì§€ í™•ì¸
        const now = Date.now();
        if (!lastTokenRefreshTime || (now - lastTokenRefreshTime) >= 30000) {
          console.log('ğŸ“Š ì£¼ê¸°ì  í† í° ì •ë³´ ìƒˆë¡œê³ ì¹¨');
          refreshTokenInfo();
          lastTokenRefreshTime = now;
        }
      }, 30000); // 30ì´ˆë§ˆë‹¤
      
      lastTokenRefreshTime = Date.now();
      
      console.log('âœ… í† í° ì •ë³´ ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì • ì™„ë£Œ');
    }

    // ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ
    async function loadUserProfile(userId) {
      try {
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .single();

        if (error) throw new Error(error.message);
        if (!profile) throw new Error('í”„ë¡œí•„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        // ë””ë²„ê¹…: í”„ë¡œí•„ ë°ì´í„° í™•ì¸
        console.log('ğŸ“Š [loadUserProfile] í”„ë¡œí•„ ì¡°íšŒ ê²°ê³¼:', {
          userId: userId,
          email: profile.email,
          user_type: profile.user_type,
          membership_level: profile.membership_level,
          fullProfile: profile
        });

        currentUser = profile;

        // UI ì—…ë°ì´íŠ¸
        const avatar = (profile.name || profile.email || 'U').charAt(0).toUpperCase();
        document.getElementById('profileAvatar').textContent = avatar;
        // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ (ì£¼ë‹ˆí˜•ìœ¼ë¡œ í‘œì‹œ)
        const displayName = profile.name || 'ì£¼ë‹ˆí˜•' || 'ì´ë¦„ ì—†ìŒ';
        document.getElementById('profileName').textContent = displayName;
        document.getElementById('profileEmail').textContent = profile.email || 'ì´ë©”ì¼ ì—†ìŒ';

        // íšŒì› ìœ í˜• ë±ƒì§€
        const userTypeText = profile.user_type === 'owner' ? 'ì‹ë‹¹ ëŒ€í‘œ' :
                            profile.user_type === 'agency' ? 'ëŒ€í–‰ì‚¬/ë¸”ë¡œê±°' : 'ê´€ë¦¬ì';
        const userTypeBadge = document.getElementById('userTypeBadge');
        userTypeBadge.textContent = userTypeText;
        userTypeBadge.className = `badge ${profile.user_type}`;

        // ë“±ê¸‰ ë±ƒì§€
        const levelText = LEVEL_NAMES[profile.membership_level] || profile.membership_level;
        const levelBadge = document.getElementById('levelBadge');
        levelBadge.textContent = levelText;
        levelBadge.className = `badge ${profile.membership_level}`;

        // ì‚¬ìš©ëŸ‰ í‘œì‹œ
        updateUsageStats(profile);

        // í¼ í•„ë“œ ì±„ìš°ê¸°
        document.getElementById('editName').value = profile.name || '';
        document.getElementById('editBusinessName').value = profile.business_name || '';
        document.getElementById('editPhone').value = profile.phone || '';

        // ì‹ë‹¹ ëŒ€í‘œê°€ ì•„ë‹ˆë©´ ê²°ì œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        if (profile.user_type !== 'owner') {
          const paymentSection = document.getElementById('paymentSection');
          if (paymentSection) {
            paymentSection.style.display = 'none';
          }
        }

        // âš¡ ë©”ì¸ ì»¨í…ì¸  ë¨¼ì € í‘œì‹œ (ë¹ ë¥¸ ë Œë”ë§)
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        // ê°€ê²Œ ì •ë³´ëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¡œë“œ (await ì œê±°)
        loadStoreInfo();
        loadBlogStyle();

      } catch (error) {
        console.error('âŒ í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error);
        showError('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ì‚¬ìš©ëŸ‰ í†µê³„ ì—…ë°ì´íŠ¸ (ì œê±°ë¨ - ê²°ì œ ì„¹ì…˜ìœ¼ë¡œ ëŒ€ì²´)
    function updateUsageStats(profile) {
      // ë“±ê¸‰ ì •ê·œí™” (ê´€ë¦¬ì í˜ì´ì§€ì™€ ë™ì¼í•œ ë¡œì§)
      const normalizedLevel = normalizeMembershipLevel(profile.membership_level);
      const currentPlanName = LEVEL_NAMES[normalizedLevel] || 'ë¼ì´íŠ¸';
      
      // ë””ë²„ê¹…: í”Œëœ ì´ë¦„ ì„¤ì • í™•ì¸
      console.log('ğŸ“Š [updateUsageStats] í”Œëœ ì´ë¦„ ì„¤ì •:', {
        original_membership_level: profile.membership_level,
        normalized_level: normalizedLevel,
        currentPlanName: currentPlanName,
        profile: {
          user_type: profile.user_type,
          membership_level: profile.membership_level
        }
      });
      
      const planNameEl = document.getElementById('currentPlanName');
      if (planNameEl) {
        planNameEl.textContent = currentPlanName;
      }
    }

    // ê²°ì œ ì •ë³´ ë¡œë“œ
    async function loadPaymentInfo(userId) {
      try {
        // Supabase ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.access_token) {
          console.error('âŒ ì„¸ì…˜ í† í°ì´ ì—†ìŠµë‹ˆë‹¤');
          return;
        }

        // ê°€ê²© ì„¤ì •ê³¼ ì‚¬ìš©ì ì •ë³´ë¥¼ ë™ì‹œì— ë¡œë“œ (ì‘ì—… í¬ë ˆë”§ ê¸°ë°˜)
        const [dashboardRes, pricingRes, usageRes] = await Promise.all([
          fetch('/api/subscription/user-dashboard?action=dashboard', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${session.access_token}`
            }
          }),
          fetch('/api/subscription/pricing-config'),
          fetch(`/api/subscription/work-credit-billing?action=get-current-usage&userId=${userId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${session.access_token}`
            }
          })
        ]);

        if (!dashboardRes.ok) {
          console.warn('âš ï¸ ê²°ì œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', dashboardRes.status);
          updatePaymentUI(null);
          return;
        }

        const dashboardResult = await dashboardRes.json();
        const pricingResult = await pricingRes.json();
        const usageResult = usageRes.ok ? await usageRes.json() : null;
        
        if (dashboardResult.success && dashboardResult.data) {
          const { profile, cycle } = dashboardResult.data;
          const pricing = pricingResult.success ? pricingResult.pricing : null;
          const usage = usageResult?.success ? usageResult.usage : null;
          
          updatePaymentUI({ profile, cycle, pricing, usage });
          
          // í”Œëœ ë²„íŠ¼ ë Œë”ë§ (ì‹ë‹¹ ëŒ€í‘œ ë“±ê¸‰ë§Œ) - pricingì´ ì—†ì–´ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ í‘œì‹œ
          renderPlanButtons(pricing);
          
          // ê²°ì œ ë‚´ì—­ ë¡œë“œ
          await loadPaymentHistory(userId);
          
          // ì‘ì—… í¬ë ˆë”§ ì •ë³´ì™€ ê²°ì œ ì„¹ì…˜ ë™ê¸°í™”
          syncCreditInfoWithPayment(cycle, profile, pricing);
          
          // ì‹¤ì‹œê°„ ì‚¬ìš©ëŸ‰ í‘œì‹œ
          if (usage) {
            displayRealTimeUsage(usage);
          }
        } else {
          updatePaymentUI(null);
          // pricingì´ ì—†ì–´ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ í”Œëœ ë²„íŠ¼ í‘œì‹œ (ì¹´ì¹´ì˜¤í˜ì´ í…ŒìŠ¤íŠ¸ìš©)
          renderPlanButtons(null);
        }
      } catch (error) {
        console.error('âŒ ê²°ì œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        updatePaymentUI(null);
        // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ í”Œëœ ë²„íŠ¼ í‘œì‹œ (ì¹´ì¹´ì˜¤í˜ì´ í…ŒìŠ¤íŠ¸ìš©)
        renderPlanButtons(null);
      }
    }

    // ê²°ì œ UI ì—…ë°ì´íŠ¸
    function updatePaymentUI(data) {
      if (!data || !data.profile) {
        // ê¸°ë³¸ê°’ (ìƒˆë¡œìš´ ìš”ê¸ˆì œ êµ¬ì¡°)
        document.getElementById('paymentPlanName').textContent = 'ë¼ì´íŠ¸ í”Œëœ';
        document.getElementById('paymentPlanBadge').textContent = 'ë¬´ë£Œ';
        document.getElementById('paymentPlanPrice').textContent = 'ë¬´ë£Œ';
        document.getElementById('paymentPlanTokens').textContent = '0 í¬ë ˆë”§';
        document.getElementById('paymentPlanDays').textContent = '30ì¼';
        return;
      }

      const profile = data.profile;
      const cycle = data.cycle;
      const pricing = data.pricing;

      // ë“±ê¸‰ ì •ê·œí™” (ê´€ë¦¬ì í˜ì´ì§€ì™€ ë™ì¼í•œ ë¡œì§)
      const normalizedLevel = normalizeMembershipLevel(profile.membership_level);
      
      // ê´€ë¦¬ì ë“±ê¸‰ ì²´í¬
      const isAdmin = normalizedLevel === 'admin' || profile.user_type === 'admin';
      
      // ì‹¤ì œ ì„¤ì •ëœ ê°€ê²©ê³¼ ì‘ì—… í¬ë ˆë”§ ì‚¬ìš©
      const membershipLevel = normalizedLevel;
      
      // ê°€ê²© ì •ë³´
      let planPrice = 0;
      let planCredits = null; // null = ë¬´ì œí•œ
      
      if (isAdmin) {
        // ê´€ë¦¬ìëŠ” ë¬´ì œí•œ
        planPrice = 0;
        planCredits = null; // ë¬´ì œí•œ
      } else if (pricing) {
        // ì‹ë‹¹ ëŒ€í‘œ ë“±ê¸‰ë§Œ ì²˜ë¦¬
        switch(membershipLevel) {
          case 'seed':
            planPrice = pricing.owner_seed_minimum_fee !== undefined ? pricing.owner_seed_minimum_fee : (pricing.owner_seed_price || 0);
            planCredits = pricing.owner_seed_included_credits !== undefined ? pricing.owner_seed_included_credits : 0;
            break;
          case 'power':
            planPrice = pricing.owner_power_minimum_fee !== undefined ? pricing.owner_power_minimum_fee : (pricing.owner_power_price || 30000);
            planCredits = pricing.owner_power_included_credits !== undefined ? pricing.owner_power_included_credits : 37500;
            break;
          case 'bigpower':  // ì •ê·œí™”ëœ ë“±ê¸‰ ì‚¬ìš©
            planPrice = pricing.owner_bigpower_minimum_fee !== undefined ? pricing.owner_bigpower_minimum_fee : (pricing.owner_bigpower_price || 50000);
            planCredits = pricing.owner_bigpower_included_credits !== undefined ? pricing.owner_bigpower_included_credits : 83333;
            break;
          case 'premium':
            planPrice = pricing.owner_premium_minimum_fee !== undefined ? pricing.owner_premium_minimum_fee : (pricing.owner_premium_price || 100000);
            planCredits = pricing.owner_premium_included_credits !== undefined ? pricing.owner_premium_included_credits : 200000;
            break;
        }
      } else {
        // ê¸°ë³¸ê°’ (API ì‹¤íŒ¨ ì‹œ) - ì‘ì—… í¬ë ˆë”§ ê¸°ë°˜ (2025-11-25)
        const defaults = {
          seed: { price: 0, credits: 0, excessRate: 1.2 },
          power: { price: 30000, credits: 37500, excessRate: 0.8 },
          bigpower: { price: 50000, credits: 83333, excessRate: 0.6 },
          premium: { price: 100000, credits: 200000, excessRate: 0.5 }
        };
        const defaultInfo = defaults[membershipLevel] || defaults.seed;
        planPrice = defaultInfo.price;
        planCredits = defaultInfo.credits;
      }

      const planNames = {
        seed: { name: 'ë¼ì´íŠ¸ í”Œëœ', badge: 'ë¬´ë£Œ' },
        power: { name: 'ìŠ¤íƒ ë‹¤ë“œ í”Œëœ', badge: 'ë² ì´ì§' },
        bigpower: { name: 'í”„ë¡œ í”Œëœ', badge: 'í”„ë¡œ' },
        premium: { name: 'í”„ë¦¬ë¯¸ì—„ í”Œëœ', badge: 'VIP' },
        admin: { name: 'ê´€ë¦¬ì í”Œëœ', badge: 'ê´€ë¦¬ì' }
      };

      const planInfo = planNames[membershipLevel] || planNames.seed;

      document.getElementById('paymentPlanName').textContent = planInfo.name;
      document.getElementById('paymentPlanBadge').textContent = planInfo.badge;
      document.getElementById('paymentPlanPrice').textContent = planPrice === 0 ? 'ë¬´ë£Œ' : `${planPrice.toLocaleString()}ì›`;
      
      // ì‹¤ì œ ì‚¬ì´í´ì˜ included_credits ìš°ì„  ì‚¬ìš© (ì‘ì—… í¬ë ˆë”§ ì‹œìŠ¤í…œ)
      const actualCredits = cycle?.included_credits !== undefined ? cycle.included_credits : (planCredits !== null ? planCredits : 0);
      document.getElementById('paymentPlanTokens').textContent = actualCredits > 0 ? `${actualCredits.toLocaleString()} í¬ë ˆë”§` : (planCredits === null ? 'ë¬´ì œí•œ' : '0 í¬ë ˆë”§');
      
      if (cycle && cycle.days_remaining !== undefined) {
        document.getElementById('paymentPlanDays').textContent = `${cycle.days_remaining}ì¼`;
      } else {
        document.getElementById('paymentPlanDays').textContent = '30ì¼';
      }
    }

    // í”Œëœ ë²„íŠ¼ ë Œë”ë§ (ì‹ë‹¹ ëŒ€í‘œ ë“±ê¸‰ë§Œ)
    function renderPlanButtons(pricing) {
      const container = document.getElementById('planButtons');
      if (!container) return;

      // í˜„ì¬ ì‚¬ìš©ìê°€ ì‹ë‹¹ ëŒ€í‘œê°€ ì•„ë‹ˆë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
      if (currentUser && currentUser.user_type !== 'owner') {
        container.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-secondary);">
            <i class="fas fa-info-circle"></i> ì‹ë‹¹ ëŒ€í‘œ ì „ìš© ê¸°ëŠ¥ì…ë‹ˆë‹¤
          </div>
        `;
        return;
      }

      // ì‹ë‹¹ ëŒ€í‘œ ë“±ê¸‰ë§Œ í‘œì‹œ (ì‘ì—… í¬ë ˆë”§ ê¸°ë°˜)
      const ownerPlans = [
        { 
          key: 'seed', 
          name: 'ë¼ì´íŠ¸', 
          icon: 'ğŸŒ±', 
          color: '#ffb6c1',
          minimumFeeKey: 'owner_seed_minimum_fee',
          priceKey: 'owner_seed_price',
          creditsKey: 'owner_seed_included_credits',
          defaultPrice: 0,
          defaultCredits: 0,
          defaultExcessRate: 1.2
        },
        { 
          key: 'power', 
          name: 'ìŠ¤íƒ ë‹¤ë“œ', 
          icon: 'âš¡', 
          color: '#f59e0b',
          minimumFeeKey: 'owner_power_minimum_fee',
          priceKey: 'owner_power_price',
          creditsKey: 'owner_power_included_credits',
          defaultPrice: 30000,
          defaultCredits: 37500,
          defaultExcessRate: 0.8
        },
        { 
          key: 'bigpower', 
          name: 'í”„ë¡œ', 
          icon: 'ğŸ’ª', 
          color: '#f97316',
          minimumFeeKey: 'owner_bigpower_minimum_fee',
          priceKey: 'owner_bigpower_price',
          creditsKey: 'owner_bigpower_included_credits',
          defaultPrice: 50000,
          defaultCredits: 83333,
          defaultExcessRate: 0.6
        },
        { 
          key: 'premium', 
          name: 'í”„ë¦¬ë¯¸ì—„', 
          icon: 'â­', 
          color: '#ec4899',
          minimumFeeKey: 'owner_premium_minimum_fee',
          priceKey: 'owner_premium_price',
          creditsKey: 'owner_premium_included_credits',
          defaultPrice: 100000,
          defaultCredits: 200000,
          defaultExcessRate: 0.5
        }
      ];

      // pricingì´ ì—†ì–´ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ í”Œëœ ë²„íŠ¼ í‘œì‹œ (ì¹´ì¹´ì˜¤í˜ì´ í…ŒìŠ¤íŠ¸ìš©)
      container.innerHTML = ownerPlans.map(plan => {
        // ìµœì†Œ ì´ìš©ë£Œê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ê°€ê²© ì‚¬ìš©, ê·¸ê²ƒë„ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        const minimumFee = pricing && pricing[plan.minimumFeeKey] !== undefined 
          ? pricing[plan.minimumFeeKey] 
          : (pricing && pricing[plan.priceKey] !== undefined 
            ? pricing[plan.priceKey] 
            : plan.defaultPrice);
        const includedCredits = pricing && pricing[plan.creditsKey] !== undefined 
          ? pricing[plan.creditsKey] 
          : plan.defaultCredits;
        const priceText = minimumFee === 0 ? 'ë¬´ë£Œ' : `${minimumFee.toLocaleString()}ì›`;
        
        return `
          <button class="btn btn-primary" onclick="goToPayment('${plan.key}')" style="width: 100%; background: linear-gradient(135deg, ${plan.color}, ${plan.color}dd);">
            <div style="text-align: left;">
              <div style="font-size: 18px; margin-bottom: 4px;">
                ${plan.icon} ${plan.name}
              </div>
              <div style="font-size: 12px; opacity: 0.9;">
                ${priceText} Â· ${includedCredits.toLocaleString()} í¬ë ˆë”§
              </div>
            </div>
          </button>
        `;
      }).join('') + `
        <button class="btn btn-secondary" onclick="goToPaymentPage()" style="width: 100%; grid-column: 1 / -1;">
          <i class="fas fa-list"></i> ì „ì²´ í”Œëœ ë³´ê¸°
        </button>
      `;
    }

    // ê²°ì œ ë‚´ì—­ ë¡œë“œ
    async function loadPaymentHistory(userId) {
      const container = document.getElementById('paymentHistory');
      if (!container) return;

      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.access_token) return;

        const response = await fetch('/api/payment/payment-handler', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            action: 'get-payment-history',
            userId: userId,
            limit: 5
          })
        });

        if (!response.ok) {
          container.innerHTML = `
            <p style="margin: 0; text-align: center; padding: 10px; color: var(--text-secondary); font-size: 13px;">
              ê²°ì œ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
            </p>
          `;
          return;
        }

        const result = await response.json();
        
        if (result.success && result.payments && result.payments.length > 0) {
          container.innerHTML = result.payments.map(payment => {
            const statusText = {
              'completed': 'ì™„ë£Œ',
              'pending': 'ëŒ€ê¸°ì¤‘',
              'failed': 'ì‹¤íŒ¨',
              'cancelled': 'ì·¨ì†Œë¨'
            }[payment.status] || payment.status;

            const statusColor = {
              'completed': 'var(--success)',
              'pending': 'var(--warning)',
              'failed': 'var(--error)',
              'cancelled': 'var(--text-secondary)'
            }[payment.status] || 'var(--text-secondary)';

            return `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
                <div>
                  <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">
                    ${payment.plan_type || 'í”Œëœ'}
                  </div>
                  <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                    ${new Date(payment.created_at).toLocaleDateString('ko-KR')}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">
                    ${payment.amount ? payment.amount.toLocaleString() + 'ì›' : '-'}
                  </div>
                  <div style="font-size: 12px; color: ${statusColor}; margin-top: 4px;">
                    ${statusText}
                  </div>
                </div>
              </div>
            `;
          }).join('');
        } else {
          container.innerHTML = `
            <p style="margin: 0; text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">
              <i class="fas fa-inbox"></i><br>
              ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤
            </p>
          `;
        }
      } catch (error) {
        console.error('âŒ ê²°ì œ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = `
          <p style="margin: 0; text-align: center; padding: 10px; color: var(--text-secondary); font-size: 13px;">
            ê²°ì œ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤
          </p>
        `;
      }
    }

    // í”„ë¡œí•„ ì €ì¥
    async function saveProfile() {
      if (!currentUser) {
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      const name = document.getElementById('editName').value.trim();
      const businessName = document.getElementById('editBusinessName').value.trim();
      const phone = document.getElementById('editPhone').value.trim();

      if (!name) {
        alert('ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ì‚¬í•­ì…ë‹ˆë‹¤.');
        return;
      }

      try {
        const { error } = await supabase
          .from('profiles')
          .update({
            name: name,
            business_name: businessName,
            phone: phone,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentUser.id);

        if (error) throw new Error(error.message);

        alert('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // í”„ë¡œí•„ ë‹¤ì‹œ ë¡œë“œ
        await loadUserProfile(currentUser.id);

      } catch (error) {
        console.error('âŒ í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨:', error);
        alert('í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ì‹œê°„ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ìƒì„± (30ë¶„ ë‹¨ìœ„)
    function initTimeDropdowns() {
      const openHourSelect = document.getElementById('editStoreOpenHour');
      const closeHourSelect = document.getElementById('editStoreCloseHour');
      
      if (!openHourSelect || !closeHourSelect) return;
      
      // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì‹œ ì„ íƒ ì œì™¸)
      while (openHourSelect.children.length > 1) {
        openHourSelect.removeChild(openHourSelect.lastChild);
      }
      while (closeHourSelect.children.length > 1) {
        closeHourSelect.removeChild(closeHourSelect.lastChild);
      }
      
      // 00:00ë¶€í„° 23:30ê¹Œì§€ 30ë¶„ ë‹¨ìœ„ë¡œ ìƒì„±
      for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
          const displayTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
          
          const openOption = document.createElement('option');
          openOption.value = timeStr;
          openOption.textContent = displayTime;
          openHourSelect.appendChild(openOption);
          
          const closeOption = document.createElement('option');
          closeOption.value = timeStr;
          closeOption.textContent = displayTime;
          closeHourSelect.appendChild(closeOption);
        }
      }
    }

    // ì˜ì—…ì‹œê°„ ë¬¸ìì—´ íŒŒì‹± (11:30-22:00 (ë§¤ì¼) í˜•ì‹)
    function parseBusinessHours(hoursStr) {
      if (!hoursStr) return { openHour: '', closeHour: '', days: 'ë§¤ì¼' };
      
      // ì‹œê°„ ì¶”ì¶œ (11:30-22:00)
      const timeMatch = hoursStr.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/);
      if (!timeMatch) return { openHour: '', closeHour: '', days: 'ë§¤ì¼' };
      
      const openHour = `${String(timeMatch[1]).padStart(2, '0')}:${timeMatch[2]}`;
      const closeHour = `${String(timeMatch[3]).padStart(2, '0')}:${timeMatch[4]}`;
      
      // ìš”ì¼ ì¶”ì¶œ
      let days = 'ë§¤ì¼';
      const daysMatch = hoursStr.match(/\(([^)]+)\)/);
      if (daysMatch) {
        days = daysMatch[1].trim();
      }
      
      return { openHour, closeHour, days };
    }

    // ë“œë¡­ë‹¤ìš´ ê°’ìœ¼ë¡œë¶€í„° ì˜ì—…ì‹œê°„ ë¬¸ìì—´ ìƒì„±
    function formatBusinessHours(openHour, closeHour, days) {
      if (!openHour || !closeHour) return '';
      return `${openHour}-${closeHour} (${days})`;
    }

    // ê°€ê²Œ ì •ë³´ ì €ì¥
    async function saveStoreInfo() {
      if (!currentUser) {
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      // ë“œë¡­ë‹¤ìš´ì—ì„œ ì˜ì—…ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
      const openHour = document.getElementById('editStoreOpenHour').value;
      const closeHour = document.getElementById('editStoreCloseHour').value;
      const days = document.getElementById('editStoreDays').value;
      const businessHours = formatBusinessHours(openHour, closeHour, days);

      const placeUrlInput = document.getElementById('editStoreUrl').value.trim();
      let normalizedPlaceUrl = placeUrlInput;
      if (placeUrlInput) {
        if (!isValidPlaceUrl(placeUrlInput)) {
          alert('ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.\nì£¼ì†Œì°½ì˜ "ê³µìœ  > ë§í¬ ë³µì‚¬" ê¸°ëŠ¥ì„ ì´ìš©í•´ ì „ì²´ ì£¼ì†Œë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.');
          return;
        }
        normalizedPlaceUrl = normalizePlaceUrl(placeUrlInput);
        if (!normalizedPlaceUrl) {
          alert('ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ URLì„ í•´ì„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ëª¨ë°”ì¼ ë²„ì „ ë§í¬ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        document.getElementById('editStoreUrl').value = normalizedPlaceUrl;
      }

      const storeInfo = {
        placeUrl: normalizedPlaceUrl,
        companyName: document.getElementById('editStoreName').value.trim(),
        companyAddress: document.getElementById('editStoreAddress').value.trim(),
        businessHours: businessHours,
        phoneNumber: document.getElementById('editStorePhone').value.trim(),
        mainMenu: document.getElementById('editStoreMenu').value.trim(),
        landmarks: document.getElementById('editStoreLandmarks').value.trim(),
        keywords: document.getElementById('editStoreKeywords').value.trim(),
      };

      try {
        const response = await fetch('/api/store-info', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUser.id, storeInfo })
        });

        if (!response.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');

        const result = await response.json();
        if (result.success) {
          let message = 'âœ… ê°€ê²Œ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\në¸”ë¡œê·¸ ì‘ì„± ì‹œ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.';
          cachedStorePlaceUrl = storeInfo.placeUrl || '';
          
          // í¬ë¡¤ë§ ê²°ê³¼ í‘œì‹œ
          if (result.crawlResult) {
            if (result.crawlResult.fromCache) {
              message += '\n\nğŸ”„ ìºì‹œëœ í”Œë ˆì´ìŠ¤ ì •ë³´ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.';
            } else {
              message += '\n\nğŸ†• í”Œë ˆì´ìŠ¤ë¥¼ ìƒˆë¡œ í¬ë¡¤ë§í–ˆìŠµë‹ˆë‹¤!';
            }
            
            // ìë™ìœ¼ë¡œ ì…ë ¥ëœ ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
            await loadStoreInfo();
          }
          
          alert(message);
        } else {
          throw new Error(result.error || 'ì €ì¥ ì‹¤íŒ¨');
        }

      } catch (error) {
        console.error('âŒ ê°€ê²Œ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ê°€ê²Œ ì •ë³´ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ë°ëª¨ ëª¨ë“œ: ìŠ¤íƒ ë‹¤ë“œ í”Œëœ ìƒ˜í”Œ í¬ë ˆë”§ ì •ë³´ í‘œì‹œ
    function loadDemoCreditInfo() {
      console.log('ğŸ” [ë°ëª¨ ëª¨ë“œ] ìŠ¤íƒ ë‹¤ë“œ í”Œëœ ìƒ˜í”Œ í¬ë ˆë”§ ì •ë³´ í‘œì‹œ');
      
      // ìŠ¤íƒ ë‹¤ë“œ í”Œëœ ìƒ˜í”Œ ë°ì´í„°
      const demoData = {
        planType: 'power', // ìŠ¤íƒ ë‹¤ë“œ
        totalCreditsUsed: 12500, // ì‚¬ìš©í•œ í¬ë ˆë”§ (ì•½ 33%)
        includedCredits: 37500, // í¬í•¨ëœ ê¸°ë³¸ í¬ë ˆë”§
        creditsRemaining: 25000, // ë‚¨ì€ í¬ë ˆë”§
        minimumFee: 30000, // ì›” ìµœì†Œ ì´ìš©ë£Œ
        actualUsageAmount: 30000, // ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ì²­êµ¬ ê¸ˆì•¡ (ì›” ìµœì†Œ ì´ìš©ë£Œì™€ ë™ì¼)
        estimatedTotalAmount: 30000 // ì˜ˆìƒ ì´ ì²­êµ¬ ê¸ˆì•¡
      };
      
      // ë“±ê¸‰ ì •ë³´ í‘œì‹œ
      document.getElementById('currentPlan').textContent = 'ìŠ¤íƒ ë‹¤ë“œ';
      document.getElementById('planBadge').textContent = 'ë“±ê¸‰';
      
      // ì‘ì—… í¬ë ˆë”§ ì‚¬ìš©ëŸ‰ í‘œì‹œ
      const creditsUsed = demoData.totalCreditsUsed;
      const includedCredits = demoData.includedCredits;
      const creditsRemaining = demoData.creditsRemaining;
      
      // ì‚¬ìš©ë¥  ê³„ì‚° (ì•½ 33%)
      const usagePercent = Math.round((creditsUsed / includedCredits) * 100);
      
      // í‘œì‹œ í˜•ì‹: "ë‚¨ì€ í¬ë ˆë”§ / í¬í•¨ëœ í¬ë ˆë”§" (ì˜ˆ: 5000/5000, 4995/5000, 4985/5000...)
      document.getElementById('tokensUsed').textContent = creditsRemaining.toLocaleString();
      document.getElementById('tokensLimit').textContent = includedCredits.toLocaleString();
      document.getElementById('tokensRemaining').textContent = creditsRemaining.toLocaleString();
      document.getElementById('usagePercent').textContent = usagePercent + '%';
      
      // ë‹¤ìŒ ê²°ì œ ì˜ˆì •ì¼
      document.getElementById('daysLeft').textContent = '15ì¼';
      
      // ì˜ˆìƒ ì²­êµ¬ ê¸ˆì•¡ í‘œì‹œ
      document.getElementById('estimatedBillingAmount').textContent = demoData.estimatedTotalAmount.toLocaleString() + 'ì›';
      document.getElementById('minimumFee').textContent = demoData.minimumFee.toLocaleString();
      document.getElementById('usageBasedAmount').textContent = demoData.actualUsageAmount.toLocaleString();
      
      // ë¯¸í„° ë°” ì—…ë°ì´íŠ¸
      const meterFill = document.getElementById('tokenMeterFill');
      if (meterFill) {
        meterFill.style.width = usagePercent + '%';
        meterFill.style.background = 'linear-gradient(90deg, #10b981, #059669)'; // ì´ˆë¡ìƒ‰ (33% ì‚¬ìš©)
      }
      
      // ìµœê·¼ ì‚¬ìš© ë‚´ì—­ ìƒ˜í”Œ ë°ì´í„°
      const usageList = document.getElementById('recentUsageList');
      if (usageList) {
        const sampleUsage = [
          { service: 'ë¸”ë¡œê·¸ ì‘ì„±', time: '2ì‹œê°„ ì „', credits: 2000 },
          { service: 'ë¦¬ë·° ë‹µê¸€', time: '5ì‹œê°„ ì „', credits: 500 },
          { service: 'ì˜ìƒ ìƒì„±', time: '1ì¼ ì „', credits: 5000 },
          { service: 'ë¸”ë¡œê·¸ ì‘ì„±', time: '2ì¼ ì „', credits: 2000 },
          { service: 'ë¦¬ë·° ë‹µê¸€', time: '3ì¼ ì „', credits: 500 }
        ];
        
        usageList.innerHTML = sampleUsage.map(item => `
          <div class="usage-item">
            <div>
              <span class="usage-api">${item.service}</span>
              <span class="usage-time">${item.time}</span>
            </div>
            <span class="usage-tokens">-${item.credits.toLocaleString()} ì‘ì—… í¬ë ˆë”§</span>
          </div>
        `).join('');
      }
      
      console.log('âœ… [ë°ëª¨ ëª¨ë“œ] ìƒ˜í”Œ í¬ë ˆë”§ ì •ë³´ í‘œì‹œ ì™„ë£Œ');
    }

    // ì‘ì—… í¬ë ˆë”§ ì‚¬ìš© í˜„í™© ë¡œë“œ
    async function loadTokenInfo(userId) {
      try {
        // Supabase ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.access_token) {
          console.error('âŒ ì„¸ì…˜ í† í°ì´ ì—†ìŠµë‹ˆë‹¤');
          throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        }

        // ì‘ì—… í¬ë ˆë”§ ì‚¬ìš© í˜„í™© ë° ì˜ˆìƒ ì²­êµ¬ ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸°
        const [usageResponse, billingResponse] = await Promise.all([
          fetch(`/api/subscription/work-credit-billing?action=get-current-usage&userId=${userId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${session.access_token}`
            }
          }),
          fetch(`/api/subscription/work-credit-billing?action=calculate&userId=${userId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${session.access_token}`
            }
          })
        ]);

        // ì‘ë‹µ í™•ì¸
        if (!usageResponse.ok && !billingResponse.ok) {
          let errorMessage = 'ì‘ì—… í¬ë ˆë”§ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨';
          try {
            const errorData = await usageResponse.json();
            errorMessage = errorData.error || errorMessage;
            console.error('âŒ API ì‘ë‹µ ì˜¤ë¥˜:', usageResponse.status, errorData);
          } catch (parseError) {
            console.error('âŒ ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜:', usageResponse.status, usageResponse.statusText);
            errorMessage = `ì„œë²„ ì˜¤ë¥˜ (${usageResponse.status}): ${usageResponse.statusText}`;
          }
          throw new Error(errorMessage);
        }

        const usageResult = usageResponse.ok ? await usageResponse.json() : null;
        const billingResult = billingResponse.ok ? await billingResponse.json() : null;
        
        console.log('ğŸ“Š ì‘ì—… í¬ë ˆë”§ ì‚¬ìš© í˜„í™©:', usageResult);
        console.log('ğŸ“Š ì˜ˆìƒ ì²­êµ¬ ê¸ˆì•¡:', billingResult);
        
        if (!usageResult || !usageResult.success) {
          const errorMsg = usageResult?.error || 'ì‘ì—… í¬ë ˆë”§ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨';
          console.error('âŒ API ì‘ë‹µ ì‹¤íŒ¨:', errorMsg);
          
          // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ê°’ì€ í‘œì‹œ
          document.getElementById('currentPlan').textContent = 'ë¼ì´íŠ¸';
          document.getElementById('planBadge').textContent = 'ë“±ê¸‰';
          document.getElementById('tokensUsed').textContent = '0';
          document.getElementById('tokensLimit').textContent = '0';
          document.getElementById('tokensRemaining').textContent = '0';
          document.getElementById('usagePercent').textContent = '0%';
          document.getElementById('daysLeft').textContent = '-';
          document.getElementById('estimatedBillingAmount').textContent = '0ì›';
          document.getElementById('minimumFee').textContent = '0';
          document.getElementById('usageBasedAmount').textContent = '0';
          
          const usageList = document.getElementById('recentUsageList');
          
          if (usageList) {
            usageList.innerHTML = `
              <div style="text-align: center; color: #ef4444; padding: 20px;">
                <i class="fas fa-exclamation-triangle"></i> 
                <div style="margin-top: 8px; font-size: 14px;">${errorMsg}</div>
                <button onclick="refreshTokenInfo()" style="margin-top: 12px; padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  <i class="fas fa-sync-alt"></i> ë‹¤ì‹œ ì‹œë„
                </button>
              </div>
            `;
          }
          
          return;
        }
        
        const usage = usageResult.usage;
        const billing = billingResult?.billing || null;
        
        // ë“±ê¸‰ ì •ë³´ í‘œì‹œ
        const normalizedLevel = normalizeMembershipLevel(usage.planType);
        document.getElementById('currentPlan').textContent = LEVEL_NAMES[normalizedLevel] || 'ë¼ì´íŠ¸';
        document.getElementById('planBadge').textContent = 'ë“±ê¸‰';
        
        // ì‘ì—… í¬ë ˆë”§ ì‚¬ìš©ëŸ‰ í‘œì‹œ (API ì‘ë‹µì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°)
        // summary ê°ì²´ì—ì„œ í¬ë ˆë”§ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìš°ì„ ìˆœìœ„)
        const summary = usageResult?.summary || {};
        const creditsUsed = summary.creditsUsed || usage.totalCreditsUsed || 0;
        const includedCredits = summary.includedCredits || summary.monthlyLimit || usage.includedCredits || 0;
        const creditsRemaining = summary.creditsRemaining !== undefined ? summary.creditsRemaining : Math.max(0, includedCredits - creditsUsed);
        
        // ì‚¬ìš©ë¥  ê³„ì‚° (ê¸°ë³¸ í¬ë ˆë”§ ì†Œì§„ìœ¨)
        const usagePercent = includedCredits > 0 ? 
          Math.round((creditsUsed / includedCredits) * 100) : 0;
        
        // í‘œì‹œ í˜•ì‹: "ë‚¨ì€ í¬ë ˆë”§ / í¬í•¨ëœ í¬ë ˆë”§" (ì˜ˆ: 5000/5000, 4995/5000, 4985/5000...)
        // tokensUsedì— ë‚¨ì€ í¬ë ˆë”§ í‘œì‹œ, tokensLimitì— í¬í•¨ëœ í¬ë ˆë”§ í‘œì‹œ
        document.getElementById('tokensUsed').textContent = creditsRemaining.toLocaleString();
        document.getElementById('tokensLimit').textContent = includedCredits.toLocaleString();
        document.getElementById('tokensRemaining').textContent = creditsRemaining.toLocaleString();
        
        // ë””ë²„ê·¸ ë¡œê·¸
        console.log(`ğŸ“Š [mypage] í¬ë ˆë”§ í‘œì‹œ: ${creditsRemaining}/${includedCredits} (ë‚¨ì€/í¬í•¨), ì‚¬ìš©ëœ í¬ë ˆë”§: ${creditsUsed}`);
        document.getElementById('usagePercent').textContent = usagePercent + '%';
        
        // ë‹¤ìŒ ê²°ì œ ì˜ˆì •ì¼ (êµ¬ë… ì‚¬ì´í´ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        // TODO: subscription_cycle í…Œì´ë¸”ì—ì„œ ë‹¤ìŒ ê²°ì œì¼ ì¡°íšŒ
        document.getElementById('daysLeft').textContent = '-';
        
        // ì˜ˆìƒ ì²­êµ¬ ê¸ˆì•¡ í‘œì‹œ
        const estimatedAmount = billing?.totalAmount || usage.estimatedTotalAmount || usage.minimumFee || 0;
        const minimumFee = usage.minimumFee || 0;
        const usageBasedAmount = usage.actualUsageAmount || 0;
        
        document.getElementById('estimatedBillingAmount').textContent = estimatedAmount.toLocaleString() + 'ì›';
        document.getElementById('minimumFee').textContent = minimumFee.toLocaleString();
        document.getElementById('usageBasedAmount').textContent = usageBasedAmount.toLocaleString();
        
        // ë¯¸í„° ë°” ì—…ë°ì´íŠ¸
        const meterFill = document.getElementById('tokenMeterFill');
        if (meterFill) {
          meterFill.style.width = Math.min(usagePercent, 100) + '%';
          
          // ì‚¬ìš©ëŸ‰ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
          if (usagePercent >= 90) {
            meterFill.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
          } else if (usagePercent >= 70) {
            meterFill.style.background = 'linear-gradient(90deg, #f59e0b, #ea580c)';
          } else {
            meterFill.style.background = 'linear-gradient(90deg, #10b981, #059669)';
          }
        }
        
        // 80% ì´ìƒ ì‚¬ìš©ì‹œ ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ í‘œì‹œ
        if (usagePercent >= 80) {
          const upgradeSection = document.getElementById('upgradeSection');
          if (upgradeSection) {
            upgradeSection.style.display = 'block';
          }
        }
        
        // ì‹¤ì‹œê°„ ì‚¬ìš©ëŸ‰ í‘œì‹œ (displayRealTimeUsage í˜¸ì¶œ)
        if (usage) {
          displayRealTimeUsage(usage);
        }

        // ìµœê·¼ ì‚¬ìš© ë‚´ì—­ ë° í¬ë ˆë”§ ì†Œì§„ ë‚´ì—­ í‘œì‹œ (APIë¥¼ í†µí•´ ì¡°íšŒ)
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (session?.access_token) {
            // í¬ë ˆë”§ ì†Œì§„ ë‚´ì—­ ì§‘ê³„ë¥¼ ìœ„í•´ ë” ë§ì€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì´ë²ˆ ë‹¬ ì „ì²´)
            console.log(`ğŸ“Š [mypage] í¬ë ˆë”§ ì‚¬ìš© ë‚´ì—­ ì¡°íšŒ ì‹œì‘: userId=${userId}`);
            const usageRes = await fetch(`/api/subscription/token-usage?user_id=${userId}&limit=100`, {
              headers: {
                'Authorization': `Bearer ${session.access_token}`
              }
            });
            
            if (usageRes.ok) {
              const usageResult = await usageRes.json();
              console.log(`ğŸ“Š [mypage] í¬ë ˆë”§ ì‚¬ìš© ë‚´ì—­ API ì‘ë‹µ:`, usageResult);
              
              const allUsage = usageResult.usage || [];
              console.log(`ğŸ“Š [mypage] ì¡°íšŒëœ ì‚¬ìš© ë‚´ì—­ ê°œìˆ˜: ${allUsage.length}ê°œ`);
              
              // ìµœê·¼ ì‚¬ìš© ë‚´ì—­ (ìµœê·¼ 5ê°œë§Œ í‘œì‹œ)
              const recentUsage = allUsage.slice(0, 5);
              const usageList = document.getElementById('recentUsageList');
              if (usageList) {
                if (recentUsage && recentUsage.length > 0) {
                  usageList.innerHTML = recentUsage.map(usage => {
                    // ì„œë¹„ìŠ¤ íƒ€ì…ì„ í•œêµ­ì–´ë¡œ ë³€í™˜
                    const serviceLabels = {
                      'blog_writing': 'ë¸”ë¡œê·¸ ì‘ì„±',
                      'review_reply': 'ë¦¬ë·° ë‹µê¸€',
                      'video_generation': 'ì˜ìƒ ìƒì„±',
                      'news': 'ë‰´ìŠ¤ ì¶”ì²œ'
                    };
                    
                    const serviceType = usage.service_type || '';
                    const serviceLabel = serviceLabels[serviceType] || serviceType;
                    const creditsUsed = usage.work_credits_used || 0;
                    const timeAgo = getTimeAgo(new Date(usage.used_at));
                    
                    return `
                      <div class="usage-item">
                        <div>
                          <span class="usage-api">${serviceLabel}</span>
                          <span class="usage-time">${timeAgo}</span>
                        </div>
                        <span class="usage-tokens">-${creditsUsed.toLocaleString()} ì‘ì—… í¬ë ˆë”§</span>
                      </div>
                    `;
                  }).join('');
                } else {
                  usageList.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                      <i class="fas fa-info-circle"></i> ì•„ì§ ì‚¬ìš© ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                  `;
                }
              }
              
            } else {
              // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ìƒì„¸ ì •ë³´ í™•ì¸
              const errorText = await usageRes.text();
              console.error('âŒ [mypage] í¬ë ˆë”§ ì‚¬ìš© ë‚´ì—­ API í˜¸ì¶œ ì‹¤íŒ¨:', {
                status: usageRes.status,
                statusText: usageRes.statusText,
                errorText: errorText,
                userId: userId,
                url: `/api/subscription/token-usage?user_id=${userId}&limit=100`
              });
              
              let errorMessage = 'ì‚¬ìš© ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
              let errorDetails = '';
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
                if (errorData.warning) {
                  errorDetails = errorData.warning;
                }
              } catch (e) {
                // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ ì‚¬ìš©
                errorDetails = errorText.length > 200 ? errorText.substring(0, 200) + '...' : errorText;
              }
              
              // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
              const usageList = document.getElementById('recentUsageList');
              
              if (usageList) {
                usageList.innerHTML = `
                  <div style="text-align: center; color: #ef4444; padding: 20px;">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <div style="margin-top: 8px; font-size: 14px; font-weight: bold;">${errorMessage}</div>
                    ${errorDetails ? `<div style="margin-top: 4px; font-size: 12px; color: #666;">${errorDetails}</div>` : ''}
                    <div style="margin-top: 8px; font-size: 12px; color: #999;">ìƒíƒœ ì½”ë“œ: ${usageRes.status}</div>
                    <button onclick="refreshTokenInfo()" style="margin-top: 12px; padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">
                      <i class="fas fa-sync-alt"></i> ë‹¤ì‹œ ì‹œë„
                    </button>
                  </div>
                `;
              }
            }
          } else {
            throw new Error('ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤');
          }
        } catch (usageError) {
          console.error('âŒ [mypage] ìµœê·¼ ì‚¬ìš© ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', usageError);
          console.error('âŒ [mypage] ì˜¤ë¥˜ ìƒì„¸:', {
            message: usageError.message,
            stack: usageError.stack
          });
          
          const usageList = document.getElementById('recentUsageList');
          
          if (usageList) {
            usageList.innerHTML = `
              <div style="text-align: center; color: #ef4444; padding: 20px;">
                <i class="fas fa-exclamation-triangle"></i> 
                <div style="margin-top: 8px; font-size: 14px;">ì‚¬ìš© ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${usageError.message}</div>
                <button onclick="location.reload()" style="margin-top: 12px; padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                </button>
              </div>
            `;
          }
          
          if (consumptionList) {
            consumptionList.innerHTML = `
              <div style="text-align: center; color: #ef4444; padding: 20px;">
                <i class="fas fa-exclamation-triangle"></i> 
                <div style="margin-top: 8px; font-size: 14px;">ì†Œì§„ ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('âŒ í† í° ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        console.error('âŒ ì—ëŸ¬ ìƒì„¸ ì •ë³´:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });
        
        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        const usageList = document.getElementById('recentUsageList');
        const errorMessage = error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
        
        if (usageList) {
          usageList.innerHTML = `
            <div style="text-align: center; color: #ef4444; padding: 20px;">
              <i class="fas fa-exclamation-triangle"></i> 
              <div style="margin-top: 8px; font-size: 14px;">ì‘ì—… í¬ë ˆë”§ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
              <div style="margin-top: 4px; font-size: 12px; color: #999;">${errorMessage}</div>
              <button onclick="refreshTokenInfo()" style="margin-top: 12px; padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-sync-alt"></i> ë‹¤ì‹œ ì‹œë„
              </button>
            </div>
          `;
        }
        
        // ê¸°ë³¸ê°’ í‘œì‹œ
        const currentPlanEl = document.getElementById('currentPlan');
        const planBadgeEl = document.getElementById('planBadge');
        const tokensUsedEl = document.getElementById('tokensUsed');
        const tokensLimitEl = document.getElementById('tokensLimit');
        const tokensRemainingEl = document.getElementById('tokensRemaining');
        const usagePercentEl = document.getElementById('usagePercent');
        
        if (currentPlanEl) currentPlanEl.textContent = 'ë¼ì´íŠ¸';
        if (planBadgeEl) planBadgeEl.textContent = 'ë“±ê¸‰';
        if (tokensUsedEl) tokensUsedEl.textContent = '0';
        if (tokensLimitEl) tokensLimitEl.textContent = '0';
        if (tokensRemainingEl) tokensRemainingEl.textContent = '0';
        if (usagePercentEl) usagePercentEl.textContent = '0%';
        
        // ì˜ˆìƒ ì²­êµ¬ ê¸ˆì•¡ ê¸°ë³¸ê°’
        const estimatedBillingEl = document.getElementById('estimatedBillingAmount');
        const minimumFeeEl = document.getElementById('minimumFee');
        const usageBasedAmountEl = document.getElementById('usageBasedAmount');
        if (estimatedBillingEl) estimatedBillingEl.textContent = '0ì›';
        if (minimumFeeEl) minimumFeeEl.textContent = '0';
        if (usageBasedAmountEl) usageBasedAmountEl.textContent = '0';
        
        const meterFill = document.getElementById('tokenMeterFill');
        if (meterFill) {
          meterFill.style.width = '0%';
        }
      }
    }
    
    // ì‹œê°„ í‘œì‹œ í—¬í¼ í•¨ìˆ˜
    function getTimeAgo(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000); // ì´ˆ ë‹¨ìœ„
      
      if (diff < 60) return 'ë°©ê¸ˆ ì „';
      if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
      if (diff < 604800) return `${Math.floor(diff / 86400)}ì¼ ì „`;
      return date.toLocaleDateString('ko-KR');
    }

    function formatKoreanDate(dateString) {
      if (!dateString) return 'ì•„ì§ ì‹¤í–‰ ì „';
      const date = new Date(dateString);
      return date.toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }


    const SUPPORTED_PLACE_TYPES = ['restaurant', 'cafe', 'shop', 'hotel', 'accommodation', 'beauty', 'activity'];

    function extractPlaceMeta(url) {
      if (!url || typeof url !== 'string') return null;
      const trimmed = url.trim();
      if (!trimmed.toLowerCase().includes('naver.')) return null;

      const patternConfigs = [
        { regex: /\/(restaurant|cafe|shop|hotel|accommodation|beauty|activity)\/(\d+)/i, typeIndex: 1, idIndex: 2 },
        { regex: /\/(place)\/(\d+)/i, typeIndex: 1, idIndex: 2 },
        { regex: /\/p\/entry\/place\/(\d+)/i, typeIndex: null, idIndex: 1 },
        { regex: /\/entry\/place\/(\d+)/i, typeIndex: null, idIndex: 1 },
        { regex: /\/v5\/entry\/place\/(\d+)/i, typeIndex: null, idIndex: 1 },
        { regex: /\/place\/(\d+)/i, typeIndex: null, idIndex: 1 },
        { regex: /[?&](?:placeId|entry|id)=(\d+)/i, typeIndex: null, idIndex: 1 }
      ];

      for (const config of patternConfigs) {
        const match = trimmed.match(config.regex);
        if (match) {
          let type = config.typeIndex != null ? match[config.typeIndex].toLowerCase() : null;
          const placeId = match[config.idIndex];
          if (!placeId) continue;

          if (!type || type === 'place') {
            type = 'restaurant';
          }

          if (!SUPPORTED_PLACE_TYPES.includes(type)) {
            type = 'restaurant';
          }

          return { placeId, placeType: type };
        }
      }

      return null;
    }

    function extractPlaceIdFromUrl(url) {
      return extractPlaceMeta(url)?.placeId || null;
    }

    function isValidPlaceUrl(url) {
      return !!extractPlaceMeta(url);
    }

    function normalizePlaceUrl(url) {
      const meta = extractPlaceMeta(url);
      if (!meta) return null;
      return `https://m.place.naver.com/${meta.placeType}/${meta.placeId}`;
    }
    
    // ì—…ê·¸ë ˆì´ë“œ í˜ì´ì§€ë¡œ ì´ë™
    function goToUpgrade() {
      window.location.href = '/payment.html?plan=power';
    }

    // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™ (í”Œëœ ì„ íƒ) - ë°ëª¨ ëª¨ë“œ ì§€ì›
    function goToPayment(plan) {
      // URLì— demo íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ìœ ì§€
      const urlParams = new URLSearchParams(window.location.search);
      const isDemo = urlParams.get('demo') === 'true' || (window.isDemoMode && window.isDemoMode());
      const demoParam = isDemo ? '&demo=true' : '';
      if (plan) {
        window.location.href = `/payment.html?plan=${plan}${demoParam}`;
      } else {
        window.location.href = `/payment.html${isDemo ? '?demo=true' : ''}`;
      }
    }
    
    // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™ (í”Œëœ ì—†ì´) - ë°ëª¨ ëª¨ë“œ ì§€ì›
    function goToPaymentPage() {
      const isDemo = (window.isDemoMode && window.isDemoMode()) || new URLSearchParams(window.location.search).get('demo') === 'true';
      window.location.href = `/payment.html${isDemo ? '?demo=true' : ''}`;
    }
    
    // ì‘ì—… í¬ë ˆë”§ ì •ë³´ì™€ ê²°ì œ ì„¹ì…˜ ë™ê¸°í™”
    function syncCreditInfoWithPayment(cycle, profile, pricing) {
      if (!cycle || !profile) return;
      
      try {
        // ë“±ê¸‰ ì •ê·œí™”
        const normalizedLevel = normalizeMembershipLevel(profile.membership_level);
        const isAdmin = normalizedLevel === 'admin' || profile.user_type === 'admin';
        const membershipLevel = normalizedLevel;
        const userType = profile.user_type || 'owner';
        
        // ì‘ì—… í¬ë ˆë”§ ì •ë³´ (credits_used, included_credits ì‚¬ìš©)
        const creditsUsed = cycle.credits_used || 0;
        let creditsLimit = cycle.included_credits;
        
        // ì‚¬ì´í´ì˜ included_creditsê°€ ì—†ê±°ë‚˜ 0ì´ë©´ pricing_configì—ì„œ ê°€ì ¸ì˜¤ê¸°
        if (!creditsLimit || creditsLimit === 0) {
          if (pricing) {
            // pricing_configì—ì„œ ë“±ê¸‰ë³„ í¬í•¨ í¬ë ˆë”§ ì¡°íšŒ
            const includedCreditsKey = `${userType}_${membershipLevel}_included_credits`;
            creditsLimit = pricing[includedCreditsKey] !== undefined ? pricing[includedCreditsKey] : 0;
          }
          
          // ì—¬ì „íˆ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
          if (!creditsLimit || creditsLimit === 0) {
            const defaults = {
              seed: 0,
              power: 37500,
              bigpower: 83333,
              premium: 200000
            };
            creditsLimit = defaults[membershipLevel] || 0;
          }
        }
        
        let creditsRemaining = cycle.credits_remaining !== undefined ? cycle.credits_remaining : (creditsLimit - creditsUsed);
        
        if (isAdmin || (creditsLimit && creditsLimit >= 999999)) {
          creditsLimit = null;
          creditsRemaining = null;
        }
        
        // ê²°ì œ ì„¹ì…˜ì˜ ì‘ì—… í¬ë ˆë”§ ì •ë³´ ì—…ë°ì´íŠ¸ (ìˆëŠ” ê²½ìš°)
        const paymentPlanTokensEl = document.getElementById('paymentPlanTokens');
        if (paymentPlanTokensEl) {
          if (creditsLimit === null) {
            paymentPlanTokensEl.textContent = 'ë¬´ì œí•œ';
          } else if (creditsLimit > 0) {
            paymentPlanTokensEl.textContent = `${creditsLimit.toLocaleString()} í¬ë ˆë”§`;
          } else {
            paymentPlanTokensEl.textContent = '0 í¬ë ˆë”§';
          }
        }
        
        // ê²°ì œ ì„¹ì…˜ì˜ ê°±ì‹ ì¼ ì—…ë°ì´íŠ¸
        const paymentPlanDaysEl = document.getElementById('paymentPlanDays');
        if (paymentPlanDaysEl && cycle.days_remaining) {
          paymentPlanDaysEl.textContent = `${cycle.days_remaining}ì¼`;
        }
        
        console.log('âœ… ì‘ì—… í¬ë ˆë”§ ì •ë³´ì™€ ê²°ì œ ì„¹ì…˜ ë™ê¸°í™” ì™„ë£Œ', { 
          creditsLimit, 
          creditsUsed, 
          membershipLevel,
          included_credits: cycle.included_credits 
        });
      } catch (error) {
        console.error('âŒ ì‘ì—… í¬ë ˆë”§ ì •ë³´ ë™ê¸°í™” ì‹¤íŒ¨:', error);
      }
    }

    // ì‹¤ì‹œê°„ ì‚¬ìš©ëŸ‰ í‘œì‹œ
    function displayRealTimeUsage(usage) {
      if (!usage) return;

      // ì‘ì—… í¬ë ˆë”§ ì‚¬ìš© í˜„í™© ì„¹ì…˜ ì—…ë°ì´íŠ¸
      updateWorkCreditSection(usage);

      // ì‚¬ìš©ëŸ‰ í‘œì‹œ ì˜ì—­ ì°¾ê¸° ë˜ëŠ” ìƒì„±
      let usageContainer = document.getElementById('realTimeUsageContainer');
      if (!usageContainer) {
        // ê²°ì œ ì„¹ì…˜ì— ì‚¬ìš©ëŸ‰ í‘œì‹œ ì˜ì—­ ì¶”ê°€
        const paymentSection = document.querySelector('.payment-section');
        if (paymentSection) {
          usageContainer = document.createElement('div');
          usageContainer.id = 'realTimeUsageContainer';
          usageContainer.style.cssText = 'margin-top: 20px; padding: 20px; background: var(--white); border-radius: 12px; border: 1px solid var(--border);';
          paymentSection.appendChild(usageContainer);
        } else {
          return; // ê²°ì œ ì„¹ì…˜ì´ ì—†ìœ¼ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
        }
      }

      const usagePercentage = usage.usagePercentage || 0;
      const isExceeded = usage.excessCredits > 0;
      const progressColor = isExceeded ? '#ef4444' : (usagePercentage >= 80 ? '#ffc107' : 'var(--accent-color)');

      usageContainer.innerHTML = `
        <div style="margin-bottom: 16px;">
          <h3 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px;">
            ğŸ“Š ì´ë²ˆ ë‹¬ ì‚¬ìš©ëŸ‰
          </h3>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: var(--text-secondary); font-size: 14px;">ì‚¬ìš©ëŸ‰</span>
            <strong style="color: var(--text-primary); font-size: 16px;">
              ${usage.totalCreditsUsed.toLocaleString()} / ${usage.includedCredits.toLocaleString()} í¬ë ˆë”§
            </strong>
          </div>
          <div style="width: 100%; height: 24px; background: var(--secondary); border-radius: 12px; overflow: hidden; position: relative; margin-bottom: 8px;">
            <div style="width: ${Math.min(100, usagePercentage)}%; height: 100%; background: ${progressColor}; transition: width 0.5s ease; border-radius: 12px;"></div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 600; color: ${usagePercentage > 50 ? 'white' : 'var(--text-primary)'};">
              ${usagePercentage.toFixed(1)}%
            </div>
          </div>
          ${isExceeded ? `
            <div style="padding: 12px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; border-radius: 4px; margin-top: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #dc2626; font-weight: 600; font-size: 14px;">
                  âš ï¸ í¬í•¨ í¬ë ˆë”§ ì´ˆê³¼
                </span>
                <strong style="color: #dc2626; font-size: 16px;">
                  +${usage.excessCredits.toLocaleString()} í¬ë ˆë”§
                </strong>
              </div>
              <div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">
                ì¶”ê°€ ìš”ê¸ˆ: <strong style="color: #dc2626;">${usage.estimatedExcessFee.toLocaleString()}ì›</strong>
                <br>
                <small>(${usage.excessCreditRate}ì›/í¬ë ˆë”§)</small>
              </div>
            </div>
          ` : usagePercentage >= 80 ? `
            <div style="padding: 12px; background: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; border-radius: 4px; margin-top: 12px; font-size: 13px; color: #856404;">
              âš ï¸ í¬í•¨ í¬ë ˆë”§ì˜ ${Math.round(usagePercentage)}% ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ì´ˆê³¼ ì‹œ ì¶”ê°€ ìš”ê¸ˆì´ ë°œìƒí•©ë‹ˆë‹¤.
            </div>
          ` : ''}
          ${usage.creditsRemaining > 0 ? `
            <div style="margin-top: 12px; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; text-align: center;">
              <span style="color: #16a34a; font-size: 14px; font-weight: 600;">
                ë‚¨ì€ í¬ë ˆë”§: ${usage.creditsRemaining.toLocaleString()} í¬ë ˆë”§
              </span>
            </div>
          ` : ''}
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary); text-align: center;">
            ì˜ˆìƒ ì´ë²ˆ ë‹¬ ì²­êµ¬ì•¡: <strong style="color: var(--accent-color);">
              ${usage.estimatedTotalAmount.toLocaleString()}ì›
            </strong>
            <br>
            <small>(ì›” ìµœì†Œ ì´ìš©ë£Œ: ${usage.minimumFee.toLocaleString()}ì›, ì‹¤ì œ ì‚¬ìš©: ${usage.actualUsageAmount.toLocaleString()}ì› ì¤‘ í° ê¸ˆì•¡)</small>
          </div>
        </div>
      `;
    }

    // ì‘ì—… í¬ë ˆë”§ ì‚¬ìš© í˜„í™© ì„¹ì…˜ ì—…ë°ì´íŠ¸
    function updateWorkCreditSection(usage) {
      if (!usage) return;

      try {
        // ì‚¬ìš© í¬ë ˆë”§ ì—…ë°ì´íŠ¸
        const tokensUsedEl = document.getElementById('tokensUsed');
        const tokensLimitEl = document.getElementById('tokensLimit');
        const tokensRemainingEl = document.getElementById('tokensRemaining');
        const usagePercentEl = document.getElementById('usagePercent');
        const tokenMeterFillEl = document.getElementById('tokenMeterFill');
        const estimatedBillingAmountEl = document.getElementById('estimatedBillingAmount');
        const minimumFeeEl = document.getElementById('minimumFee');
        const usageBasedAmountEl = document.getElementById('usageBasedAmount');

        if (tokensUsedEl) {
          // í‘œì‹œ í˜•ì‹: "ë‚¨ì€ í¬ë ˆë”§ / í¬í•¨ëœ í¬ë ˆë”§" (ì˜ˆ: 5000/5000, 4995/5000, 4985/5000...)
          const creditsRemaining = (usage.includedCredits || 0) - (usage.totalCreditsUsed || 0);
          tokensUsedEl.textContent = Math.max(0, creditsRemaining).toLocaleString();
        }
        if (tokensLimitEl) {
          tokensLimitEl.textContent = (usage.includedCredits || 0).toLocaleString();
        }
        if (tokensRemainingEl) {
          tokensRemainingEl.textContent = (usage.creditsRemaining || 0).toLocaleString();
        }

        // ì‚¬ìš©ë¥  ê³„ì‚° ë° ì—…ë°ì´íŠ¸
        const usagePercentage = usage.usagePercentage || 0;
        if (usagePercentEl) {
          usagePercentEl.textContent = `${usagePercentage.toFixed(1)}%`;
        }
        if (tokenMeterFillEl) {
          const progressColor = usage.excessCredits > 0 ? '#ef4444' : (usagePercentage >= 80 ? '#ffc107' : 'var(--accent-color)');
          tokenMeterFillEl.style.width = `${Math.min(100, usagePercentage)}%`;
          tokenMeterFillEl.style.background = progressColor;
        }

        // ì˜ˆìƒ ì²­êµ¬ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        if (estimatedBillingAmountEl) {
          estimatedBillingAmountEl.textContent = `${(usage.estimatedTotalAmount || 0).toLocaleString()}ì›`;
        }
        if (minimumFeeEl) {
          minimumFeeEl.textContent = (usage.minimumFee || 0).toLocaleString();
        }
        if (usageBasedAmountEl) {
          usageBasedAmountEl.textContent = (usage.actualUsageAmount || 0).toLocaleString();
        }

        console.log('âœ… ì‘ì—… í¬ë ˆë”§ ì‚¬ìš© í˜„í™© ì„¹ì…˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
      } catch (error) {
        console.error('âŒ ì‘ì—… í¬ë ˆë”§ ì„¹ì…˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
      }
    }
    
    // í† í° ì •ë³´ ìƒˆë¡œê³ ì¹¨
    async function refreshTokenInfo() {
      if (!supabase) {
        console.warn('âš ï¸ Supabaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
        return;
      }
      
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
          console.log('ğŸ”„ í† í° ì •ë³´ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
          await loadTokenInfo(session.user.id);
          lastTokenRefreshTime = Date.now();
          console.log('âœ… í† í° ì •ë³´ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
        } else {
          console.warn('âš ï¸ ì„¸ì…˜ì´ ì—†ì–´ í† í° ì •ë³´ë¥¼ ìƒˆë¡œê³ ì¹¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
      } catch (error) {
        console.error('âŒ í† í° ì •ë³´ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
      }
    }
    
    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (HTMLì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
    window.refreshTokenInfo = refreshTokenInfo;
    
    // í¬ë ˆë”§ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ í¬ë ˆë”§ ì°¨ê° ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨)
    window.addEventListener('creditUpdated', async function(event) {
      console.log('ğŸ”„ [í¬ë ˆë”§ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸] í¬ë ˆë”§ ì •ë³´ ìë™ ìƒˆë¡œê³ ì¹¨:', event.detail);
      await refreshTokenInfo();
    });
    
    // localStorage ë³€ê²½ ê°ì§€ (ë‹¤ë¥¸ íƒ­ì—ì„œ í¬ë ˆë”§ ì°¨ê° ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨)
    window.addEventListener('storage', function(event) {
      if (event.key === 'creditLastUpdated') {
        console.log('ğŸ”„ [í¬ë ˆë”§ ì—…ë°ì´íŠ¸ ê°ì§€] ë‹¤ë¥¸ íƒ­ì—ì„œ í¬ë ˆë”§ì´ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤. í¬ë ˆë”§ ì •ë³´ ìƒˆë¡œê³ ì¹¨...');
        refreshTokenInfo();
      }
    });
    
    // ì£¼ê¸°ì ìœ¼ë¡œ localStorage í™•ì¸ (ê°™ì€ íƒ­ì—ì„œë„ ê°ì§€)
    setInterval(function() {
      const lastUpdated = localStorage.getItem('creditLastUpdated');
      const lastChecked = sessionStorage.getItem('creditLastChecked') || '';
      
      if (lastUpdated && lastUpdated !== lastChecked) {
        console.log('ğŸ”„ [í¬ë ˆë”§ ì—…ë°ì´íŠ¸ ê°ì§€] í¬ë ˆë”§ ì •ë³´ ìƒˆë¡œê³ ì¹¨...');
        sessionStorage.setItem('creditLastChecked', lastUpdated);
        refreshTokenInfo();
      }
    }, 2000); // 2ì´ˆë§ˆë‹¤ í™•ì¸

    // í¬ë ˆë”§ íŒì—… ê´€ë ¨ í•¨ìˆ˜ë“¤
    async function showCreditModal() {
      const modal = document.getElementById('creditModal');
      if (!modal) {
        console.error('âŒ í¬ë ˆë”§ ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      document.getElementById('modalTokensUsed').textContent = 'ì¡°íšŒ ì¤‘...';
      document.getElementById('modalTokensLimit').textContent = 'ì¡°íšŒ ì¤‘...';
      document.getElementById('modalTokensRemaining').textContent = 'ì¡°íšŒ ì¤‘...';
      document.getElementById('modalUsagePercent').textContent = 'ì¡°íšŒ ì¤‘...';
      document.getElementById('modalEstimatedBilling').textContent = 'ì¡°íšŒ ì¤‘...';

      const warningBox = document.getElementById('creditWarningBox');
      const modalIcon = document.getElementById('creditModalIcon');
      
      // ê²½ê³  ë©”ì‹œì§€ ì´ˆê¸°í™”
      if (warningBox) {
        warningBox.classList.add('hidden');
      }
      if (modalIcon) {
        modalIcon.classList.remove('warning');
        modalIcon.innerHTML = '<i class="fas fa-coins"></i>';
      }

      modal.classList.add('active');

      // í˜„ì¬ í¬ë ˆë”§ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) {
          throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        }

        const userId = session.user.id;
        
        // ì‘ì—… í¬ë ˆë”§ ì‚¬ìš© í˜„í™© ì¡°íšŒ
        const usageResponse = await fetch(`/api/subscription/work-credit-billing?action=get-current-usage&userId=${userId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          }
        });

        if (!usageResponse.ok) {
          throw new Error('í¬ë ˆë”§ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }

        const usageResult = await usageResponse.json();
        
        if (usageResult.success && usageResult.usage) {
          const usage = usageResult.usage;
          const creditsUsed = usage.totalCreditsUsed || 0;
          const includedCredits = usage.includedCredits || 0;
          // ë‚¨ì€ í¬ë ˆë”§ ì§ì ‘ ê³„ì‚° (API ì‘ë‹µê°’ì´ ì—†ì„ ìˆ˜ ìˆìŒ)
          const creditsRemaining = Math.max(0, includedCredits - creditsUsed);
          const usagePercent = includedCredits > 0 ? Math.round((creditsUsed / includedCredits) * 100) : 0;
          const estimatedBilling = usage.estimatedTotalAmount || 0;
          const isInsufficient = creditsRemaining <= 0 && includedCredits > 0;

          // í¬ë ˆë”§ ë¶€ì¡± ì‹œ ê²½ê³  í‘œì‹œ
          if (isInsufficient && warningBox) {
            warningBox.classList.remove('hidden');
          }
          if (isInsufficient && modalIcon) {
            modalIcon.classList.add('warning');
            modalIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
          }

          // ê°’ ì—…ë°ì´íŠ¸
          document.getElementById('modalTokensUsed').textContent = creditsUsed.toLocaleString() + ' í¬ë ˆë”§';
          document.getElementById('modalTokensLimit').textContent = includedCredits > 0 ? includedCredits.toLocaleString() + ' í¬ë ˆë”§' : 'ë¬´ì œí•œ';
          document.getElementById('modalTokensRemaining').textContent = creditsRemaining.toLocaleString() + ' í¬ë ˆë”§';
          document.getElementById('modalTokensRemaining').className = 'credit-info-value ' + (isInsufficient ? 'warning' : 'success');
          document.getElementById('modalUsagePercent').textContent = usagePercent.toFixed(1) + '%';
          document.getElementById('modalUsagePercent').className = 'credit-info-value ' + (usagePercent >= 90 ? 'warning' : usagePercent >= 70 ? 'warning' : 'success');
          document.getElementById('modalEstimatedBilling').textContent = estimatedBilling.toLocaleString() + 'ì›';
        } else {
          throw new Error('í¬ë ˆë”§ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
      } catch (error) {
        console.error('âŒ í¬ë ˆë”§ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
        document.getElementById('modalTokensUsed').textContent = 'ì¡°íšŒ ì‹¤íŒ¨';
        document.getElementById('modalTokensUsed').className = 'credit-info-value warning';
        document.getElementById('modalTokensLimit').textContent = 'í™•ì¸ ë¶ˆê°€';
        document.getElementById('modalTokensRemaining').textContent = 'í™•ì¸ ë¶ˆê°€';
        document.getElementById('modalUsagePercent').textContent = 'í™•ì¸ ë¶ˆê°€';
        document.getElementById('modalEstimatedBilling').textContent = 'í™•ì¸ ë¶ˆê°€';
      }
    }

    function closeCreditModal() {
      const modal = document.getElementById('creditModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('DOMContentLoaded', function() {
      const creditModal = document.getElementById('creditModal');
      if (creditModal) {
        creditModal.addEventListener('click', function(e) {
          if (e.target === creditModal) {
            closeCreditModal();
          }
        });
      }
    });

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
    window.showCreditModal = showCreditModal;
    window.closeCreditModal = closeCreditModal;

    // ê°€ê²Œ ì •ë³´ ë¡œë“œ
    async function loadStoreInfo() {
      if (!currentUser) return;

      try {
        const response = await fetch(`/api/store-info?userId=${currentUser.id}`);
        if (!response.ok) {
          await loadMonitoringSettings();
          return;
        }

        const result = await response.json();
        if (!result.success || !result.data) {
          await loadMonitoringSettings();
          return;
        }

        const data = result.data;
        
        // âœ… "ë¯¸ì…ë ¥" ë¬¸ìì—´ í•„í„°ë§ í•¨ìˆ˜
        function cleanValue(value) {
          if (!value || typeof value !== 'string') return '';
          const trimmed = value.trim();
          // "ë¯¸ì…ë ¥", "ì •ë³´ ì—†ìŒ" ë“±ì˜ ë¬¸ìì—´ ì œê±°
          if (trimmed.includes('ë¯¸ì…ë ¥') || trimmed.includes('ì •ë³´ ì—†ìŒ')) return '';
          return trimmed;
        }
        
        // í¼ì— ìë™ ì…ë ¥ (ì •ì œëœ ê°’ë§Œ ì…ë ¥)
        const cleanedData = {
          storeUrl: cleanValue(data.store_place_url),
          storeName: cleanValue(data.store_name),
          storeAddress: cleanValue(data.store_address),
          storeHours: cleanValue(data.store_business_hours),
          storePhone: cleanValue(data.store_phone_number),
          storeMenu: cleanValue(data.store_main_menu),
          storeLandmarks: cleanValue(data.store_landmarks),
          storeKeywords: cleanValue(data.store_keywords)
        };
        
        console.log('âœ… ê°€ê²Œ ì •ë³´ ë¡œë“œ ì™„ë£Œ (ì •ì œë¨):', cleanedData);
        
        // ë¹ˆ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš°ë§Œ ì…ë ¥
        if (cleanedData.storeUrl) {
          const normalizedLoadedUrl = normalizePlaceUrl(cleanedData.storeUrl) || cleanedData.storeUrl;
          document.getElementById('editStoreUrl').value = normalizedLoadedUrl;
          cachedStorePlaceUrl = normalizedLoadedUrl;
        } else {
          cachedStorePlaceUrl = '';
        }
        if (cleanedData.storeName) document.getElementById('editStoreName').value = cleanedData.storeName;
        if (cleanedData.storeAddress) document.getElementById('editStoreAddress').value = cleanedData.storeAddress;
        
        // ì˜ì—…ì‹œê°„ íŒŒì‹±í•˜ì—¬ ë“œë¡­ë‹¤ìš´ì— ì„¤ì •
        if (cleanedData.storeHours) {
          const parsed = parseBusinessHours(cleanedData.storeHours);
          if (parsed.openHour) document.getElementById('editStoreOpenHour').value = parsed.openHour;
          if (parsed.closeHour) document.getElementById('editStoreCloseHour').value = parsed.closeHour;
          if (parsed.days) document.getElementById('editStoreDays').value = parsed.days;
        }
        
        if (cleanedData.storePhone) document.getElementById('editStorePhone').value = cleanedData.storePhone;
        if (cleanedData.storeMenu) document.getElementById('editStoreMenu').value = cleanedData.storeMenu;
        if (cleanedData.storeLandmarks) document.getElementById('editStoreLandmarks').value = cleanedData.storeLandmarks;
        if (cleanedData.storeKeywords) document.getElementById('editStoreKeywords').value = cleanedData.storeKeywords;

        cachedStorePlaceUrl = cleanedData.storeUrl || '';
      } catch (error) {
        console.error('ê°€ê²Œ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ë‚´ ê°€ê²Œ ì•Œë¦¬ê¸° ì €ì¥
    async function savePromotion() {
      if (!currentUser) {
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      const promotionData = {
        signature_menu: document.getElementById('signatureMenu').value.trim(),
        special_ingredients: document.getElementById('specialIngredients').value.trim(),
        atmosphere_facilities: document.getElementById('atmosphereFacilities').value.trim(),
        owner_story: document.getElementById('ownerStory').value.trim(),
        recommended_situations: document.getElementById('recommendedSituations').value.trim(),
        sns_photo_points: document.getElementById('snsPhotoPoints').value.trim(),
        special_events: document.getElementById('specialEvents').value.trim()
      };

      try {
        const response = await fetch('/api/store-promotion', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUser.id, promotionData })
        });

        if (!response.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');

        const result = await response.json();
        if (result.success) {
          alert(`âœ… ì €ì¥ ì™„ë£Œ!\n\nì‘ì„± í˜„í™©: ${result.filledCount} / ${result.totalCount} í•­ëª©\n\nğŸ’¡ ìì„¸íˆ ì“¸ìˆ˜ë¡ AIê°€ ë” í’ë¶€í•œ ë¸”ë¡œê·¸/ë‹µê¸€ì„ ìƒì„±í•©ë‹ˆë‹¤!`);
          
          // ìƒíƒœ ì—…ë°ì´íŠ¸
          updatePromotionStatus(result.filledCount, result.totalCount);
        } else {
          throw new Error(result.error || 'ì €ì¥ ì‹¤íŒ¨');
        }

      } catch (error) {
        console.error('âŒ ë‚´ ê°€ê²Œ ì•Œë¦¬ê¸° ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ë‚´ ê°€ê²Œ ì•Œë¦¬ê¸° ë¡œë“œ
    async function loadPromotion() {
      if (!currentUser) return;

      try {
        const response = await fetch(`/api/store-promotion?userId=${currentUser.id}`);
        if (!response.ok) return;

        const result = await response.json();
        if (!result.success) return;

        const data = result.data;
        
        if (data) {
          // í¼ì— ìë™ ì…ë ¥
          if (data.signature_menu) document.getElementById('signatureMenu').value = data.signature_menu;
          if (data.special_ingredients) document.getElementById('specialIngredients').value = data.special_ingredients;
          if (data.atmosphere_facilities) document.getElementById('atmosphereFacilities').value = data.atmosphere_facilities;
          if (data.owner_story) document.getElementById('ownerStory').value = data.owner_story;
          if (data.recommended_situations) document.getElementById('recommendedSituations').value = data.recommended_situations;
          if (data.sns_photo_points) document.getElementById('snsPhotoPoints').value = data.sns_photo_points;
          if (data.special_events) document.getElementById('specialEvents').value = data.special_events;
        }

        // ì‘ì„± í˜„í™© ì—…ë°ì´íŠ¸
        updatePromotionStatus(result.filledCount || 0, result.totalCount || 7);
        
        console.log('âœ… ë‚´ ê°€ê²Œ ì•Œë¦¬ê¸° ë¡œë“œ ì™„ë£Œ:', result.filledCount, '/ 7');
      } catch (error) {
        console.error('ë‚´ ê°€ê²Œ ì•Œë¦¬ê¸° ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ì‘ì„± í˜„í™© ì—…ë°ì´íŠ¸
    function updatePromotionStatus(filled, total) {
      const percentage = Math.round((filled / total) * 100);
      
      document.getElementById('promotionCount').textContent = `${filled} / ${total} í•­ëª©`;
      document.getElementById('promotionBar').style.width = `${percentage}%`;
      
      // ê° í•­ëª© ì²´í¬ í‘œì‹œ
      const fields = [
        { id: 'sigStatus', elementId: 'signatureMenu' },
        { id: 'ingStatus', elementId: 'specialIngredients' },
        { id: 'atmStatus', elementId: 'atmosphereFacilities' },
        { id: 'storyStatus', elementId: 'ownerStory' },
        { id: 'situStatus', elementId: 'recommendedSituations' },
        { id: 'snsStatus', elementId: 'snsPhotoPoints' },
        { id: 'eventStatus', elementId: 'specialEvents' }
      ];

      fields.forEach(field => {
        const value = document.getElementById(field.elementId).value.trim();
        const statusEl = document.getElementById(field.id);
        if (statusEl) {
          statusEl.textContent = value ? 'âœ…' : 'â–¡';
          statusEl.style.color = value ? '#4CAF50' : '#999';
        }
      });
    }

    // ì‹¤ì‹œê°„ ì‘ì„± í˜„í™© ì—…ë°ì´íŠ¸
    function setupPromotionListeners() {
      const textareas = [
        'signatureMenu', 'specialIngredients', 'atmosphereFacilities',
        'ownerStory', 'recommendedSituations', 'snsPhotoPoints', 'specialEvents'
      ];

      textareas.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', () => {
            const filled = textareas.filter(tid => 
              document.getElementById(tid).value.trim().length > 0
            ).length;
            updatePromotionStatus(filled, 7);
          });
        }
      });
    }

    // ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ ë¡œë“œ
    async function loadBlogStyle() {
      if (!currentUser) return;

      try {
        const response = await fetch(`/api/blog-style?userId=${currentUser.id}`);
        if (!response.ok) return;

        const result = await response.json();
        if (!result.success || !result.data) return;

        const style = result.data;

        // í¼ í•„ë“œ ìë™ ì…ë ¥
        if (style.tone) document.getElementById('blogTone').value = style.tone;
        if (style.formality) document.getElementById('blogFormality').value = style.formality;
        if (style.emoji_usage) document.getElementById('blogEmojiUsage').value = style.emoji_usage;
        if (style.personality) document.getElementById('blogPersonality').value = style.personality;
        if (style.expertise_level) document.getElementById('blogExpertiseLevel').value = style.expertise_level;
        if (style.content_length) document.getElementById('blogContentLength').value = style.content_length;
        if (style.writing_style) document.getElementById('blogWritingStyle').value = style.writing_style;

        console.log('âœ… ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ ë¡œë“œ ì™„ë£Œ');
      } catch (error) {
        console.error('ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ ì €ì¥
    async function saveBlogStyle() {
      if (!currentUser) {
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      try {
        const blogStyle = {
          tone: document.getElementById('blogTone').value,
          formality: document.getElementById('blogFormality').value,
          emoji_usage: document.getElementById('blogEmojiUsage').value,
          personality: document.getElementById('blogPersonality').value,
          expertise_level: document.getElementById('blogExpertiseLevel').value,
          content_length: document.getElementById('blogContentLength').value,
          writing_style: document.getElementById('blogWritingStyle').value
        };

        const response = await fetch('/api/blog-style', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userId: currentUser.id, 
            blogStyle 
          })
        });

        if (!response.ok) {
          throw new Error('ì €ì¥ ì‹¤íŒ¨');
        }

        const result = await response.json();
        if (result.success) {
          alert('âœ… ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¤ìŒ ë¸”ë¡œê·¸ ì‘ì„± ì‹œë¶€í„° ì´ ìŠ¤íƒ€ì¼ë¡œ ì‘ì„±ë©ë‹ˆë‹¤.');
        } else {
          throw new Error(result.error || 'ì €ì¥ ì‹¤íŒ¨');
        }

      } catch (error) {
        console.error('âŒ ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ì‡¼ì¸  ì˜ìƒ ëª©ë¡ ë¡œë“œ
    async function loadShortsVideos(userId) {
      const container = document.getElementById('shortsVideos');
      if (!container) return;
      
      try {
        // Supabase ì„¸ì…˜ì—ì„œ userId ê°€ì ¸ì˜¤ê¸°
        if (!userId && supabase) {
          const { data: { session } } = await supabase.auth.getSession();
          if (session?.user) {
            userId = session.user.id;
          }
        }

        if (!userId) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <div>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
            </div>
          `;
          return;
        }

        const response = await fetch(`/api/shorts/videos?userId=${encodeURIComponent(userId)}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'user-id': userId
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('API ì‘ë‹µ ì˜¤ë¥˜:', response.status, errorText);
          throw new Error(`ì˜ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ (${response.status})`);
        }

        const result = await response.json();

        if (!result.success || !result.data || result.data.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-video"></i>
              <div>ìƒì„±í•œ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>
              <button class="btn btn-primary" onclick="location.href='/shorts-editor.html'" style="margin-top: 16px;">
                <i class="fas fa-plus"></i> ì˜ìƒ ë§Œë“¤ê¸°
              </button>
            </div>
          `;
          return;
        }

        container.innerHTML = result.data.map(video => {
          const statusText = {
            'processing': 'ìƒì„± ì¤‘...',
            'completed': 'ì™„ë£Œ',
            'failed': 'ì‹¤íŒ¨'
          }[video.status] || video.status;

          const statusColor = {
            'processing': 'var(--warning)',
            'completed': 'var(--success)',
            'failed': 'var(--error)'
          }[video.status] || 'var(--text-secondary)';

          const styleNames = {
            'luxury': 'ëŸ­ì…”ë¦¬',
            'fast': 'ë¹ ë¥¸ ë¦¬ë“¬',
            'chef': 'ì…°í”„ì˜ ì†',
            'plating': 'í”Œë ˆì´íŒ…',
            'simple': 'ì‹¬í”Œ í´ë˜ì‹'
          };

          // ìƒì„± ì¤‘ì¸ ì˜ìƒì€ ì£¼ê¸°ì ìœ¼ë¡œ ìƒíƒœ ì²´í¬
          const videoId = video.id;
          const isProcessing = video.status === 'processing';
          
          // ì˜ìƒ URL ì²˜ë¦¬
          let videoSrc = '';
          if (video.status === 'completed' && video.video_url) {
            if (video.video_url.includes('supabase.co/storage')) {
              // Supabase Storage URLì€ ì§ì ‘ ì‚¬ìš© (ì„œë²„ì— ì €ì¥ëœ ì˜ìƒ)
              videoSrc = video.video_url;
            } else if (video.video_url.includes('generativelanguage.googleapis.com')) {
              // Google API URLì€ í•­ìƒ í”„ë¡ì‹œ ì‚¬ìš©
              videoSrc = '/api/shorts/play?url=' + encodeURIComponent(video.video_url);
            } else if (video.video_url.startsWith('http')) {
              // ì¼ë°˜ HTTP URLì€ ì§ì ‘ ì‚¬ìš©
              videoSrc = video.video_url;
            } else {
              // ìƒëŒ€ ê²½ë¡œë‚˜ ê¸°íƒ€ URLì€ í”„ë¡ì‹œ ì‚¬ìš©
              videoSrc = '/api/shorts/play?url=' + encodeURIComponent(video.video_url);
            }
          }
          
          return `
            <div class="activity-item" id="shorts-video-${videoId}" data-video-id="${videoId}" data-status="${video.status}">
              <div class="activity-title">
                ${video.menu_name || video.title || 'ì œëª© ì—†ìŒ'}
                <span style="margin-left: 8px; font-size: 12px; color: ${statusColor}; font-weight: 600;">
                  ${statusText}
                  ${isProcessing ? '<i class="fas fa-spinner fa-spin" style="margin-left: 4px;"></i>' : ''}
                </span>
              </div>
              <div class="activity-content">
                ${video.menu_features ? video.menu_features.substring(0, 80) + '...' : 'ì„¤ëª… ì—†ìŒ'}
                ${video.menu_price ? ` Â· ${video.menu_price}` : ''}
                ${video.style ? ` Â· ${styleNames[video.style] || video.style}` : ''}
                ${video.duration_sec ? ` Â· ${video.duration_sec}ì´ˆ` : ''}
              </div>
              ${video.status === 'completed' && video.video_url ? `
                <div style="margin-top: 12px; position: relative;" id="video-container-${videoId}">
                  <video 
                    id="video-${videoId}"
                    controls 
                    preload="metadata" 
                    crossorigin="anonymous"
                    playsinline
                    style="max-width: 200px; max-height: 300px; width: 100%; border-radius: 8px; border: 1px solid var(--border); background: #000; display: block; cursor: pointer; pointer-events: auto;"
                    data-video-src="${videoSrc}">
                    <source src="${videoSrc}" type="video/mp4">
                    ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                  </video>
                </div>
              ` : ''}
              ${video.status === 'failed' ? `
                <div style="margin-top: 8px; padding: 8px; background: #fee2e2; border-radius: 6px; font-size: 12px; color: #dc2626;">
                  <i class="fas fa-exclamation-triangle"></i> ìƒì„± ì‹¤íŒ¨
                </div>
              ` : ''}
              <div class="activity-meta" style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                <span><i class="fas fa-clock"></i> ${new Date(video.created_at).toLocaleString('ko-KR', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit'
                })}</span>
                <div style="display: flex; gap: 8px;">
                  ${video.status === 'completed' && video.video_url ? `
                    <button onclick="downloadVideo('${video.video_url}', '${(video.menu_name || video.title || 'video').replace(/[^a-zA-Z0-9ê°€-í£]/g, '_')}.mp4', '${videoId}')" 
                            style="padding: 6px 12px; background: var(--white); color: var(--accent-color); border: 1px solid var(--accent-color); border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
                      <i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ
                    </button>
                    ${!video.video_url.includes('supabase.co/storage') ? `
                      <button onclick="saveVideoToServer('${videoId}')" 
                              style="padding: 6px 12px; background: var(--secondary); color: var(--accent-color); border: 1px solid var(--accent-color); border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;"
                              title="ë§Œë£Œëœ ì˜ìƒì„ ì„œë²„ì— ì €ì¥">
                        <i class="fas fa-cloud-upload-alt"></i> ì„œë²„ ì €ì¥
                      </button>
                    ` : ''}
                  ` : ''}
                  ${isProcessing ? `
                    <button onclick="checkVideoStatus('${videoId}')" 
                            style="padding: 6px 12px; background: var(--secondary); color: var(--accent-color); border: 1px solid var(--accent-color); border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
                      <i class="fas fa-sync-alt"></i> ìƒíƒœ í™•ì¸
                    </button>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');

        // ìƒì„± ì¤‘ì¸ ì˜ìƒì´ ìˆìœ¼ë©´ ì£¼ê¸°ì ìœ¼ë¡œ ìƒíƒœ ì²´í¬
        const processingVideos = result.data.filter(v => v.status === 'processing');
        if (processingVideos.length > 0) {
          console.log(`ğŸ”„ ìƒì„± ì¤‘ì¸ ì˜ìƒ ${processingVideos.length}ê°œ ë°œê²¬. ì£¼ê¸°ì  ìƒíƒœ ì²´í¬ ì‹œì‘...`);
          startVideoStatusPolling(userId);
        }

        // ì™„ë£Œëœ ì˜ìƒì˜ video íƒœê·¸ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        result.data.filter(v => v.status === 'completed' && v.video_url).forEach(video => {
          const videoId = video.id;
          setTimeout(() => {
            const videoEl = document.getElementById(`video-${videoId}`);
            if (videoEl) {
              const videoSrc = videoEl.getAttribute('data-video-src') || videoEl.querySelector('source')?.src;
              console.log('ğŸ¬ ì˜ìƒ ë¡œë“œ ì‹œë„:', videoId, videoSrc);
              
              // ì—ëŸ¬ í•¸ë“¤ë§
              videoEl.addEventListener('error', function(e) {
                console.error('âŒ ì˜ìƒ ë¡œë“œ ì˜¤ë¥˜:', {
                  videoId: videoId,
                  src: this.src,
                  error: e,
                  networkState: this.networkState,
                  readyState: this.readyState,
                  errorCode: this.error?.code,
                  errorMessage: this.error?.message
                });
                
                const container = document.getElementById(`video-container-${videoId}`);
                if (container) {
                  container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #999; background: #f5f5f5; border-radius: 8px;">
                      <i class="fas fa-exclamation-triangle"></i><br>
                      ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br>
                      <small style="font-size: 10px; color: #ccc;">${this.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</small>
                    </div>
                  `;
                }
              }, { once: true });
              
              // ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸
              videoEl.addEventListener('loadedmetadata', function() {
                console.log('âœ… ì˜ìƒ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', videoId, this.videoWidth, 'x', this.videoHeight);
              });
              
              videoEl.addEventListener('canplay', function() {
                console.log('âœ… ì˜ìƒ ì¬ìƒ ê°€ëŠ¥:', videoId);
              });
              
              videoEl.addEventListener('loadstart', function() {
                console.log('ğŸ”„ ì˜ìƒ ë¡œë“œ ì‹œì‘:', videoId);
              });
              
              // ê°•ì œë¡œ ë¡œë“œ ì‹œë„
              if (videoEl.readyState === 0) {
                console.log('ğŸ”„ ì˜ìƒ ê°•ì œ ë¡œë“œ ì‹œë„:', videoId);
                videoEl.load();
              }
              
              // 3ì´ˆ í›„ì—ë„ ë¡œë“œë˜ì§€ ì•Šìœ¼ë©´ ì¬ì‹œë„
              setTimeout(() => {
                if (videoEl.readyState === 0 || videoEl.networkState === 3) {
                  console.log('ğŸ”„ ì˜ìƒ ë¡œë“œ ì¬ì‹œë„:', videoId);
                  videoEl.load();
                }
              }, 3000);
            }
          }, 200);
        });

        // #shorts í•´ì‹œê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        if (window.location.hash === '#shorts') {
          setTimeout(() => {
            const section = document.getElementById('shortsSection');
            if (section) {
              section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 500);
        }

      } catch (error) {
        console.error('âŒ ì‡¼ì¸  ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <div>ì˜ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>
          </div>
        `;
      }
    }

    // ì˜ìƒ ìƒíƒœ ì²´í¬ (ë‹¨ì¼)
    async function checkVideoStatus(videoId) {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }

        const userId = session.user.id;
        const response = await fetch(`/api/shorts/videos?userId=${encodeURIComponent(userId)}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'user-id': userId
          }
        });

        if (!response.ok) {
          throw new Error('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨');
        }

        const result = await response.json();
        if (result.success && result.data) {
          const video = result.data.find(v => v.id === videoId);
          if (video) {
            // í•´ë‹¹ ì˜ìƒë§Œ ì—…ë°ì´íŠ¸
            const videoElement = document.getElementById(`shorts-video-${videoId}`);
            if (videoElement) {
              // ì „ì²´ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ (ê°„ë‹¨í•œ ë°©ë²•)
              await loadShortsVideos(userId);
            }
          }
        }
      } catch (error) {
        console.error('âŒ ì˜ìƒ ìƒíƒœ ì²´í¬ ì‹¤íŒ¨:', error);
        alert('ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì˜ìƒ ìƒíƒœ ì£¼ê¸°ì  ì²´í¬ (Polling)
    let videoStatusPollingInterval = null;

    function startVideoStatusPolling(userId) {
      // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆìœ¼ë©´ ì •ë¦¬
      if (videoStatusPollingInterval) {
        clearInterval(videoStatusPollingInterval);
      }

      // 10ì´ˆë§ˆë‹¤ ìƒíƒœ ì²´í¬
      videoStatusPollingInterval = setInterval(async () => {
        try {
          const response = await fetch(`/api/shorts/videos?userId=${encodeURIComponent(userId)}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'user-id': userId
            }
          });

          if (!response.ok) {
            console.warn('âš ï¸ ì˜ìƒ ìƒíƒœ ì²´í¬ ì‹¤íŒ¨');
            return;
          }

          const result = await response.json();
          if (result.success && result.data) {
            const processingVideos = result.data.filter(v => v.status === 'processing');
            
            // ìƒì„± ì¤‘ì¸ ì˜ìƒì´ ì—†ìœ¼ë©´ í´ë§ ì¤‘ì§€
            if (processingVideos.length === 0) {
              console.log('âœ… ëª¨ë“  ì˜ìƒ ìƒì„± ì™„ë£Œ. ìƒíƒœ ì²´í¬ ì¤‘ì§€.');
              clearInterval(videoStatusPollingInterval);
              videoStatusPollingInterval = null;
              return;
            }

            // ìƒíƒœê°€ ë³€ê²½ëœ ì˜ìƒì´ ìˆìœ¼ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            const currentVideos = Array.from(document.querySelectorAll('[data-video-id]'));
            let needsRefresh = false;

            for (const video of result.data) {
              const element = document.getElementById(`shorts-video-${video.id}`);
              if (element) {
                const currentStatus = element.getAttribute('data-status');
                if (currentStatus !== video.status) {
                  needsRefresh = true;
                  break;
                }
              }
            }

            if (needsRefresh) {
              console.log('ğŸ”„ ì˜ìƒ ìƒíƒœ ë³€ê²½ ê°ì§€. ëª©ë¡ ìƒˆë¡œê³ ì¹¨...');
              await loadShortsVideos(userId);
            }
          }
        } catch (error) {
          console.error('âŒ ì˜ìƒ ìƒíƒœ ì²´í¬ ì¤‘ ì˜¤ë¥˜:', error);
        }
      }, 10000); // 10ì´ˆë§ˆë‹¤ ì²´í¬

      console.log('âœ… ì˜ìƒ ìƒíƒœ ì£¼ê¸°ì  ì²´í¬ ì‹œì‘ (10ì´ˆ ê°„ê²©)');
    }

    // ì˜ìƒ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    async function downloadVideo(videoUrl, filename, videoId) {
      try {
        console.log('ğŸ“¥ ì˜ìƒ ë‹¤ìš´ë¡œë“œ ì‹œì‘:', videoUrl, filename, videoId);
        
        // í˜„ì¬ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
        let userId = null;
        if (supabase) {
          const { data: { session } } = await supabase.auth.getSession();
          if (session?.user) {
            userId = session.user.id;
          }
        }
        
        // ì„œë²„ í”„ë¡ì‹œ APIë¥¼ í†µí•´ ë‹¤ìš´ë¡œë“œ
        let proxyUrl = `/api/shorts/download?url=${encodeURIComponent(videoUrl)}&filename=${encodeURIComponent(filename)}`;
        if (videoId) {
          proxyUrl += `&videoId=${encodeURIComponent(videoId)}`;
        }
        if (userId) {
          proxyUrl += `&userId=${encodeURIComponent(userId)}`;
        }
        
        console.log('ğŸ“¥ ë‹¤ìš´ë¡œë“œ URL:', proxyUrl);
        
        // fetchë¥¼ ì‚¬ìš©í•´ì„œ blobìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: {
            'Accept': 'video/mp4, video/*, */*'
          }
        });
        
        if (!response.ok) {
          let errorMessage = 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨';
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorMessage;
          } catch (e) {
            const errorText = await response.text();
            errorMessage = errorText || errorMessage;
          }
          
          console.error('âŒ ë‹¤ìš´ë¡œë“œ ì‘ë‹µ ì˜¤ë¥˜:', response.status, errorMessage);
          
          // 403 ì—ëŸ¬ì¸ ê²½ìš° íŠ¹ë³„í•œ ë©”ì‹œì§€
          if (response.status === 403) {
            throw new Error('ì˜ìƒ ë‹¤ìš´ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì˜ìƒ URLì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì ‘ê·¼ì´ ì œí•œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          }
          
          throw new Error(errorMessage);
        }
        
        // blobìœ¼ë¡œ ë³€í™˜
        const blob = await response.blob();
        console.log('âœ… Blob ìƒì„± ì™„ë£Œ:', blob.size, 'bytes');
        
        // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        
        // ì •ë¦¬
        setTimeout(() => {
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        }, 100);
        
        console.log('âœ… ì˜ìƒ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filename);
      } catch (error) {
        console.error('âŒ ì˜ìƒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
        
        // Google API URLì´ê³  400/403 ì—ëŸ¬ì¸ ê²½ìš° ì„œë²„ì— ì €ì¥ ì‹œë„
        if (videoUrl.includes('generativelanguage.googleapis.com') && 
            (error.message.includes('400') || error.message.includes('403') || error.message.includes('ë§Œë£Œ'))) {
          console.log('ğŸ’¾ ë§Œë£Œëœ ì˜ìƒ ê°ì§€ - ì„œë²„ì— ì €ì¥ ì‹œë„...');
          try {
            await saveVideoToServer(videoId);
            // ì €ì¥ ì„±ê³µ í›„ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ ì‹œë„
            setTimeout(() => {
              downloadVideo(videoUrl, filename, videoId);
            }, 1000);
            return;
          } catch (saveError) {
            console.error('âŒ ì„œë²„ ì €ì¥ ì‹¤íŒ¨:', saveError);
          }
        }
        
        alert('ì˜ìƒ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    }

    // ì˜ìƒì„ ì„œë²„ì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
    async function saveVideoToServer(videoId) {
      try {
        if (!supabase) {
          throw new Error('Supabaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
        }

        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) {
          throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        }

        console.log('ğŸ’¾ ì˜ìƒ ì„œë²„ ì €ì¥ ì‹œì‘:', videoId);

        const response = await fetch('/api/shorts/save-to-server', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'user-id': session.user.id
          },
          body: JSON.stringify({ videoId })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'ì„œë²„ ì €ì¥ ì‹¤íŒ¨');
        }

        const result = await response.json();
        
        if (result.success) {
          console.log('âœ… ì˜ìƒ ì„œë²„ ì €ì¥ ì™„ë£Œ:', result.video_url);
          alert('âœ… ì˜ìƒì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ì œ ë‹¤ìš´ë¡œë“œì™€ ì¬ìƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
          
          // ì˜ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          if (session?.user) {
            await loadShortsVideos(session.user.id);
          }
        } else {
          throw new Error(result.error || 'ì„œë²„ ì €ì¥ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('âŒ ì˜ìƒ ì„œë²„ ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ì˜ìƒ ì„œë²„ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        throw error;
      }
    }

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¸í„°ë²Œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (videoStatusPollingInterval) {
        clearInterval(videoStatusPollingInterval);
      }
    });

    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      document.getElementById('loadingContainer').style.display = 'none';
      const container = document.getElementById('errorContainer');
      container.innerHTML = `
        <div class="error">
          <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
      `;
      container.style.display = 'block';
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸
    function setupLogoutButton() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async function() {
          if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
          
          try {
            // Supabase ë¡œê·¸ì•„ì›ƒ
            if (supabase) {
              await supabase.auth.signOut();
            }
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userData');
            
            // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/login.html';
          } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        });
      }
    }

    // ========== ì™¸ë¶€ í”Œë«í¼ ì—°ë™ ê´€ë ¨ í•¨ìˆ˜ ==========
    
    // ì—°ë™ëœ í”Œë«í¼ ëª©ë¡ ë¡œë“œ
    async function loadPlatformConnections(userId) {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        // ëª¨ë“  í”Œë«í¼ì˜ ì—°ë™ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸°
        const [naverRes, baeminRes, yogiyoRes, coupangRes] = await Promise.allSettled([
          fetch('/api/naver/connections', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'user-id': userId
            }
          }),
          fetch('/api/baemin/connections', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'user-id': userId
            }
          }),
          fetch('/api/yogiyo/connections', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'user-id': userId
            }
          }),
          fetch('/api/coupangeats/connections', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'user-id': userId
            }
          })
        ]);

        const connections = [];
        
        // ë„¤ì´ë²„
        if (naverRes.status === 'fulfilled' && naverRes.value.ok) {
          const naverData = await naverRes.value.json();
          if (naverData.connections) {
            connections.push(...naverData.connections.map(c => ({ ...c, platform: 'naver' })));
          }
        }
        
        // ë°°ë‹¬ì˜ë¯¼ì¡±
        if (baeminRes.status === 'fulfilled' && baeminRes.value.ok) {
          const baeminData = await baeminRes.value.json();
          if (baeminData.connections) {
            connections.push(...baeminData.connections.map(c => ({ ...c, platform: 'baemin' })));
          }
        }
        
        // ìš”ê¸°ìš”
        if (yogiyoRes.status === 'fulfilled' && yogiyoRes.value.ok) {
          const yogiyoData = await yogiyoRes.value.json();
          if (yogiyoData.connections) {
            connections.push(...yogiyoData.connections.map(c => ({ ...c, platform: 'yogiyo' })));
          }
        }
        
        // ì¿ íŒ¡ì´ì¸ 
        if (coupangRes.status === 'fulfilled' && coupangRes.value.ok) {
          const coupangData = await coupangRes.value.json();
          if (coupangData.connections) {
            connections.push(...coupangData.connections.map(c => ({ ...c, platform: 'coupangeats' })));
          }
        }

        // ê° ì—°ë™ì— ëŒ€í•´ í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë°±ì—”ë“œ API ì§€ì› ì‹œ)
        const connectionsWithProfile = await Promise.all(
          connections.map(async (conn) => {
            try {
              const profileRes = await fetch(`/api/${conn.platform}/profile?connectionId=${conn.id}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'user-id': userId
          }
        });

              if (profileRes.ok) {
                const profileData = await profileRes.json();
                if (profileData.success && profileData.profile) {
                  return { ...conn, ...profileData.profile };
                }
              }
            } catch (error) {
              console.warn(`âš ï¸ ${conn.platform} í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:`, error);
            }
            return conn;
          })
        );

        updatePlatformConnectionsUI(connectionsWithProfile);
      } catch (error) {
        console.error('âŒ í”Œë«í¼ ì—°ë™ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        updatePlatformConnectionsUI([]);
      }
    }

    // UI ì—…ë°ì´íŠ¸
    function updatePlatformConnectionsUI(connections) {
      const container = document.getElementById('connectedPlatforms');

      // ì—°ë™ëœ í”Œë«í¼ ëª©ë¡ í‘œì‹œ
      if (connections && connections.length > 0) {
        // ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ ì œê±° (ì»¨í…Œì´ë„ˆë¥¼ ë¹„ìš°ì§€ ì•Šê³  ë°”ë¡œ ì¹´ë“œ í‘œì‹œ)
        const platformInfo = {
          naver: { name: 'ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸í”Œë ˆì´ìŠ¤', icon: 'fab fa-neos', color: '#03C75A' },
          baemin: { name: 'ë°°ë‹¬ì˜ë¯¼ì¡±', icon: 'fas fa-utensils', color: '#2AC1BC' },
          yogiyo: { name: 'ìš”ê¸°ìš”', icon: 'fas fa-motorcycle', color: '#FF2F00' },
          coupangeats: { name: 'ì¿ íŒ¡ì´ì¸ ', icon: 'fas fa-shopping-bag', color: '#FFA500' }
        };

        container.innerHTML = connections.map(conn => {
          const platform = platformInfo[conn.platform] || { name: conn.platform, icon: 'fas fa-link', color: '#666' };
          
          // í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ
          const profileImage = conn.profile_image || conn.store_image || conn.place_image || null;
          const storeName = conn.place_name || conn.store_name || conn.business_name || platform.name;
          const storeAddress = conn.address || conn.store_address || conn.place_address || '';
          const phoneNumber = conn.phone || conn.store_phone || conn.phone_number || '';
          
          return `
            <div class="platform-card" style="
            background: var(--white);
              border: 2px solid ${platform.color};
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
          ">
              <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                ${profileImage ? `
                  <img src="${profileImage}" alt="${storeName}" style="
                    width: 80px;
                    height: 80px;
                    border-radius: 12px;
                    object-fit: cover;
                    border: 2px solid ${platform.color};
                  " onerror="this.style.display='none'">
                ` : `
                  <div style="
                    width: 80px;
                    height: 80px;
                    border-radius: 12px;
                    background: linear-gradient(135deg, ${platform.color}, ${platform.color}dd);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border: 2px solid ${platform.color};
                  ">
                    <i class="${platform.icon}" style="font-size: 32px; color: white;"></i>
                  </div>
                `}
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div>
                      <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
                        <i class="${platform.icon}" style="color: ${platform.color}; margin-right: 8px; font-size: 16px;"></i>
                        ${storeName}
                </h4>
                      ${storeAddress ? `
                        <p style="color: var(--text-secondary); font-size: 13px; margin: 4px 0;">
                          <i class="fas fa-map-marker-alt" style="font-size: 11px; margin-right: 4px;"></i>
                          ${storeAddress}
                        </p>
                      ` : ''}
                      ${phoneNumber ? `
                        <p style="color: var(--text-secondary); font-size: 13px; margin: 4px 0;">
                          <i class="fas fa-phone" style="font-size: 11px; margin-right: 4px;"></i>
                          ${phoneNumber}
                        </p>
                      ` : ''}
                      <p style="color: var(--text-secondary); font-size: 12px; margin: 4px 0 0 0;">
                        ${conn.place_id ? `í”Œë ˆì´ìŠ¤ ID: ${conn.place_id}` : ''}
                        ${conn.store_id ? `ë§¤ì¥ ID: ${conn.store_id}` : ''}
                </p>
              </div>
              <span style="
                padding: 6px 12px;
                background: ${conn.is_active ? '#dcfce7' : '#fee2e2'};
                color: ${conn.is_active ? '#166534' : '#991b1b'};
                border-radius: 999px;
                font-size: 12px;
                font-weight: 600;
                      white-space: nowrap;
              ">
                ${conn.is_active ? 'âœ“ í™œì„±í™”' : 'âœ— ë¹„í™œì„±í™”'}
              </span>
                  </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">ë§ˆì§€ë§‰ ë™ê¸°í™”</div>
                <div style="color: var(--text-primary); font-size: 14px; font-weight: 600;">
                  ${conn.last_sync_at ? new Date(conn.last_sync_at).toLocaleString('ko-KR') : 'ì•„ì§ ì—†ìŒ'}
                </div>
              </div>
              <div>
                <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">ë‹µê¸€ í†¤</div>
                <div style="color: var(--text-primary); font-size: 14px; font-weight: 600;">
                  ${conn.reply_tone === 'friendly' ? 'ì¹œê·¼í•œ' : conn.reply_tone === 'professional' ? 'ì „ë¬¸ì ì¸' : 'ìºì£¼ì–¼'}
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
              <div style="flex: 1; text-align: center; padding: 12px; background: var(--bg-color); border-radius: 8px;">
                <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">ì´ ë¦¬ë·°</div>
                <div style="color: var(--accent-color); font-size: 20px; font-weight: 700;">
                  ${conn.total_reviews || 0}ê±´
                </div>
              </div>
              <div style="flex: 1; text-align: center; padding: 12px; background: var(--bg-color); border-radius: 8px;">
                <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">ë‹µê¸€ ëŒ€ê¸°ì¤‘</div>
                <div style="color: var(--warning); font-size: 20px; font-weight: 700;">
                  ${conn.pending_replies || 0}ê±´
                </div>
              </div>
            </div>

              <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-color); border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" 
                         id="auto-reply-${conn.id}" 
                         ${conn.auto_reply_enabled ? 'checked' : ''}
                         onchange="toggleAutoReply('${conn.platform}', '${conn.id}', this.checked)"
                         style="width: 18px; height: 18px; cursor: pointer;">
                  <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">
                    <i class="fas fa-magic" style="color: var(--accent-color);"></i> ìë™ ë‹µê¸€ í™œì„±í™”
                  </span>
                </label>
                <p style="font-size: 12px; color: var(--text-secondary); margin: 8px 0 0 26px;">
                  í™œì„±í™” ì‹œ ìƒˆë¡œìš´ ë¦¬ë·°ì— AI ë‹µê¸€ì´ ìë™ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤
                </p>
              </div>

            <div style="display: flex; gap: 8px;">
              <a href="/app/ai-review-automation.html" class="btn" style="
                flex: 1;
                background: var(--accent-color);
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                text-align: center;
                text-decoration: none;
                font-weight: 600;
                cursor: pointer;
              ">
                <i class="fas fa-robot"></i> ë¦¬ë·° ê´€ë¦¬í•˜ê¸°
              </a>
                <button onclick="disconnectPlatform('${conn.platform}', '${conn.id}')" class="btn" style="
                background: var(--error);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
              ">
                  <i class="fas fa-unlink"></i> ì—°ë™ í•´ì²´
              </button>
            </div>
          </div>
          `;
        }).join('');
      } else {
        // ì—°ë™ëœ í”Œë«í¼ì´ ì—†ì„ ë•ŒëŠ” ì»¨í…Œì´ë„ˆ ë¹„ìš°ê¸° (ë©”ì‹œì§€ í‘œì‹œ ì•ˆ í•¨)
        container.innerHTML = '';
      }
      
      // ë²„íŠ¼ì— ì—°ë™ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì—°ë™ëœ í”Œë«í¼ì´ ì—†ì–´ë„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸)
      updatePlatformButtons(connections || []);
    }
    
    // í”Œë«í¼ ë²„íŠ¼ì— ì—°ë™ ìƒíƒœ í‘œì‹œ
    function updatePlatformButtons(connections) {
      const platforms = ['naver', 'baemin', 'yogiyo', 'coupangeats'];
      
      platforms.forEach(platform => {
        const button = document.getElementById(`platform-btn-${platform}`);
        if (!button) return;
        
        // í•´ë‹¹ í”Œë«í¼ì´ ì—°ë™ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        const isConnected = connections.some(conn => conn.platform === platform && conn.is_active);
        
        // ê¸°ì¡´ ìƒíƒœ í‘œì‹œ ì œê±°
        const existingStatus = button.querySelector('.connection-status');
        if (existingStatus) {
          existingStatus.remove();
        }
        
        if (isConnected) {
          // ì—°ë™ë¨ ìƒíƒœ: ì˜¤ë¥¸ìª½ì— ì²´í¬ í‘œì‹œì™€ "ì—°ë™ë¨" í…ìŠ¤íŠ¸ ì¶”ê°€
          const statusSpan = document.createElement('span');
          statusSpan.className = 'connection-status';
          statusSpan.style.cssText = 'margin-left: auto; display: flex; align-items: center; gap: 6px; font-size: 13px; opacity: 0.95;';
          statusSpan.innerHTML = '<i class="fas fa-check-circle" style="font-size: 16px;"></i> <span>ì—°ë™ë¨</span>';
          button.appendChild(statusSpan);
        }
      });
    }

    // í™ˆíƒìŠ¤ ì—°ë™ í•¨ìˆ˜
    async function connectHometax() {
      try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/login.html';
        return;
      }

        // í™ˆíƒìŠ¤ ì—°ë™ ëª¨ë‹¬ í‘œì‹œ
        const modal = document.createElement('div');
        modal.className = 'hometax-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          z-index: 2000;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
        
        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          ">
            <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary);">
              <i class="fas fa-receipt" style="color: #0066CC; margin-right: 8px;"></i>
              í™ˆíƒìŠ¤ ì—°ë™
            </h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 24px;">
              ë°”ë¡œë¹Œ í™ˆíƒìŠ¤ ë§¤ì…ë§¤ì¶œì¡°íšŒ ì„œë¹„ìŠ¤ë¥¼ ì—°ë™í•©ë‹ˆë‹¤.<br>
              ì„¸ê¸ˆê³„ì‚°ì„œ ì„œë¹„ìŠ¤ë¥¼ ì—°ë™í•©ë‹ˆë‹¤.
            </p>
            <form id="hometaxForm" style="display: flex; flex-direction: column; gap: 16px;">
              <input type="hidden" id="hometaxServiceType" value="taxinvoice">
              <div>
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                  ì‚¬ì—…ìë²ˆí˜¸ <span style="color: var(--error);">*</span>
                </label>
                <input type="text" id="hometaxCorpNum" placeholder="í•˜ì´í”ˆ(-) ì œì™¸í•œ ìˆ«ìë§Œ ì…ë ¥" 
                  style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                  required maxlength="10" pattern="[0-9]{10}">
              </div>
              <div>
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                  ì‹ ì²­ ë°©ë²• <span style="color: var(--error);">*</span>
                </label>
                <select id="hometaxRequestMethod" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;" required>
                  <option value="url">ì‹ ì²­ í™”ë©´ìœ¼ë¡œ ì´ë™ (ê¶Œì¥)</option>
                  <option value="api">APIë¡œ ì§ì ‘ ì‹ ì²­</option>
                </select>
                <p style="font-size: 12px; color: #999; margin-top: 4px;">
                  ì‹ ì²­ í™”ë©´ ë°©ì‹ì€ ë°”ë¡œë¹Œ ì‚¬ì´íŠ¸ì—ì„œ ì§ì ‘ ì‹ ì²­í•  ìˆ˜ ìˆì–´ ë” ì•ˆì „í•©ë‹ˆë‹¤.
                </p>
              </div>
              <div id="hometaxApiFields" style="display: none; flex-direction: column; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    í™ˆíƒìŠ¤ ë¡œê·¸ì¸ ë°©ë²• <span style="color: var(--error);">*</span>
                  </label>
                  <select id="hometaxLoginMethod" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                    <option value="ID">í™ˆíƒìŠ¤ ì•„ì´ë””</option>
                    <option value="CERT">ê³µë™ì¸ì¦ì„œ</option>
                  </select>
                </div>
                <div id="hometaxIdFields" style="display: none; flex-direction: column; gap: 12px;">
                  <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                      í™ˆíƒìŠ¤ ì•„ì´ë”” <span style="color: var(--error);">*</span>
                    </label>
                    <input type="text" id="hometaxId" placeholder="í™ˆíƒìŠ¤ ì•„ì´ë”” ì…ë ¥"
                      style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                  </div>
                  <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                      í™ˆíƒìŠ¤ ë¹„ë°€ë²ˆí˜¸ <span style="color: var(--error);">*</span>
                    </label>
                    <input type="password" id="hometaxPwd" placeholder="í™ˆíƒìŠ¤ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
                      style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                  </div>
                  <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                      ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ì• 7ìë¦¬ <span style="color: var(--error);">*</span>
                    </label>
                    <input type="text" id="hometaxJumin" placeholder="ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ì• 7ìë¦¬"
                      style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                      maxlength="7" pattern="[0-9]{7}">
                  </div>
                </div>
              </div>
              <div style="display: flex; gap: 12px; margin-top: 8px;">
                <button type="button" onclick="this.closest('.hometax-modal').remove()" 
                  style="flex: 1; padding: 14px; border: 1px solid var(--border); border-radius: 8px; background: white; color: var(--text-primary); font-weight: 600; cursor: pointer;">
                  ì·¨ì†Œ
                </button>
                <button type="submit" 
                  style="flex: 1; padding: 14px; border: none; border-radius: 8px; background: linear-gradient(135deg, #0066CC, #0052A3); color: white; font-weight: 600; cursor: pointer;">
                  ì—°ë™í•˜ê¸°
                </button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // ì‹ ì²­ ë°©ë²• ë³€ê²½ ì‹œ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        document.getElementById('hometaxRequestMethod').addEventListener('change', (e) => {
          const apiFields = document.getElementById('hometaxApiFields');
          if (e.target.value === 'api') {
            apiFields.style.display = 'flex';
          } else {
            apiFields.style.display = 'none';
          }
        });

        // ë¡œê·¸ì¸ ë°©ë²• ë³€ê²½ ì‹œ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        const loginMethodSelect = document.getElementById('hometaxLoginMethod');
        if (loginMethodSelect) {
          loginMethodSelect.addEventListener('change', (e) => {
            const idFields = document.getElementById('hometaxIdFields');
            if (e.target.value === 'ID') {
              idFields.style.display = 'flex';
              document.getElementById('hometaxId').required = true;
              document.getElementById('hometaxPwd').required = true;
              document.getElementById('hometaxJumin').required = true;
            } else {
              idFields.style.display = 'none';
              document.getElementById('hometaxId').required = false;
              document.getElementById('hometaxPwd').required = false;
              document.getElementById('hometaxJumin').required = false;
            }
          });
        }
        
        // í¼ ì œì¶œ
        document.getElementById('hometaxForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const serviceType = 'taxinvoice'; // ì„¸ê¸ˆê³„ì‚°ì„œ ì„œë¹„ìŠ¤ ê³ ì •
          const requestMethod = document.getElementById('hometaxRequestMethod').value;
          const corpNum = document.getElementById('hometaxCorpNum').value.replace(/-/g, '');
          
          if (!corpNum || corpNum.length !== 10) {
            alert('ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (10ìë¦¬ ìˆ«ì)');
            return;
          }
          
          try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
              alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
              return;
            }

            // ì‹ ì²­ í™”ë©´ ë°©ì‹ (ê¶Œì¥)
            if (requestMethod === 'url') {
              const response = await fetch('/api/hometax/get-request-url', {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({
                  userId: session.user.id,
                  corpNum,
                  serviceType
                })
              });
              
              const result = await response.json();
              
              if (result.success && result.data.requestUrl) {
                // íŒì—…ìœ¼ë¡œ ì‹ ì²­ í™”ë©´ ì—´ê¸°
                const popup = window.open(
                  result.data.requestUrl,
                  'í™ˆíƒìŠ¤ì—°ë™ì‹ ì²­',
                  'width=800,height=600,scrollbars=yes,resizable=yes'
                );
                
                // íŒì—…ì´ ë‹«íˆë©´ ì—°ë™ ìƒíƒœ í™•ì¸
                const checkInterval = setInterval(() => {
                  if (popup.closed) {
                    clearInterval(checkInterval);
                    alert('ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì—°ë™ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    modal.remove();
                    loadPlatformConnections(session.user.id);
                  }
                }, 1000);
              } else {
                alert('ì‹ ì²­ URL ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
              }
            } 
            // API ì§ì ‘ ì‹ ì²­ ë°©ì‹
            else {
              const loginMethod = document.getElementById('hometaxLoginMethod').value;
              const hometaxId = document.getElementById('hometaxId').value;
              const hometaxPwd = document.getElementById('hometaxPwd').value;
              const jumin = document.getElementById('hometaxJumin').value;
              
              if (loginMethod === 'ID' && (!hometaxId || !hometaxPwd || !jumin)) {
                alert('í™ˆíƒìŠ¤ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
              }

              const response = await fetch('/api/hometax/register', {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({
                  userId: session.user.id,
                  corpNum,
                  serviceType,
                  loginMethod,
                  hometaxId: loginMethod === 'ID' ? hometaxId : null,
                  hometaxPwd: loginMethod === 'ID' ? hometaxPwd : null,
                  jumin: loginMethod === 'ID' ? jumin : null
                })
              });
              
              const result = await response.json();
              
              if (result.success) {
                const serviceName = serviceType === 'cashbill' ? 'í˜„ê¸ˆì˜ìˆ˜ì¦' : 'ì„¸ê¸ˆê³„ì‚°ì„œ';
                alert(`âœ… ${serviceName} ì„œë¹„ìŠ¤ ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\në§¤ì¼ ì˜¤ì „ 4ì‹œ~6ì‹œì— ì „ë‚ ê¹Œì§€ì˜ ë§¤ì…ë§¤ì¶œ ë‚´ì—­ì„ ìë™ìœ¼ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.`);
                modal.remove();
                await loadPlatformConnections(session.user.id);
              } else {
                // ë°”ë¡œë¹Œ íšŒì›ê°€ì…ì´ í•„ìš”í•œ ê²½ìš°
                if (result.needRegistration) {
                  const register = confirm('ë°”ë¡œë¹Œ íšŒì›ê°€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.\në°”ë¡œë¹Œ íšŒì›ê°€ì…ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                  if (register) {
                    // ë°”ë¡œë¹Œ íšŒì›ê°€ì… ëª¨ë‹¬ í‘œì‹œ
                    showBarobillRegistrationModal(corpNum, serviceType, modal);
                  }
                } else {
                  alert('ì—°ë™ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
              }
            }
          } catch (error) {
            console.error('í™ˆíƒìŠ¤ ì—°ë™ ì‹¤íŒ¨:', error);
            alert('ì—°ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
          }
        });
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      } catch (error) {
        console.error('í™ˆíƒìŠ¤ ì—°ë™ ëª¨ë‹¬ ì˜¤í”ˆ ì‹¤íŒ¨:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // ë°”ë¡œë¹Œ íšŒì›ê°€ì… ëª¨ë‹¬ í‘œì‹œ
    async function showBarobillRegistrationModal(corpNum, serviceType, parentModal) {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }

        // ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', session.user.id)
          .single();

        const modal = document.createElement('div');
        modal.className = 'barobill-registration-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          z-index: 2001;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
        
        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          ">
            <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary);">
              <i class="fas fa-building" style="color: #0066CC; margin-right: 8px;"></i>
              ë°”ë¡œë¹Œ íšŒì›ê°€ì…
            </h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 24px;">
              í™ˆíƒìŠ¤ ì—°ë™ì„ ìœ„í•´ ë°”ë¡œë¹Œ íšŒì›ê°€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
              ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </p>
            <form id="barobillRegistrationForm" style="display: flex; flex-direction: column; gap: 16px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    ì‚¬ì—…ìë²ˆí˜¸ <span style="color: var(--error);">*</span>
                  </label>
                  <input type="text" id="barobillCorpNum" value="${corpNum.replace(/-/g, '')}" 
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                    required maxlength="10" pattern="[0-9]{10}" readonly>
                </div>
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    íšŒì‚¬ëª… <span style="color: var(--error);">*</span>
                  </label>
                  <input type="text" id="barobillCorpName" value="${(profile?.store_name || '').replace(/"/g, '&quot;')}" placeholder="íšŒì‚¬ëª… ì…ë ¥"
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                    required>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    ëŒ€í‘œìëª… <span style="color: var(--error);">*</span>
                  </label>
                  <input type="text" id="barobillCeoName" placeholder="ëŒ€í‘œìëª… ì…ë ¥"
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                    required>
                </div>
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    ì—…íƒœ <span style="color: var(--error);">*</span>
                  </label>
                  <input type="text" id="barobillBizType" placeholder="ì˜ˆ: ë„ë§¤ ë° ì†Œë§¤ì—…" 
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                    required>
                </div>
              </div>
              <div>
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                  ì—…ì¢… <span style="color: var(--error);">*</span>
                </label>
                <input type="text" id="barobillBizClass" placeholder="ì˜ˆ: ìŒì‹ì ì—…" 
                  style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                  required>
              </div>
              <div>
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                  ì£¼ì†Œ <span style="color: var(--error);">*</span>
                </label>
                <input type="text" id="barobillAddr1" value="${(profile?.store_address || '').replace(/"/g, '&quot;')}" placeholder="ì£¼ì†Œ ì…ë ¥"
                  style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                  required>
              </div>
              <div>
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                  ìƒì„¸ì£¼ì†Œ
                </label>
                <input type="text" id="barobillAddr2" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥ (ì„ íƒì‚¬í•­)"
                  style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    ì´ë¦„ <span style="color: var(--error);">*</span>
                  </label>
                  <input type="text" id="barobillMemberName" value="${(session.user.user_metadata?.full_name || session.user.email?.split('@')[0] || '').replace(/"/g, '&quot;')}" placeholder="ì´ë¦„ ì…ë ¥"
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                    required>
                </div>
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    ì „í™”ë²ˆí˜¸ <span style="color: var(--error);">*</span>
                  </label>
                  <input type="text" id="barobillTel" value="${(profile?.phone_number || profile?.store_phone_number || '').replace(/"/g, '&quot;')}" placeholder="ì „í™”ë²ˆí˜¸ ì…ë ¥"
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                    required>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    ë°”ë¡œë¹Œ ì•„ì´ë”” <span style="color: var(--error);">*</span>
                  </label>
                  <input type="text" id="barobillId" placeholder="6~20ì"
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                    required minlength="6" maxlength="20">
                  <p style="font-size: 12px; color: #999; margin-top: 4px;">6~20ì ì˜ë¬¸, ìˆ«ì ì¡°í•©</p>
                </div>
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    ë°”ë¡œë¹Œ ë¹„ë°€ë²ˆí˜¸ <span style="color: var(--error);">*</span>
                  </label>
                  <input type="password" id="barobillPwd" placeholder="6~20ì"
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                    required minlength="6" maxlength="20">
                  <p style="font-size: 12px; color: #999; margin-top: 4px;">6~20ì</p>
                </div>
              </div>
              <div>
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                  ì´ë©”ì¼ <span style="color: var(--error);">*</span>
                </label>
                <input type="email" id="barobillEmail" value="${(session.user.email || '').replace(/"/g, '&quot;')}" placeholder="ì´ë©”ì¼ ì…ë ¥"
                  style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                  required>
              </div>
              <div style="display: flex; gap: 12px; margin-top: 8px;">
                <button type="button" onclick="this.closest('.barobill-registration-modal').remove()" 
                  style="flex: 1; padding: 14px; border: 1px solid var(--border); border-radius: 8px; background: white; color: var(--text-primary); font-weight: 600; cursor: pointer;">
                  ì·¨ì†Œ
                </button>
                <button type="submit" 
                  style="flex: 1; padding: 14px; border: none; border-radius: 8px; background: linear-gradient(135deg, #0066CC, #0052A3); color: white; font-weight: 600; cursor: pointer;">
                  íšŒì›ê°€ì…
                </button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // í¼ ì œì¶œ
        document.getElementById('barobillRegistrationForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const registrationData = {
            corpNum: document.getElementById('barobillCorpNum').value,
            corpName: document.getElementById('barobillCorpName').value,
            ceoName: document.getElementById('barobillCeoName').value,
            bizType: document.getElementById('barobillBizType').value,
            bizClass: document.getElementById('barobillBizClass').value,
            postNum: '',
            addr1: document.getElementById('barobillAddr1').value,
            addr2: document.getElementById('barobillAddr2').value,
            memberName: document.getElementById('barobillMemberName').value,
            id: document.getElementById('barobillId').value,
            pwd: document.getElementById('barobillPwd').value,
            grade: '',
            tel: document.getElementById('barobillTel').value,
            hp: '',
            email: document.getElementById('barobillEmail').value
          };
          
          try {
            const response = await fetch('/api/barobill/register-corp', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
              },
              body: JSON.stringify(registrationData)
            });
            
            const result = await response.json();
            
            if (result.success) {
              alert('âœ… ë°”ë¡œë¹Œ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ì œ í™ˆíƒìŠ¤ ì—°ë™ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              modal.remove();
              // í™ˆíƒìŠ¤ ì—°ë™ ë‹¤ì‹œ ì‹œë„
              if (parentModal) {
                // í™ˆíƒìŠ¤ ì—°ë™ í¼ ë‹¤ì‹œ ì œì¶œ
                const hometaxForm = parentModal.querySelector('#hometaxForm');
                if (hometaxForm) {
                  hometaxForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                }
              }
            } else {
              alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
          } catch (error) {
            console.error('ë°”ë¡œë¹Œ íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
            alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
          }
        });
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      } catch (error) {
        console.error('ë°”ë¡œë¹Œ íšŒì›ê°€ì… ëª¨ë‹¬ ì˜¤í”ˆ ì‹¤íŒ¨:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // í”Œë«í¼ ì—°ë™ í•¨ìˆ˜
    async function connectPlatform(platform) {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login.html';
          return;
        }

        const userId = session.user.id;
        
        // ë„¤ì´ë²„ëŠ” OAuth ë°©ì‹, ë‚˜ë¨¸ì§€ëŠ” ê¸°ì¡´ ë°©ì‹
        const platformUrls = {
          naver: {
            loginUrl: 'https://nid.naver.com/nidlogin.login?svctype=1&locale=ko_KR&url=' + encodeURIComponent(`https://new.smartplace.naver.com/`),
            callbackUrl: `${window.location.origin}/api/naver/oauth-callback?userId=${userId}`,
            name: 'ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸í”Œë ˆì´ìŠ¤',
            instruction: 'ë„¤ì´ë²„ ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.'
          },
          baemin: {
            loginUrl: 'https://ceo.baemin.com/login',
            callbackUrl: `${window.location.origin}/platform-callback.html?platform=baemin`,
            name: 'ë°°ë‹¬ì˜ë¯¼ì¡±',
            instruction: 'ë¡œê·¸ì¸ í›„ ì‚¬ì¥ë‹˜ ê´‘ì¥ ë©”ì¸ í˜ì´ì§€ì˜ URLì„ ë³µì‚¬í•´ì£¼ì„¸ìš”.'
          },
          yogiyo: {
            loginUrl: 'https://www.yogiyo.co.kr/mobile/#/login/',
            callbackUrl: `${window.location.origin}/platform-callback.html?platform=yogiyo`,
            name: 'ìš”ê¸°ìš”',
            instruction: 'ë¡œê·¸ì¸ í›„ ë§¤ì¥ ê´€ë¦¬ í˜ì´ì§€ì˜ URLì„ ë³µì‚¬í•´ì£¼ì„¸ìš”.'
          },
          coupangeats: {
            loginUrl: 'https://partners.coupang.com/login',
            callbackUrl: `${window.location.origin}/platform-callback.html?platform=coupangeats`,
            name: 'ì¿ íŒ¡ì´ì¸ ',
            instruction: 'ë¡œê·¸ì¸ í›„ íŒŒíŠ¸ë„ˆ ì„¼í„° ë©”ì¸ í˜ì´ì§€ì˜ URLì„ ë³µì‚¬í•´ì£¼ì„¸ìš”.'
          }
        };

        const platformInfo = platformUrls[platform];
        if (!platformInfo) {
          alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” í”Œë«í¼ì…ë‹ˆë‹¤.');
          return;
        }

        // ë„¤ì´ë²„ëŠ” OAuth ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
        if (platform === 'naver') {
      // ë„¤ì´ë²„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          window.location.href = platformInfo.loginUrl;
        } else {
          // ë‹¤ë¥¸ í”Œë«í¼ì€ ê¸°ì¡´ ë°©ì‹ (callback í˜ì´ì§€ë¡œ)
          sessionStorage.setItem(`${platform}_user_id`, userId);
          sessionStorage.setItem('connecting_platform', platform);
          window.location.href = platformInfo.callbackUrl;
        }
      } catch (error) {
        console.error(`âŒ ${platform} ì—°ë™ ì‹¤íŒ¨:`, error);
        alert('ì—°ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // ìë™ ë‹µê¸€ í™œì„±í™”/ë¹„í™œì„±í™”
    async function toggleAutoReply(platform, connectionId, enabled) {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        }

        const response = await fetch(`/api/platform/toggle-auto-reply`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'user-id': session.user.id
          },
          body: JSON.stringify({
            connectionId,
            enabled
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ìë™ ë‹µê¸€ ì„¤ì • ì‹¤íŒ¨');
        }

        const result = await response.json();
        
        if (result.success) {
          // UI ì—…ë°ì´íŠ¸
          await loadPlatformConnections(session.user.id);
        } else {
          throw new Error(result.error || 'ìë™ ë‹µê¸€ ì„¤ì • ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('âŒ ìë™ ë‹µê¸€ ì„¤ì • ì‹¤íŒ¨:', error);
        alert('ìë™ ë‹µê¸€ ì„¤ì • ì‹¤íŒ¨: ' + error.message);
        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë˜ëŒë¦¬ê¸°
        const checkbox = document.getElementById(`auto-reply-${connectionId}`);
        if (checkbox) {
          checkbox.checked = !enabled;
        }
      }
    }

    // í”Œë«í¼ ì—°ë™ í•´ì²´ í•¨ìˆ˜
    async function disconnectPlatform(platform, connectionId) {
      if (!confirm('ì •ë§ ì—°ë™ì„ í•´ì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ë™ í•´ì²´ í›„ ë¦¬ë·° ìë™ ìˆ˜ì§‘ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤.')) {
        return;
      }

      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        }

        const apiEndpoints = {
          naver: `/api/naver/disconnect/${connectionId}`,
          baemin: `/api/baemin/disconnect/${connectionId}`,
          yogiyo: `/api/yogiyo/disconnect/${connectionId}`,
          coupangeats: `/api/coupangeats/disconnect/${connectionId}`
        };

        const endpoint = apiEndpoints[platform];
        if (!endpoint) {
          throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” í”Œë«í¼ì…ë‹ˆë‹¤');
        }

        const response = await fetch(endpoint, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'user-id': session.user.id
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ì—°ë™ í•´ì²´ ì‹¤íŒ¨');
        }

        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          await loadPlatformConnections(session.user.id);
        } else {
          throw new Error(result.error || 'ì—°ë™ í•´ì œ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('âŒ ì—°ë™ í•´ì²´ ì‹¤íŒ¨:', error);
        alert('ì—°ë™ í•´ì²´ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // URLë¡œ ì—°ë™ ì™„ë£Œ
    async function connectFromUrl() {
      const smartplaceUrl = document.getElementById('smartplaceUrl').value.trim();
      const replyTone = document.getElementById('replyTone').value;

      if (!smartplaceUrl) {
        alert('ìŠ¤ë§ˆíŠ¸í”Œë ˆì´ìŠ¤ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // URLì—ì„œ í”Œë ˆì´ìŠ¤ ID ì¶”ì¶œ
      const placeIdMatch = smartplaceUrl.match(/(?:restaurant|place)\/(\d+)/) || 
                          smartplaceUrl.match(/\/my-place\/(\d+)/) ||
                          smartplaceUrl.match(/\/place\/(\d+)/);
      
      if (!placeIdMatch) {
        alert('ì˜¬ë°”ë¥¸ ìŠ¤ë§ˆíŠ¸í”Œë ˆì´ìŠ¤ URLì´ ì•„ë‹™ë‹ˆë‹¤.\nì˜ˆ: https://new.smartplace.naver.com/... ë˜ëŠ” https://m.place.naver.com/my-place/...');
        return;
      }

      const placeId = placeIdMatch[1];
      const connectBtn = document.getElementById('connectFromUrlBtn');
      const originalText = connectBtn.innerHTML;
      connectBtn.disabled = true;
      connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì—°ë™ ì¤‘...';

      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        }

        const response = await fetch('/api/naver/connect', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'user-id': session.user.id
          },
          body: JSON.stringify({
            placeId,
            replyTone,
            smartplaceUrl
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ì—°ë™ ì‹¤íŒ¨');
        }

        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸í”Œë ˆì´ìŠ¤ ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ì œ 10ë¶„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ë¦¬ë·°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.');
          
          // í¼ ì´ˆê¸°í™”
          document.getElementById('smartplaceUrl').value = '';
          document.getElementById('urlInputGroup').style.display = 'none';
          document.getElementById('connectFromUrlBtn').style.display = 'none';
          document.getElementById('connectBtn').style.display = 'block';
          
          // ì—°ë™ ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
          await loadPlatformConnections(session.user.id);
        } else {
          throw new Error(result.error || 'ì—°ë™ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('âŒ ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì—°ë™ ì‹¤íŒ¨:', error);
        alert('ì—°ë™ ì‹¤íŒ¨: ' + error.message);
      } finally {
        connectBtn.disabled = false;
        connectBtn.innerHTML = originalText;
      }
    }

    // ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì—°ë™ (ê¸°ì¡´ í•¨ìˆ˜ëŠ” ë°±ì—…ìš©)
    async function connectNaverPlace() {
      const naverId = document.getElementById('naverId')?.value.trim();
      const naverPassword = document.getElementById('naverPassword')?.value.trim();
      const placeSelect = document.getElementById('placeSelect');
      const selectedPlaceId = placeSelect ? placeSelect.value : null;
      const replyTone = document.getElementById('replyTone').value;

      if (!naverId || !naverPassword) {
        alert('ë„¤ì´ë²„ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const connectBtn = document.getElementById('connectBtn');
      const originalText = connectBtn.innerHTML;
      connectBtn.disabled = true;
      connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¡œê·¸ì¸ ì¤‘...';

      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        }

        // í”Œë ˆì´ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì•„ì§ ì„ íƒ ì•ˆ í–ˆìœ¼ë©´)
        let finalPlaceId = selectedPlaceId;
        if (!finalPlaceId) {
          connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> í”Œë ˆì´ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
          
          const listResponse = await fetch('/api/naver/get-places', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'user-id': session.user.id
            },
            body: JSON.stringify({ naverId, naverPassword })
          });

          if (!listResponse.ok) {
            const error = await listResponse.json();
            throw new Error(error.error || 'í”Œë ˆì´ìŠ¤ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }

          const listResult = await listResponse.json();
          if (!listResult.success || !listResult.places || listResult.places.length === 0) {
            throw new Error('ê´€ë¦¬í•˜ëŠ” í”Œë ˆì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }

          // í”Œë ˆì´ìŠ¤ê°€ 1ê°œë©´ ìë™ ì„ íƒ, ì—¬ëŸ¬ ê°œë©´ ì„ íƒ UI í‘œì‹œ
          if (listResult.places.length === 1) {
            finalPlaceId = listResult.places[0].placeId;
          } else {
            // ì—¬ëŸ¬ ê°œë©´ ì„ íƒ UI í‘œì‹œ
            const placeSelectGroup = document.getElementById('placeSelectGroup');
            const placeSelectEl = document.getElementById('placeSelect');
            
            if (placeSelectGroup && placeSelectEl) {
              placeSelectGroup.style.display = 'block';
              placeSelectEl.innerHTML = '<option value="">í”Œë ˆì´ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>' +
                listResult.places.map(p => 
                  `<option value="${p.placeId}">${p.placeName} (ID: ${p.placeId})</option>`
                ).join('');
              
              connectBtn.innerHTML = '<i class="fas fa-hand-pointer"></i> í”Œë ˆì´ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
              connectBtn.disabled = false;
              
              // í”Œë ˆì´ìŠ¤ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ì—°ë™ ì§„í–‰
              const handlePlaceSelect = async function() {
                if (placeSelectEl.value) {
                  await connectNaverPlace(); // ì¬ê·€ í˜¸ì¶œ
                }
              };
              
              // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
              placeSelectEl.removeEventListener('change', handlePlaceSelect);
              placeSelectEl.addEventListener('change', handlePlaceSelect);
              
              return; // ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸°
            } else {
              // UIê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í”Œë ˆì´ìŠ¤ ì‚¬ìš©
              finalPlaceId = listResult.places[0].placeId;
            }
          }
        }

        connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì—°ë™ ì¤‘...';
        connectBtn.disabled = true;

        const response = await fetch('/api/naver/connect', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'user-id': session.user.id
          },
          body: JSON.stringify({
            naverId,
            naverPassword,
            placeId: finalPlaceId,
            replyTone
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ì—°ë™ ì‹¤íŒ¨');
        }

        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸í”Œë ˆì´ìŠ¤ ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ì œ 10ë¶„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ë¦¬ë·°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.');
          
          // í¼ ì´ˆê¸°í™”
          document.getElementById('naverId').value = '';
          document.getElementById('naverPassword').value = '';
          const placeSelectGroup = document.getElementById('placeSelectGroup');
          if (placeSelectGroup) placeSelectGroup.style.display = 'none';
          
          // ì—°ë™ ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
          await loadPlatformConnections(session.user.id);
        } else {
          throw new Error(result.error || 'ì—°ë™ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('âŒ ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì—°ë™ ì‹¤íŒ¨:', error);
        alert('ì—°ë™ ì‹¤íŒ¨: ' + error.message);
      } finally {
        connectBtn.disabled = false;
        connectBtn.innerHTML = originalText;
      }
    }

    // ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì—°ë™ í•´ì²´
    async function disconnectNaverPlace(connectionId) {
      if (!confirm('ì •ë§ ì—°ë™ì„ í•´ì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ë™ í•´ì²´ í›„ ë¦¬ë·° ìë™ ìˆ˜ì§‘ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤.')) {
        return;
      }

      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        }

        const response = await fetch(`/api/naver/disconnect/${connectionId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'user-id': session.user.id
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ì—°ë™ í•´ì²´ ì‹¤íŒ¨');
        }

        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          await loadPlatformConnections(session.user.id);
        } else {
          throw new Error(result.error || 'ì—°ë™ í•´ì œ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('âŒ ì—°ë™ í•´ì²´ ì‹¤íŒ¨:', error);
        alert('ì—°ë™ í•´ì²´ ì‹¤íŒ¨: ' + error.message);
      }
    }

    window.addEventListener('load', function() {
      initTimeDropdowns(); // ì‹œê°„ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
      initPage();
      setupLogoutButton();
    });
  </script>

  <!-- ì¶”ì  ë° ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="/assets/analytics.js"></script>
  <script src="/assets/error-logger.js"></script>
  <script src="/assets/performance-tracker.js"></script>

  <!-- í‘¸í„° -->
  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-item">
        <div class="footer-label">ìƒí˜¸ëª…</div>
        <div class="footer-value">ì‚¬ì¥í”½</div>
      </div>
      <div class="footer-item">
        <div class="footer-label">ëŒ€í‘œìëª…</div>
        <div class="footer-value">ì˜¤ëŒ€ì¤€</div>
      </div>
      <div class="footer-item">
        <div class="footer-label">ì‚¬ì—…ì¥ ì£¼ì†Œì§€</div>
        <div class="footer-value">ë¶€ì‚°ê´‘ì—­ì‹œ ë¶êµ¬ ë°±ì–‘ëŒ€ë¡œ 1003 5ë™307í˜¸</div>
      </div>
      <div class="footer-item">
        <div class="footer-label">ì‚¬ì—…ì ë²ˆí˜¸</div>
        <div class="footer-value">441-31-01878</div>
      </div>
      <div class="footer-item">
        <div class="footer-label">ì´ë©”ì¼ ì£¼ì†Œ</div>
        <div class="footer-value">
          <a href="mailto:ohdaejun@naver.com">ohdaejun@naver.com</a>
        </div>
      </div>
      <div class="footer-item">
        <div class="footer-label">ì „í™”ë²ˆí˜¸</div>
        <div class="footer-value">
          <a href="tel:010-6664-3744">010-6664-3744</a>
        </div>
      </div>
    </div>
  </footer>
</body>
</html>

